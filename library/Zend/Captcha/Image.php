<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Captcha
php php*php php@subpackagephp Adapter
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Imagephp.phpphp php2php2php5php8php9php php2php0php1php0php-php0php7php-php1php6php php2php0php:php5php1php:php5php1Zphp mikaelkaelphp php$
php php*php/

php/php*php*php php@seephp Zendphp_Captchaphp_Wordphp php*php/
requirephp_oncephp php'Zendphp/Captchaphp/Wordphp.phpphp'php;

php/php*php*
php php*php Imagephp-basedphp captchaphp element
php php*
php php*php Generatesphp imagephp displayingphp randomphp word
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Captcha
php php*php php@subpackagephp Adapter
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_Captchaphp_Imagephp extendsphp Zendphp_Captchaphp_Word
php{
php php php php php/php*php*
php php php php php php*php Directoryphp forphp generatedphp images
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_imgDirphp php=php php"php.php/imagesphp/captchaphp/php"php;

php php php php php/php*php*
php php php php php php*php URLphp forphp accessingphp images
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_imgUrlphp php=php php"php/imagesphp/captchaphp/php"php;

php php php php php/php*php*
php php php php php php*php Imagephp'sphp altphp tagphp content
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_imgAltphp php=php php"php"php;

php php php php php/php*php*
php php php php php php*php Imagephp suffixphp php(includingphp dotphp)
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_suffixphp php=php php"php.pngphp"php;

php php php php php/php*php*
php php php php php php*php Imagephp width
php php php php php php*
php php php php php php*php php@varphp int
php php php php php php*php/
php php php php protectedphp php$php_widthphp php=php php2php0php0php;

php php php php php/php*php*
php php php php php php*php Imagephp height
php php php php php php*
php php php php php php*php php@varphp int
php php php php php php*php/
php php php php protectedphp php$php_heightphp php=php php5php0php;

php php php php php/php*php*
php php php php php php*php Fontphp size
php php php php php php*
php php php php php php*php php@varphp int
php php php php php php*php/
php php php php protectedphp php$php_fsizephp php=php php2php4php;

php php php php php/php*php*
php php php php php php*php Imagephp fontphp file
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_fontphp;

php php php php php/php*php*
php php php php php php*php Imagephp tophp usephp asphp startingphp point
php php php php php php*php Defaultphp isphp blankphp imagephp.php Ifphp providedphp,php shouldphp bephp PNGphp imagephp.
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_startImagephp;
php php php php php/php*php*
php php php php php php*php Howphp frequentlyphp tophp executephp garbagephp collection
php php php php php php*
php php php php php php*php php@varphp int
php php php php php php*php/
php php php php protectedphp php$php_gcFreqphp php=php php1php0php;

php php php php php/php*php*
php php php php php php*php Howphp longphp tophp keepphp generatedphp images
php php php php php php*
php php php php php php*php php@varphp int
php php php php php php*php/
php php php php protectedphp php$php_expirationphp php=php php6php0php0php;

php php php php php/php*php*
php php php php php php*php Numberphp ofphp noisephp dotsphp onphp image
php php php php php php*php Usedphp twicephp php-php beforephp andphp afterphp transform
php php php php php php*
php php php php php php*php php@varphp int
php php php php php php*php/
php php php php protectedphp php$php_dotNoiseLevelphp php=php php1php0php0php;
php php php php php/php*php*
php php php php php php*php Numberphp ofphp noisephp linesphp onphp image
php php php php php php*php Usedphp twicephp php-php beforephp andphp afterphp transform
php php php php php php*
php php php php php php*php php@varphp int
php php php php php php*php/
php php php php protectedphp php$php_lineNoiseLevelphp php=php php5php;
php php php php php/php*php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getImgAltphp php(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_imgAltphp;
php php php php php}
php php php php php/php*php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getStartImagephp php(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_startImagephp;
php php php php php}
php php php php php/php*php*
php php php php php php*php php@returnphp int
php php php php php php*php/
php php php php publicphp functionphp getDotNoiseLevelphp php(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_dotNoiseLevelphp;
php php php php php}
php php php php php/php*php*
php php php php php php*php php@returnphp int
php php php php php php*php/
php php php php publicphp functionphp getLineNoiseLevelphp php(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_lineNoiseLevelphp;
php php php php php}
php php php php php/php*php*
php php php php php php*php Getphp captchaphp expiration
php php php php php php*
php php php php php php*php php@returnphp int
php php php php php php*php/
php php php php publicphp functionphp getExpirationphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_expirationphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp garbagephp collectionphp frequency
php php php php php php*
php php php php php php*php php@returnphp int
php php php php php php*php/
php php php php publicphp functionphp getGcFreqphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_gcFreqphp;
php php php php php}
php php php php php/php*php*
php php php php php php*php Getphp fontphp tophp usephp whenphp generatingphp captcha
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getFontphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_fontphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp fontphp size
php php php php php php*
php php php php php php*php php@returnphp int
php php php php php php*php/
php php php php publicphp functionphp getFontSizephp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_fsizephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp captchaphp imagephp height
php php php php php php*
php php php php php php*php php@returnphp int
php php php php php php*php/
php php php php publicphp functionphp getHeightphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_heightphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp captchaphp imagephp directory
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getImgDirphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_imgDirphp;
php php php php php}
php php php php php/php*php*
php php php php php php*php Getphp captchaphp imagephp basephp URL
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getImgUrlphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_imgUrlphp;
php php php php php}
php php php php php/php*php*
php php php php php php*php Getphp captchaphp imagephp filephp suffix
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getSuffixphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_suffixphp;
php php php php php}
php php php php php/php*php*
php php php php php php*php Getphp captchaphp imagephp width
php php php php php php*
php php php php php php*php php@returnphp int
php php php php php php*php/
php php php php publicphp functionphp getWidthphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_widthphp;
php php php php php}
php php php php php/php*php*
php php php php php php*php php@paramphp stringphp php$startImage
php php php php php php*php/
php php php php publicphp functionphp setStartImagephp php(php$startImagephp)
php php php php php{
php php php php php php php php php$thisphp-php>php_startImagephp php=php php$startImagephp;
php php php php php php php php returnphp php$thisphp;
php php php php php}
php php php php php/php*php*
php php php php php php*php php@paramphp intphp php$dotNoiseLevel
php php php php php php*php/
php php php php publicphp functionphp setDotNoiseLevelphp php(php$dotNoiseLevelphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_dotNoiseLevelphp php=php php$dotNoiseLevelphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}
php php php php/php*php*
php php php php php php*php php@paramphp intphp php$lineNoiseLevel
php php php php php php*php/
php php php php publicphp functionphp setLineNoiseLevelphp php(php$lineNoiseLevelphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_lineNoiseLevelphp php=php php$lineNoiseLevelphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp captchaphp expiration
php php php php php php*
php php php php php php*php php@paramphp intphp php$expiration
php php php php php php*php php@returnphp Zendphp_Captchaphp_Image
php php php php php php*php/
php php php php publicphp functionphp setExpirationphp(php$expirationphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_expirationphp php=php php$expirationphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp garbagephp collectionphp frequency
php php php php php php*
php php php php php php*php php@paramphp intphp php$gcFreq
php php php php php php*php php@returnphp Zendphp_Captchaphp_Image
php php php php php php*php/
php php php php publicphp functionphp setGcFreqphp(php$gcFreqphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_gcFreqphp php=php php$gcFreqphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp captchaphp font
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$font
php php php php php php*php php@returnphp Zendphp_Captchaphp_Image
php php php php php php*php/
php php php php publicphp functionphp setFontphp(php$fontphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_fontphp php=php php$fontphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp captchaphp fontphp size
php php php php php php*
php php php php php php*php php@paramphp php intphp php$fsize
php php php php php php*php php@returnphp Zendphp_Captchaphp_Image
php php php php php php*php/
php php php php publicphp functionphp setFontSizephp(php$fsizephp)
php php php php php{
php php php php php php php php php$thisphp-php>php_fsizephp php=php php$fsizephp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp captchaphp imagephp height
php php php php php php*
php php php php php php*php php@paramphp php intphp php$height
php php php php php php*php php@returnphp Zendphp_Captchaphp_Image
php php php php php php*php/
php php php php publicphp functionphp setHeightphp(php$heightphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_heightphp php=php php$heightphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp captchaphp imagephp storagephp directory
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$imgDir
php php php php php php*php php@returnphp Zendphp_Captchaphp_Image
php php php php php php*php/
php php php php publicphp functionphp setImgDirphp(php$imgDirphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_imgDirphp php=php rtrimphp(php$imgDirphp,php php"php/php\php\php"php)php php.php php'php/php'php;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp captchaphp imagephp basephp URL
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$imgUrl
php php php php php php*php php@returnphp Zendphp_Captchaphp_Image
php php php php php php*php/
php php php php publicphp functionphp setImgUrlphp(php$imgUrlphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_imgUrlphp php=php rtrimphp(php$imgUrlphp,php php"php/php\php\php"php)php php.php php'php/php'php;
php php php php php php php php returnphp php$thisphp;
php php php php php}
php php php php php/php*php*
php php php php php php*php php@paramphp stringphp php$imgAlt
php php php php php php*php/
php php php php publicphp functionphp setImgAltphp php(php$imgAltphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_imgAltphp php=php php$imgAltphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp captchphp imagephp filenamephp suffix
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$suffix
php php php php php php*php php@returnphp Zendphp_Captchaphp_Image
php php php php php php*php/
php php php php publicphp functionphp setSuffixphp(php$suffixphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_suffixphp php=php php$suffixphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp captchaphp imagephp width
php php php php php php*
php php php php php php*php php@paramphp php intphp php$width
php php php php php php*php php@returnphp Zendphp_Captchaphp_Image
php php php php php php*php/
php php php php publicphp functionphp setWidthphp(php$widthphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_widthphp php=php php$widthphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Generatephp randomphp frequency
php php php php php php*
php php php php php php*php php@returnphp float
php php php php php php*php/
php php php php protectedphp functionphp php_randomFreqphp(php)
php php php php php{
php php php php php php php php returnphp mtphp_randphp(php7php0php0php0php0php0php,php php1php0php0php0php0php0php0php)php php/php php1php5php0php0php0php0php0php0php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Generatephp randomphp phase
php php php php php php*
php php php php php php*php php@returnphp float
php php php php php php*php/
php php php php protectedphp functionphp php_randomPhasephp(php)
php php php php php{
php php php php php php php php php/php/php randomphp phasephp fromphp php0php tophp pi
php php php php php php php php returnphp mtphp_randphp(php0php,php php3php1php4php1php5php9php2php)php php/php php1php0php0php0php0php0php0php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Generatephp randomphp characterphp size
php php php php php php*
php php php php php php*php php@returnphp int
php php php php php php*php/
php php php php protectedphp functionphp php_randomSizephp(php)
php php php php php{
php php php php php php php php returnphp mtphp_randphp(php3php0php0php,php php7php0php0php)php php/php php1php0php0php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Generatephp captcha
php php php php php php*
php php php php php php*php php@returnphp stringphp captchaphp ID
php php php php php php*php/
php php php php publicphp functionphp generatephp(php)
php php php php php{
php php php php php php php php php$idphp php=php parentphp:php:generatephp(php)php;
php php php php php php php php php$triesphp php=php php5php;
php php php php php php php php php/php/php Ifphp therephp'sphp alreadyphp suchphp filephp,php tryphp creatingphp aphp newphp ID
php php php php php php php php whilephp(php$triesphp-php-php php&php&php filephp_existsphp(php$thisphp-php>getImgDirphp(php)php php.php php$idphp php.php php$thisphp-php>getSuffixphp(php)php)php)php php{
php php php php php php php php php php php php php$idphp php=php php$thisphp-php>php_generateRandomIdphp(php)php;
php php php php php php php php php php php php php$thisphp-php>php_setIdphp(php$idphp)php;
php php php php php php php php php}
php php php php php php php php php$thisphp-php>php_generateImagephp(php$idphp,php php$thisphp-php>getWordphp(php)php)php;

php php php php php php php php ifphp php(mtphp_randphp(php1php,php php$thisphp-php>getGcFreqphp(php)php)php php=php=php php1php)php php{
php php php php php php php php php php php php php$thisphp-php>php_gcphp(php)php;
php php php php php php php php php}
php php php php php php php php returnphp php$idphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Generatephp imagephp captcha
php php php php php php*
php php php php php php*php Overridephp thisphp functionphp ifphp youphp wantphp differentphp imagephp generator
php php php php php php*php Wavephp transformphp fromphp httpphp:php/php/wwwphp.captchaphp.ruphp/captchasphp/multiwavephp/
php php php php php php*
php php php php php php*php php@paramphp stringphp php$idphp Captchaphp ID
php php php php php php*php php@paramphp stringphp php$wordphp Captchaphp word
php php php php php php*php/
php php php php protectedphp functionphp php_generateImagephp(php$idphp,php php$wordphp)
php php php php php{
php php php php php php php php ifphp php(php!extensionphp_loadedphp(php"gdphp"php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Captchaphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Captchaphp_Exceptionphp(php"Imagephp CAPTCHAphp requiresphp GDphp extensionphp"php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!functionphp_existsphp(php"imagepngphp"php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Captchaphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Captchaphp_Exceptionphp(php"Imagephp CAPTCHAphp requiresphp PNGphp supportphp"php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!functionphp_existsphp(php"imageftbboxphp"php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Captchaphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Captchaphp_Exceptionphp(php"Imagephp CAPTCHAphp requiresphp FTphp fontsphp supportphp"php)php;
php php php php php php php php php}

php php php php php php php php php$fontphp php=php php$thisphp-php>getFontphp(php)php;

php php php php php php php php ifphp php(emptyphp(php$fontphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Captchaphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Captchaphp_Exceptionphp(php"Imagephp CAPTCHAphp requiresphp fontphp"php)php;
php php php php php php php php php}

php php php php php php php php php$wphp php php php php php=php php$thisphp-php>getWidthphp(php)php;
php php php php php php php php php$hphp php php php php php=php php$thisphp-php>getHeightphp(php)php;
php php php php php php php php php$fsizephp php=php php$thisphp-php>getFontSizephp(php)php;

php php php php php php php php php$imgphp_filephp php php php=php php$thisphp-php>getImgDirphp(php)php php.php php$idphp php.php php$thisphp-php>getSuffixphp(php)php;
php php php php php php php php ifphp(emptyphp(php$thisphp-php>php_startImagephp)php)php php{
php php php php php php php php php php php php php$imgphp php php php php php php php php=php imagecreatetruecolorphp(php$wphp,php php$hphp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$imgphp php=php imagecreatefrompngphp(php$thisphp-php>php_startImagephp)php;
php php php php php php php php php php php php ifphp(php!php$imgphp)php php{
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Captchaphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Captchaphp_Exceptionphp(php"Canphp notphp loadphp startphp imagephp"php)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$wphp php=php imagesxphp(php$imgphp)php;
php php php php php php php php php php php php php$hphp php=php imagesyphp(php$imgphp)php;
php php php php php php php php php}
php php php php php php php php php$textphp_colorphp php=php imagecolorallocatephp(php$imgphp,php php0php,php php0php,php php0php)php;
php php php php php php php php php$bgphp_colorphp php php php=php imagecolorallocatephp(php$imgphp,php php2php5php5php,php php2php5php5php,php php2php5php5php)php;
php php php php php php php php imagefilledrectanglephp(php$imgphp,php php0php,php php0php,php php$wphp-php1php,php php$hphp-php1php,php php$bgphp_colorphp)php;
php php php php php php php php php$textboxphp php=php imageftbboxphp(php$fsizephp,php php0php,php php$fontphp,php php$wordphp)php;
php php php php php php php php php$xphp php=php php(php$wphp php-php php(php$textboxphp[php2php]php php-php php$textboxphp[php0php]php)php)php php/php php2php;
php php php php php php php php php$yphp php=php php(php$hphp php-php php(php$textboxphp[php7php]php php-php php$textboxphp[php1php]php)php)php php/php php2php;
php php php php php php php php imagefttextphp(php$imgphp,php php$fsizephp,php php0php,php php$xphp,php php$yphp,php php$textphp_colorphp,php php$fontphp,php php$wordphp)php;

php php php php php php php php/php/php generatephp noise
php php php php php php php php forphp php(php$iphp=php0php;php php$i<php$thisphp-php>php_dotNoiseLevelphp;php php$iphp+php+php)php php{
php php php php php php php php php php php imagefilledellipsephp(php$imgphp,php mtphp_randphp(php0php,php$wphp)php,php mtphp_randphp(php0php,php$hphp)php,php php2php,php php2php,php php$textphp_colorphp)php;
php php php php php php php php php}
php php php php php php php php forphp(php$iphp=php0php;php php$i<php$thisphp-php>php_lineNoiseLevelphp;php php$iphp+php+php)php php{
php php php php php php php php php php php imagelinephp(php$imgphp,php mtphp_randphp(php0php,php$wphp)php,php mtphp_randphp(php0php,php$hphp)php,php mtphp_randphp(php0php,php$wphp)php,php mtphp_randphp(php0php,php$hphp)php,php php$textphp_colorphp)php;
php php php php php php php php php}

php php php php php php php php php/php/php transformedphp image
php php php php php php php php php$imgphp2php php php php php php=php imagecreatetruecolorphp(php$wphp,php php$hphp)php;
php php php php php php php php php$bgphp_colorphp php=php imagecolorallocatephp(php$imgphp2php,php php2php5php5php,php php2php5php5php,php php2php5php5php)php;
php php php php php php php php imagefilledrectanglephp(php$imgphp2php,php php0php,php php0php,php php$wphp-php1php,php php$hphp-php1php,php php$bgphp_colorphp)php;
php php php php php php php php php/php/php applyphp wavephp transforms
php php php php php php php php php$freqphp1php php=php php$thisphp-php>php_randomFreqphp(php)php;
php php php php php php php php php$freqphp2php php=php php$thisphp-php>php_randomFreqphp(php)php;
php php php php php php php php php$freqphp3php php=php php$thisphp-php>php_randomFreqphp(php)php;
php php php php php php php php php$freqphp4php php=php php$thisphp-php>php_randomFreqphp(php)php;

php php php php php php php php php$phphp1php php=php php$thisphp-php>php_randomPhasephp(php)php;
php php php php php php php php php$phphp2php php=php php$thisphp-php>php_randomPhasephp(php)php;
php php php php php php php php php$phphp3php php=php php$thisphp-php>php_randomPhasephp(php)php;
php php php php php php php php php$phphp4php php=php php$thisphp-php>php_randomPhasephp(php)php;

php php php php php php php php php$szxphp php=php php$thisphp-php>php_randomSizephp(php)php;
php php php php php php php php php$szyphp php=php php$thisphp-php>php_randomSizephp(php)php;

php php php php php php php php forphp php(php$xphp php=php php0php;php php$xphp <php php$wphp;php php$xphp+php+php)php php{
php php php php php php php php php php php php forphp php(php$yphp php=php php0php;php php$yphp <php php$hphp;php php$yphp+php+php)php php{
php php php php php php php php php php php php php php php php php$sxphp php=php php$xphp php+php php(sinphp(php$xphp*php$freqphp1php php+php php$phphp1php)php php+php sinphp(php$yphp*php$freqphp3php php+php php$phphp3php)php)php php*php php$szxphp;
php php php php php php php php php php php php php php php php php$syphp php=php php$yphp php+php php(sinphp(php$xphp*php$freqphp2php php+php php$phphp2php)php php+php sinphp(php$yphp*php$freqphp4php php+php php$phphp4php)php)php php*php php$szyphp;

php php php php php php php php php php php php php php php php ifphp php(php$sxphp <php php0php php|php|php php$syphp <php php0php php|php|php php$sxphp php>php=php php$wphp php-php php1php php|php|php php$syphp php>php=php php$hphp php-php php1php)php php{
php php php php php php php php php php php php php php php php php php php php continuephp;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php$colorphp php php php php=php php(imagecoloratphp(php$imgphp,php php$sxphp,php php$syphp)php php>php>php php1php6php)php php php php php php php php php php&php php0xFFphp;
php php php php php php php php php php php php php php php php php php php php php$colorphp_xphp php php=php php(imagecoloratphp(php$imgphp,php php$sxphp php+php php1php,php php$syphp)php php>php>php php1php6php)php php php php php php&php php0xFFphp;
php php php php php php php php php php php php php php php php php php php php php$colorphp_yphp php php=php php(imagecoloratphp(php$imgphp,php php$sxphp,php php$syphp php+php php1php)php php>php>php php1php6php)php php php php php php&php php0xFFphp;
php php php php php php php php php php php php php php php php php php php php php$colorphp_xyphp php=php php(imagecoloratphp(php$imgphp,php php$sxphp php+php php1php,php php$syphp php+php php1php)php php>php>php php1php6php)php php&php php0xFFphp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php ifphp php(php$colorphp php=php=php php2php5php5php php&php&php php$colorphp_xphp php=php=php php2php5php5php php&php&php php$colorphp_yphp php=php=php php2php5php5php php&php&php php$colorphp_xyphp php=php=php php2php5php5php)php php{
php php php php php php php php php php php php php php php php php php php php php/php/php ignorephp background
php php php php php php php php php php php php php php php php php php php php continuephp;
php php php php php php php php php php php php php php php php php}php elseifphp php(php$colorphp php=php=php php0php php&php&php php$colorphp_xphp php=php=php php0php php&php&php php$colorphp_yphp php=php=php php0php php&php&php php$colorphp_xyphp php=php=php php0php)php php{
php php php php php php php php php php php php php php php php php php php php php/php/php transferphp insidephp ofphp thephp imagephp asphp-is
php php php php php php php php php php php php php php php php php php php php php$newcolorphp php=php php0php;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php/php/php dophp antialiasingphp forphp borderphp items
php php php php php php php php php php php php php php php php php php php php php$fracphp_xphp php php=php php$sxphp-floorphp(php$sxphp)php;
php php php php php php php php php php php php php php php php php php php php php$fracphp_yphp php php=php php$syphp-floorphp(php$syphp)php;
php php php php php php php php php php php php php php php php php php php php php$fracphp_xphp1php php=php php1php-php$fracphp_xphp;
php php php php php php php php php php php php php php php php php php php php php$fracphp_yphp1php php=php php1php-php$fracphp_yphp;

php php php php php php php php php php php php php php php php php php php php php$newcolorphp php=php php$colorphp php php php php*php php$fracphp_xphp1php php*php php$fracphp_yphp1
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php+php php$colorphp_xphp php php*php php$fracphp_xphp php php*php php$fracphp_yphp1
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php+php php$colorphp_yphp php php*php php$fracphp_xphp1php php*php php$fracphp_y
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php+php php$colorphp_xyphp php*php php$fracphp_xphp php php*php php$fracphp_yphp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php imagesetpixelphp(php$imgphp2php,php php$xphp,php php$yphp,php imagecolorallocatephp(php$imgphp2php,php php$newcolorphp,php php$newcolorphp,php php$newcolorphp)php)php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php/php/php generatephp noise
php php php php php php php php forphp php(php$iphp=php0php;php php$i<php$thisphp-php>php_dotNoiseLevelphp;php php$iphp+php+php)php php{
php php php php php php php php php php php php imagefilledellipsephp(php$imgphp2php,php mtphp_randphp(php0php,php$wphp)php,php mtphp_randphp(php0php,php$hphp)php,php php2php,php php2php,php php$textphp_colorphp)php;
php php php php php php php php php}
php php php php php php php php forphp php(php$iphp=php0php;php php$i<php$thisphp-php>php_lineNoiseLevelphp;php php$iphp+php+php)php php{
php php php php php php php php php php php imagelinephp(php$imgphp2php,php mtphp_randphp(php0php,php$wphp)php,php mtphp_randphp(php0php,php$hphp)php,php mtphp_randphp(php0php,php$wphp)php,php mtphp_randphp(php0php,php$hphp)php,php php$textphp_colorphp)php;
php php php php php php php php php}

php php php php php php php php imagepngphp(php$imgphp2php,php php$imgphp_filephp)php;
php php php php php php php php imagedestroyphp(php$imgphp)php;
php php php php php php php php imagedestroyphp(php$imgphp2php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Removephp oldphp filesphp fromphp imagephp directory
php php php php php php*
php php php php php php*php/
php php php php protectedphp functionphp php_gcphp(php)
php php php php php{
php php php php php php php php php$expirephp php=php timephp(php)php php-php php$thisphp-php>getExpirationphp(php)php;
php php php php php php php php php$imgdirphp php=php php$thisphp-php>getImgDirphp(php)php;
php php php php php php php php ifphp(php!php$imgdirphp php|php|php strlenphp(php$imgdirphp)php <php php2php)php php{
php php php php php php php php php php php php php/php/php safetyphp guard
php php php php php php php php php php php php returnphp;
php php php php php php php php php}
php php php php php php php php php$suffixLengthphp php=php strlenphp(php$thisphp-php>php_suffixphp)php;
php php php php php php php php foreachphp php(newphp DirectoryIteratorphp(php$imgdirphp)php asphp php$filephp)php php{
php php php php php php php php php php php php ifphp php(php!php$filephp-php>isDotphp(php)php php&php&php php!php$filephp-php>isDirphp(php)php)php php{
php php php php php php php php php php php php php php php php ifphp php(php$filephp-php>getMTimephp(php)php <php php$expirephp)php php{
php php php php php php php php php php php php php php php php php php php php php/php/php onlyphp deletesphp filesphp endingphp withphp php$thisphp-php>php_suffix
php php php php php php php php php php php php php php php php php php php php ifphp php(substrphp(php$filephp-php>getFilenamephp(php)php,php php-php(php$suffixLengthphp)php)php php=php=php php$thisphp-php>php_suffixphp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php unlinkphp(php$filephp-php>getPathnamephp(php)php)php;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Displayphp thephp captcha
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Viewphp_Interfacephp php$view
php php php php php php*php php@paramphp mixedphp php$element
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp renderphp(Zendphp_Viewphp_Interfacephp php$viewphp php=php nullphp,php php$elementphp php=php nullphp)
php php php php php{
php php php php php php php php returnphp php'php<imgphp widthphp=php"php'php php.php php$thisphp-php>getWidthphp(php)php php.php php'php"php heightphp=php"php'php php.php php$thisphp-php>getHeightphp(php)php php.php php'php"php altphp=php"php'php php.php php$thisphp-php>getImgAltphp(php)
php php php php php php php php php php php php php php.php php'php"php srcphp=php"php'php php.php php$thisphp-php>getImgUrlphp(php)php php.php php$thisphp-php>getIdphp(php)php php.php php$thisphp-php>getSuffixphp(php)php php.php php'php"php php/php>php'php;
php php php php php}
php}
