<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Captcha
php php*php php@subpackagephp Adapter
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/

php/php*php*php php@seephp Zendphp_Captchaphp_Basephp php*php/
requirephp_oncephp php'Zendphp/Captchaphp/Basephp.phpphp'php;

php/php*php*
php php*php Wordphp-basedphp captchaphp adapter
php php*
php php*php Generatesphp randomphp wordphp whichphp userphp shouldphp recognise
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Captcha
php php*php php@subpackagephp Adapter
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Wordphp.phpphp php2php3php5php8php4php php2php0php1php0php-php1php2php-php2php8php php1php9php:php5php1php:php4php9Zphp matthewphp php$
php php*php/
abstractphp classphp Zendphp_Captchaphp_Wordphp extendsphp Zendphp_Captchaphp_Base
php{
php php php php php/php*php*php#php@php+
php php php php php php*php php@varphp arrayphp Characterphp sets
php php php php php php*php/
php php php php staticphp php$Vphp php php=php arrayphp(php"aphp"php,php php"ephp"php,php php"iphp"php,php php"ophp"php,php php"uphp"php,php php"yphp"php)php;
php php php php staticphp php$VNphp php=php arrayphp(php"aphp"php,php php"ephp"php,php php"iphp"php,php php"ophp"php,php php"uphp"php,php php"yphp"php,php"php2php"php,php"php3php"php,php"php4php"php,php"php5php"php,php"php6php"php,php"php7php"php,php"php8php"php,php"php9php"php)php;
php php php php staticphp php$Cphp php php=php arrayphp(php"bphp"php,php"cphp"php,php"dphp"php,php"fphp"php,php"gphp"php,php"hphp"php,php"jphp"php,php"kphp"php,php"mphp"php,php"nphp"php,php"pphp"php,php"qphp"php,php"rphp"php,php"sphp"php,php"tphp"php,php"uphp"php,php"vphp"php,php"wphp"php,php"xphp"php,php"zphp"php)php;
php php php php staticphp php$CNphp php=php arrayphp(php"bphp"php,php"cphp"php,php"dphp"php,php"fphp"php,php"gphp"php,php"hphp"php,php"jphp"php,php"kphp"php,php"mphp"php,php"nphp"php,php"pphp"php,php"qphp"php,php"rphp"php,php"sphp"php,php"tphp"php,php"uphp"php,php"vphp"php,php"wphp"php,php"xphp"php,php"zphp"php,php"php2php"php,php"php3php"php,php"php4php"php,php"php5php"php,php"php6php"php,php"php7php"php,php"php8php"php,php"php9php"php)php;
php php php php php/php*php*php#php@php-php*php/

php php php php php/php*php*
php php php php php php*php Randomphp sessionphp ID
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_idphp;

php php php php php/php*php*
php php php php php php*php Generatedphp word
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_wordphp;

php php php php php/php*php*
php php php php php php*php Session
php php php php php php*
php php php php php php*php php@varphp Zendphp_Sessionphp_Namespace
php php php php php php*php/
php php php php protectedphp php$php_sessionphp;

php php php php php/php*php*
php php php php php php*php Classphp namephp forphp sessions
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_sessionClassphp php=php php'Zendphp_Sessionphp_Namespacephp'php;

php php php php php/php*php*
php php php php php php*php Shouldphp thephp numbersphp bephp usedphp orphp onlyphp letters
php php php php php php*
php php php php php php*php php@varphp boolean
php php php php php php*php/
php php php php protectedphp php$php_useNumbersphp php=php truephp;

php php php php php/php*php*
php php php php php php*php Shouldphp bothphp casesphp bephp usedphp orphp onlyphp lowercase
php php php php php php*
php php php php php php*php php@varphp boolean
php php php php php php*php/
php php php php php/php/php protectedphp php$php_useCasephp php=php falsephp;

php php php php php/php*php*
php php php php php php*php Sessionphp lifetimephp forphp thephp captchaphp data
php php php php php php*
php php php php php php*php php@varphp integer
php php php php php php*php/
php php php php protectedphp php$php_timeoutphp php=php php3php0php0php;

php php php php php/php*php*
php php php php php php*php Shouldphp generatephp(php)php keepphp sessionphp orphp createphp aphp newphp onephp?
php php php php php php*
php php php php php php*php php@varphp boolean
php php php php php php*php/
php php php php protectedphp php$php_keepSessionphp php=php falsephp;

php php php php php/php*php*php#php@php+
php php php php php php*php Errorphp codes
php php php php php php*php/
php php php php constphp MISSINGphp_VALUEphp php=php php'missingValuephp'php;
php php php php constphp MISSINGphp_IDphp php php php php=php php'missingIDphp'php;
php php php php constphp BADphp_CAPTCHAphp php php php=php php'badCaptchaphp'php;
php php php php php/php*php*php#php@php-php*php/

php php php php php/php*php*
php php php php php php*php Errorphp messages
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_messageTemplatesphp php=php arrayphp(
php php php php php php php php selfphp:php:MISSINGphp_VALUEphp php=php>php php'Emptyphp captchaphp valuephp'php,
php php php php php php php php selfphp:php:MISSINGphp_IDphp php php php php=php>php php'Captchaphp IDphp fieldphp isphp missingphp'php,
php php php php php php php php selfphp:php:BADphp_CAPTCHAphp php php php=php>php php'Captchaphp valuephp isphp wrongphp'php,
php php php php php)php;

php php php php php/php*php*
php php php php php php*php Lengthphp ofphp thephp wordphp tophp generate
php php php php php php*
php php php php php php*php php@varphp integer
php php php php php php*php/
php php php php protectedphp php$php_wordlenphp php=php php8php;

php php php php php/php*php*
php php php php php php*php Retrievephp sessionphp classphp tophp utilize
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getSessionClassphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_sessionClassphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp sessionphp classphp forphp persistence
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$php_sessionClass
php php php php php php*php php@returnphp Zendphp_Captchaphp_Word
php php php php php php*php/
php php php php publicphp functionphp setSessionClassphp(php$php_sessionClassphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_sessionClassphp php=php php$php_sessionClassphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp wordphp lengthphp tophp usephp whenphp genratingphp captcha
php php php php php php*
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp functionphp getWordlenphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_wordlenphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp wordphp lengthphp ofphp captcha
php php php php php php*
php php php php php php*php php@paramphp integerphp php$wordlen
php php php php php php*php php@returnphp Zendphp_Captchaphp_Word
php php php php php php*php/
php php php php publicphp functionphp setWordlenphp(php$wordlenphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_wordlenphp php=php php$wordlenphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp captchaphp ID
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getIdphp php(php)
php php php php php{
php php php php php php php php ifphp php(nullphp php=php=php=php php$thisphp-php>php_idphp)php php{
php php php php php php php php php php php php php$thisphp-php>php_setIdphp(php$thisphp-php>php_generateRandomIdphp(php)php)php;
php php php php php php php php php}
php php php php php php php php returnphp php$thisphp-php>php_idphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp captchaphp identifier
php php php php php php*
php php php php php php*php php@paramphp stringphp php$id
php php php php php php*php returnphp Zendphp_Captchaphp_Word
php php php php php php*php/
php php php php protectedphp functionphp php_setIdphp php(php$idphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_idphp php=php php$idphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp timeoutphp forphp sessionphp token
php php php php php php*
php php php php php php*php php@paramphp php intphp php$ttl
php php php php php php*php php@returnphp Zendphp_Captchaphp_Word
php php php php php php*php/
php php php php publicphp functionphp setTimeoutphp(php$ttlphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_timeoutphp php=php php(intphp)php php$ttlphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp sessionphp tokenphp timeout
php php php php php php*
php php php php php php*php php@returnphp int
php php php php php php*php/
php php php php publicphp functionphp getTimeoutphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_timeoutphp;
php php php php php}

php	php/php*php*
php	php php*php Setsphp ifphp sessionphp shouldphp bephp preservedphp onphp generatephp(php)
php	php php*
php	php php*php php@paramphp php$keepSessionphp Shouldphp sessionphp bephp keptphp onphp generatephp(php)php?
php	php php*php php@returnphp Zendphp_Captchaphp_Word
php	php php*php/
php	publicphp functionphp setKeepSessionphp(php$keepSessionphp)
php	php{
php	php	php$thisphp-php>php_keepSessionphp php=php php$keepSessionphp;
php	php	returnphp php$thisphp;
php	php}

php php php php php/php*php*
php php php php php php*php Numbersphp shouldphp bephp includedphp inphp thephp patternphp?
php php php php php php*
php php php php php php*php php@returnphp bool
php php php php php php*php/
php php php php publicphp functionphp getUseNumbersphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_useNumbersphp;
php php php php php}

php	php/php*php*
php	php php*php Setphp ifphp numbersphp shouldphp bephp includedphp inphp thephp pattern
php	php php*
php php php php php php*php php@paramphp php$php_useNumbersphp numbersphp shouldphp bephp includedphp inphp thephp patternphp?
php php php php php php*php php@returnphp Zendphp_Captchaphp_Word
php php php php php php*php/
php php php php publicphp functionphp setUseNumbersphp(php$php_useNumbersphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_useNumbersphp php=php php$php_useNumbersphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}
php php php php 
php php php php php/php*php*
php php php php php php*php Getphp sessionphp object
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Sessionphp_Namespace
php php php php php php*php/
php php php php publicphp functionphp getSessionphp(php)
php php php php php{
php php php php php php php php ifphp php(php!issetphp(php$thisphp-php>php_sessionphp)php php|php|php php(nullphp php=php=php=php php$thisphp-php>php_sessionphp)php)php php{
php php php php php php php php php php php php php$idphp php=php php$thisphp-php>getIdphp(php)php;
php php php php php php php php php php php php ifphp php(php!classphp_existsphp(php$thisphp-php>php_sessionClassphp)php)php php{
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Loaderphp.phpphp'php;
php php php php php php php php php php php php php php php php Zendphp_Loaderphp:php:loadClassphp(php$thisphp-php>php_sessionClassphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$thisphp-php>php_sessionphp php=php newphp php$thisphp-php>php_sessionClassphp(php'Zendphp_Formphp_Captchaphp_php'php php.php php$idphp)php;
php php php php php php php php php php php php php$thisphp-php>php_sessionphp-php>setExpirationHopsphp(php1php,php nullphp,php truephp)php;
php php php php php php php php php php php php php$thisphp-php>php_sessionphp-php>setExpirationSecondsphp(php$thisphp-php>getTimeoutphp(php)php)php;
php php php php php php php php php}
php php php php php php php php returnphp php$thisphp-php>php_sessionphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp sessionphp namespacephp object
php php php php php php*
php php php php php php*php php@paramphp php Zendphp_Sessionphp_Namespacephp php$session
php php php php php php*php php@returnphp Zendphp_Captchaphp_Word
php php php php php php*php/
php php php php publicphp functionphp setSessionphp(Zendphp_Sessionphp_Namespacephp php$sessionphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_sessionphp php=php php$sessionphp;
php php php php php php php php ifphp(php$sessionphp)php php{
php php php php php php php php php php php php php$thisphp-php>php_keepSessionphp php=php truephp;
php php php php php php php php php}
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp captchaphp word
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getWordphp(php)
php php php php php{
php php php php php php php php ifphp php(emptyphp(php$thisphp-php>php_wordphp)php)php php{
php php php php php php php php php php php php php$sessionphp php php php php php=php php$thisphp-php>getSessionphp(php)php;
php php php php php php php php php php php php php$thisphp-php>php_wordphp php=php php$sessionphp-php>wordphp;
php php php php php php php php php}
php php php php php php php php returnphp php$thisphp-php>php_wordphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp captchaphp word
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$word
php php php php php php*php php@returnphp Zendphp_Captchaphp_Word
php php php php php php*php/
php php php php protectedphp functionphp php_setWordphp(php$wordphp)
php php php php php{
php php php php php php php php php$sessionphp php php php php php php php=php php$thisphp-php>getSessionphp(php)php;
php php php php php php php php php$sessionphp-php>wordphp php=php php$wordphp;
php php php php php php php php php$thisphp-php>php_wordphp php php php=php php$wordphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Generatephp newphp randomphp word
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php protectedphp functionphp php_generateWordphp(php)
php php php php php{
php php php php php php php php php$wordphp php php php php php php php=php php'php'php;
php php php php php php php php php$wordLenphp php php php php=php php$thisphp-php>getWordLenphp(php)php;
php php php php php php php php php$vowelsphp php php php php php=php php$thisphp-php>php_useNumbersphp php?php selfphp:php:php$VNphp php:php selfphp:php:php$Vphp;
php php php php php php php php php$consonantsphp php=php php$thisphp-php>php_useNumbersphp php?php selfphp:php:php$CNphp php:php selfphp:php:php$Cphp;

php php php php php php php php forphp php(php$iphp=php0php;php php$iphp <php php$wordLenphp;php php$iphp php=php php$iphp php+php php2php)php php{
php php php php php php php php php php php php php/php/php generatephp wordphp withphp mixphp ofphp vowelsphp andphp consonants
php php php php php php php php php php php php php$consonantphp php=php php$consonantsphp[arrayphp_randphp(php$consonantsphp)php]php;
php php php php php php php php php php php php php$vowelphp php php php php php=php php$vowelsphp[arrayphp_randphp(php$vowelsphp)php]php;
php php php php php php php php php php php php php$wordphp php php php php php.php=php php$consonantphp php.php php$vowelphp;
php php php php php php php php php}

php php php php php php php php ifphp php(strlenphp(php$wordphp)php php>php php$wordLenphp)php php{
php php php php php php php php php php php php php$wordphp php=php substrphp(php$wordphp,php php0php,php php$wordLenphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$wordphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Generatephp newphp sessionphp IDphp andphp newphp word
php php php php php php*
php php php php php php*php php@returnphp stringphp sessionphp ID
php php php php php php*php/
php php php php publicphp functionphp generatephp(php)
php php php php php{
php php php php php php php php ifphp(php!php$thisphp-php>php_keepSessionphp)php php{
php php php php php php php php php php php php php$thisphp-php>php_sessionphp php=php nullphp;
php php php php php php php php php}
php php php php php php php php php$idphp php=php php$thisphp-php>php_generateRandomIdphp(php)php;
php php php php php php php php php$thisphp-php>php_setIdphp(php$idphp)php;
php php php php php php php php php$wordphp php=php php$thisphp-php>php_generateWordphp(php)php;
php php php php php php php php php$thisphp-php>php_setWordphp(php$wordphp)php;
php php php php php php php php returnphp php$idphp;
php php php php php}

php php php php protectedphp functionphp php_generateRandomIdphp(php)
php php php php php{
php php php php php php php php returnphp mdphp5php(mtphp_randphp(php0php,php php1php0php0php0php)php php.php microtimephp(truephp)php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Validatephp thephp word
php php php php php php*
php php php php php php*php php@seephp php php php Zendphp_Validatephp_Interfacephp:php:isValidphp(php)
php php php php php php*php php@paramphp php mixedphp php$value
php php php php php php*php php@returnphp boolean
php php php php php php*php/
php php php php publicphp functionphp isValidphp(php$valuephp,php php$contextphp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(php!isphp_arrayphp(php$valuephp)php php&php&php php!isphp_arrayphp(php$contextphp)php)php php{
php php php php php php php php php php php php php$thisphp-php>php_errorphp(selfphp:php:MISSINGphp_VALUEphp)php;
php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php}
php php php php php php php php ifphp php(php!isphp_arrayphp(php$valuephp)php php&php&php isphp_arrayphp(php$contextphp)php)php php{
php php php php php php php php php php php php php$valuephp php=php php$contextphp;
php php php php php php php php php}

php php php php php php php php php$namephp php=php php$thisphp-php>getNamephp(php)php;

php php php php php php php php ifphp php(issetphp(php$valuephp[php$namephp]php)php)php php{
php php php php php php php php php php php php php$valuephp php=php php$valuephp[php$namephp]php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!issetphp(php$valuephp[php'inputphp'php]php)php)php php{
php php php php php php php php php php php php php$thisphp-php>php_errorphp(selfphp:php:MISSINGphp_VALUEphp)php;
php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php}
php php php php php php php php php$inputphp php=php strtolowerphp(php$valuephp[php'inputphp'php]php)php;
php php php php php php php php php$thisphp-php>php_setValuephp(php$inputphp)php;

php php php php php php php php ifphp php(php!issetphp(php$valuephp[php'idphp'php]php)php)php php{
php php php php php php php php php php php php php$thisphp-php>php_errorphp(selfphp:php:MISSINGphp_IDphp)php;
php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_idphp php=php php$valuephp[php'idphp'php]php;
php php php php php php php php ifphp php(php$inputphp php!php=php=php php$thisphp-php>getWordphp(php)php)php php{
php php php php php php php php php php php php php$thisphp-php>php_errorphp(selfphp:php:BADphp_CAPTCHAphp)php;
php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php}

php php php php php php php php returnphp truephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp captchaphp decorator
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getDecoratorphp(php)
php php php php php{
php php php php php php php php returnphp php"Captchaphp_Wordphp"php;
php php php php php}
php}
