<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_InfoCard
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php InfoCardphp.phpphp php2php0php0php9php6php php2php0php1php0php-php0php1php-php0php6php php0php2php:php0php5php:php0php9Zphp bkarwinphp php$
php php*php/

php/php*php*
php php*php Zendphp_InfoCardphp_Xmlphp_EncryptedData
php php*php/
requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/EncryptedDataphp.phpphp'php;

php/php*php*
php php*php Zendphp_InfoCardphp_Xmlphp_Assertion
php php*php/
requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Assertionphp.phpphp'php;

php/php*php*
php php*php Zendphp_InfoCardphp_Cipher
php php*php/
requirephp_oncephp php'Zendphp/InfoCardphp/Cipherphp.phpphp'php;

php/php*php*
php php*php Zendphp_InfoCardphp_Xmlphp_Security
php php*php/
requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp.phpphp'php;

php/php*php*
php php*php Zendphp_InfoCardphp_Adapterphp_Interface
php php*php/
requirephp_oncephp php'Zendphp/InfoCardphp/Adapterphp/Interfacephp.phpphp'php;

php/php*php*
php php*php Zendphp_InfoCardphp_Claims
php php*php/
requirephp_oncephp php'Zendphp/InfoCardphp/Claimsphp.phpphp'php;

php/php*php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_InfoCard
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_InfoCard
php{
php php php php php/php*php*
php php php php php php*php URIphp forphp XMLphp Digitalphp Signaturephp SHAphp1php Digests
php php php php php php*php/
php php php php constphp DIGESTphp_SHAphp1php php php php php php php php php=php php'httpphp:php/php/wwwphp.wphp3php.orgphp/php2php0php0php0php/php0php9php/xmldsigphp#shaphp1php'php;

php php php php php/php*php*
php php php php php php*php Anphp arrayphp ofphp certificatephp pairphp filesphp andphp optionalphp passwordsphp forphp themphp tophp search
php php php php php php*php whenphp tryingphp tophp determinephp whichphp certificatephp wasphp usedphp tophp encryptphp thephp transientphp key
php php php php php php*
php php php php php php*php php@varphp Array
php php php php php php*php/
php php php php protectedphp php$php_keyPairsphp;

php php php php php/php*php*
php php php php php php*php Thephp instancephp tophp usephp tophp decryptphp publicphp-keyphp encryptedphp data
php php php php php php*
php php php php php php*php php@varphp Zendphp_InfoCardphp_Cipherphp_Pkiphp_Interface
php php php php php php*php/
php php php php protectedphp php$php_pkiCipherObjphp;

php php php php php/php*php*
php php php php php php*php Thephp instancephp tophp usephp tophp decryptphp symmetricphp encryptedphp data
php php php php php php*
php php php php php php*php php@varphp Zendphp_InfoCardphp_Cipherphp_Symmetricphp_Interface
php php php php php php*php/
php php php php protectedphp php$php_symCipherObjphp;

php php php php php/php*php*
php php php php php php*php Thephp InfoCardphp Adapterphp tophp usephp forphp callbacksphp intophp thephp applicationphp usingphp thephp component
php php php php php php*php suchphp asphp whenphp storingphp assertionsphp,php etcphp.
php php php php php php*
php php php php php php*php php@varphp Zendphp_InfoCardphp_Adapterphp_Interface
php php php php php php*php/
php php php php protectedphp php$php_adapterphp;


php php php php php/php*php*
php php php php php php*php InfoCardphp Constructor
php php php php php php*
php php php php php php*php php@throwsphp Zendphp_InfoCardphp_Exception
php php php php php php*php/
php php php php publicphp functionphp php_php_constructphp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_keyPairsphp php=php arrayphp(php)php;

php php php php php php php php ifphp(php!extensionphp_loadedphp(php'mcryptphp'php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Usephp ofphp thephp Zendphp_InfoCardphp componentphp requiresphp thephp mcryptphp extensionphp tophp bephp enabledphp inphp PHPphp"php)php;
php php php php php php php php php}

php php php php php php php php ifphp(php!extensionphp_loadedphp(php'opensslphp'php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Usephp ofphp thephp Zendphp_InfoCardphp componentphp requiresphp thephp opensslphp extensionphp tophp bephp enabledphp inphp PHPphp"php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Setsphp thephp adapterphp uesdphp forphp callbacksphp intophp thephp applicationphp usingphp thephp componentphp,php used
php php php php php php*php whenphp doingphp thingsphp suchphp asphp storingphp php/php retrievingphp assertionsphp,php etcphp.
php php php php php php*
php php php php php php*php php@paramphp Zendphp_InfoCardphp_Adapterphp_Interfacephp php$aphp Thephp Adapterphp instance
php php php php php php*php php@returnphp Zendphp_InfoCardphp Thephp instnace
php php php php php php*php/
php php php php publicphp functionphp setAdapterphp(Zendphp_InfoCardphp_Adapterphp_Interfacephp php$aphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_adapterphp php=php php$aphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievesphp thephp adapterphp usedphp forphp callbacksphp intophp thephp applicationphp usingphp thephp componentphp.
php php php php php php*php Ifphp nophp adapterphp wasphp setphp thenphp anphp instancephp ofphp Zendphp_InfoCardphp_Adapterphp_Defaultphp isphp used
php php php php php php*
php php php php php php*php php@returnphp Zendphp_InfoCardphp_Adapterphp_Interfacephp Thephp Adapterphp instance
php php php php php php*php/
php php php php publicphp functionphp getAdapterphp(php)
php php php php php{
php php php php php php php php ifphp(php$thisphp-php>php_adapterphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Adapterphp/Defaultphp.phpphp'php;
php php php php php php php php php php php php php$thisphp-php>setAdapterphp(newphp Zendphp_InfoCardphp_Adapterphp_Defaultphp(php)php)php;
php php php php php php php php php}

php php php php php php php php returnphp php$thisphp-php>php_adapterphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getsphp thephp Publicphp Keyphp Cipherphp objectphp usedphp inphp thisphp instance
php php php php php php*
php php php php php php*php php@returnphp Zendphp_InfoCardphp_Cipherphp_Pkiphp_Interface
php php php php php php*php/
php php php php publicphp functionphp getPkiCipherObjectphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_pkiCipherObjphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setsphp thephp Publicphp Keyphp Cipherphp Objectphp usedphp inphp thisphp instance
php php php php php php*
php php php php php php*php php@paramphp Zendphp_InfoCardphp_Cipherphp_Pkiphp_Interfacephp php$cipherObj
php php php php php php*php php@returnphp Zendphp_InfoCard
php php php php php php*php/
php php php php publicphp functionphp setPkiCipherObjectphp(Zendphp_InfoCardphp_Cipherphp_Pkiphp_Interfacephp php$cipherObjphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_pkiCipherObjphp php=php php$cipherObjphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp thephp Symmetricphp Cipherphp Objectphp usedphp inphp thisphp instance
php php php php php php*
php php php php php php*php php@returnphp Zendphp_InfoCardphp_Cipherphp_Symmetricphp_Interface
php php php php php php*php/
php php php php publicphp functionphp getSymCipherObjectphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_symCipherObjphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setsphp thephp Symmetricphp Cipherphp Objectphp usedphp inphp thisphp instance
php php php php php php*
php php php php php php*php php@paramphp Zendphp_InfoCardphp_Cipherphp_Symmetricphp_Interfacephp php$cipherObj
php php php php php php*php php@returnphp Zendphp_InfoCard
php php php php php php*php/
php php php php publicphp functionphp setSymCipherObjectphp(php$cipherObjphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_symCipherObjphp php=php php$cipherObjphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Removephp aphp Certificatephp Pairphp byphp Keyphp IDphp fromphp thephp searchphp list
php php php php php php*
php php php php php php*php php@throwsphp Zendphp_InfoCardphp_Exception
php php php php php php*php php@paramphp stringphp php$keyphp_idphp Thephp Certificatephp Keyphp IDphp returnedphp fromphp addingphp thephp certificatephp pair
php php php php php php*php php@returnphp Zendphp_InfoCard
php php php php php php*php/
php php php php publicphp functionphp removeCertificatePairphp(php$keyphp_idphp)
php php php php php{

php php php php php php php php ifphp(php!keyphp_existsphp(php$keyphp_idphp,php php$thisphp-php>php_keyPairsphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Attemptedphp tophp removephp unknownphp keyphp idphp:php php$keyphp_idphp"php)php;
php php php php php php php php php}

php php php php php php php php unsetphp(php$thisphp-php>php_keyPairsphp[php$keyphp_idphp]php)php;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Addphp aphp Certificatephp Pairphp tophp thephp listphp ofphp certificatesphp searchedphp byphp thephp component
php php php php php php*
php php php php php php*php php@throwsphp Zendphp_InfoCardphp_Exception
php php php php php php*php php@paramphp stringphp php$privatephp_keyphp_filephp Thephp pathphp tophp thephp privatephp keyphp filephp forphp thephp pair
php php php php php php*php php@paramphp stringphp php$publicphp_keyphp_filephp Thephp pathphp tophp thephp certificatephp php/php publicphp keyphp forphp thephp pair
php php php php php php*php php@paramphp stringphp php$typephp php(optionalphp)php Thephp URIphp forphp thephp typephp ofphp keyphp pairphp thisphp isphp php(defaultphp RSAphp withphp OAEPphp paddingphp)
php php php php php php*php php@paramphp stringphp php$passwordphp php(optionalphp)php Thephp passwordphp forphp thephp privatephp keyphp filephp ifphp necessary
php php php php php php*php php@returnphp stringphp Aphp keyphp IDphp representingphp thisphp keyphp pairphp inphp thephp component
php php php php php php*php/
php php php php publicphp functionphp addCertificatePairphp(php$privatephp_keyphp_filephp,php php$publicphp_keyphp_filephp,php php$typephp php=php Zendphp_InfoCardphp_Cipherphp:php:ENCphp_RSAphp_OAEPphp_MGFphp1Pphp,php php$passwordphp php=php nullphp)
php php php php php{
php php php php php php php php ifphp(php!filephp_existsphp(php$privatephp_keyphp_filephp)php php|php|
php php php php php php php php php php php php!filephp_existsphp(php$publicphp_keyphp_filephp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Couldphp notphp locatephp thephp publicphp andphp privatephp certificatephp pairphp filesphp:php php$privatephp_keyphp_filephp,php php$publicphp_keyphp_filephp"php)php;
php php php php php php php php php}

php php php php php php php php ifphp(php!isphp_readablephp(php$privatephp_keyphp_filephp)php php|php|
php php php php php php php php php php php php!isphp_readablephp(php$publicphp_keyphp_filephp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Couldphp notphp readphp thephp publicphp andphp privatephp certificatephp pairphp filesphp php(checkphp permissionsphp)php:php php$privatephp_keyphp_filephp,php php$publicphp_keyphp_filephp"php)php;
php php php php php php php php php}

php php php php php php php php php$keyphp_idphp php=php mdphp5php(php$privatephp_keyphp_filephp.php$publicphp_keyphp_filephp)php;

php php php php php php php php ifphp(keyphp_existsphp(php$keyphp_idphp,php php$thisphp-php>php_keyPairsphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Attemptedphp tophp addphp previouslyphp existingphp certificatephp pairphp:php php$privatephp_keyphp_filephp,php php$publicphp_keyphp_filephp"php)php;
php php php php php php php php php}

php php php php php php php php switchphp(php$typephp)php php{
php php php php php php php php php php php php casephp Zendphp_InfoCardphp_Cipherphp:php:ENCphp_RSAphp:
php php php php php php php php php php php php casephp Zendphp_InfoCardphp_Cipherphp:php:ENCphp_RSAphp_OAEPphp_MGFphp1Pphp:
php php php php php php php php php php php php php php php php php$thisphp-php>php_keyPairsphp[php$keyphp_idphp]php php=php arrayphp(php'privatephp'php php=php>php php$privatephp_keyphp_filephp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php'publicphp'php php php php php php php=php>php php$publicphp_keyphp_filephp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php'typephp_uriphp'php php php php php=php>php php$typephp)php;

php php php php php php php php php php php php php php php php ifphp(php$passwordphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>php_keyPairsphp[php$keyphp_idphp]php[php'passwordphp'php]php php=php php$passwordphp;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>php_keyPairsphp[php$keyphp_idphp]php[php'passwordphp'php]php php=php nullphp;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php returnphp php$keyphp_idphp;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Invalidphp Certificatephp Pairphp Typephp specifiedphp:php php$typephp"php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnphp aphp Certificatephp Pairphp fromphp aphp keyphp ID
php php php php php php*
php php php php php php*php php@throwsphp Zendphp_InfoCardphp_Exception
php php php php php php*php php@paramphp stringphp php$keyphp_idphp Thephp Keyphp IDphp ofphp thephp certificatephp pairphp inphp thephp component
php php php php php php*php php@returnphp arrayphp Anphp arrayphp containingphp thephp pathphp tophp thephp privatephp/publicphp keyphp filesphp,
php php php php php php*php php php php php php php php php php php php php php php thephp typephp URIphp andphp thephp passwordphp ifphp provided
php php php php php php*php/
php php php php publicphp functionphp getCertificatePairphp(php$keyphp_idphp)
php php php php php{
php php php php php php php php ifphp(keyphp_existsphp(php$keyphp_idphp,php php$thisphp-php>php_keyPairsphp)php)php php{
php php php php php php php php php php php php returnphp php$thisphp-php>php_keyPairsphp[php$keyphp_idphp]php;
php php php php php php php php php}

php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Invalidphp Certificatephp Pairphp IDphp providedphp:php php$keyphp_idphp"php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp thephp digestphp ofphp aphp givenphp publicphp keyphp php/php certificatephp usingphp thephp providedphp digest
php php php php php php*php method
php php php php php php*
php php php php php php*php php@throwsphp Zendphp_InfoCardphp_Exception
php php php php php php*php php@paramphp stringphp php$keyphp_idphp Thephp certificatephp keyphp idphp inphp thephp component
php php php php php php*php php@paramphp stringphp php$digestMethodphp Thephp URIphp ofphp thephp digestphp methodphp tophp usephp php(defaultphp SHAphp1php)
php php php php php php*php php@returnphp stringphp Thephp digestphp valuephp inphp binaryphp format
php php php php php php*php/
php php php php protectedphp functionphp php_getPublicKeyDigestphp(php$keyphp_idphp,php php$digestMethodphp php=php selfphp:php:DIGESTphp_SHAphp1php)
php php php php php{
php php php php php php php php php$certificatePairphp php=php php$thisphp-php>getCertificatePairphp(php$keyphp_idphp)php;

php php php php php php php php php$tempphp php=php filephp(php$certificatePairphp[php'publicphp'php]php)php;
php php php php php php php php unsetphp(php$tempphp[countphp(php$tempphp)php-php1php]php)php;
php php php php php php php php unsetphp(php$tempphp[php0php]php)php;
php php php php php php php php php$certificateDataphp php=php basephp6php4php_decodephp(implodephp(php"php\nphp"php,php php$tempphp)php)php;

php php php php php php php php switchphp(php$digestMethodphp)php php{
php php php php php php php php php php php php casephp selfphp:php:DIGESTphp_SHAphp1php:
php php php php php php php php php php php php php php php php php$digestphp_retvalphp php=php shaphp1php(php$certificateDataphp,php truephp)php;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Invalidphp Digestphp Typephp Providedphp:php php$digestMethodphp"php)php;
php php php php php php php php php}

php php php php php php php php returnphp php$digestphp_retvalphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Findphp aphp certificatephp pairphp basedphp onphp aphp digestphp ofphp itsphp publicphp keyphp php/php certificatephp file
php php php php php php*
php php php php php php*php php@paramphp stringphp php$digestphp Thephp digestphp valuephp ofphp thephp publicphp keyphp wantedphp inphp binaryphp form
php php php php php php*php php@paramphp stringphp php$digestMethodphp Thephp URIphp ofphp thephp digestphp methodphp usedphp tophp calculatephp thephp digest
php php php php php php*php php@returnphp mixedphp Thephp Keyphp IDphp ofphp thephp matchingphp certificatephp pairphp orphp falsephp ifphp notphp found
php php php php php php*php/
php php php php protectedphp functionphp php_findCertifiatePairByDigestphp(php$digestphp,php php$digestMethodphp php=php selfphp:php:DIGESTphp_SHAphp1php)
php php php php php{

php php php php php php php php foreachphp(php$thisphp-php>php_keyPairsphp asphp php$keyphp_idphp php=php>php php$certificatephp_dataphp)php php{

php php php php php php php php php php php php php$certphp_digestphp php=php php$thisphp-php>php_getPublicKeyDigestphp(php$keyphp_idphp,php php$digestMethodphp)php;

php php php php php php php php php php php php ifphp(php$certphp_digestphp php=php=php php$digestphp)php php{
php php php php php php php php php php php php php php php php returnphp php$keyphp_idphp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp falsephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Extractsphp thephp Signedphp Tokenphp fromphp anphp EncryptedDataphp block
php php php php php php*
php php php php php php*php php@throwsphp Zendphp_InfoCardphp_Exception
php php php php php php*php php@paramphp stringphp php$strXmlTokenphp Thephp EncryptedDataphp XMLphp block
php php php php php php*php php@returnphp stringphp Thephp XMLphp ofphp thephp Signedphp Tokenphp insidephp ofphp thephp EncryptedDataphp block
php php php php php php*php/
php php php php protectedphp functionphp php_extractSignedTokenphp(php$strXmlTokenphp)
php php php php php{
php php php php php php php php php$encryptedDataphp php=php Zendphp_InfoCardphp_Xmlphp_EncryptedDataphp:php:getInstancephp(php$strXmlTokenphp)php;

php php php php php php php php php/php/php Determinephp thephp Encryptionphp Methodphp usedphp tophp encryptphp thephp token

php php php php php php php php switchphp(php$encryptedDataphp-php>getEncryptionMethodphp(php)php)php php{
php php php php php php php php php php php php casephp Zendphp_InfoCardphp_Cipherphp:php:ENCphp_AESphp1php2php8CBCphp:
php php php php php php php php php php php php casephp Zendphp_InfoCardphp_Cipherphp:php:ENCphp_AESphp2php5php6CBCphp:
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Unknownphp Encryptionphp Methodphp usedphp inphp thephp securephp tokenphp"php)php;
php php php php php php php php php}

php php php php php php php php php/php/php Figurephp outphp thephp Keyphp wephp arephp usingphp tophp decryptphp thephp token

php php php php php php php php php$keyinfophp php=php php$encryptedDataphp-php>getKeyInfophp(php)php;

php php php php php php php php ifphp(php!php(php$keyinfophp instanceofphp Zendphp_InfoCardphp_Xmlphp_KeyInfophp_XmlDSigphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Expectedphp aphp XMLphp digitalphp signaturephp KeyInfophp,php butphp wasphp notphp foundphp"php)php;
php php php php php php php php php}


php php php php php php php php php$encryptedKeyphp php=php php$keyinfophp-php>getEncryptedKeyphp(php)php;

php php php php php php php php switchphp(php$encryptedKeyphp-php>getEncryptionMethodphp(php)php)php php{
php php php php php php php php php php php php casephp Zendphp_InfoCardphp_Cipherphp:php:ENCphp_RSAphp:
php php php php php php php php php php php php casephp Zendphp_InfoCardphp_Cipherphp:php:ENCphp_RSAphp_OAEPphp_MGFphp1Pphp:
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Unknownphp Keyphp Encryptionphp Methodphp usedphp inphp securephp tokenphp"php)php;
php php php php php php php php php}

php php php php php php php php php$securityTokenRefphp php=php php$encryptedKeyphp-php>getKeyInfophp(php)php-php>getSecurityTokenReferencephp(php)php;

php php php php php php php php php$keyphp_idphp php=php php$thisphp-php>php_findCertifiatePairByDigestphp(php$securityTokenRefphp-php>getKeyReferencephp(php)php)php;

php php php php php php php php ifphp(php!php$keyphp_idphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Unablephp tophp findphp keyphp pairphp usedphp tophp encryptphp symmetricphp InfoCardphp Keyphp"php)php;
php php php php php php php php php}

php php php php php php php php php$certificatephp_pairphp php=php php$thisphp-php>getCertificatePairphp(php$keyphp_idphp)php;

php php php php php php php php php/php/php Santityphp Check

php php php php php php php php ifphp(php$certificatephp_pairphp[php'typephp_uriphp'php]php php!php=php php$encryptedKeyphp-php>getEncryptionMethodphp(php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Certificatephp Pairphp whichphp matchesphp digestphp isphp notphp ofphp samephp algorithmphp typephp asphp documentphp,php checkphp addCertificatephp(php)php"php)php;
php php php php php php php php php}

php php php php php php php php php$PKcipherphp php=php Zendphp_InfoCardphp_Cipherphp:php:getInstanceByURIphp(php$encryptedKeyphp-php>getEncryptionMethodphp(php)php)php;

php php php php php php php php php$basephp6php4DecodeSupportsStrictParamphp php=php versionphp_comparephp(PHPphp_VERSIONphp,php php'php5php.php2php.php0php'php,php php'php>php=php'php)php;

php php php php php php php php ifphp php(php$basephp6php4DecodeSupportsStrictParamphp)php php{
php php php php php php php php php php php php php$keyCipherValueBasephp6php4Decodedphp php=php basephp6php4php_decodephp(php$encryptedKeyphp-php>getCipherValuephp(php)php,php truephp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$keyCipherValueBasephp6php4Decodedphp php=php basephp6php4php_decodephp(php$encryptedKeyphp-php>getCipherValuephp(php)php)php;
php php php php php php php php php}

php php php php php php php php php$symmetricKeyphp php=php php$PKcipherphp-php>decryptphp(
php php php php php php php php php php php php php$keyCipherValueBasephp6php4Decodedphp,
php php php php php php php php php php php php filephp_getphp_contentsphp(php$certificatephp_pairphp[php'privatephp'php]php)php,
php php php php php php php php php php php php php$certificatephp_pairphp[php'passwordphp'php]
php php php php php php php php php php php php php)php;

php php php php php php php php php$symCipherphp php=php Zendphp_InfoCardphp_Cipherphp:php:getInstanceByURIphp(php$encryptedDataphp-php>getEncryptionMethodphp(php)php)php;

php php php php php php php php ifphp php(php$basephp6php4DecodeSupportsStrictParamphp)php php{
php php php php php php php php php php php php php$dataCipherValueBasephp6php4Decodedphp php=php basephp6php4php_decodephp(php$encryptedDataphp-php>getCipherValuephp(php)php,php truephp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$dataCipherValueBasephp6php4Decodedphp php=php basephp6php4php_decodephp(php$encryptedDataphp-php>getCipherValuephp(php)php)php;
php php php php php php php php php}

php php php php php php php php php$signedTokenphp php=php php$symCipherphp-php>decryptphp(php$dataCipherValueBasephp6php4Decodedphp,php php$symmetricKeyphp)php;

php php php php php php php php returnphp php$signedTokenphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Processphp anphp inputphp Infomationphp Cardphp EncryptedDataphp blockphp sentphp fromphp thephp clientphp,
php php php php php php*php validatephp itphp,php andphp returnphp thephp claimsphp containedphp withinphp itphp onphp successphp orphp anphp errorphp messagephp onphp error
php php php php php php*
php php php php php php*php php@paramphp stringphp php$strXmlTokenphp Thephp XMLphp tokenphp sentphp tophp thephp serverphp fromphp thephp client
php php php php php php*php php@returnphp Zendphp_Infocardphp_Claimsphp Thephp Claimsphp objectphp containingphp thephp claimsphp,php orphp anyphp errorsphp whichphp occurred
php php php php php php*php/
php php php php publicphp functionphp processphp(php$strXmlTokenphp)
php php php php php{

php php php php php php php php php$retvalphp php=php newphp Zendphp_InfoCardphp_Claimsphp(php)php;

php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Exceptionphp.phpphp'php;
php php php php php php php php tryphp php{
php php php php php php php php php php php php php$signedAssertionsXmlphp php=php php$thisphp-php>php_extractSignedTokenphp(php$strXmlTokenphp)php;
php php php php php php php php php}php catchphp(Zendphp_InfoCardphp_Exceptionphp php$ephp)php php{
php php php php php php php php php php php php php$retvalphp-php>setErrorphp(php'Failedphp tophp extractphp assertionphp documentphp'php)php;
php php php php php php php php php php php php php$retvalphp-php>setCodephp(Zendphp_InfoCardphp_Claimsphp:php:RESULTphp_PROCESSINGphp_FAILUREphp)php;
php php php php php php php php php php php php returnphp php$retvalphp;
php php php php php php php php php}

php php php php php php php php tryphp php{
php php php php php php php php php php php php php$assertionsphp php=php Zendphp_InfoCardphp_Xmlphp_Assertionphp:php:getInstancephp(php$signedAssertionsXmlphp)php;
php php php php php php php php php}php catchphp(Zendphp_InfoCardphp_Exceptionphp php$ephp)php php{
php php php php php php php php php php php php php$retvalphp-php>setErrorphp(php'Failurephp processingphp assertionphp documentphp'php)php;
php php php php php php php php php php php php php$retvalphp-php>setCodephp(Zendphp_InfoCardphp_Claimsphp:php:RESULTphp_PROCESSINGphp_FAILUREphp)php;
php php php php php php php php php php php php returnphp php$retvalphp;
php php php php php php php php php}

php php php php php php php php ifphp(php!php(php$assertionsphp instanceofphp Zendphp_InfoCardphp_Xmlphp_Assertionphp_Interfacephp)php)php php{
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Exceptionphp(php"Invalidphp Assertionphp Objectphp returnedphp"php)php;
php php php php php php php php php}

php php php php php php php php ifphp(php!php(php$referencephp_idphp php=php Zendphp_InfoCardphp_Xmlphp_Securityphp:php:validateXMLSignaturephp(php$assertionsphp-php>asXMLphp(php)php)php)php)php php{
php php php php php php php php php php php php php$retvalphp-php>setErrorphp(php"Failurephp Validatingphp thephp Signaturephp ofphp thephp assertionphp documentphp"php)php;
php php php php php php php php php php php php php$retvalphp-php>setCodephp(Zendphp_InfoCardphp_Claimsphp:php:RESULTphp_VALIDATIONphp_FAILUREphp)php;
php php php php php php php php php php php php returnphp php$retvalphp;
php php php php php php php php php}

php php php php php php php php php/php/php Thephp referencephp idphp shouldphp bephp locallyphp scopedphp asphp farphp asphp Iphp know
php php php php php php php php ifphp(php$referencephp_idphp[php0php]php php=php=php php'php#php'php)php php{
php php php php php php php php php php php php php$referencephp_idphp php=php substrphp(php$referencephp_idphp,php php1php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$retvalphp-php>setErrorphp(php"Referencephp ofphp documentphp signaturephp doesphp notphp referencephp thephp localphp documentphp"php)php;
php php php php php php php php php php php php php$retvalphp-php>setCodephp(Zendphp_InfoCardphp_Claimsphp:php:RESULTphp_VALIDATIONphp_FAILUREphp)php;
php php php php php php php php php php php php returnphp php$retvalphp;
php php php php php php php php php}

php php php php php php php php php/php/php Makephp surephp thephp signaturephp isphp inphp referencephp tophp thephp samephp documentphp asphp thephp assertions
php php php php php php php php ifphp(php$referencephp_idphp php!php=php php$assertionsphp-php>getAssertionIDphp(php)php)php php{
php php php php php php php php php php php php php$retvalphp-php>setErrorphp(php"Referencephp ofphp documentphp signaturephp doesphp notphp referencephp thephp localphp documentphp"php)php;
php php php php php php php php php php php php php$retvalphp-php>setCodephp(Zendphp_InfoCardphp_Claimsphp:php:RESULTphp_VALIDATIONphp_FAILUREphp)php;
php php php php php php php php php}

php php php php php php php php php/php/php Validatephp wephp havenphp'tphp seenphp thisphp beforephp andphp thephp conditionsphp arephp acceptable
php php php php php php php php php$conditionsphp php=php php$thisphp-php>getAdapterphp(php)php-php>retrieveAssertionphp(php$assertionsphp-php>getAssertionURIphp(php)php,php php$assertionsphp-php>getAssertionIDphp(php)php)php;

php php php php php php php php ifphp(php$conditionsphp php=php=php=php falsephp)php php{
php php php php php php php php php php php php php$conditionsphp php=php php$assertionsphp-php>getConditionsphp(php)php;
php php php php php php php php php}


php php php php php php php php ifphp(isphp_arrayphp(php$conditionphp_errorphp php=php php$assertionsphp-php>validateConditionsphp(php$conditionsphp)php)php)php php{
php php php php php php php php php php php php php$retvalphp-php>setErrorphp(php"Conditionsphp ofphp assertionphp documentphp arephp notphp metphp:php php{php$conditionphp_errorphp[php1php]php}php php(php{php$conditionphp_errorphp[php0php]php}php)php"php)php;
php php php php php php php php php php php php php$retvalphp-php>setCodephp(Zendphp_InfoCardphp_Claimsphp:php:RESULTphp_VALIDATIONphp_FAILUREphp)php;
php php php php php php php php php}

php php php php php php php php php$attributesphp php=php php$assertionsphp-php>getAttributesphp(php)php;

php php php php php php php php php$retvalphp-php>setClaimsphp(php$attributesphp)php;

php php php php php php php php ifphp(php$retvalphp-php>getCodephp(php)php php=php=php php0php)php php{
php php php php php php php php php php php php php$retvalphp-php>setCodephp(Zendphp_InfoCardphp_Claimsphp:php:RESULTphp_SUCCESSphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$retvalphp;
php php php php php}
php}
