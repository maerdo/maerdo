<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Soap
php php*php php@subpackagephp Server
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/

php/php*php*
php php*php php@seephp Zendphp_Serverphp_Interface
php php*php/
requirephp_oncephp php'Zendphp/Serverphp/Interfacephp.phpphp'php;

php/php*php*
php php*php Zendphp_Soapphp_Server
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Soap
php php*php php@subpackagephp Server
php php*php php@usesphp php php php php php php Zendphp_Serverphp_Interface
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Serverphp.phpphp php2php2php2php2php3php php2php0php1php0php-php0php5php-php2php1php php0php8php:php0php6php:php4php7Zphp janphp php$
php php*php/
classphp Zendphp_Soapphp_Serverphp implementsphp Zendphp_Serverphp_Interface
php{
php php php php php/php*php*
php php php php php php*php Actorphp URI
php php php php php php*php php@varphp stringphp URI
php php php php php php*php/
php php php php protectedphp php$php_actorphp;

php php php php php/php*php*
php php php php php php*php Classphp registeredphp withphp thisphp server
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_classphp;

php php php php php/php*php*
php php php php php php*php Argumentsphp tophp passphp tophp php{php@linkphp php$php_classphp}php constructor
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_classArgsphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Objectphp registeredphp withphp thisphp server
php php php php php php*php/
php php php php protectedphp php$php_objectphp;

php php php php php/php*php*
php php php php php php*php Arrayphp ofphp SOAPphp typephp php=php>php PHPphp classphp pairingsphp forphp handlingphp returnphp/incomingphp values
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_classmapphp;

php php php php php/php*php*
php php php php php php*php Encoding
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_encodingphp;

php php php php php/php*php*
php php php php php php*php SOAPphp Serverphp Features
php php php php php php*
php php php php php php*php php@varphp int
php php php php php php*php/
php php php php protectedphp php$php_featuresphp;

php php php php php/php*php*
php php php php php php*php WSDLphp Cachingphp Optionsphp ofphp SOAPphp Server
php php php php php php*
php php php php php php*php php@varphp mixed
php php php php php php*php/
php php php php protectedphp php$php_wsdlCachephp;


php php php php php/php*php*
php php php php php php*php Registeredphp faultphp exceptions
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_faultExceptionsphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Functionsphp registeredphp withphp thisphp serverphp;php mayphp bephp eitherphp anphp arrayphp orphp thephp SOAPphp_FUNCTIONSphp_ALL
php php php php php php*php constant
php php php php php php*php php@varphp arrayphp|int
php php php php php php*php/
php php php php protectedphp php$php_functionsphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Persistencephp modephp;php shouldphp bephp onephp ofphp thephp SOAPphp persistencephp constants
php php php php php php*php php@varphp int
php php php php php php*php/
php php php php protectedphp php$php_persistencephp;

php php php php php/php*php*
php php php php php php*php Requestphp XML
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_requestphp;

php php php php php/php*php*
php php php php php php*php Responsephp XML
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_responsephp;

php php php php php/php*php*
php php php php php php*php Flagphp:php whetherphp orphp notphp php{php@linkphp handlephp(php)php}php shouldphp returnphp aphp responsephp instead
php php php php php php*php ofphp automaticallyphp emittingphp itphp.
php php php php php php*php php@varphp boolean
php php php php php php*php/
php php php php protectedphp php$php_returnResponsephp php=php falsephp;

php php php php php/php*php*
php php php php php php*php SOAPphp versionphp tophp usephp;php SOAPphp_php1php_php2php byphp defaultphp,php tophp allowphp processingphp ofphp headers
php php php php php php*php php@varphp int
php php php php php php*php/
php php php php protectedphp php$php_soapVersionphp php=php SOAPphp_php1php_php2php;

php php php php php/php*php*
php php php php php php*php URIphp orphp pathphp tophp WSDL
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_wsdlphp;

php php php php php/php*php*
php php php php php php*php URIphp namespacephp forphp SOAPphp server
php php php php php php*php php@varphp stringphp URI
php php php php php php*php/
php php php php protectedphp php$php_uriphp;

php php php php php/php*php*
php php php php php php*php Constructor
php php php php php php*
php php php php php php*php Setsphp displayphp_errorsphp INIphp settingphp tophp offphp php(preventphp clientphp errorsphp duephp tophp bad
php php php php php php*php XMLphp inphp responsephp)php.php Registersphp php{php@linkphp handlePhpErrorsphp(php)php}php asphp errorphp handler
php php php php php php*php forphp Ephp_USERphp_ERRORphp.
php php php php php php*
php php php php php php*php Ifphp php$wsdlphp isphp providedphp,php itphp isphp passedphp onphp tophp php{php@linkphp setWsdlphp(php)php}php;php ifphp any
php php php php php php*php optionsphp arephp specifiedphp,php theyphp arephp passedphp onphp tophp php{php@linkphp setOptionsphp(php)php}php.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$wsdl
php php php php php php*php php@paramphp arrayphp php$options
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php publicphp functionphp php_php_constructphp(php$wsdlphp php=php nullphp,php arrayphp php$optionsphp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(php!extensionphp_loadedphp(php'soapphp'php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'SOAPphp extensionphp isphp notphp loadedphp.php'php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(nullphp php!php=php=php php$wsdlphp)php php{
php php php php php php php php php php php php php$thisphp-php>setWsdlphp(php$wsdlphp)php;
php php php php php php php php php}

php php php php php php php php ifphp php(nullphp php!php=php=php php$optionsphp)php php{
php php php php php php php php php php php php php$thisphp-php>setOptionsphp(php$optionsphp)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp Options
php php php php php php*
php php php php php php*php Allowsphp settingphp optionsphp asphp anphp associativephp arrayphp ofphp optionphp php=php>php valuephp pairsphp.
php php php php php php*
php php php php php php*php php@paramphp php arrayphp|Zendphp_Configphp php$options
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php/
php php php php publicphp functionphp setOptionsphp(php$optionsphp)
php php php php php{
php php php php php php php php ifphp(php$optionsphp instanceofphp Zendphp_Configphp)php php{
php php php php php php php php php php php php php$optionsphp php=php php$optionsphp-php>toArrayphp(php)php;
php php php php php php php php php}

php php php php php php php php foreachphp php(php$optionsphp asphp php$keyphp php=php>php php$valuephp)php php{
php php php php php php php php php php php php switchphp php(php$keyphp)php php{
php php php php php php php php php php php php php php php php casephp php'actorphp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setActorphp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php casephp php'classmapphp'php:
php php php php php php php php php php php php php php php php casephp php'classMapphp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setClassmapphp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php casephp php'encodingphp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setEncodingphp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php casephp php'soapVersionphp'php:
php php php php php php php php php php php php php php php php casephp php'soapphp_versionphp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setSoapVersionphp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php casephp php'uriphp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setUriphp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php casephp php'wsdlphp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setWsdlphp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php casephp php'featuesphp'php:
php php php php php php php php php php php php php php php php php php php php triggerphp_errorphp(php_php_METHODphp_php_php php.php php'php:php thephp optionphp php"featuesphp"php isphp deprecatedphp asphp ofphp php1php.php1php0php.xphp andphp willphp bephp removedphp withphp php2php.php0php.php0php;php usephp php"featuresphp"php insteadphp'php,php Ephp_USERphp_NOTICEphp)php;
php php php php php php php php php php php php php php php php casephp php'featuresphp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setSoapFeaturesphp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php casephp php'cachephp_wsdlphp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setWsdlCachephp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnphp arrayphp ofphp optionsphp suitablephp forphp usingphp withphp SoapServerphp constructor
php php php php php php*
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp getOptionsphp(php)
php php php php php{
php php php php php php php php php$optionsphp php=php arrayphp(php)php;
php php php php php php php php ifphp php(nullphp php!php=php=php php$thisphp-php>php_actorphp)php php{
php php php php php php php php php php php php php$optionsphp[php'actorphp'php]php php=php php$thisphp-php>php_actorphp;
php php php php php php php php php}

php php php php php php php php ifphp php(nullphp php!php=php=php php$thisphp-php>php_classmapphp)php php{
php php php php php php php php php php php php php$optionsphp[php'classmapphp'php]php php=php php$thisphp-php>php_classmapphp;
php php php php php php php php php}

php php php php php php php php ifphp php(nullphp php!php=php=php php$thisphp-php>php_encodingphp)php php{
php php php php php php php php php php php php php$optionsphp[php'encodingphp'php]php php=php php$thisphp-php>php_encodingphp;
php php php php php php php php php}

php php php php php php php php ifphp php(nullphp php!php=php=php php$thisphp-php>php_soapVersionphp)php php{
php php php php php php php php php php php php php$optionsphp[php'soapphp_versionphp'php]php php=php php$thisphp-php>php_soapVersionphp;
php php php php php php php php php}

php php php php php php php php ifphp php(nullphp php!php=php=php php$thisphp-php>php_uriphp)php php{
php php php php php php php php php php php php php$optionsphp[php'uriphp'php]php php=php php$thisphp-php>php_uriphp;
php php php php php php php php php}

php php php php php php php php ifphp(nullphp php!php=php=php php$thisphp-php>php_featuresphp)php php{
php php php php php php php php php php php php php$optionsphp[php'featuresphp'php]php php=php php$thisphp-php>php_featuresphp;
php php php php php php php php php}

php php php php php php php php ifphp(nullphp php!php=php=php php$thisphp-php>php_wsdlCachephp)php php{
php php php php php php php php php php php php php$optionsphp[php'cachephp_wsdlphp'php]php php=php php$thisphp-php>php_wsdlCachephp;
php php php php php php php php php}

php php php php php php php php returnphp php$optionsphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp encoding
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$encoding
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php php@throwsphp Zendphp_Soapphp_Serverphp_Exceptionphp withphp invalidphp encodingphp argument
php php php php php php*php/
php php php php publicphp functionphp setEncodingphp(php$encodingphp)
php php php php php{
php php php php php php php php ifphp php(php!isphp_stringphp(php$encodingphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Invalidphp encodingphp specifiedphp'php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_encodingphp php=php php$encodingphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp encoding
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getEncodingphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_encodingphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp SOAPphp version
php php php php php php*
php php php php php php*php php@paramphp php intphp php$versionphp Onephp ofphp thephp SOAPphp_php1php_php1php orphp SOAPphp_php1php_php2php constants
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php php@throwsphp Zendphp_Soapphp_Serverphp_Exceptionphp withphp invalidphp soapphp versionphp argument
php php php php php php*php/
php php php php publicphp functionphp setSoapVersionphp(php$versionphp)
php php php php php{
php php php php php php php php ifphp php(php!inphp_arrayphp(php$versionphp,php arrayphp(SOAPphp_php1php_php1php,php SOAPphp_php1php_php2php)php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Invalidphp soapphp versionphp specifiedphp'php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_soapVersionphp php=php php$versionphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp SOAPphp version
php php php php php php*
php php php php php php*php php@returnphp int
php php php php php php*php/
php php php php publicphp functionphp getSoapVersionphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_soapVersionphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Checkphp forphp validphp URN
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$urn
php php php php php php*php php@returnphp true
php php php php php php*php php@throwsphp Zendphp_Soapphp_Serverphp_Exceptionphp onphp invalidphp URN
php php php php php php*php/
php php php php publicphp functionphp validateUrnphp(php$urnphp)
php php php php php{
php php php php php php php php php$schemephp php=php parsephp_urlphp(php$urnphp,php PHPphp_URLphp_SCHEMEphp)php;
php php php php php php php php ifphp php(php$schemephp php=php=php=php falsephp php|php|php php$schemephp php=php=php=php nullphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Invalidphp URNphp'php)php;
php php php php php php php php php}

php php php php php php php php returnphp truephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp actor
php php php php php php*
php php php php php php*php Actorphp isphp thephp actorphp URIphp forphp thephp serverphp.
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$actor
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php/
php php php php publicphp functionphp setActorphp(php$actorphp)
php php php php php{
php php php php php php php php php$thisphp-php>validateUrnphp(php$actorphp)php;
php php php php php php php php php$thisphp-php>php_actorphp php=php php$actorphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp actor
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getActorphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_actorphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp URI
php php php php php php*
php php php php php php*php URIphp inphp SoapServerphp isphp actuallyphp thephp targetphp namespacephp,php notphp aphp URIphp;php php$uriphp mustphp beginphp withphp php'urnphp:php'php.
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$uri
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php php@throwsphp Zendphp_Soapphp_Serverphp_Exceptionphp withphp invalidphp uriphp argument
php php php php php php*php/
php php php php publicphp functionphp setUriphp(php$uriphp)
php php php php php{
php php php php php php php php php$thisphp-php>validateUrnphp(php$uriphp)php;
php php php php php php php php php$thisphp-php>php_uriphp php=php php$uriphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp URI
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getUriphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_uriphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp classmap
php php php php php php*
php php php php php php*php php@paramphp php arrayphp php$classmap
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php php@throwsphp Zendphp_Soapphp_Serverphp_Exceptionphp forphp anyphp invalidphp classphp inphp thephp classphp map
php php php php php php*php/
php php php php publicphp functionphp setClassmapphp(php$classmapphp)
php php php php php{
php php php php php php php php ifphp php(php!isphp_arrayphp(php$classmapphp)php)php php{
php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php*php php@seephp Zendphp_Soapphp_Serverphp_Exception
php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Classmapphp mustphp bephp anphp arrayphp'php)php;
php php php php php php php php php}
php php php php php php php php foreachphp php(php$classmapphp asphp php$typephp php=php>php php$classphp)php php{
php php php php php php php php php php php php ifphp php(php!classphp_existsphp(php$classphp)php)php php{
php php php php php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php php php php php*php php@seephp Zendphp_Soapphp_Serverphp_Exception
php php php php php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Invalidphp classphp inphp classphp mapphp'php)php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_classmapphp php=php php$classmapphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp classmap
php php php php php php*
php php php php php php*php php@returnphp mixed
php php php php php php*php/
php php php php publicphp functionphp getClassmapphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_classmapphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp wsdl
php php php php php php*
php php php php php php*php php@paramphp stringphp php$wsdlphp php URIphp orphp pathphp tophp aphp WSDL
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php/
php php php php publicphp functionphp setWsdlphp(php$wsdlphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_wsdlphp php=php php$wsdlphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp wsdl
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getWsdlphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_wsdlphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp thephp SOAPphp Featurephp optionsphp.
php php php php php php*
php php php php php php*php php@paramphp php stringphp|intphp php$feature
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php/
php php php php publicphp functionphp setSoapFeaturesphp(php$featurephp)
php php php php php{
php php php php php php php php php$thisphp-php>php_featuresphp php=php php$featurephp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnphp currentphp SOAPphp Featuresphp options
php php php php php php*
php php php php php php*php php@returnphp int
php php php php php php*php/
php php php php publicphp functionphp getSoapFeaturesphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_featuresphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp thephp SOAPphp Wsdlphp Cachingphp Options
php php php php php php*
php php php php php php*php php@paramphp stringphp|intphp|booleanphp php$caching
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php/
php php php php publicphp functionphp setWsdlCachephp(php$optionsphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_wsdlCachephp php=php php$optionsphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp currentphp SOAPphp Wsdlphp Cachingphp option
php php php php php php*php/
php php php php publicphp functionphp getWsdlCachephp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_wsdlCachephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Attachphp aphp functionphp asphp aphp serverphp method
php php php php php php*
php php php php php php*php php@paramphp arrayphp|stringphp php$functionphp Functionphp namephp,php arrayphp ofphp functionphp namesphp tophp attachphp,
php php php php php php*php orphp SOAPphp_FUNCTIONSphp_ALLphp tophp attachphp allphp functions
php php php php php php*php php@paramphp php stringphp php$namespacephp Ignored
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php php@throwsphp Zendphp_Soapphp_Serverphp_Exceptionphp onphp invalidphp functions
php php php php php php*php/
php php php php publicphp functionphp addFunctionphp(php$functionphp,php php$namespacephp php=php php'php'php)
php php php php php{
php php php php php php php php php/php/php Bailphp earlyphp ifphp setphp tophp SOAPphp_FUNCTIONSphp_ALL
php php php php php php php php ifphp php(php$thisphp-php>php_functionsphp php=php=php SOAPphp_FUNCTIONSphp_ALLphp)php php{
php php php php php php php php php php php php returnphp php$thisphp;
php php php php php php php php php}

php php php php php php php php ifphp php(isphp_arrayphp(php$functionphp)php)php php{
php php php php php php php php php php php php foreachphp php(php$functionphp asphp php$funcphp)php php{
php php php php php php php php php php php php php php php php ifphp php(isphp_stringphp(php$funcphp)php php&php&php functionphp_existsphp(php$funcphp)php)php php{
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>php_functionsphp[php]php php=php php$funcphp;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Onephp orphp morephp invalidphp functionsphp specifiedphp inphp arrayphp'php)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$thisphp-php>php_functionsphp php=php arrayphp_mergephp(php$thisphp-php>php_functionsphp,php php$functionphp)php;
php php php php php php php php php}php elseifphp php(isphp_stringphp(php$functionphp)php php&php&php functionphp_existsphp(php$functionphp)php)php php{
php php php php php php php php php php php php php$thisphp-php>php_functionsphp[php]php php=php php$functionphp;
php php php php php php php php php}php elseifphp php(php$functionphp php=php=php SOAPphp_FUNCTIONSphp_ALLphp)php php{
php php php php php php php php php php php php php$thisphp-php>php_functionsphp php=php SOAPphp_FUNCTIONSphp_ALLphp;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Invalidphp functionphp specifiedphp'php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(isphp_arrayphp(php$thisphp-php>php_functionsphp)php)php php{
php php php php php php php php php php php php php$thisphp-php>php_functionsphp php=php arrayphp_uniquephp(php$thisphp-php>php_functionsphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Attachphp aphp classphp tophp aphp server
php php php php php php*
php php php php php php*php Acceptsphp aphp classphp namephp tophp usephp whenphp handlingphp requestsphp.php Anyphp additional
php php php php php php*php argumentsphp willphp bephp passedphp tophp thatphp classphp'php constructorphp whenphp instantiatedphp.
php php php php php php*
php php php php php php*php Seephp php{php@linkphp setObjectphp(php)php}php tophp setphp preconfiguredphp objectphp instancesphp asphp requestphp handlersphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$classphp Classphp Namephp whichphp executesphp SOAPphp Requestsphp atphp endpointphp.
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php php@throwsphp Zendphp_Soapphp_Serverphp_Exceptionphp ifphp calledphp morephp thanphp oncephp,php orphp ifphp class
php php php php php php*php doesphp notphp exist
php php php php php php*php/
php php php php publicphp functionphp setClassphp(php$classphp,php php$namespacephp php=php php'php'php,php php$argvphp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(issetphp(php$thisphp-php>php_classphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Aphp classphp hasphp alreadyphp beenphp registeredphp withphp thisphp soapphp serverphp instancephp'php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!isphp_stringphp(php$classphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Invalidphp classphp argumentphp php(php'php php.php gettypephp(php$classphp)php php.php php'php)php'php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!classphp_existsphp(php$classphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Classphp php"php'php php.php php$classphp php.php php'php"php doesphp notphp existphp'php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_classphp php=php php$classphp;
php php php php php php php php ifphp php(php1php <php funcphp_numphp_argsphp(php)php)php php{
php php php php php php php php php php php php php$argvphp php=php funcphp_getphp_argsphp(php)php;
php php php php php php php php php php php php arrayphp_shiftphp(php$argvphp)php;
php php php php php php php php php php php php php$thisphp-php>php_classArgsphp php=php php$argvphp;
php php php php php php php php php}

php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Attachphp anphp objectphp tophp aphp server
php php php php php php*
php php php php php php*php Acceptsphp anphp instanciatedphp objectphp tophp usephp whenphp handlingphp requestsphp.
php php php php php php*
php php php php php php*php php@paramphp objectphp php$object
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php/
php php php php publicphp functionphp setObjectphp(php$objectphp)
php php php php php{
php php php php php php php php ifphp(php!isphp_objectphp(php$objectphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Invalidphp objectphp argumentphp php(php'php.gettypephp(php$objectphp)php.php'php)php'php)php;
php php php php php php php php php}

php php php php php php php php ifphp(issetphp(php$thisphp-php>php_objectphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Anphp objectphp hasphp alreadyphp beenphp registeredphp withphp thisphp soapphp serverphp instancephp'php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_objectphp php=php php$objectphp;

php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnphp aphp serverphp definitionphp array
php php php php php php*
php php php php php php*php Returnsphp aphp listphp ofphp allphp functionsphp registeredphp withphp php{php@linkphp addFunctionphp(php)php}php,
php php php php php php*php mergedphp withphp allphp publicphp methodsphp ofphp thephp classphp setphp withphp php{php@linkphp setClassphp(php)php}
php php php php php php*php php(ifphp anyphp)php.
php php php php php php*
php php php php php php*php php@accessphp public
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp getFunctionsphp(php)
php php php php php{
php php php php php php php php php$functionsphp php=php arrayphp(php)php;
php php php php php php php php ifphp php(nullphp php!php=php=php php$thisphp-php>php_classphp)php php{
php php php php php php php php php php php php php$functionsphp php=php getphp_classphp_methodsphp(php$thisphp-php>php_classphp)php;
php php php php php php php php php}php elseifphp php(nullphp php!php=php=php php$thisphp-php>php_objectphp)php php{
php php php php php php php php php php php php php$functionsphp php=php getphp_classphp_methodsphp(php$thisphp-php>php_objectphp)php;
php php php php php php php php php}

php php php php php php php php returnphp arrayphp_mergephp(php(arrayphp)php php$thisphp-php>php_functionsphp,php php$functionsphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Unimplementedphp:php Loadphp serverphp definition
php php php php php php*
php php php php php php*php php@paramphp arrayphp php$array
php php php php php php*php php@returnphp void
php php php php php php*php php@throwsphp Zendphp_Soapphp_Serverphp_Exceptionphp Unimplemented
php php php php php php*php/
php php php php publicphp functionphp loadFunctionsphp(php$definitionphp)
php php php php php{
php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Unimplementedphp'php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp serverphp persistence
php php php php php php*
php php php php php php*php php@paramphp intphp php$mode
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php/
php php php php publicphp functionphp setPersistencephp(php$modephp)
php php php php php{
php php php php php php php php ifphp php(php!inphp_arrayphp(php$modephp,php arrayphp(SOAPphp_PERSISTENCEphp_SESSIONphp,php SOAPphp_PERSISTENCEphp_REQUESTphp)php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Invalidphp persistencephp modephp specifiedphp'php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_persistencephp php=php php$modephp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp serverphp persistence
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php/
php php php php publicphp functionphp getPersistencephp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_persistencephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp request
php php php php php php*
php php php php php php*php php$requestphp mayphp bephp anyphp ofphp:
php php php php php php*php php-php DOMDocumentphp;php ifphp sophp,php thenphp castphp tophp XML
php php php php php php*php php-php DOMNodephp;php ifphp sophp,php thenphp grabphp ownerphp documentphp andphp castphp tophp XML
php php php php php php*php php-php SimpleXMLElementphp;php ifphp sophp,php thenphp castphp tophp XML
php php php php php php*php php-php stdClassphp;php ifphp sophp,php callsphp php_php_toStringphp(php)php andphp verifiesphp XML
php php php php php php*php php-php stringphp;php ifphp sophp,php verifiesphp XML
php php php php php php*
php php php php php php*php php@paramphp DOMDocumentphp|DOMNodephp|SimpleXMLElementphp|stdClassphp|stringphp php$request
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php/
php php php php protectedphp functionphp php_setRequestphp(php$requestphp)
php php php php php{
php php php php php php php php ifphp php(php$requestphp instanceofphp DOMDocumentphp)php php{
php php php php php php php php php php php php php$xmlphp php=php php$requestphp-php>saveXMLphp(php)php;
php php php php php php php php php}php elseifphp php(php$requestphp instanceofphp DOMNodephp)php php{
php php php php php php php php php php php php php$xmlphp php=php php$requestphp-php>ownerDocumentphp-php>saveXMLphp(php)php;
php php php php php php php php php}php elseifphp php(php$requestphp instanceofphp SimpleXMLElementphp)php php{
php php php php php php php php php php php php php$xmlphp php=php php$requestphp-php>asXMLphp(php)php;
php php php php php php php php php}php elseifphp php(isphp_objectphp(php$requestphp)php php|php|php isphp_stringphp(php$requestphp)php)php php{
php php php php php php php php php php php php ifphp php(isphp_objectphp(php$requestphp)php)php php{
php php php php php php php php php php php php php php php php php$xmlphp php=php php$requestphp-php>php_php_toStringphp(php)php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$xmlphp php=php php$requestphp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$domphp php=php newphp DOMDocumentphp(php)php;
php php php php php php php php php php php php ifphp(strlenphp(php$xmlphp)php php=php=php php0php php|php|php php!php$domphp-php>loadXMLphp(php$xmlphp)php)php php{
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Soapphp_Serverphp_Exceptionphp(php'Invalidphp XMLphp'php)php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php php$thisphp-php>php_requestphp php=php php$xmlphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp requestphp XML
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getLastRequestphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_requestphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp returnphp responsephp flag
php php php php php php*
php php php php php php*php Ifphp truephp,php php{php@linkphp handlephp(php)php}php willphp returnphp thephp responsephp insteadphp of
php php php php php php*php automaticallyphp sendingphp itphp backphp tophp thephp requestingphp clientphp.
php php php php php php*
php php php php php php*php Thephp responsephp isphp alwaysphp availablephp viaphp php{php@linkphp getResponsephp(php)php}php.
php php php php php php*
php php php php php php*php php@paramphp booleanphp php$flag
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php/
php php php php publicphp functionphp setReturnResponsephp(php$flagphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_returnResponsephp php=php php(php$flagphp)php php?php truephp php:php falsephp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp returnphp responsephp flag
php php php php php php*
php php php php php php*php php@returnphp boolean
php php php php php php*php/
php php php php publicphp functionphp getReturnResponsephp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_returnResponsephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp responsephp XML
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getLastResponsephp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_responsephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp SoapServerphp object
php php php php php php*
php php php php php php*php Usesphp php{php@linkphp php$php_wsdlphp}php andphp returnphp valuephp ofphp php{php@linkphp getOptionsphp(php)php}php tophp instantiate
php php php php php php*php SoapServerphp objectphp,php andphp thenphp registersphp anyphp functionsphp orphp classphp withphp itphp,php as
php php php php php php*php wellphp asphp peristencephp.
php php php php php php*
php php php php php php*php php@returnphp SoapServer
php php php php php php*php/
php php php php protectedphp functionphp php_getSoapphp(php)
php php php php php{
php php php php php php php php php$optionsphp php=php php$thisphp-php>getOptionsphp(php)php;
php php php php php php php php php$serverphp php php=php newphp SoapServerphp(php$thisphp-php>php_wsdlphp,php php$optionsphp)php;

php php php php php php php php ifphp php(php!emptyphp(php$thisphp-php>php_functionsphp)php)php php{
php php php php php php php php php php php php php$serverphp-php>addFunctionphp(php$thisphp-php>php_functionsphp)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!emptyphp(php$thisphp-php>php_classphp)php)php php{
php php php php php php php php php php php php php$argsphp php=php php$thisphp-php>php_classArgsphp;
php php php php php php php php php php php php arrayphp_unshiftphp(php$argsphp,php php$thisphp-php>php_classphp)php;
php php php php php php php php php php php php callphp_userphp_funcphp_arrayphp(arrayphp(php$serverphp,php php'setClassphp'php)php,php php$argsphp)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!emptyphp(php$thisphp-php>php_objectphp)php)php php{
php php php php php php php php php php php php php$serverphp-php>setObjectphp(php$thisphp-php>php_objectphp)php;
php php php php php php php php php}

php php php php php php php php ifphp php(nullphp php!php=php=php php$thisphp-php>php_persistencephp)php php{
php php php php php php php php php php php php php$serverphp-php>setPersistencephp(php$thisphp-php>php_persistencephp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$serverphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Handlephp aphp request
php php php php php php*
php php php php php php*php Instantiatesphp SoapServerphp objectphp withphp optionsphp setphp inphp objectphp,php and
php php php php php php*php dispatchesphp itsphp handlephp(php)php methodphp.
php php php php php php*
php php php php php php*php php$requestphp mayphp bephp anyphp ofphp:
php php php php php php*php php-php DOMDocumentphp;php ifphp sophp,php thenphp castphp tophp XML
php php php php php php*php php-php DOMNodephp;php ifphp sophp,php thenphp grabphp ownerphp documentphp andphp castphp tophp XML
php php php php php php*php php-php SimpleXMLElementphp;php ifphp sophp,php thenphp castphp tophp XML
php php php php php php*php php-php stdClassphp;php ifphp sophp,php callsphp php_php_toStringphp(php)php andphp verifiesphp XML
php php php php php php*php php-php stringphp;php ifphp sophp,php verifiesphp XML
php php php php php php*
php php php php php php*php Ifphp nophp requestphp isphp passedphp,php pullsphp requestphp usingphp phpphp:php:php/php/inputphp php(for
php php php php php php*php crossphp-platformphp compatabilityphp purposesphp)php.
php php php php php php*
php php php php php php*php php@paramphp DOMDocumentphp|DOMNodephp|SimpleXMLElementphp|stdClassphp|stringphp php$requestphp Optionalphp request
php php php php php php*php php@returnphp voidphp|string
php php php php php php*php/
php php php php publicphp functionphp handlephp(php$requestphp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(nullphp php=php=php=php php$requestphp)php php{
php php php php php php php php php php php php php$requestphp php=php filephp_getphp_contentsphp(php'phpphp:php/php/inputphp'php)php;
php php php php php php php php php}

php php php php php php php php php/php/php Setphp Zendphp_Soapphp_Serverphp errorphp handler
php php php php php php php php php$displayErrorsOriginalStatephp php=php php$thisphp-php>php_initializeSoapErrorContextphp(php)php;

php php php php php php php php php$setRequestExceptionphp php=php nullphp;
php php php php php php php php php/php*php*
php php php php php php php php php php*php php@seephp Zendphp_Soapphp_Serverphp_Exception
php php php php php php php php php php*php/
php php php php php php php php requirephp_oncephp php'Zendphp/Soapphp/Serverphp/Exceptionphp.phpphp'php;
php php php php php php php php tryphp php{
php php php php php php php php php php php php php$thisphp-php>php_setRequestphp(php$requestphp)php;
php php php php php php php php php}php catchphp php(Zendphp_Soapphp_Serverphp_Exceptionphp php$ephp)php php{
php php php php php php php php php php php php php$setRequestExceptionphp php=php php$ephp;
php php php php php php php php php}

php php php php php php php php php$soapphp php=php php$thisphp-php>php_getSoapphp(php)php;

php php php php php php php php obphp_startphp(php)php;
php php php php php php php php ifphp(php$setRequestExceptionphp instanceofphp Exceptionphp)php php{
php php php php php php php php php php php php php/php/php Sendphp SOAPphp faultphp messagephp ifphp wephp'vephp catchedphp exception
php php php php php php php php php php php php php$soapphp-php>faultphp(php"Senderphp"php,php php$setRequestExceptionphp-php>getMessagephp(php)php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php tryphp php{
php php php php php php php php php php php php php php php php php$soapphp-php>handlephp(php$requestphp)php;
php php php php php php php php php php php php php}php catchphp php(Exceptionphp php$ephp)php php{
php php php php php php php php php php php php php php php php php$faultphp php=php php$thisphp-php>faultphp(php$ephp)php;
php php php php php php php php php php php php php php php php php$soapphp-php>faultphp(php$faultphp-php>faultcodephp,php php$faultphp-php>faultstringphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php php$thisphp-php>php_responsephp php=php obphp_getphp_cleanphp(php)php;

php php php php php php php php php/php/php Restorephp originalphp errorphp handler
php php php php php php php php restorephp_errorphp_handlerphp(php)php;
php php php php php php php php iniphp_setphp(php'displayphp_errorsphp'php,php php$displayErrorsOriginalStatephp)php;

php php php php php php php php ifphp php(php!php$thisphp-php>php_returnResponsephp)php php{
php php php php php php php php php php php php echophp php$thisphp-php>php_responsephp;
php php php php php php php php php php php php returnphp;
php php php php php php php php php}

php php php php php php php php returnphp php$thisphp-php>php_responsephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Methodphp initalizesphp thephp errorphp contextphp thatphp thephp SOAPServerphp enviromentphp willphp runphp inphp.
php php php php php php*
php php php php php php*php php@returnphp booleanphp displayphp_errorsphp originalphp value
php php php php php php*php/
php php php php protectedphp functionphp php_initializeSoapErrorContextphp(php)
php php php php php{
php php php php php php php php php$displayErrorsOriginalStatephp php=php iniphp_getphp(php'displayphp_errorsphp'php)php;
php php php php php php php php iniphp_setphp(php'displayphp_errorsphp'php,php falsephp)php;
php php php php php php php php setphp_errorphp_handlerphp(arrayphp(php$thisphp,php php'handlePhpErrorsphp'php)php,php Ephp_USERphp_ERRORphp)php;
php php php php php php php php returnphp php$displayErrorsOriginalStatephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Registerphp aphp validphp faultphp exception
php php php php php php*
php php php php php php*php php@paramphp php stringphp|arrayphp php$classphp Exceptionphp classphp orphp arrayphp ofphp exceptionphp classes
php php php php php php*php php@returnphp Zendphp_Soapphp_Server
php php php php php php*php/
php php php php publicphp functionphp registerFaultExceptionphp(php$classphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_faultExceptionsphp php=php arrayphp_mergephp(php$thisphp-php>php_faultExceptionsphp,php php(arrayphp)php php$classphp)php;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Deregisterphp aphp faultphp exceptionphp fromphp thephp faultphp exceptionphp stack
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$class
php php php php php php*php php@returnphp boolean
php php php php php php*php/
php php php php publicphp functionphp deregisterFaultExceptionphp(php$classphp)
php php php php php{
php php php php php php php php ifphp php(inphp_arrayphp(php$classphp,php php$thisphp-php>php_faultExceptionsphp,php truephp)php)php php{
php php php php php php php php php php php php php$indexphp php=php arrayphp_searchphp(php$classphp,php php$thisphp-php>php_faultExceptionsphp)php;
php php php php php php php php php php php php unsetphp(php$thisphp-php>php_faultExceptionsphp[php$indexphp]php)php;
php php php php php php php php php php php php returnphp truephp;
php php php php php php php php php}

php php php php php php php php returnphp falsephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnphp faultphp exceptionsphp list
php php php php php php*
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp getFaultExceptionsphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_faultExceptionsphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Generatephp aphp serverphp fault
php php php php php php*
php php php php php php*php Notephp thatphp thephp argumentsphp arephp reversephp tophp thosephp ofphp SoapFaultphp.
php php php php php php*
php php php php php php*php Ifphp anphp exceptionphp isphp passedphp asphp thephp firstphp argumentphp,php itsphp messagephp andphp code
php php php php php php*php willphp bephp usedphp tophp createphp thephp faultphp objectphp ifphp itphp hasphp beenphp registeredphp via
php php php php php php*php php{php@Linkphp registerFaultExceptionphp(php)php}php.
php php php php php php*
php php php php php php*php php@linkphp php php httpphp:php/php/wwwphp.wphp3php.orgphp/TRphp/soapphp1php2php-partphp1php/php#faultcodes
php php php php php php*php php@paramphp php stringphp|Exceptionphp php$fault
php php php php php php*php php@paramphp php stringphp php$codephp SOAPphp Faultphp Codes
php php php php php php*php php@returnphp SoapFault
php php php php php php*php/
php php php php publicphp functionphp faultphp(php$faultphp php=php nullphp,php php$codephp php=php php"Receiverphp"php)
php php php php php{
php php php php php php php php ifphp php(php$faultphp instanceofphp Exceptionphp)php php{
php php php php php php php php php php php php php$classphp php=php getphp_classphp(php$faultphp)php;
php php php php php php php php php php php php ifphp php(inphp_arrayphp(php$classphp,php php$thisphp-php>php_faultExceptionsphp)php)php php{
php php php php php php php php php php php php php php php php php$messagephp php=php php$faultphp-php>getMessagephp(php)php;
php php php php php php php php php php php php php php php php php$eCodephp php php php=php php$faultphp-php>getCodephp(php)php;
php php php php php php php php php php php php php php php php php$codephp php php php php=php emptyphp(php$eCodephp)php php?php php$codephp php:php php$eCodephp;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$messagephp php=php php'Unknownphp errorphp'php;
php php php php php php php php php php php php php}
php php php php php php php php php}php elseifphp(isphp_stringphp(php$faultphp)php)php php{
php php php php php php php php php php php php php$messagephp php=php php$faultphp;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$messagephp php=php php'Unknownphp errorphp'php;
php php php php php php php php php}

php php php php php php php php php$allowedFaultModesphp php=php arrayphp(
php php php php php php php php php php php php php'VersionMismatchphp'php,php php'MustUnderstandphp'php,php php'DataEncodingUnknownphp'php,
php php php php php php php php php php php php php'Senderphp'php,php php'Receiverphp'php,php php'Serverphp'
php php php php php php php php php)php;
php php php php php php php php ifphp(php!inphp_arrayphp(php$codephp,php php$allowedFaultModesphp)php)php php{
php php php php php php php php php php php php php$codephp php=php php"Receiverphp"php;
php php php php php php php php php}

php php php php php php php php returnphp newphp SoapFaultphp(php$codephp,php php$messagephp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Throwphp PHPphp errorsphp asphp SoapFaults
php php php php php php*
php php php php php php*php php@paramphp intphp php$errno
php php php php php php*php php@paramphp stringphp php$errstr
php php php php php php*php php@paramphp stringphp php$errfile
php php php php php php*php php@paramphp intphp php$errline
php php php php php php*php php@paramphp arrayphp php$errcontext
php php php php php php*php php@returnphp void
php php php php php php*php php@throwsphp SoapFault
php php php php php php*php/
php php php php publicphp functionphp handlePhpErrorsphp(php$errnophp,php php$errstrphp,php php$errfilephp php=php nullphp,php php$errlinephp php=php nullphp,php arrayphp php$errcontextphp php=php nullphp)
php php php php php{
php php php php php php php php throwphp php$thisphp-php>faultphp(php$errstrphp,php php"Receiverphp"php)php;
php php php php php}
php}
