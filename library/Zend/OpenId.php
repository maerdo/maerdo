<php?php

php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_OpenId
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php OpenIdphp.phpphp php2php2php6php5php3php php2php0php1php0php-php0php7php-php2php2php php1php8php:php4php1php:php3php9Zphp mabephp php$
php php*php/

php/php*php*
php php*php php@seephp Zendphp_Controllerphp_Responsephp_Abstract
php php*php/
requirephp_oncephp php"Zendphp/Controllerphp/Responsephp/Abstractphp.phpphp"php;

php/php*php*
php php*php Staticphp classphp thatphp containsphp commonphp utilityphp functionsphp for
php php*php php{php@linkphp Zendphp_OpenIdphp_Consumerphp}php andphp php{php@linkphp Zendphp_OpenIdphp_Providerphp}php.
php php*
php php*php Thisphp classphp implementsphp commonphp utilityphp functionsphp thatphp arephp usedphp byphp both
php php*php Consumerphp andphp Providerphp.php Theyphp includephp functionsphp forphp Diffiephp-Hellmanphp keys
php php*php generationphp andphp exchangephp,php URLphp normalizationphp,php HTTPphp redirectionphp andphp somephp othersphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_OpenId
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_OpenId
php{
php php php php php/php*php*
php php php php php php*php Defaultphp Diffiephp-Hellmanphp keyphp generatorphp php(php1php0php2php4php bitphp)
php php php php php php*php/
php php php php constphp DHphp_Pphp php php php=php php'dcfphp9php3aphp0bphp8php8php3php9php7php2ecphp0ephp1php9php9php8php9acphp5aphp2cephp3php1php0ephp1dphp3php7php7php1php7ephp8dphp9php5php7php1bbphp7php6php2php3php7php3php1php8php6php6ephp6php1efphp7php5aphp2ephp2php7php8php9php8bphp0php5php7fphp9php8php9php1cphp2ephp2php7aphp6php3php9cphp3fphp2php9bphp6php0php8php1php4php5php8php1cdphp3bphp2caphp3php9php8php6dphp2php6php8php3php7php0php5php5php7php7dphp4php5cphp2ephp7ephp5php2dcphp8php1cphp7aphp1php7php1php8php7php6ephp5ceaphp7php4bphp1php4php4php8bfdfafphp1php8php8php2php8efdphp2php5php1php9fphp1php4ephp4php5ephp3php8php2php6php6php3php4afphp1php9php4php9ephp5bphp5php3php5ccphp8php2php9aphp4php8php3bphp8aphp7php6php2php2php3ephp5dphp4php9php0aphp2php5php7fphp0php5bdffphp1php6fphp2fbphp2php2cphp5php8php3abphp'php;

php php php php php/php*php*
php php php php php php*php Defaultphp Diffiephp-Hellmanphp primephp numberphp php(shouldphp bephp php2php orphp php5php)
php php php php php php*php/
php php php php constphp DHphp_Gphp php php php=php php'php0php2php'php;

php php php php php/php*php*
php php php php php php*php OpenIDphp php2php.php0php namespacephp.php Allphp OpenIDphp php2php.php0php messagesphp MUSTphp containphp variable
php php php php php php*php openidphp.nsphp withphp itsphp valuephp.
php php php php php php*php/
php php php php constphp NSphp_php2php_php0php php=php php'httpphp:php/php/specsphp.openidphp.netphp/authphp/php2php.php0php'php;

php php php php php/php*php*
php php php php php php*php Allowsphp enablephp/disablephp stopingphp executionphp ofphp PHPphp scriptphp afterphp redirectphp(php)
php php php php php php*php/
php php php php staticphp publicphp php$exitOnRedirectphp php=php truephp;

php php php php php/php*php*
php php php php php php*php Alternativephp requestphp URLphp thatphp canphp bephp usedphp tophp overridephp thephp default
php php php php php php*php selfUrlphp(php)php response
php php php php php php*php/
php php php php staticphp publicphp php$selfUrlphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php Setsphp alternativephp requestphp URLphp thatphp canphp bephp usedphp tophp overridephp thephp default
php php php php php php*php selfUrlphp(php)php response
php php php php php php*
php php php php php php*php php@paramphp stringphp php$selfUrlphp thephp URLphp tophp bephp set
php php php php php php*php php@returnphp stringphp thephp oldphp valuephp ofphp overridingphp URL
php php php php php php*php/
php php php php staticphp publicphp functionphp setSelfUrlphp(php$selfUrlphp php=php nullphp)
php php php php php{
php php php php php php php php php$retphp php=php selfphp:php:php$selfUrlphp;
php php php php php php php php selfphp:php:php$selfUrlphp php=php php$selfUrlphp;
php php php php php php php php returnphp php$retphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp aphp fullphp URLphp thatphp wasphp requestedphp onphp currentphp HTTPphp requestphp.
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php staticphp publicphp functionphp selfUrlphp(php)
php php php php php{
php php php php php php php php ifphp php(selfphp:php:php$selfUrlphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php returnphp selfphp:php:php$selfUrlphp;
php php php php php php php php php}php ifphp php(issetphp(php$php_SERVERphp[php'SCRIPTphp_URIphp'php]php)php)php php{
php php php php php php php php php php php php returnphp php$php_SERVERphp[php'SCRIPTphp_URIphp'php]php;
php php php php php php php php php}
php php php php php php php php php$urlphp php=php php'php'php;
php php php php php php php php php$portphp php=php php'php'php;
php php php php php php php php ifphp php(issetphp(php$php_SERVERphp[php'HTTPphp_HOSTphp'php]php)php)php php{
php php php php php php php php php php php php ifphp php(php(php$posphp php=php strposphp(php$php_SERVERphp[php'HTTPphp_HOSTphp'php]php,php php'php:php'php)php)php php=php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php ifphp php(issetphp(php$php_SERVERphp[php'SERVERphp_PORTphp'php]php)php)php php{
php php php php php php php php php php php php php php php php php php php php php$portphp php=php php'php:php'php php.php php$php_SERVERphp[php'SERVERphp_PORTphp'php]php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php$urlphp php=php php$php_SERVERphp[php'HTTPphp_HOSTphp'php]php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$urlphp php=php substrphp(php$php_SERVERphp[php'HTTPphp_HOSTphp'php]php,php php0php,php php$posphp)php;
php php php php php php php php php php php php php php php php php$portphp php=php substrphp(php$php_SERVERphp[php'HTTPphp_HOSTphp'php]php,php php$posphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}php elsephp ifphp php(issetphp(php$php_SERVERphp[php'SERVERphp_NAMEphp'php]php)php)php php{
php php php php php php php php php php php php php$urlphp php=php php$php_SERVERphp[php'SERVERphp_NAMEphp'php]php;
php php php php php php php php php php php php ifphp php(issetphp(php$php_SERVERphp[php'SERVERphp_PORTphp'php]php)php)php php{
php php php php php php php php php php php php php php php php php$portphp php=php php'php:php'php php.php php$php_SERVERphp[php'SERVERphp_PORTphp'php]php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php ifphp php(issetphp(php$php_SERVERphp[php'HTTPSphp'php]php)php php&php&php php$php_SERVERphp[php'HTTPSphp'php]php php=php=php php'onphp'php)php php{
php php php php php php php php php php php php php$urlphp php=php php'httpsphp:php/php/php'php php.php php$urlphp;
php php php php php php php php php php php php ifphp php(php$portphp php=php=php php'php:php4php4php3php'php)php php{
php php php php php php php php php php php php php php php php php$portphp php=php php'php'php;
php php php php php php php php php php php php php}
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$urlphp php=php php'httpphp:php/php/php'php php.php php$urlphp;
php php php php php php php php php php php php ifphp php(php$portphp php=php=php php'php:php8php0php'php)php php{
php php php php php php php php php php php php php php php php php$portphp php=php php'php'php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php$urlphp php.php=php php$portphp;
php php php php php php php php ifphp php(issetphp(php$php_SERVERphp[php'HTTPphp_Xphp_REWRITEphp_URLphp'php]php)php)php php{
php php php php php php php php php php php php php$urlphp php.php=php php$php_SERVERphp[php'HTTPphp_Xphp_REWRITEphp_URLphp'php]php;
php php php php php php php php php}php elseifphp php(issetphp(php$php_SERVERphp[php'REQUESTphp_URIphp'php]php)php)php php{
php php php php php php php php php php php php php$queryphp php=php strposphp(php$php_SERVERphp[php'REQUESTphp_URIphp'php]php,php php'php?php'php)php;
php php php php php php php php php php php php ifphp php(php$queryphp php=php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php php$urlphp php.php=php php$php_SERVERphp[php'REQUESTphp_URIphp'php]php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$urlphp php.php=php substrphp(php$php_SERVERphp[php'REQUESTphp_URIphp'php]php,php php0php,php php$queryphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}php elsephp ifphp php(issetphp(php$php_SERVERphp[php'SCRIPTphp_URLphp'php]php)php)php php{
php php php php php php php php php php php php php$urlphp php.php=php php$php_SERVERphp[php'SCRIPTphp_URLphp'php]php;
php php php php php php php php php}php elsephp ifphp php(issetphp(php$php_SERVERphp[php'REDIRECTphp_URLphp'php]php)php)php php{
php php php php php php php php php php php php php$urlphp php.php=php php$php_SERVERphp[php'REDIRECTphp_URLphp'php]php;
php php php php php php php php php}php elsephp ifphp php(issetphp(php$php_SERVERphp[php'PHPphp_SELFphp'php]php)php)php php{
php php php php php php php php php php php php php$urlphp php.php=php php$php_SERVERphp[php'PHPphp_SELFphp'php]php;
php php php php php php php php php}php elsephp ifphp php(issetphp(php$php_SERVERphp[php'SCRIPTphp_NAMEphp'php]php)php)php php{
php php php php php php php php php php php php php$urlphp php.php=php php$php_SERVERphp[php'SCRIPTphp_NAMEphp'php]php;
php php php php php php php php php php php php ifphp php(issetphp(php$php_SERVERphp[php'PATHphp_INFOphp'php]php)php)php php{
php php php php php php php php php php php php php php php php php$urlphp php.php=php php$php_SERVERphp[php'PATHphp_INFOphp'php]php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php returnphp php$urlphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp anphp absolutephp URLphp forphp thephp givenphp one
php php php php php php*
php php php php php php*php php@paramphp stringphp php$urlphp absilutephp orphp relativephp URL
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php staticphp publicphp functionphp absoluteUrlphp(php$urlphp)
php php php php php{
php php php php php php php php ifphp php(emptyphp(php$urlphp)php)php php{
php php php php php php php php php php php php returnphp Zendphp_OpenIdphp:php:selfUrlphp(php)php;
php php php php php php php php php}php elsephp ifphp php(php!pregphp_matchphp(php'php|php^php(php[php^php:php]php+php)php:php/php/php|php'php,php php$urlphp)php)php php{
php php php php php php php php php php php php ifphp php(pregphp_matchphp(php'php|php^php(php[php^php:php]php+php)php:php/php/php(php[php^php:php@php]php*php(php?php:php[php:php]php[php^php@php]php*php)php?php@php)php?php(php[php^php/php:php@php?php#php]php*php)php(php?php:php[php:php]php(php[php^php/php?php#php]php*php)php)php?php(php/php[php^php?php]php*php)php?php(php(php?php:php[php?php]php(php?php:php[php^php#php]php*php)php)php?php(php?php:php#php.php*php)php?php)php$php|php'php,php Zendphp_OpenIdphp:php:selfUrlphp(php)php,php php$regphp)php)php php{
php php php php php php php php php php php php php php php php php$schemephp php=php php$regphp[php1php]php;
php php php php php php php php php php php php php php php php php$authphp php=php php$regphp[php2php]php;
php php php php php php php php php php php php php php php php php$hostphp php=php php$regphp[php3php]php;
php php php php php php php php php php php php php php php php php$portphp php=php php$regphp[php4php]php;
php php php php php php php php php php php php php php php php php$pathphp php=php php$regphp[php5php]php;
php php php php php php php php php php php php php php php php php$queryphp php=php php$regphp[php6php]php;
php php php php php php php php php php php php php php php php ifphp php(php$urlphp[php0php]php php=php=php php'php/php'php)php php{
php php php php php php php php php php php php php php php php php php php php returnphp php$scheme
php php php php php php php php php php php php php php php php php php php php php php php php php.php php'php:php/php/php'
php php php php php php php php php php php php php php php php php php php php php php php php php.php php$auth
php php php php php php php php php php php php php php php php php php php php php php php php php.php php$host
php php php php php php php php php php php php php php php php php php php php php php php php php.php php(emptyphp(php$portphp)php php?php php'php'php php:php php(php'php:php'php php.php php$portphp)php)
php php php php php php php php php php php php php php php php php php php php php php php php php.php php$urlphp;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php$dirphp php=php dirnamephp(php$pathphp)php;
php php php php php php php php php php php php php php php php php php php php returnphp php$scheme
php php php php php php php php php php php php php php php php php php php php php php php php php.php php'php:php/php/php'
php php php php php php php php php php php php php php php php php php php php php php php php php.php php$auth
php php php php php php php php php php php php php php php php php php php php php php php php php.php php$host
php php php php php php php php php php php php php php php php php php php php php php php php php.php php(emptyphp(php$portphp)php php?php php'php'php php:php php(php'php:php'php php.php php$portphp)php)
php php php php php php php php php php php php php php php php php php php php php php php php php.php php(strlenphp(php$dirphp)php php>php php1php php?php php$dirphp php:php php'php'php)
php php php php php php php php php php php php php php php php php php php php php php php php php.php php'php/php'
php php php php php php php php php php php php php php php php php php php php php php php php php.php php$urlphp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php returnphp php$urlphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Convertsphp variablephp/valuephp pairsphp intophp URLphp encodedphp queryphp string
php php php php php php*
php php php php php php*php php@paramphp arrayphp php$paramsphp variablephp/valuephp pairs
php php php php php php*php php@returnphp stringphp URLphp encodedphp queryphp string
php php php php php php*php/
php php php php staticphp publicphp functionphp paramsToQueryphp(php$paramsphp)
php php php php php{
php php php php php php php php foreachphp(php$paramsphp asphp php$keyphp php=php>php php$valuephp)php php{
php php php php php php php php php php php php ifphp php(issetphp(php$queryphp)php)php php{
php php php php php php php php php php php php php php php php php$queryphp php.php=php php'php&php'php php.php php$keyphp php.php php'php=php'php php.php urlencodephp(php$valuephp)php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$queryphp php=php php$keyphp php.php php'php=php'php php.php urlencodephp(php$valuephp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php returnphp issetphp(php$queryphp)php php?php php$queryphp php:php php'php'php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Normalizesphp URLphp accordingphp tophp RFCphp php3php9php8php6php tophp usephp itphp inphp comparisonphp operationsphp.
php php php php php php*php Thephp functionphp getsphp URLphp argumentphp byphp referencephp andphp modifiesphp itphp.
php php php php php php*php Itphp returnsphp truephp onphp successphp andphp falsephp ofphp failurephp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php&php$idphp urlphp tophp bephp normalized
php php php php php php*php php@returnphp bool
php php php php php php*php/
php php php php staticphp publicphp functionphp normalizeUrlphp(php&php$idphp)
php php php php php{
php php php php php php php php php/php/php RFCphp php3php9php8php6php,php php6php.php2php.php2php.php php Syntaxphp-Basedphp Normalization

php php php php php php php php php/php/php RFCphp php3php9php8php6php,php php6php.php2php.php2php.php2php Percentphp-Encodingphp Normalization
php php php php php php php php php$iphp php=php php0php;
php php php php php php php php php$nphp php=php strlenphp(php$idphp)php;
php php php php php php php php php$resphp php=php php'php'php;
php php php php php php php php whilephp php(php$iphp <php php$nphp)php php{
php php php php php php php php php php php php ifphp php(php$idphp[php$iphp]php php=php=php php'php%php'php)php php{
php php php php php php php php php php php php php php php php ifphp php(php$iphp php+php php2php php>php=php php$nphp)php php{
php php php php php php php php php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php+php+php$iphp;
php php php php php php php php php php php php php php php php ifphp php(php$idphp[php$iphp]php php>php=php php'php0php'php php&php&php php$idphp[php$iphp]php <php=php php'php9php'php)php php{
php php php php php php php php php php php php php php php php php php php php php$cphp php=php ordphp(php$idphp[php$iphp]php)php php-php ordphp(php'php0php'php)php;
php php php php php php php php php php php php php php php php php}php elsephp ifphp php(php$idphp[php$iphp]php php>php=php php'Aphp'php php&php&php php$idphp[php$iphp]php <php=php php'Fphp'php)php php{
php php php php php php php php php php php php php php php php php php php php php$cphp php=php ordphp(php$idphp[php$iphp]php)php php-php ordphp(php'Aphp'php)php php+php php1php0php;
php php php php php php php php php php php php php php php php php}php elsephp ifphp php(php$idphp[php$iphp]php php>php=php php'aphp'php php&php&php php$idphp[php$iphp]php <php=php php'fphp'php)php php{
php php php php php php php php php php php php php php php php php php php php php$cphp php=php ordphp(php$idphp[php$iphp]php)php php-php ordphp(php'aphp'php)php php+php php1php0php;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php+php+php$iphp;
php php php php php php php php php php php php php php php php ifphp php(php$idphp[php$iphp]php php>php=php php'php0php'php php&php&php php$idphp[php$iphp]php <php=php php'php9php'php)php php{
php php php php php php php php php php php php php php php php php php php php php$cphp php=php php(php$cphp <php<php php4php)php php|php php(ordphp(php$idphp[php$iphp]php)php php-php ordphp(php'php0php'php)php)php;
php php php php php php php php php php php php php php php php php}php elsephp ifphp php(php$idphp[php$iphp]php php>php=php php'Aphp'php php&php&php php$idphp[php$iphp]php <php=php php'Fphp'php)php php{
php php php php php php php php php php php php php php php php php php php php php$cphp php=php php(php$cphp <php<php php4php)php php|php php(ordphp(php$idphp[php$iphp]php)php php-php ordphp(php'Aphp'php)php php+php php1php0php)php;
php php php php php php php php php php php php php php php php php}php elsephp ifphp php(php$idphp[php$iphp]php php>php=php php'aphp'php php&php&php php$idphp[php$iphp]php <php=php php'fphp'php)php php{
php php php php php php php php php php php php php php php php php php php php php$cphp php=php php(php$cphp <php<php php4php)php php|php php(ordphp(php$idphp[php$iphp]php)php php-php ordphp(php'aphp'php)php php+php php1php0php)php;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php+php+php$iphp;
php php php php php php php php php php php php php php php php php$chphp php=php chrphp(php$cphp)php;
php php php php php php php php php php php php php php php php ifphp php(php(php$chphp php>php=php php'Aphp'php php&php&php php$chphp <php=php php'Zphp'php)php php|php|
php php php php php php php php php php php php php php php php php php php php php(php$chphp php>php=php php'aphp'php php&php&php php$chphp <php=php php'zphp'php)php php|php|
php php php php php php php php php php php php php php php php php php php php php$chphp php=php=php php'php-php'php php|php|
php php php php php php php php php php php php php php php php php php php php php$chphp php=php=php php'php.php'php php|php|
php php php php php php php php php php php php php php php php php php php php php$chphp php=php=php php'php_php'php php|php|
php php php php php php php php php php php php php php php php php php php php php$chphp php=php=php php'php~php'php)php php{
php php php php php php php php php php php php php php php php php php php php php$resphp php.php=php php$chphp;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php$resphp php.php=php php'php%php'php;
php php php php php php php php php php php php php php php php php php php php ifphp php(php(php$cphp php>php>php php4php)php <php php1php0php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php$resphp php.php=php chrphp(php(php$cphp php>php>php php4php)php php+php ordphp(php'php0php'php)php)php;
php php php php php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php php php php php$resphp php.php=php chrphp(php(php$cphp php>php>php php4php)php php-php php1php0php php+php ordphp(php'Aphp'php)php)php;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php php php php php$cphp php=php php$cphp php&php php0xfphp;
php php php php php php php php php php php php php php php php php php php php ifphp php(php$cphp <php php1php0php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php$resphp php.php=php chrphp(php$cphp php+php ordphp(php'php0php'php)php)php;
php php php php php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php php php php php$resphp php.php=php chrphp(php$cphp php-php php1php0php php+php ordphp(php'Aphp'php)php)php;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$resphp php.php=php php$idphp[php$iphp+php+php]php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php ifphp php(php!pregphp_matchphp(php'php|php^php(php[php^php:php]php+php)php:php/php/php(php[php^php:php@php]php*php(php?php:php[php:php]php[php^php@php]php*php)php?php@php)php?php(php[php^php/php:php@php?php#php]php*php)php(php?php:php[php:php]php(php[php^php/php?php#php]php*php)php)php?php(php/php[php^php?php#php]php*php)php?php(php(php?php:php[php?php]php(php?php:php[php^php#php]php*php)php)php?php)php(php(php?php:php#php.php*php)php?php)php$php|php'php,php php$resphp,php php$regphp)php)php php{
php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php}
php php php php php php php php php$schemephp php=php php$regphp[php1php]php;
php php php php php php php php php$authphp php=php php$regphp[php2php]php;
php php php php php php php php php$hostphp php=php php$regphp[php3php]php;
php php php php php php php php php$portphp php=php php$regphp[php4php]php;
php php php php php php php php php$pathphp php=php php$regphp[php5php]php;
php php php php php php php php php$queryphp php=php php$regphp[php6php]php;
php php php php php php php php php$fragmentphp php=php php$regphp[php7php]php;php php/php*php stripphp itphp php*php/

php php php php php php php php ifphp php(emptyphp(php$schemephp)php php|php|php emptyphp(php$hostphp)php)php php{
php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php}

php php php php php php php php php/php/php RFCphp php3php9php8php6php,php php6php.php2php.php2php.php1php.php php Casephp Normalization
php php php php php php php php php$schemephp php=php strtolowerphp(php$schemephp)php;
php php php php php php php php php$hostphp php=php strtolowerphp(php$hostphp)php;

php php php php php php php php php/php/php RFCphp php3php9php8php6php,php php6php.php2php.php2php.php3php.php php Pathphp Segmentphp Normalization
php php php php php php php php ifphp php(php!emptyphp(php$pathphp)php)php php{
php php php php php php php php php php php php php$iphp php=php php0php;
php php php php php php php php php php php php php$nphp php=php strlenphp(php$pathphp)php;
php php php php php php php php php php php php php$resphp php=php php"php"php;
php php php php php php php php php php php php whilephp php(php$iphp <php php$nphp)php php{
php php php php php php php php php php php php php php php php ifphp php(php$pathphp[php$iphp]php php=php=php php'php/php'php)php php{
php php php php php php php php php php php php php php php php php php php php php+php+php$iphp;
php php php php php php php php php php php php php php php php php php php php whilephp php(php$iphp <php php$nphp php&php&php php$pathphp[php$iphp]php php=php=php php'php/php'php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php+php+php$iphp;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php php php php ifphp php(php$iphp <php php$nphp php&php&php php$pathphp[php$iphp]php php=php=php php'php.php'php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php+php+php$iphp;
php php php php php php php php php php php php php php php php php php php php php php php php ifphp php(php$iphp <php php$nphp php&php&php php$pathphp[php$iphp]php php=php=php php'php.php'php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php+php+php$iphp;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php ifphp php(php$iphp php=php=php php$nphp php|php|php php$pathphp[php$iphp]php php=php=php php'php/php'php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php ifphp php(php(php$posphp php=php strrposphp(php$resphp,php php'php/php'php)php)php php!php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$resphp php=php substrphp(php$resphp,php php0php,php php$posphp)php;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$resphp php.php=php php'php/php.php.php'php;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php php php php php php php php php}php elsephp ifphp php(php$iphp php!php=php php$nphp php&php&php php$pathphp[php$iphp]php php!php=php php'php/php'php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$resphp php.php=php php'php/php.php'php;
php php php php php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php php php php php$resphp php.php=php php'php/php'php;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php$resphp php.php=php php$pathphp[php$iphp+php+php]php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$pathphp php=php php$resphp;
php php php php php php php php php}

php php php php php php php php php/php/php RFCphp php3php9php8php6php,php6php.php2php.php3php.php php Schemephp-Basedphp Normalization
php php php php php php php php ifphp php(php$schemephp php=php=php php'httpphp'php)php php{
php php php php php php php php php php php php ifphp php(php$portphp php=php=php php8php0php)php php{
php php php php php php php php php php php php php php php php php$portphp php=php php'php'php;
php php php php php php php php php php php php php}
php php php php php php php php php}php elsephp ifphp php(php$schemephp php=php=php php'httpsphp'php)php php{
php php php php php php php php php php php php ifphp php(php$portphp php=php=php php4php4php3php)php php{
php php php php php php php php php php php php php php php php php$portphp php=php php'php'php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php ifphp php(emptyphp(php$pathphp)php)php php{
php php php php php php php php php php php php php$pathphp php=php php'php/php'php;
php php php php php php php php php}

php php php php php php php php php$idphp php=php php$scheme
php php php php php php php php php php php php php.php php'php:php/php/php'
php php php php php php php php php php php php php.php php$auth
php php php php php php php php php php php php php.php php$host
php php php php php php php php php php php php php.php php(emptyphp(php$portphp)php php?php php'php'php php:php php(php'php:php'php php.php php$portphp)php)
php php php php php php php php php php php php php.php php$path
php php php php php php php php php php php php php.php php$queryphp;
php php php php php php php php returnphp truephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Normalizesphp OpenIDphp identifierphp thatphp canphp bephp URLphp orphp XRIphp namephp.
php php php php php php*php Returnsphp truephp onphp successphp andphp falsephp ofphp failurephp.
php php php php php php*
php php php php php php*php Normalizationphp isphp performedphp accordingphp tophp thephp followingphp rulesphp:
php php php php php php*php php1php.php Ifphp thephp userphp'sphp inputphp startsphp withphp onephp ofphp thephp php"xriphp:php/php/php"php,php php"xriphp:php/php/php$ipphp*php"php,
php php php php php php*php php php php orphp php"xriphp:php/php/php$dnsphp*php"php prefixesphp,php theyphp MUSTphp bephp strippedphp offphp,php sophp thatphp XRIs
php php php php php php*php php php php arephp usedphp inphp thephp canonicalphp formphp,php andphp URIphp-authorityphp XRIsphp arephp further
php php php php php php*php php php php consideredphp URLphp identifiersphp.
php php php php php php*php php2php.php Ifphp thephp firstphp characterphp ofphp thephp resultingphp stringphp isphp anphp XRIphp Global
php php php php php php*php php php php Contextphp Symbolphp php(php"php=php"php,php php"php@php"php,php php"php+php"php,php php"php$php"php,php php"php!php"php)php,php thenphp thephp inputphp SHOULDphp be
php php php php php php*php php php php treatedphp asphp anphp XRIphp.
php php php php php php*php php3php.php Otherwisephp,php thephp inputphp SHOULDphp bephp treatedphp asphp anphp httpphp URLphp;php ifphp itphp does
php php php php php php*php php php php notphp includephp aphp php"httpphp"php orphp php"httpsphp"php schemephp,php thephp Identifierphp MUSTphp be
php php php php php php*php php php php prefixedphp withphp thephp stringphp php"httpphp:php/php/php"php.
php php php php php php*php php4php.php URLphp identifiersphp MUSTphp thenphp bephp furtherphp normalizedphp byphp bothphp following
php php php php php php*php php php php redirectsphp whenphp retrievingphp theirphp contentphp andphp finallyphp applyingphp the
php php php php php php*php php php php rulesphp inphp Sectionphp php6php ofphp php[RFCphp3php9php8php6php]php tophp thephp finalphp destinationphp URLphp.
php php php php php php*php php@paramphp stringphp php&php$idphp identifierphp tophp bephp normalized
php php php php php php*php php@returnphp bool
php php php php php php*php/
php php php php staticphp publicphp functionphp normalizephp(php&php$idphp)
php php php php php{
php php php php php php php php php$idphp php=php trimphp(php$idphp)php;
php php php php php php php php ifphp php(strlenphp(php$idphp)php php=php=php=php php0php)php php{
php php php php php php php php php php php php returnphp truephp;
php php php php php php php php php}

php php php php php php php php php/php/php php7php.php2php.php1
php php php php php php php php ifphp php(strposphp(php$idphp,php php'xriphp:php/php/php$ipphp*php'php)php php=php=php=php php0php)php php{
php php php php php php php php php php php php php$idphp php=php substrphp(php$idphp,php strlenphp(php'xriphp:php/php/php$ipphp*php'php)php)php;
php php php php php php php php php}php elsephp ifphp php(strposphp(php$idphp,php php'xriphp:php/php/php$dnsphp*php'php)php php=php=php=php php0php)php php{
php php php php php php php php php php php php php$idphp php=php substrphp(php$idphp,php strlenphp(php'xriphp:php/php/php$dnsphp*php'php)php)php;
php php php php php php php php php}php elsephp ifphp php(strposphp(php$idphp,php php'xriphp:php/php/php'php)php php=php=php=php php0php)php php{
php php php php php php php php php php php php php$idphp php=php substrphp(php$idphp,php strlenphp(php'xriphp:php/php/php'php)php)php;
php php php php php php php php php}

php php php php php php php php php/php/php php7php.php2php.php2
php php php php php php php php ifphp php(php$idphp[php0php]php php=php=php php'php=php'php php|php|
php php php php php php php php php php php php php$idphp[php0php]php php=php=php php'php@php'php php|php|
php php php php php php php php php php php php php$idphp[php0php]php php=php=php php'php+php'php php|php|
php php php php php php php php php php php php php$idphp[php0php]php php=php=php php'php$php'php php|php|
php php php php php php php php php php php php php$idphp[php0php]php php=php=php php'php!php'php)php php{
php php php php php php php php php php php php returnphp truephp;
php php php php php php php php php}

php php php php php php php php php/php/php php7php.php2php.php3
php php php php php php php php ifphp php(strposphp(php$idphp,php php"php:php/php/php"php)php php=php=php=php falsephp)php php{
php php php php php php php php php php php php php$idphp php=php php'httpphp:php/php/php'php php.php php$idphp;
php php php php php php php php php}

php php php php php php php php php/php/php php7php.php2php.php4
php php php php php php php php returnphp selfphp:php:normalizeURLphp(php$idphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Performsphp aphp HTTPphp redirectionphp tophp specifiedphp URLphp withphp additionalphp dataphp.
php php php php php php*php Itphp mayphp generatephp redirectedphp requestphp usingphp GETphp orphp POSTphp HTTPphp methodphp.
php php php php php php*php Thephp functionphp neverphp returnsphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$urlphp URLphp tophp redirectphp to
php php php php php php*php php@paramphp arrayphp php$paramsphp additionalphp variablephp/valuephp pairsphp tophp send
php php php php php php*php php@paramphp Zendphp_Controllerphp_Responsephp_Abstractphp php$response
php php php php php php*php php@paramphp stringphp php$methodphp redirectionphp methodphp php(php'GETphp'php orphp php'POSTphp'php)
php php php php php php*php/
php php php php staticphp publicphp functionphp redirectphp(php$urlphp,php php$paramsphp php=php nullphp,
php php php php php php php php Zendphp_Controllerphp_Responsephp_Abstractphp php$responsephp php=php nullphp,php php$methodphp php=php php'GETphp'php)
php php php php php{
php php php php php php php php php$urlphp php=php Zendphp_OpenIdphp:php:absoluteUrlphp(php$urlphp)php;
php php php php php php php php php$bodyphp php=php php"php"php;
php php php php php php php php ifphp php(nullphp php=php=php=php php$responsephp)php php{
php php php php php php php php php php php php requirephp_oncephp php"Zendphp/Controllerphp/Responsephp/Httpphp.phpphp"php;
php php php php php php php php php php php php php$responsephp php=php newphp Zendphp_Controllerphp_Responsephp_Httpphp(php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$methodphp php=php=php php'POSTphp'php)php php{
php php php php php php php php php php php php php$bodyphp php=php php"php<htmlphp>php<bodyphp onLoadphp=php\php"documentphp.formsphp[php0php]php.submitphp(php)php;php\php"php>php\nphp"php;
php php php php php php php php php php php php php$bodyphp php.php=php php"php<formphp methodphp=php\php"POSTphp\php"php actionphp=php\php"php$urlphp\php"php>php\nphp"php;
php php php php php php php php php php php php ifphp php(isphp_arrayphp(php$paramsphp)php php&php&php countphp(php$paramsphp)php php>php php0php)php php{
php php php php php php php php php php php php php php php php foreachphp(php$paramsphp asphp php$keyphp php=php>php php$valuephp)php php{
php php php php php php php php php php php php php php php php php php php php php$bodyphp php.php=php php'php<inputphp typephp=php"hiddenphp"php namephp=php"php'php php.php php$keyphp php.php php'php"php valuephp=php"php'php php.php php$valuephp php.php php"php\php"php>php\nphp"php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$bodyphp php.php=php php"php<inputphp typephp=php\php"submitphp\php"php valuephp=php\php"Continuephp OpenIDphp transactionphp\php"php>php\nphp"php;
php php php php php php php php php php php php php$bodyphp php.php=php php"<php/formphp><php/bodyphp><php/htmlphp>php\nphp"php;
php php php php php php php php php}php elsephp ifphp php(isphp_arrayphp(php$paramsphp)php php&php&php countphp(php$paramsphp)php php>php php0php)php php{
php php php php php php php php php php php php ifphp php(strposphp(php$urlphp,php php'php?php'php)php php=php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php php$urlphp php.php=php php'php?php'php php.php selfphp:php:paramsToQueryphp(php$paramsphp)php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$urlphp php.php=php php'php&php'php php.php selfphp:php:paramsToQueryphp(php$paramsphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php ifphp php(php!emptyphp(php$bodyphp)php)php php{
php php php php php php php php php php php php php$responsephp-php>setBodyphp(php$bodyphp)php;
php php php php php php php php php}php elsephp ifphp php(php!php$responsephp-php>canSendHeadersphp(php)php)php php{
php php php php php php php php php php php php php$responsephp-php>setBodyphp(php"php<scriptphp languagephp=php\php"JavaScriptphp\php"php"php php.
php php php php php php php php php php php php php php php php php php"php typephp=php\php"textphp/javascriptphp\php"php>windowphp.locationphp=php'php$urlphp'php;php"php php.
php php php php php php php php php php php php php php php php php php"<php/scriptphp>php"php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$responsephp-php>setRedirectphp(php$urlphp)php;
php php php php php php php php php}
php php php php php php php php php$responsephp-php>sendResponsephp(php)php;
php php php php php php php php ifphp php(selfphp:php:php$exitOnRedirectphp)php php{
php php php php php php php php php php php php exitphp(php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Producesphp stringphp ofphp randomphp bytephp ofphp givenphp lengthphp.
php php php php php php*
php php php php php php*php php@paramphp integerphp php$lenphp lengthphp ofphp requestedphp string
php php php php php php*php php@returnphp stringphp RAWphp randomphp binaryphp string
php php php php php php*php/
php php php php staticphp publicphp functionphp randomBytesphp(php$lenphp)
php php php php php{
php php php php php php php php php$keyphp php=php php'php'php;
php php php php php php php php forphp(php$iphp=php0php;php php$iphp <php php$lenphp;php php$iphp+php+php)php php{
php php php php php php php php php php php php php$keyphp php.php=php chrphp(mtphp_randphp(php0php,php php2php5php5php)php)php;
php php php php php php php php php}
php php php php php php php php returnphp php$keyphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Generatesphp aphp hashphp valuephp php(messagephp digestphp)php accordingphp tophp givenphp algorithmphp.
php php php php php php*php Itphp returnsphp RAWphp binaryphp stringphp.
php php php php php php*
php php php php php php*php Thisphp isphp aphp wrapperphp functionphp thatphp usesphp onephp ofphp availablephp internalphp function
php php php php php php*php dependentphp onphp givenphp PHPphp configurationphp.php Itphp mayphp usephp variousphp functionsphp from
php php php php php php*php php extphp/opensslphp,php extphp/hashphp,php extphp/mhashphp orphp extphp/standardphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$funcphp digestphp algorithm
php php php php php php*php php@paramphp stringphp php$dataphp dataphp tophp sign
php php php php php php*php php@returnphp stringphp RAWphp digitalphp signature
php php php php php php*php php@throwsphp Zendphp_OpenIdphp_Exception
php php php php php php*php/
php php php php staticphp publicphp functionphp digestphp(php$funcphp,php php$dataphp)
php php php php php{
php php php php php php php php ifphp php(functionphp_existsphp(php'opensslphp_digestphp'php)php)php php{
php php php php php php php php php php php php returnphp opensslphp_digestphp(php$dataphp,php php$funcphp,php truephp)php;
php php php php php php php php php}php elsephp ifphp php(functionphp_existsphp(php'hashphp'php)php)php php{
php php php php php php php php php php php php returnphp hashphp(php$funcphp,php php$dataphp,php truephp)php;
php php php php php php php php php}php elsephp ifphp php(php$funcphp php=php=php=php php'shaphp1php'php)php php{
php php php php php php php php php php php php returnphp shaphp1php(php$dataphp,php truephp)php;
php php php php php php php php php}php elsephp ifphp php(php$funcphp php=php=php=php php'shaphp2php5php6php'php)php php{
php php php php php php php php php php php php ifphp php(functionphp_existsphp(php'mhashphp'php)php)php php{
php php php php php php php php php php php php php php php php returnphp mhashphp(MHASHphp_SHAphp2php5php6php php,php php$dataphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php requirephp_oncephp php"Zendphp/OpenIdphp/Exceptionphp.phpphp"php;
php php php php php php php php throwphp newphp Zendphp_OpenIdphp_Exceptionphp(
php php php php php php php php php php php php php'Unsupportedphp digestphp algorithmphp php"php'php php.php php$funcphp php.php php'php"php.php'php,
php php php php php php php php php php php php Zendphp_OpenIdphp_Exceptionphp:php:UNSUPPORTEDphp_DIGESTphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Generatesphp aphp keyedphp hashphp valuephp usingphp thephp HMACphp methodphp.php Itphp usesphp extphp/hash
php php php php php php*php ifphp availablephp orphp userphp-levelphp PHPphp implementationphp,php thatphp isphp notphp significantly
php php php php php php*php slowerphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$macFuncphp namephp ofphp selectedphp hashingphp algorithmphp php(shaphp1php,php shaphp2php5php6php)
php php php php php php*php php@paramphp stringphp php$dataphp dataphp tophp sign
php php php php php php*php php@paramphp stringphp php$secretphp sharedphp secretphp keyphp usedphp forphp generatingphp thephp HMAC
php php php php php php*php php variantphp ofphp thephp messagephp digest
php php php php php php*php php@returnphp stringphp RAWphp HMACphp value
php php php php php php*php/
php php php php staticphp publicphp functionphp hashHmacphp(php$macFuncphp,php php$dataphp,php php$secretphp)
php php php php php{
php/php/php php php php php php php php requirephp_oncephp php"Zendphp/Cryptphp/Hmacphp.phpphp"php;
php/php/php php php php php php php php returnphp Zendphp_Cryptphp_Hmacphp:php:computephp(php$secretphp,php php$macFuncphp,php php$dataphp,php Zendphp_Cryptphp_Hmacphp:php:BINARYphp)php;
php php php php php php php php ifphp php(functionphp_existsphp(php'hashphp_hmacphp'php)php)php php{
php php php php php php php php php php php php returnphp hashphp_hmacphp(php$macFuncphp,php php$dataphp,php php$secretphp,php php1php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php ifphp php(Zendphp_OpenIdphp:php:strlenphp(php$secretphp)php php>php php6php4php)php php{
php php php php php php php php php php php php php php php php php$secretphp php=php selfphp:php:digestphp(php$macFuncphp,php php$secretphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$secretphp php=php strphp_padphp(php$secretphp,php php6php4php,php chrphp(php0xphp0php0php)php)php;
php php php php php php php php php php php php php$ipadphp php=php strphp_repeatphp(chrphp(php0xphp3php6php)php,php php6php4php)php;
php php php php php php php php php php php php php$opadphp php=php strphp_repeatphp(chrphp(php0xphp5cphp)php,php php6php4php)php;
php php php php php php php php php php php php php$hashphp1php php=php selfphp:php:digestphp(php$macFuncphp,php php(php$secretphp php^php php$ipadphp)php php.php php$dataphp)php;
php php php php php php php php php php php php returnphp selfphp:php:digestphp(php$macFuncphp,php php(php$secretphp php^php php$opadphp)php php.php php$hashphp1php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Convertsphp binaryphp representationphp intophp extphp/gmpphp orphp extphp/bcmathphp bigphp integer
php php php php php php*php representationphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$binphp binaryphp representationphp ofphp bigphp number
php php php php php php*php php@returnphp mixed
php php php php php php*php php@throwsphp Zendphp_OpenIdphp_Exception
php php php php php php*php/
php php php php staticphp protectedphp functionphp binToBigNumphp(php$binphp)
php php php php php{
php php php php php php php php ifphp php(extensionphp_loadedphp(php'gmpphp'php)php)php php{
php php php php php php php php php php php php returnphp gmpphp_initphp(binphp2hexphp(php$binphp)php,php php1php6php)php;
php php php php php php php php php}php elsephp ifphp php(extensionphp_loadedphp(php'bcmathphp'php)php)php php{
php php php php php php php php php php php php php$bnphp php=php php0php;
php php php php php php php php php php php php php$lenphp php=php Zendphp_OpenIdphp:php:strlenphp(php$binphp)php;
php php php php php php php php php php php php forphp php(php$iphp php=php php0php;php php$iphp <php php$lenphp;php php$iphp+php+php)php php{
php php php php php php php php php php php php php php php php php$bnphp php=php bcmulphp(php$bnphp,php php2php5php6php)php;
php php php php php php php php php php php php php php php php php$bnphp php=php bcaddphp(php$bnphp,php ordphp(php$binphp[php$iphp]php)php)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php returnphp php$bnphp;
php php php php php php php php php}
php php php php php php php php requirephp_oncephp php"Zendphp/OpenIdphp/Exceptionphp.phpphp"php;
php php php php php php php php throwphp newphp Zendphp_OpenIdphp_Exceptionphp(
php php php php php php php php php php php php php'Thephp systemphp doesnphp\php'tphp havephp properphp bigphp integerphp extensionphp'php,
php php php php php php php php php php php php Zendphp_OpenIdphp_Exceptionphp:php:UNSUPPORTEDphp_LONGphp_MATHphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Convertsphp internalphp extphp/gmpphp orphp extphp/bcmathphp bigphp integerphp representationphp into
php php php php php php*php binaryphp stringphp.
php php php php php php*
php php php php php php*php php@paramphp mixedphp php$bnphp bigphp number
php php php php php php*php php@returnphp string
php php php php php php*php php@throwsphp Zendphp_OpenIdphp_Exception
php php php php php php*php/
php php php php staticphp protectedphp functionphp bigNumToBinphp(php$bnphp)
php php php php php{
php php php php php php php php ifphp php(extensionphp_loadedphp(php'gmpphp'php)php)php php{
php php php php php php php php php php php php php$sphp php=php gmpphp_strvalphp(php$bnphp,php php1php6php)php;
php php php php php php php php php php php php ifphp php(strlenphp(php$sphp)php php%php php2php php!php=php php0php)php php{
php php php php php php php php php php php php php php php php php$sphp php=php php'php0php'php php.php php$sphp;
php php php php php php php php php php php php php}php elsephp ifphp php(php$sphp[php0php]php php>php php'php7php'php)php php{
php php php php php php php php php php php php php php php php php$sphp php=php php'php0php0php'php php.php php$sphp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php returnphp packphp(php"Hphp*php"php,php php$sphp)php;
php php php php php php php php php}php elsephp ifphp php(extensionphp_loadedphp(php'bcmathphp'php)php)php php{
php php php php php php php php php php php php php$cmpphp php=php bccompphp(php$bnphp,php php0php)php;
php php php php php php php php php php php php ifphp php(php$cmpphp php=php=php php0php)php php{
php php php php php php php php php php php php php php php php returnphp php"php\php0php"php;
php php php php php php php php php php php php php}php elsephp ifphp php(php$cmpphp <php php0php)php php{
php php php php php php php php php php php php php php php php requirephp_oncephp php"Zendphp/OpenIdphp/Exceptionphp.phpphp"php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_OpenIdphp_Exceptionphp(
php php php php php php php php php php php php php php php php php php php php php'Bigphp integerphp arithmeticphp errorphp'php,
php php php php php php php php php php php php php php php php php php php php Zendphp_OpenIdphp_Exceptionphp:php:ERRORphp_LONGphp_MATHphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$binphp php=php php"php"php;
php php php php php php php php php php php php whilephp php(bccompphp(php$bnphp,php php0php)php php>php php0php)php php{
php php php php php php php php php php php php php php php php php$binphp php=php chrphp(bcmodphp(php$bnphp,php php2php5php6php)php)php php.php php$binphp;
php php php php php php php php php php php php php php php php php$bnphp php=php bcdivphp(php$bnphp,php php2php5php6php)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php ifphp php(ordphp(php$binphp[php0php]php)php php>php php1php2php7php)php php{
php php php php php php php php php php php php php php php php php$binphp php=php php"php\php0php"php php.php php$binphp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php returnphp php$binphp;
php php php php php php php php php}
php php php php php php php php requirephp_oncephp php"Zendphp/OpenIdphp/Exceptionphp.phpphp"php;
php php php php php php php php throwphp newphp Zendphp_OpenIdphp_Exceptionphp(
php php php php php php php php php php php php php'Thephp systemphp doesnphp\php'tphp havephp properphp bigphp integerphp extensionphp'php,
php php php php php php php php php php php php Zendphp_OpenIdphp_Exceptionphp:php:UNSUPPORTEDphp_LONGphp_MATHphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Performsphp thephp firstphp stepphp ofphp aphp Diffiephp-Hellmanphp keyphp exchangephp byphp generating
php php php php php php*php privatephp andphp publicphp DHphp valuesphp basedphp onphp givenphp primephp numberphp php$pphp and
php php php php php php*php generatorphp php$gphp.php Bothphp sidesphp ofphp keyphp exchangephp MUSTphp havephp thephp samephp primephp number
php php php php php php*php andphp generatorphp.php Inphp thisphp casephp theyphp willphp ablephp tophp createphp aphp randomphp shared
php php php php php php*php secretphp thatphp isphp neverphp sendphp fromphp onephp tophp thephp otherphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$pphp primephp numberphp inphp binaryphp representation
php php php php php php*php php@paramphp stringphp php$gphp generatorphp inphp binaryphp representation
php php php php php php*php php@paramphp stringphp php$privphp_keyphp privatephp keyphp inphp binaryphp representation
php php php php php php*php php@returnphp mixed
php php php php php php*php/
php php php php staticphp publicphp functionphp createDhKeyphp(php$pphp,php php$gphp,php php$privphp_keyphp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(functionphp_existsphp(php'opensslphp_dhphp_computephp_keyphp'php)php)php php{
php php php php php php php php php php php php php$dhphp_detailsphp php=php arrayphp(
php php php php php php php php php php php php php php php php php php php php php'pphp'php php=php>php php$pphp,
php php php php php php php php php php php php php php php php php php php php php'gphp'php php=php>php php$g
php php php php php php php php php php php php php php php php php)php;
php php php php php php php php php php php php ifphp php(php$privphp_keyphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php$dhphp_detailsphp[php'privphp_keyphp'php]php php=php php$privphp_keyphp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php returnphp opensslphp_pkeyphp_newphp(arrayphp(php'dhphp'php=php>php$dhphp_detailsphp)php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$bnphp_pphp php php php php php php php php=php selfphp:php:binToBigNumphp(php$pphp)php;
php php php php php php php php php php php php php$bnphp_gphp php php php php php php php php=php selfphp:php:binToBigNumphp(php$gphp)php;
php php php php php php php php php php php php ifphp php(php$privphp_keyphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php$privphp_keyphp php php php php=php selfphp:php:randomBytesphp(Zendphp_OpenIdphp:php:strlenphp(php$pphp)php)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$bnphp_privphp_keyphp php=php selfphp:php:binToBigNumphp(php$privphp_keyphp)php;
php php php php php php php php php php php php ifphp php(extensionphp_loadedphp(php'gmpphp'php)php)php php{
php php php php php php php php php php php php php php php php php$bnphp_pubphp_keyphp php php=php gmpphp_powmphp(php$bnphp_gphp,php php$bnphp_privphp_keyphp,php php$bnphp_pphp)php;
php php php php php php php php php php php php php}php elsephp ifphp php(extensionphp_loadedphp(php'bcmathphp'php)php)php php{
php php php php php php php php php php php php php php php php php$bnphp_pubphp_keyphp php php=php bcpowmodphp(php$bnphp_gphp,php php$bnphp_privphp_keyphp,php php$bnphp_pphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$pubphp_keyphp php php php php php=php selfphp:php:bigNumToBinphp(php$bnphp_pubphp_keyphp)php;

php php php php php php php php php php php php returnphp arrayphp(
php php php php php php php php php php php php php php php php php'pphp'php php php php php php php php php=php>php php$bnphp_pphp,
php php php php php php php php php php php php php php php php php'gphp'php php php php php php php php php=php>php php$bnphp_gphp,
php php php php php php php php php php php php php php php php php'privphp_keyphp'php php=php>php php$bnphp_privphp_keyphp,
php php php php php php php php php php php php php php php php php'pubphp_keyphp'php php php=php>php php$bnphp_pubphp_keyphp,
php php php php php php php php php php php php php php php php php'detailsphp'php php php=php>php arrayphp(
php php php php php php php php php php php php php php php php php php php php php'pphp'php php php php php php php php php=php>php php$pphp,
php php php php php php php php php php php php php php php php php php php php php'gphp'php php php php php php php php php=php>php php$gphp,
php php php php php php php php php php php php php php php php php php php php php'privphp_keyphp'php php=php>php php$privphp_keyphp,
php php php php php php php php php php php php php php php php php php php php php'pubphp_keyphp'php php php=php>php php$pubphp_keyphp)php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp anphp associativephp arrayphp withphp Diffiephp-Hellmanphp keyphp componentsphp in
php php php php php php*php binaryphp representationphp.php Thephp arrayphp includesphp originalphp primephp numberphp php'pphp'php and
php php php php php php*php generatorphp php'gphp'php,php randomphp privatephp keyphp php'privphp_keyphp'php andphp correspondingphp public
php php php php php php*php keyphp php'pubphp_keyphp'php.
php php php php php php*
php php php php php php*php php@paramphp mixedphp php$dhphp Diffiephp-Hellmanphp key
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php staticphp publicphp functionphp getDhKeyDetailsphp(php$dhphp)
php php php php php{
php php php php php php php php ifphp php(functionphp_existsphp(php'opensslphp_dhphp_computephp_keyphp'php)php)php php{
php php php php php php php php php php php php php$detailsphp php=php opensslphp_pkeyphp_getphp_detailsphp(php$dhphp)php;
php php php php php php php php php php php php ifphp php(issetphp(php$detailsphp[php'dhphp'php]php)php)php php{
php php php php php php php php php php php php php php php php returnphp php$detailsphp[php'dhphp'php]php;
php php php php php php php php php php php php php}
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php returnphp php$dhphp[php'detailsphp'php]php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Computesphp thephp sharedphp secretphp fromphp thephp privatephp DHphp valuephp php$dhphp andphp thephp other
php php php php php php*php partyphp'sphp publicphp valuephp inphp php$pubphp_key
php php php php php php*
php php php php php php*php php@paramphp stringphp php$pubphp_keyphp otherphp partyphp'sphp publicphp value
php php php php php php*php php@paramphp mixedphp php$dhphp Diffiephp-Hellmanphp key
php php php php php php*php php@returnphp string
php php php php php php*php php@throwsphp Zendphp_OpenIdphp_Exception
php php php php php php*php/
php php php php staticphp publicphp functionphp computeDhSecretphp(php$pubphp_keyphp,php php$dhphp)
php php php php php{
php php php php php php php php ifphp php(functionphp_existsphp(php'opensslphp_dhphp_computephp_keyphp'php)php)php php{
php php php php php php php php php php php php php$retphp php=php opensslphp_dhphp_computephp_keyphp(php$pubphp_keyphp,php php$dhphp)php;
php php php php php php php php php php php php ifphp php(ordphp(php$retphp[php0php]php)php php>php php1php2php7php)php php{
php php php php php php php php php php php php php php php php php$retphp php=php php"php\php0php"php php.php php$retphp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php returnphp php$retphp;
php php php php php php php php php}php elsephp ifphp php(extensionphp_loadedphp(php'gmpphp'php)php)php php{
php php php php php php php php php php php php php$bnphp_pubphp_keyphp php=php selfphp:php:binToBigNumphp(php$pubphp_keyphp)php;
php php php php php php php php php php php php php$bnphp_secretphp php php=php gmpphp_powmphp(php$bnphp_pubphp_keyphp,php php$dhphp[php'privphp_keyphp'php]php,php php$dhphp[php'pphp'php]php)php;
php php php php php php php php php php php php returnphp selfphp:php:bigNumToBinphp(php$bnphp_secretphp)php;
php php php php php php php php php}php elsephp ifphp php(extensionphp_loadedphp(php'bcmathphp'php)php)php php{
php php php php php php php php php php php php php$bnphp_pubphp_keyphp php=php selfphp:php:binToBigNumphp(php$pubphp_keyphp)php;
php php php php php php php php php php php php php$bnphp_secretphp php php=php bcpowmodphp(php$bnphp_pubphp_keyphp,php php$dhphp[php'privphp_keyphp'php]php,php php$dhphp[php'pphp'php]php)php;
php php php php php php php php php php php php returnphp selfphp:php:bigNumToBinphp(php$bnphp_secretphp)php;
php php php php php php php php php}
php php php php php php php php requirephp_oncephp php"Zendphp/OpenIdphp/Exceptionphp.phpphp"php;
php php php php php php php php throwphp newphp Zendphp_OpenIdphp_Exceptionphp(
php php php php php php php php php php php php php'Thephp systemphp doesnphp\php'tphp havephp properphp bigphp integerphp extensionphp'php,
php php php php php php php php php php php php Zendphp_OpenIdphp_Exceptionphp:php:UNSUPPORTEDphp_LONGphp_MATHphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Takesphp anphp arbitraryphp precisionphp integerphp andphp returnsphp itsphp shortestphp bigphp-endian
php php php php php php*php twophp'sphp complementphp representationphp.
php php php php php php*
php php php php php php*php Arbitraryphp precisionphp integersphp MUSTphp bephp encodedphp asphp bigphp-endianphp signedphp twophp's
php php php php php php*php complementphp binaryphp stringsphp.php Henceforthphp,php php"btwocphp"php isphp aphp functionphp thatphp takes
php php php php php php*php anphp arbitraryphp precisionphp integerphp andphp returnsphp itsphp shortestphp bigphp-endianphp twophp's
php php php php php php*php complementphp representationphp.php Allphp integersphp thatphp arephp usedphp with
php php php php php php*php Diffiephp-Hellmanphp Keyphp Exchangephp arephp positivephp.php Thisphp meansphp thatphp thephp leftphp-most
php php php php php php*php bitphp ofphp thephp twophp'sphp complementphp representationphp MUSTphp bephp zerophp.php Ifphp itphp isphp notphp,
php php php php php php*php implementationsphp MUSTphp addphp aphp zerophp bytephp atphp thephp frontphp ofphp thephp stringphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$strphp binaryphp representationphp ofphp arbitraryphp precisionphp integer
php php php php php php*php php@returnphp stringphp bigphp-endianphp signedphp representation
php php php php php php*php/
php php php php staticphp publicphp functionphp btwocphp(php$strphp)
php php php php php{
php php php php php php php php ifphp php(ordphp(php$strphp[php0php]php)php php>php php1php2php7php)php php{
php php php php php php php php php php php php returnphp php"php\php0php"php php.php php$strphp;
php php php php php php php php php}
php php php php php php php php returnphp php$strphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp lenghtphp ofphp binaryphp stringphp inphp bytes
php php php php php php*
php php php php php php*php php@paramphp stringphp php$str
php php php php php php*php php@returnphp intphp thephp stringphp lenght
php php php php php php*php/
php php php php staticphp publicphp functionphp strlenphp(php$strphp)
php php php php php{
php php php php php php php php ifphp php(extensionphp_loadedphp(php'mbstringphp'php)php php&php&
php php php php php php php php php php php php php(php(php(intphp)iniphp_getphp(php'mbstringphp.funcphp_overloadphp'php)php)php php&php php2php)php)php php{
php php php php php php php php php php php php returnphp mbphp_strlenphp(php$strphp,php php'latinphp1php'php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php returnphp strlenphp(php$strphp)php;
php php php php php php php php php}
php php php php php}

php}
