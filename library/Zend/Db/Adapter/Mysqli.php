<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Db
php php*php php@subpackagephp Adapter
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Mysqliphp.phpphp php2php0php0php9php6php php2php0php1php0php-php0php1php-php0php6php php0php2php:php0php5php:php0php9Zphp bkarwinphp php$
php php*php/


php/php*php*
php php*php php@seephp Zendphp_Dbphp_Adapterphp_Abstract
php php*php/
requirephp_oncephp php'Zendphp/Dbphp/Adapterphp/Abstractphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Dbphp_Profiler
php php*php/
requirephp_oncephp php'Zendphp/Dbphp/Profilerphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Dbphp_Select
php php*php/
requirephp_oncephp php'Zendphp/Dbphp/Selectphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Dbphp_Statementphp_Mysqli
php php*php/
requirephp_oncephp php'Zendphp/Dbphp/Statementphp/Mysqliphp.phpphp'php;


php/php*php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Db
php php*php php@subpackagephp Adapter
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_Dbphp_Adapterphp_Mysqliphp extendsphp Zendphp_Dbphp_Adapterphp_Abstract
php{

php php php php php/php*php*
php php php php php php*php Keysphp arephp UPPERCASEphp SQLphp datatypesphp orphp thephp constants
php php php php php php*php Zendphp_Dbphp:php:INTphp_TYPEphp,php Zendphp_Dbphp:php:BIGINTphp_TYPEphp,php orphp Zendphp_Dbphp:php:FLOATphp_TYPEphp.
php php php php php php*
php php php php php php*php Valuesphp arephp:
php php php php php php*php php0php php=php php3php2php-bitphp integer
php php php php php php*php php1php php=php php6php4php-bitphp integer
php php php php php php*php php2php php=php floatphp orphp decimal
php php php php php php*
php php php php php php*php php@varphp arrayphp Associativephp arrayphp ofphp datatypesphp tophp valuesphp php0php,php php1php,php orphp php2php.
php php php php php php*php/
php php php php protectedphp php$php_numericDataTypesphp php=php arrayphp(
php php php php php php php php Zendphp_Dbphp:php:INTphp_TYPEphp php php php php=php>php Zendphp_Dbphp:php:INTphp_TYPEphp,
php php php php php php php php Zendphp_Dbphp:php:BIGINTphp_TYPEphp php=php>php Zendphp_Dbphp:php:BIGINTphp_TYPEphp,
php php php php php php php php Zendphp_Dbphp:php:FLOATphp_TYPEphp php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPEphp,
php php php php php php php php php'INTphp'php php php php php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:INTphp_TYPEphp,
php php php php php php php php php'INTEGERphp'php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:INTphp_TYPEphp,
php php php php php php php php php'MEDIUMINTphp'php php php php php php php php php php php=php>php Zendphp_Dbphp:php:INTphp_TYPEphp,
php php php php php php php php php'SMALLINTphp'php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:INTphp_TYPEphp,
php php php php php php php php php'TINYINTphp'php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:INTphp_TYPEphp,
php php php php php php php php php'BIGINTphp'php php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:BIGINTphp_TYPEphp,
php php php php php php php php php'SERIALphp'php php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:BIGINTphp_TYPEphp,
php php php php php php php php php'DECphp'php php php php php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPEphp,
php php php php php php php php php'DECIMALphp'php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPEphp,
php php php php php php php php php'DOUBLEphp'php php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPEphp,
php php php php php php php php php'DOUBLEphp PRECISIONphp'php php php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPEphp,
php php php php php php php php php'FIXEDphp'php php php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPEphp,
php php php php php php php php php'FLOATphp'php php php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPE
php php php php php)php;

php php php php php/php*php*
php php php php php php*php php@varphp Zendphp_Dbphp_Statementphp_Mysqli
php php php php php php*php/
php php php php protectedphp php$php_stmtphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php Defaultphp classphp namephp forphp aphp DBphp statementphp.
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_defaultStmtClassphp php=php php'Zendphp_Dbphp_Statementphp_Mysqliphp'php;

php php php php php/php*php*
php php php php php php*php Quotephp aphp rawphp stringphp.
php php php php php php*
php php php php php php*php php@paramphp mixedphp php$valuephp Rawphp string
php php php php php php*
php php php php php php*php php@returnphp stringphp php php php php php php php php php php Quotedphp string
php php php php php php*php/
php php php php protectedphp functionphp php_quotephp(php$valuephp)
php php php php php{
php php php php php php php php ifphp php(isphp_intphp(php$valuephp)php php|php|php isphp_floatphp(php$valuephp)php)php php{
php php php php php php php php php php php php returnphp php$valuephp;
php php php php php php php php php}
php php php php php php php php php$thisphp-php>php_connectphp(php)php;
php php php php php php php php returnphp php"php'php"php php.php php$thisphp-php>php_connectionphp-php>realphp_escapephp_stringphp(php$valuephp)php php.php php"php'php"php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp thephp symbolphp thephp adapterphp usesphp forphp delimitingphp identifiersphp.
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getQuoteIdentifierSymbolphp(php)
php php php php php{
php php php php php php php php returnphp php"php`php"php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp aphp listphp ofphp thephp tablesphp inphp thephp databasephp.
php php php php php php*
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp listTablesphp(php)
php php php php php{
php php php php php php php php php$resultphp php=php arrayphp(php)php;
php php php php php php php php php/php/php Usephp mysqliphp extensionphp APIphp,php becausephp SHOWphp doesnphp'tphp work
php php php php php php php php php/php/php wellphp asphp aphp preparedphp statementphp onphp MySQLphp php4php.php1php.
php php php php php php php php php$sqlphp php=php php'SHOWphp TABLESphp'php;
php php php php php php php php ifphp php(php$queryResultphp php=php php$thisphp-php>getConnectionphp(php)php-php>queryphp(php$sqlphp)php)php php{
php php php php php php php php php php php php whilephp php(php$rowphp php=php php$queryResultphp-php>fetchphp_rowphp(php)php)php php{
php php php php php php php php php php php php php php php php php$resultphp[php]php php=php php$rowphp[php0php]php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$queryResultphp-php>closephp(php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php*php php@seephp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exception
php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Dbphp/Adapterphp/Mysqliphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exceptionphp(php$thisphp-php>getConnectionphp(php)php-php>errorphp)php;
php php php php php php php php php}
php php php php php php php php returnphp php$resultphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp thephp columnphp descriptionsphp forphp aphp tablephp.
php php php php php php*
php php php php php php*php Thephp returnphp valuephp isphp anphp associativephp arrayphp keyedphp byphp thephp columnphp namephp,
php php php php php php*php asphp returnedphp byphp thephp RDBMSphp.
php php php php php php*
php php php php php php*php Thephp valuephp ofphp eachphp arrayphp elementphp isphp anphp associativephp array
php php php php php php*php withphp thephp followingphp keysphp:
php php php php php php*
php php php php php php*php SCHEMAphp_NAMEphp php php php php php php=php>php stringphp;php namephp ofphp databasephp orphp schema
php php php php php php*php TABLEphp_NAMEphp php php php php php php php=php>php stringphp;
php php php php php php*php COLUMNphp_NAMEphp php php php php php php=php>php stringphp;php columnphp name
php php php php php php*php COLUMNphp_POSITIONphp php php=php>php numberphp;php ordinalphp positionphp ofphp columnphp inphp table
php php php php php php*php DATAphp_TYPEphp php php php php php php php php=php>php stringphp;php SQLphp datatypephp namephp ofphp column
php php php php php php*php DEFAULTphp php php php php php php php php php php=php>php stringphp;php defaultphp expressionphp ofphp columnphp,php nullphp ifphp none
php php php php php php*php NULLABLEphp php php php php php php php php php=php>php booleanphp;php truephp ifphp columnphp canphp havephp nulls
php php php php php php*php LENGTHphp php php php php php php php php php php php=php>php numberphp;php lengthphp ofphp CHARphp/VARCHAR
php php php php php php*php SCALEphp php php php php php php php php php php php php=php>php numberphp;php scalephp ofphp NUMERICphp/DECIMAL
php php php php php php*php PRECISIONphp php php php php php php php php=php>php numberphp;php precisionphp ofphp NUMERICphp/DECIMAL
php php php php php php*php UNSIGNEDphp php php php php php php php php php=php>php booleanphp;php unsignedphp propertyphp ofphp anphp integerphp type
php php php php php php*php PRIMARYphp php php php php php php php php php php=php>php booleanphp;php truephp ifphp columnphp isphp partphp ofphp thephp primaryphp key
php php php php php php*php PRIMARYphp_POSITIONphp php=php>php integerphp;php positionphp ofphp columnphp inphp primaryphp key
php php php php php php*php IDENTITYphp php php php php php php php php php=php>php integerphp;php truephp ifphp columnphp isphp autophp-generatedphp withphp uniquephp values
php php php php php php*
php php php php php php*php php@paramphp stringphp php$tableName
php php php php php php*php php@paramphp stringphp php$schemaNamephp OPTIONAL
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp describeTablephp(php$tableNamephp,php php$schemaNamephp php=php nullphp)
php php php php php{
php php php php php php php php php/php*php*
php php php php php php php php php php*php php@todophp php usephp INFORMATIONphp_SCHEMAphp somedayphp when
php php php php php php php php php php*php MySQLphp'sphp implementationphp isnphp'tphp toophp slowphp.
php php php php php php php php php php*php/

php php php php php php php php ifphp php(php$schemaNamephp)php php{
php php php php php php php php php php php php php$sqlphp php=php php'DESCRIBEphp php'php php.php php$thisphp-php>quoteIdentifierphp(php"php$schemaNamephp.php$tableNamephp"php,php truephp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$sqlphp php=php php'DESCRIBEphp php'php php.php php$thisphp-php>quoteIdentifierphp(php$tableNamephp,php truephp)php;
php php php php php php php php php}

php php php php php php php php php/php*php*
php php php php php php php php php php*php Usephp mysqliphp extensionphp APIphp,php becausephp DESCRIBEphp doesnphp'tphp work
php php php php php php php php php php*php wellphp asphp aphp preparedphp statementphp onphp MySQLphp php4php.php1php.
php php php php php php php php php php*php/
php php php php php php php php ifphp php(php$queryResultphp php=php php$thisphp-php>getConnectionphp(php)php-php>queryphp(php$sqlphp)php)php php{
php php php php php php php php php php php php whilephp php(php$rowphp php=php php$queryResultphp-php>fetchphp_assocphp(php)php)php php{
php php php php php php php php php php php php php php php php php$resultphp[php]php php=php php$rowphp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$queryResultphp-php>closephp(php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php*php php@seephp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exception
php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Dbphp/Adapterphp/Mysqliphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exceptionphp(php$thisphp-php>getConnectionphp(php)php-php>errorphp)php;
php php php php php php php php php}

php php php php php php php php php$descphp php=php arrayphp(php)php;

php php php php php php php php php$rowphp_defaultsphp php=php arrayphp(
php php php php php php php php php php php php php'Lengthphp'php php php php php php php php php php php=php>php nullphp,
php php php php php php php php php php php php php'Scalephp'php php php php php php php php php php php php=php>php nullphp,
php php php php php php php php php php php php php'Precisionphp'php php php php php php php php=php>php nullphp,
php php php php php php php php php php php php php'Unsignedphp'php php php php php php php php php=php>php nullphp,
php php php php php php php php php php php php php'Primaryphp'php php php php php php php php php php=php>php falsephp,
php php php php php php php php php php php php php'PrimaryPositionphp'php php=php>php nullphp,
php php php php php php php php php php php php php'Identityphp'php php php php php php php php php=php>php false
php php php php php php php php php)php;
php php php php php php php php php$iphp php=php php1php;
php php php php php php php php php$pphp php=php php1php;
php php php php php php php php foreachphp php(php$resultphp asphp php$keyphp php=php>php php$rowphp)php php{
php php php php php php php php php php php php php$rowphp php=php arrayphp_mergephp(php$rowphp_defaultsphp,php php$rowphp)php;
php php php php php php php php php php php php ifphp php(pregphp_matchphp(php'php/unsignedphp/php'php,php php$rowphp[php'Typephp'php]php)php)php php{
php php php php php php php php php php php php php php php php php$rowphp[php'Unsignedphp'php]php php=php truephp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php ifphp php(pregphp_matchphp(php'php/php^php(php(php?php:varphp)php?charphp)php\php(php(php\dphp+php)php\php)php/php'php,php php$rowphp[php'Typephp'php]php,php php$matchesphp)php)php php{
php php php php php php php php php php php php php php php php php$rowphp[php'Typephp'php]php php=php php$matchesphp[php1php]php;
php php php php php php php php php php php php php php php php php$rowphp[php'Lengthphp'php]php php=php php$matchesphp[php2php]php;
php php php php php php php php php php php php php}php elsephp ifphp php(pregphp_matchphp(php'php/php^decimalphp\php(php(php\dphp+php)php,php(php\dphp+php)php\php)php/php'php,php php$rowphp[php'Typephp'php]php,php php$matchesphp)php)php php{
php php php php php php php php php php php php php php php php php$rowphp[php'Typephp'php]php php=php php'decimalphp'php;
php php php php php php php php php php php php php php php php php$rowphp[php'Precisionphp'php]php php=php php$matchesphp[php1php]php;
php php php php php php php php php php php php php php php php php$rowphp[php'Scalephp'php]php php=php php$matchesphp[php2php]php;
php php php php php php php php php php php php php}php elsephp ifphp php(pregphp_matchphp(php'php/php^floatphp\php(php(php\dphp+php)php,php(php\dphp+php)php\php)php/php'php,php php$rowphp[php'Typephp'php]php,php php$matchesphp)php)php php{
php php php php php php php php php php php php php php php php php$rowphp[php'Typephp'php]php php=php php'floatphp'php;
php php php php php php php php php php php php php php php php php$rowphp[php'Precisionphp'php]php php=php php$matchesphp[php1php]php;
php php php php php php php php php php php php php php php php php$rowphp[php'Scalephp'php]php php=php php$matchesphp[php2php]php;
php php php php php php php php php php php php php}php elsephp ifphp php(pregphp_matchphp(php'php/php^php(php(php?php:bigphp|mediumphp|smallphp|tinyphp)php?intphp)php\php(php(php\dphp+php)php\php)php/php'php,php php$rowphp[php'Typephp'php]php,php php$matchesphp)php)php php{
php php php php php php php php php php php php php php php php php$rowphp[php'Typephp'php]php php=php php$matchesphp[php1php]php;
php php php php php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php php php php php*php Thephp optionalphp argumentphp ofphp aphp MySQLphp intphp typephp isphp notphp precision
php php php php php php php php php php php php php php php php php php*php orphp lengthphp;php itphp isphp onlyphp aphp hintphp forphp displayphp widthphp.
php php php php php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php php}
php php php php php php php php php php php php ifphp php(strtoupperphp(php$rowphp[php'Keyphp'php]php)php php=php=php php'PRIphp'php)php php{
php php php php php php php php php php php php php php php php php$rowphp[php'Primaryphp'php]php php=php truephp;
php php php php php php php php php php php php php php php php php$rowphp[php'PrimaryPositionphp'php]php php=php php$pphp;
php php php php php php php php php php php php php php php php ifphp php(php$rowphp[php'Extraphp'php]php php=php=php php'autophp_incrementphp'php)php php{
php php php php php php php php php php php php php php php php php php php php php$rowphp[php'Identityphp'php]php php=php truephp;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php$rowphp[php'Identityphp'php]php php=php falsephp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php+php+php$pphp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$descphp[php$thisphp-php>foldCasephp(php$rowphp[php'Fieldphp'php]php)php]php php=php arrayphp(
php php php php php php php php php php php php php php php php php'SCHEMAphp_NAMEphp'php php php php php php php=php>php nullphp,php php/php/php php@todo
php php php php php php php php php php php php php php php php php'TABLEphp_NAMEphp'php php php php php php php php=php>php php$thisphp-php>foldCasephp(php$tableNamephp)php,
php php php php php php php php php php php php php php php php php'COLUMNphp_NAMEphp'php php php php php php php=php>php php$thisphp-php>foldCasephp(php$rowphp[php'Fieldphp'php]php)php,
php php php php php php php php php php php php php php php php php'COLUMNphp_POSITIONphp'php php php=php>php php$iphp,
php php php php php php php php php php php php php php php php php'DATAphp_TYPEphp'php php php php php php php php php=php>php php$rowphp[php'Typephp'php]php,
php php php php php php php php php php php php php php php php php'DEFAULTphp'php php php php php php php php php php php=php>php php$rowphp[php'Defaultphp'php]php,
php php php php php php php php php php php php php php php php php'NULLABLEphp'php php php php php php php php php php=php>php php(boolphp)php php(php$rowphp[php'Nullphp'php]php php=php=php php'YESphp'php)php,
php php php php php php php php php php php php php php php php php'LENGTHphp'php php php php php php php php php php php php=php>php php$rowphp[php'Lengthphp'php]php,
php php php php php php php php php php php php php php php php php'SCALEphp'php php php php php php php php php php php php php=php>php php$rowphp[php'Scalephp'php]php,
php php php php php php php php php php php php php php php php php'PRECISIONphp'php php php php php php php php php=php>php php$rowphp[php'Precisionphp'php]php,
php php php php php php php php php php php php php php php php php'UNSIGNEDphp'php php php php php php php php php php=php>php php$rowphp[php'Unsignedphp'php]php,
php php php php php php php php php php php php php php php php php'PRIMARYphp'php php php php php php php php php php php=php>php php$rowphp[php'Primaryphp'php]php,
php php php php php php php php php php php php php php php php php'PRIMARYphp_POSITIONphp'php php=php>php php$rowphp[php'PrimaryPositionphp'php]php,
php php php php php php php php php php php php php php php php php'IDENTITYphp'php php php php php php php php php php=php>php php$rowphp[php'Identityphp'php]
php php php php php php php php php php php php php)php;
php php php php php php php php php php php php php+php+php$iphp;
php php php php php php php php php}
php php php php php php php php returnphp php$descphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Createsphp aphp connectionphp tophp thephp databasephp.
php php php php php php*
php php php php php php*php php@returnphp void
php php php php php php*php php@throwsphp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exception
php php php php php php*php/
php php php php protectedphp functionphp php_connectphp(php)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_connectionphp)php php{
php php php php php php php php php php php php returnphp;
php php php php php php php php php}

php php php php php php php php ifphp php(php!extensionphp_loadedphp(php'mysqliphp'php)php)php php{
php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php*php php@seephp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exception
php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Dbphp/Adapterphp/Mysqliphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exceptionphp(php'Thephp Mysqliphp extensionphp isphp requiredphp forphp thisphp adapterphp butphp thephp extensionphp isphp notphp loadedphp'php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(issetphp(php$thisphp-php>php_configphp[php'portphp'php]php)php)php php{
php php php php php php php php php php php php php$portphp php=php php(integerphp)php php$thisphp-php>php_configphp[php'portphp'php]php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$portphp php=php nullphp;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_connectionphp php=php mysqliphp_initphp(php)php;

php php php php php php php php ifphp(php!emptyphp(php$thisphp-php>php_configphp[php'driverphp_optionsphp'php]php)php)php php{
php php php php php php php php php php php php foreachphp(php$thisphp-php>php_configphp[php'driverphp_optionsphp'php]php asphp php$optionphp=php>php$valuephp)php php{
php php php php php php php php php php php php php php php php ifphp(isphp_stringphp(php$optionphp)php)php php{
php php php php php php php php php php php php php php php php php php php php php/php/php Suppressphp warningsphp here
php php php php php php php php php php php php php php php php php php php php php/php/php Ignorephp itphp ifphp itphp'sphp notphp aphp validphp constant
php php php php php php php php php php php php php php php php php php php php php$optionphp php=php php@constantphp(strtoupperphp(php$optionphp)php)php;
php php php php php php php php php php php php php php php php php php php php ifphp(php$optionphp php=php=php=php nullphp)
php php php php php php php php php php php php php php php php php php php php php php php php continuephp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php mysqliphp_optionsphp(php$thisphp-php>php_connectionphp,php php$optionphp,php php$valuephp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php/php/php Suppressphp connectionphp warningsphp herephp.
php php php php php php php php php/php/php Throwphp anphp exceptionphp insteadphp.
php php php php php php php php php$php_isConnectedphp php=php php@mysqliphp_realphp_connectphp(
php php php php php php php php php php php php php$thisphp-php>php_connectionphp,
php php php php php php php php php php php php php$thisphp-php>php_configphp[php'hostphp'php]php,
php php php php php php php php php php php php php$thisphp-php>php_configphp[php'usernamephp'php]php,
php php php php php php php php php php php php php$thisphp-php>php_configphp[php'passwordphp'php]php,
php php php php php php php php php php php php php$thisphp-php>php_configphp[php'dbnamephp'php]php,
php php php php php php php php php php php php php$port
php php php php php php php php php)php;

php php php php php php php php ifphp php(php$php_isConnectedphp php=php=php=php falsephp php|php|php mysqliphp_connectphp_errnophp(php)php)php php{

php php php php php php php php php php php php php$thisphp-php>closeConnectionphp(php)php;
php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php*php php@seephp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exception
php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Dbphp/Adapterphp/Mysqliphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exceptionphp(mysqliphp_connectphp_errorphp(php)php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!emptyphp(php$thisphp-php>php_configphp[php'charsetphp'php]php)php)php php{
php php php php php php php php php php php php mysqliphp_setphp_charsetphp(php$thisphp-php>php_connectionphp,php php$thisphp-php>php_configphp[php'charsetphp'php]php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Testphp ifphp aphp connectionphp isphp active
php php php php php php*
php php php php php php*php php@returnphp boolean
php php php php php php*php/
php php php php publicphp functionphp isConnectedphp(php)
php php php php php{
php php php php php php php php returnphp php(php(boolphp)php php(php$thisphp-php>php_connectionphp instanceofphp mysqliphp)php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Forcephp thephp connectionphp tophp closephp.
php php php php php php*
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php publicphp functionphp closeConnectionphp(php)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>isConnectedphp(php)php)php php{
php php php php php php php php php php php php php$thisphp-php>php_connectionphp-php>closephp(php)php;
php php php php php php php php php}
php php php php php php php php php$thisphp-php>php_connectionphp php=php nullphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Preparephp aphp statementphp andphp returnphp aphp PDOStatementphp-likephp objectphp.
php php php php php php*
php php php php php php*php php@paramphp php stringphp php php$sqlphp php SQLphp query
php php php php php php*php php@returnphp Zendphp_Dbphp_Statementphp_Mysqli
php php php php php php*php/
php php php php publicphp functionphp preparephp(php$sqlphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_connectphp(php)php;
php php php php php php php php ifphp php(php$thisphp-php>php_stmtphp)php php{
php php php php php php php php php php php php php$thisphp-php>php_stmtphp-php>closephp(php)php;
php php php php php php php php php}
php php php php php php php php php$stmtClassphp php=php php$thisphp-php>php_defaultStmtClassphp;
php php php php php php php php ifphp php(php!classphp_existsphp(php$stmtClassphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Loaderphp.phpphp'php;
php php php php php php php php php php php php Zendphp_Loaderphp:php:loadClassphp(php$stmtClassphp)php;
php php php php php php php php php}
php php php php php php php php php$stmtphp php=php newphp php$stmtClassphp(php$thisphp,php php$sqlphp)php;
php php php php php php php php ifphp php(php$stmtphp php=php=php=php falsephp)php php{
php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php}
php php php php php php php php php$stmtphp-php>setFetchModephp(php$thisphp-php>php_fetchModephp)php;
php php php php php php php php php$thisphp-php>php_stmtphp php=php php$stmtphp;
php php php php php php php php returnphp php$stmtphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getsphp thephp lastphp IDphp generatedphp automaticallyphp byphp anphp IDENTITYphp/AUTOINCREMENTphp columnphp.
php php php php php php*
php php php php php php*php Asphp aphp conventionphp,php onphp RDBMSphp brandsphp thatphp supportphp sequences
php php php php php php*php php(ephp.gphp.php Oraclephp,php PostgreSQLphp,php DBphp2php)php,php thisphp methodphp formsphp thephp namephp ofphp aphp sequence
php php php php php php*php fromphp thephp argumentsphp andphp returnsphp thephp lastphp idphp generatedphp byphp thatphp sequencephp.
php php php php php php*php Onphp RDBMSphp brandsphp thatphp supportphp IDENTITYphp/AUTOINCREMENTphp columnsphp,php thisphp method
php php php php php php*php returnsphp thephp lastphp valuephp generatedphp forphp suchphp aphp columnphp,php andphp thephp tablephp name
php php php php php php*php argumentphp isphp disregardedphp.
php php php php php php*
php php php php php php*php MySQLphp doesphp notphp supportphp sequencesphp,php sophp php$tableNamephp andphp php$primaryKeyphp arephp ignoredphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$tableNamephp php php OPTIONALphp Namephp ofphp tablephp.
php php php php php php*php php@paramphp stringphp php$primaryKeyphp php OPTIONALphp Namephp ofphp primaryphp keyphp columnphp.
php php php php php php*php php@returnphp string
php php php php php php*php php@todophp Returnphp valuephp shouldphp bephp intphp?
php php php php php php*php/
php php php php publicphp functionphp lastInsertIdphp(php$tableNamephp php=php nullphp,php php$primaryKeyphp php=php nullphp)
php php php php php{
php php php php php php php php php$mysqliphp php=php php$thisphp-php>php_connectionphp;
php php php php php php php php returnphp php(stringphp)php php$mysqliphp-php>insertphp_idphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Beginphp aphp transactionphp.
php php php php php php*
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php protectedphp functionphp php_beginTransactionphp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_connectphp(php)php;
php php php php php php php php php$thisphp-php>php_connectionphp-php>autocommitphp(falsephp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Commitphp aphp transactionphp.
php php php php php php*
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php protectedphp functionphp php_commitphp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_connectphp(php)php;
php php php php php php php php php$thisphp-php>php_connectionphp-php>commitphp(php)php;
php php php php php php php php php$thisphp-php>php_connectionphp-php>autocommitphp(truephp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Rollphp-backphp aphp transactionphp.
php php php php php php*
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php protectedphp functionphp php_rollBackphp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_connectphp(php)php;
php php php php php php php php php$thisphp-php>php_connectionphp-php>rollbackphp(php)php;
php php php php php php php php php$thisphp-php>php_connectionphp-php>autocommitphp(truephp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp thephp fetchphp modephp.
php php php php php php*
php php php php php php*php php@paramphp intphp php$mode
php php php php php php*php php@returnphp void
php php php php php php*php php@throwsphp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exception
php php php php php php*php/
php php php php publicphp functionphp setFetchModephp(php$modephp)
php php php php php{
php php php php php php php php switchphp php(php$modephp)php php{
php php php php php php php php php php php php casephp Zendphp_Dbphp:php:FETCHphp_LAZYphp:
php php php php php php php php php php php php casephp Zendphp_Dbphp:php:FETCHphp_ASSOCphp:
php php php php php php php php php php php php casephp Zendphp_Dbphp:php:FETCHphp_NUMphp:
php php php php php php php php php php php php casephp Zendphp_Dbphp:php:FETCHphp_BOTHphp:
php php php php php php php php php php php php casephp Zendphp_Dbphp:php:FETCHphp_NAMEDphp:
php php php php php php php php php php php php casephp Zendphp_Dbphp:php:FETCHphp_OBJphp:
php php php php php php php php php php php php php php php php php$thisphp-php>php_fetchModephp php=php php$modephp;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php casephp Zendphp_Dbphp:php:FETCHphp_BOUNDphp:php php/php/php boundphp tophp PHPphp variable
php php php php php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php php php php php*php php@seephp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exception
php php php php php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Dbphp/Adapterphp/Mysqliphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exceptionphp(php'FETCHphp_BOUNDphp isphp notphp supportedphp yetphp'php)php;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php php php php php*php php@seephp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exception
php php php php php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Dbphp/Adapterphp/Mysqliphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exceptionphp(php"Invalidphp fetchphp modephp php'php$modephp'php specifiedphp"php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Addsphp anphp adapterphp-specificphp LIMITphp clausephp tophp thephp SELECTphp statementphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$sql
php php php php php php*php php@paramphp intphp php$count
php php php php php php*php php@paramphp intphp php$offsetphp OPTIONAL
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp limitphp(php$sqlphp,php php$countphp,php php$offsetphp php=php php0php)
php php php php php{
php php php php php php php php php$countphp php=php intvalphp(php$countphp)php;
php php php php php php php php ifphp php(php$countphp <php=php php0php)php php{
php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php*php php@seephp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exception
php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Dbphp/Adapterphp/Mysqliphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exceptionphp(php"LIMITphp argumentphp countphp=php$countphp isphp notphp validphp"php)php;
php php php php php php php php php}

php php php php php php php php php$offsetphp php=php intvalphp(php$offsetphp)php;
php php php php php php php php ifphp php(php$offsetphp <php php0php)php php{
php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php*php php@seephp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exception
php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Dbphp/Adapterphp/Mysqliphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Dbphp_Adapterphp_Mysqliphp_Exceptionphp(php"LIMITphp argumentphp offsetphp=php$offsetphp isphp notphp validphp"php)php;
php php php php php php php php php}

php php php php php php php php php$sqlphp php.php=php php"php LIMITphp php$countphp"php;
php php php php php php php php ifphp php(php$offsetphp php>php php0php)php php{
php php php php php php php php php php php php php$sqlphp php.php=php php"php OFFSETphp php$offsetphp"php;
php php php php php php php php php}

php php php php php php php php returnphp php$sqlphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Checkphp ifphp thephp adapterphp supportsphp realphp SQLphp parametersphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$typephp php'positionalphp'php orphp php'namedphp'
php php php php php php*php php@returnphp bool
php php php php php php*php/
php php php php publicphp functionphp supportsParametersphp(php$typephp)
php php php php php{
php php php php php php php php switchphp php(php$typephp)php php{
php php php php php php php php php php php php casephp php'positionalphp'php:
php php php php php php php php php php php php php php php php returnphp truephp;
php php php php php php php php php php php php casephp php'namedphp'php:
php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp serverphp versionphp inphp PHPphp style
php php php php php php*
php php php php php php*php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getServerVersionphp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_connectphp(php)php;
php php php php php php php php php$versionphp php=php php$thisphp-php>php_connectionphp-php>serverphp_versionphp;
php php php php php php php php php$majorphp php=php php(intphp)php php(php$versionphp php/php php1php0php0php0php0php)php;
php php php php php php php php php$minorphp php=php php(intphp)php php(php$versionphp php%php php1php0php0php0php0php php/php php1php0php0php)php;
php php php php php php php php php$revisionphp php=php php(intphp)php php(php$versionphp php%php php1php0php0php)php;
php php php php php php php php returnphp php$majorphp php.php php'php.php'php php.php php$minorphp php.php php'php.php'php php.php php$revisionphp;
php php php php php}
php}
