<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Db
php php*php php@subpackagephp Adapter
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Mssqlphp.phpphp php2php0php0php9php6php php2php0php1php0php-php0php1php-php0php6php php0php2php:php0php5php:php0php9Zphp bkarwinphp php$
php php*php/


php/php*php*
php php*php php@seephp Zendphp_Dbphp_Adapterphp_Pdophp_Abstract
php php*php/
requirephp_oncephp php'Zendphp/Dbphp/Adapterphp/Pdophp/Abstractphp.phpphp'php;


php/php*php*
php php*php Classphp forphp connectingphp tophp Microsoftphp SQLphp Serverphp databasesphp andphp performingphp commonphp operationsphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Db
php php*php php@subpackagephp Adapter
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_Dbphp_Adapterphp_Pdophp_Mssqlphp extendsphp Zendphp_Dbphp_Adapterphp_Pdophp_Abstract
php{
php php php php php/php*php*
php php php php php php*php PDOphp typephp.
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_pdoTypephp php=php php'mssqlphp'php;

php php php php php/php*php*
php php php php php php*php Keysphp arephp UPPERCASEphp SQLphp datatypesphp orphp thephp constants
php php php php php php*php Zendphp_Dbphp:php:INTphp_TYPEphp,php Zendphp_Dbphp:php:BIGINTphp_TYPEphp,php orphp Zendphp_Dbphp:php:FLOATphp_TYPEphp.
php php php php php php*
php php php php php php*php Valuesphp arephp:
php php php php php php*php php0php php=php php3php2php-bitphp integer
php php php php php php*php php1php php=php php6php4php-bitphp integer
php php php php php php*php php2php php=php floatphp orphp decimal
php php php php php php*
php php php php php php*php php@varphp arrayphp Associativephp arrayphp ofphp datatypesphp tophp valuesphp php0php,php php1php,php orphp php2php.
php php php php php php*php/
php php php php protectedphp php$php_numericDataTypesphp php=php arrayphp(
php php php php php php php php Zendphp_Dbphp:php:INTphp_TYPEphp php php php php=php>php Zendphp_Dbphp:php:INTphp_TYPEphp,
php php php php php php php php Zendphp_Dbphp:php:BIGINTphp_TYPEphp php=php>php Zendphp_Dbphp:php:BIGINTphp_TYPEphp,
php php php php php php php php Zendphp_Dbphp:php:FLOATphp_TYPEphp php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPEphp,
php php php php php php php php php'INTphp'php php php php php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:INTphp_TYPEphp,
php php php php php php php php php'SMALLINTphp'php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:INTphp_TYPEphp,
php php php php php php php php php'TINYINTphp'php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:INTphp_TYPEphp,
php php php php php php php php php'BIGINTphp'php php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:BIGINTphp_TYPEphp,
php php php php php php php php php'DECIMALphp'php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPEphp,
php php php php php php php php php'FLOATphp'php php php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPEphp,
php php php php php php php php php'MONEYphp'php php php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPEphp,
php php php php php php php php php'NUMERICphp'php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPEphp,
php php php php php php php php php'REALphp'php php php php php php php php php php php php php php php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPEphp,
php php php php php php php php php'SMALLMONEYphp'php php php php php php php php php php=php>php Zendphp_Dbphp:php:FLOATphp_TYPE
php php php php php)php;

php php php php php/php*php*
php php php php php php*php Createsphp aphp PDOphp DSNphp forphp thephp adapterphp fromphp php$thisphp-php>php_configphp settingsphp.
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php protectedphp functionphp php_dsnphp(php)
php php php php php{
php php php php php php php php php/php/php baselinephp ofphp DSNphp parts
php php php php php php php php php$dsnphp php=php php$thisphp-php>php_configphp;

php php php php php php php php php/php/php donphp'tphp passphp thephp usernamephp andphp passwordphp inphp thephp DSN
php php php php php php php php unsetphp(php$dsnphp[php'usernamephp'php]php)php;
php php php php php php php php unsetphp(php$dsnphp[php'passwordphp'php]php)php;
php php php php php php php php unsetphp(php$dsnphp[php'optionsphp'php]php)php;
php php php php php php php php unsetphp(php$dsnphp[php'persistentphp'php]php)php;
php php php php php php php php unsetphp(php$dsnphp[php'driverphp_optionsphp'php]php)php;

php php php php php php php php ifphp php(issetphp(php$dsnphp[php'portphp'php]php)php)php php{
php php php php php php php php php php php php php$seperatorphp php=php php'php:php'php;
php php php php php php php php php php php php ifphp php(strtoupperphp(substrphp(PHPphp_OSphp,php php0php,php php3php)php)php php=php=php=php php'WINphp'php)php php{
php php php php php php php php php php php php php php php php php$seperatorphp php=php php'php,php'php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$dsnphp[php'hostphp'php]php php.php=php php$seperatorphp php.php php$dsnphp[php'portphp'php]php;
php php php php php php php php php php php php unsetphp(php$dsnphp[php'portphp'php]php)php;
php php php php php php php php php}

php php php php php php php php php/php/php thisphp driverphp supportsphp multiplephp DSNphp prefixes
php php php php php php php php php/php/php php@seephp httpphp:php/php/wwwphp.phpphp.netphp/manualphp/enphp/refphp.pdophp-dblibphp.connectionphp.php
php php php php php php php php ifphp php(issetphp(php$dsnphp[php'pdoTypephp'php]php)php)php php{
php php php php php php php php php php php php switchphp php(strtolowerphp(php$dsnphp[php'pdoTypephp'php]php)php)php php{
php php php php php php php php php php php php php php php php casephp php'freetdsphp'php:
php php php php php php php php php php php php php php php php casephp php'sybasephp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>php_pdoTypephp php=php php'sybasephp'php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php casephp php'mssqlphp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>php_pdoTypephp php=php php'mssqlphp'php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php casephp php'dblibphp'php:
php php php php php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>php_pdoTypephp php=php php'dblibphp'php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php unsetphp(php$dsnphp[php'pdoTypephp'php]php)php;
php php php php php php php php php}

php php php php php php php php php/php/php usephp allphp remainingphp partsphp inphp thephp DSN
php php php php php php php php foreachphp php(php$dsnphp asphp php$keyphp php=php>php php$valphp)php php{
php php php php php php php php php php php php php$dsnphp[php$keyphp]php php=php php"php$keyphp=php$valphp"php;
php php php php php php php php php}

php php php php php php php php php$dsnphp php=php php$thisphp-php>php_pdoTypephp php.php php'php:php'php php.php implodephp(php'php;php'php,php php$dsnphp)php;
php php php php php php php php returnphp php$dsnphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php protectedphp functionphp php_connectphp(php)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_connectionphp)php php{
php php php php php php php php php php php php returnphp;
php php php php php php php php php}
php php php php php php php php parentphp:php:php_connectphp(php)php;
php php php php php php php php php$thisphp-php>php_connectionphp-php>execphp(php'SETphp QUOTEDphp_IDENTIFIERphp ONphp'php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Beginphp aphp transactionphp.
php php php php php php*
php php php php php php*php Itphp isphp necessaryphp tophp overridephp thephp abstractphp PDOphp transactionphp functionsphp herephp,php as
php php php php php php*php thephp PDOphp driverphp forphp MSSQLphp doesphp notphp supportphp transactionsphp.
php php php php php php*php/
php php php php protectedphp functionphp php_beginTransactionphp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_connectphp(php)php;
php php php php php php php php php$thisphp-php>php_connectionphp-php>execphp(php'BEGINphp TRANSACTIONphp'php)php;
php php php php php php php php returnphp truephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Commitphp aphp transactionphp.
php php php php php php*
php php php php php php*php Itphp isphp necessaryphp tophp overridephp thephp abstractphp PDOphp transactionphp functionsphp herephp,php as
php php php php php php*php thephp PDOphp driverphp forphp MSSQLphp doesphp notphp supportphp transactionsphp.
php php php php php php*php/
php php php php protectedphp functionphp php_commitphp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_connectphp(php)php;
php php php php php php php php php$thisphp-php>php_connectionphp-php>execphp(php'COMMITphp TRANSACTIONphp'php)php;
php php php php php php php php returnphp truephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Rollphp-backphp aphp transactionphp.
php php php php php php*
php php php php php php*php Itphp isphp necessaryphp tophp overridephp thephp abstractphp PDOphp transactionphp functionsphp herephp,php as
php php php php php php*php thephp PDOphp driverphp forphp MSSQLphp doesphp notphp supportphp transactionsphp.
php php php php php php*php/
php php php php protectedphp functionphp php_rollBackphp(php)php php{
php php php php php php php php php$thisphp-php>php_connectphp(php)php;
php php php php php php php php php$thisphp-php>php_connectionphp-php>execphp(php'ROLLBACKphp TRANSACTIONphp'php)php;
php php php php php php php php returnphp truephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp aphp listphp ofphp thephp tablesphp inphp thephp databasephp.
php php php php php php*
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp listTablesphp(php)
php php php php php{
php php php php php php php php php$sqlphp php=php php"SELECTphp namephp FROMphp sysobjectsphp WHEREphp typephp php=php php'Uphp'php ORDERphp BYphp namephp"php;
php php php php php php php php returnphp php$thisphp-php>fetchColphp(php$sqlphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp thephp columnphp descriptionsphp forphp aphp tablephp.
php php php php php php*
php php php php php php*php Thephp returnphp valuephp isphp anphp associativephp arrayphp keyedphp byphp thephp columnphp namephp,
php php php php php php*php asphp returnedphp byphp thephp RDBMSphp.
php php php php php php*
php php php php php php*php Thephp valuephp ofphp eachphp arrayphp elementphp isphp anphp associativephp array
php php php php php php*php withphp thephp followingphp keysphp:
php php php php php php*
php php php php php php*php SCHEMAphp_NAMEphp php php php php php php=php>php stringphp;php namephp ofphp databasephp orphp schema
php php php php php php*php TABLEphp_NAMEphp php php php php php php php=php>php stringphp;
php php php php php php*php COLUMNphp_NAMEphp php php php php php php=php>php stringphp;php columnphp name
php php php php php php*php COLUMNphp_POSITIONphp php php=php>php numberphp;php ordinalphp positionphp ofphp columnphp inphp table
php php php php php php*php DATAphp_TYPEphp php php php php php php php php=php>php stringphp;php SQLphp datatypephp namephp ofphp column
php php php php php php*php DEFAULTphp php php php php php php php php php php=php>php stringphp;php defaultphp expressionphp ofphp columnphp,php nullphp ifphp none
php php php php php php*php NULLABLEphp php php php php php php php php php=php>php booleanphp;php truephp ifphp columnphp canphp havephp nulls
php php php php php php*php LENGTHphp php php php php php php php php php php php=php>php numberphp;php lengthphp ofphp CHARphp/VARCHAR
php php php php php php*php SCALEphp php php php php php php php php php php php php=php>php numberphp;php scalephp ofphp NUMERICphp/DECIMAL
php php php php php php*php PRECISIONphp php php php php php php php php=php>php numberphp;php precisionphp ofphp NUMERICphp/DECIMAL
php php php php php php*php UNSIGNEDphp php php php php php php php php php=php>php booleanphp;php unsignedphp propertyphp ofphp anphp integerphp type
php php php php php php*php PRIMARYphp php php php php php php php php php php=php>php booleanphp;php truephp ifphp columnphp isphp partphp ofphp thephp primaryphp key
php php php php php php*php PRIMARYphp_POSITIONphp php=php>php integerphp;php positionphp ofphp columnphp inphp primaryphp key
php php php php php php*php PRIMARYphp_AUTOphp php php php php php=php>php integerphp;php positionphp ofphp autophp-generatedphp columnphp inphp primaryphp key
php php php php php php*
php php php php php php*php php@todophp Discoverphp columnphp primaryphp keyphp positionphp.
php php php php php php*php php@todophp Discoverphp integerphp unsignedphp propertyphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$tableName
php php php php php php*php php@paramphp stringphp php$schemaNamephp OPTIONAL
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp describeTablephp(php$tableNamephp,php php$schemaNamephp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(php$schemaNamephp php!php=php nullphp)php php{
php php php php php php php php php php php php ifphp php(strposphp(php$schemaNamephp,php php'php.php'php)php php!php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php php$resultphp php=php explodephp(php'php.php'php,php php$schemaNamephp)php;
php php php php php php php php php php php php php php php php php$schemaNamephp php=php php$resultphp[php1php]php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php php/php*php*
php php php php php php php php php php*php Discoverphp metadataphp informationphp aboutphp thisphp tablephp.
php php php php php php php php php php*php/
php php php php php php php php php$sqlphp php=php php"execphp spphp_columnsphp php@tablephp_namephp php=php php"php php.php php$thisphp-php>quoteIdentifierphp(php$tableNamephp,php truephp)php;
php php php php php php php php ifphp php(php$schemaNamephp php!php=php nullphp)php php{
php php php php php php php php php php php php php$sqlphp php.php=php php"php,php php@tablephp_ownerphp php=php php"php php.php php$thisphp-php>quoteIdentifierphp(php$schemaNamephp,php truephp)php;
php php php php php php php php php}

php php php php php php php php php$stmtphp php=php php$thisphp-php>queryphp(php$sqlphp)php;
php php php php php php php php php$resultphp php=php php$stmtphp-php>fetchAllphp(Zendphp_Dbphp:php:FETCHphp_NUMphp)php;

php php php php php php php php php$tablephp_namephp php php=php php2php;
php php php php php php php php php$columnphp_namephp php=php php3php;
php php php php php php php php php$typephp_namephp php php php=php php5php;
php php php php php php php php php$precisionphp php php php=php php6php;
php php php php php php php php php$lengthphp php php php php php php=php php7php;
php php php php php php php php php$scalephp php php php php php php php=php php8php;
php php php php php php php php php$nullablephp php php php php=php php1php0php;
php php php php php php php php php$columnphp_defphp php php=php php1php2php;
php php php php php php php php php$columnphp_positionphp php=php php1php6php;

php php php php php php php php php/php*php*
php php php php php php php php php php*php Discoverphp primaryphp keyphp columnphp(sphp)php forphp thisphp tablephp.
php php php php php php php php php php*php/
php php php php php php php php php$sqlphp php=php php"execphp spphp_pkeysphp php@tablephp_namephp php=php php"php php.php php$thisphp-php>quoteIdentifierphp(php$tableNamephp,php truephp)php;
php php php php php php php php ifphp php(php$schemaNamephp php!php=php nullphp)php php{
php php php php php php php php php php php php php$sqlphp php.php=php php"php,php php@tablephp_ownerphp php=php php"php php.php php$thisphp-php>quoteIdentifierphp(php$schemaNamephp,php truephp)php;
php php php php php php php php php}

php php php php php php php php php$stmtphp php=php php$thisphp-php>queryphp(php$sqlphp)php;
php php php php php php php php php$primaryKeysResultphp php=php php$stmtphp-php>fetchAllphp(Zendphp_Dbphp:php:FETCHphp_NUMphp)php;
php php php php php php php php php$primaryKeyColumnphp php=php arrayphp(php)php;
php php php php php php php php php$pkeyphp_columnphp_namephp php=php php3php;
php php php php php php php php php$pkeyphp_keyphp_seqphp php=php php4php;
php php php php php php php php foreachphp php(php$primaryKeysResultphp asphp php$pkeysRowphp)php php{
php php php php php php php php php php php php php$primaryKeyColumnphp[php$pkeysRowphp[php$pkeyphp_columnphp_namephp]php]php php=php php$pkeysRowphp[php$pkeyphp_keyphp_seqphp]php;
php php php php php php php php php}

php php php php php php php php php$descphp php=php arrayphp(php)php;
php php php php php php php php php$pphp php=php php1php;
php php php php php php php php foreachphp php(php$resultphp asphp php$keyphp php=php>php php$rowphp)php php{
php php php php php php php php php php php php php$identityphp php=php falsephp;
php php php php php php php php php php php php php$wordsphp php=php explodephp(php'php php'php,php php$rowphp[php$typephp_namephp]php,php php2php)php;
php php php php php php php php php php php php ifphp php(issetphp(php$wordsphp[php0php]php)php)php php{
php php php php php php php php php php php php php php php php php$typephp php=php php$wordsphp[php0php]php;
php php php php php php php php php php php php php php php php ifphp php(issetphp(php$wordsphp[php1php]php)php)php php{
php php php php php php php php php php php php php php php php php php php php php$identityphp php=php php(boolphp)php pregphp_matchphp(php'php/identityphp/php'php,php php$wordsphp[php1php]php)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$isPrimaryphp php=php arrayphp_keyphp_existsphp(php$rowphp[php$columnphp_namephp]php,php php$primaryKeyColumnphp)php;
php php php php php php php php php php php php ifphp php(php$isPrimaryphp)php php{
php php php php php php php php php php php php php php php php php$primaryPositionphp php=php php$primaryKeyColumnphp[php$rowphp[php$columnphp_namephp]php]php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$primaryPositionphp php=php nullphp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$descphp[php$thisphp-php>foldCasephp(php$rowphp[php$columnphp_namephp]php)php]php php=php arrayphp(
php php php php php php php php php php php php php php php php php'SCHEMAphp_NAMEphp'php php php php php php php=php>php nullphp,php php/php/php php@todo
php php php php php php php php php php php php php php php php php'TABLEphp_NAMEphp'php php php php php php php php=php>php php$thisphp-php>foldCasephp(php$rowphp[php$tablephp_namephp]php)php,
php php php php php php php php php php php php php php php php php'COLUMNphp_NAMEphp'php php php php php php php=php>php php$thisphp-php>foldCasephp(php$rowphp[php$columnphp_namephp]php)php,
php php php php php php php php php php php php php php php php php'COLUMNphp_POSITIONphp'php php php=php>php php(intphp)php php$rowphp[php$columnphp_positionphp]php,
php php php php php php php php php php php php php php php php php'DATAphp_TYPEphp'php php php php php php php php php=php>php php$typephp,
php php php php php php php php php php php php php php php php php'DEFAULTphp'php php php php php php php php php php php=php>php php$rowphp[php$columnphp_defphp]php,
php php php php php php php php php php php php php php php php php'NULLABLEphp'php php php php php php php php php php=php>php php(boolphp)php php$rowphp[php$nullablephp]php,
php php php php php php php php php php php php php php php php php'LENGTHphp'php php php php php php php php php php php php=php>php php$rowphp[php$lengthphp]php,
php php php php php php php php php php php php php php php php php'SCALEphp'php php php php php php php php php php php php php=php>php php$rowphp[php$scalephp]php,
php php php php php php php php php php php php php php php php php'PRECISIONphp'php php php php php php php php php=php>php php$rowphp[php$precisionphp]php,
php php php php php php php php php php php php php php php php php'UNSIGNEDphp'php php php php php php php php php php=php>php nullphp,php php/php/php php@todo
php php php php php php php php php php php php php php php php php'PRIMARYphp'php php php php php php php php php php php=php>php php$isPrimaryphp,
php php php php php php php php php php php php php php php php php'PRIMARYphp_POSITIONphp'php php=php>php php$primaryPositionphp,
php php php php php php php php php php php php php php php php php'IDENTITYphp'php php php php php php php php php php=php>php php$identity
php php php php php php php php php php php php php)php;
php php php php php php php php php}
php php php php php php php php returnphp php$descphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Addsphp anphp adapterphp-specificphp LIMITphp clausephp tophp thephp SELECTphp statementphp.
php php php php php php*
php php php php php php*php php@linkphp httpphp:php/php/listsphp.bestpracticalphp.comphp/pipermailphp/rtphp-develphp/php2php0php0php5php-Junephp/php0php0php7php3php3php9php.html
php php php php php php*
php php php php php php*php php@paramphp stringphp php$sql
php php php php php php*php php@paramphp integerphp php$count
php php php php php php*php php@paramphp integerphp php$offsetphp OPTIONAL
php php php php php php*php php@throwsphp Zendphp_Dbphp_Adapterphp_Exception
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php php publicphp functionphp limitphp(php$sqlphp,php php$countphp,php php$offsetphp php=php php0php)
php php php php php php{
php php php php php php php php php$countphp php=php intvalphp(php$countphp)php;
php php php php php php php php ifphp php(php$countphp <php=php php0php)php php{
php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Dbphp_Adapterphp_Exceptionphp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Dbphp/Adapterphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Dbphp_Adapterphp_Exceptionphp(php"LIMITphp argumentphp countphp=php$countphp isphp notphp validphp"php)php;
php php php php php php php php php}

php php php php php php php php php$offsetphp php=php intvalphp(php$offsetphp)php;
php php php php php php php php ifphp php(php$offsetphp <php php0php)php php{
php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Dbphp_Adapterphp_Exceptionphp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Dbphp/Adapterphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Dbphp_Adapterphp_Exceptionphp(php"LIMITphp argumentphp offsetphp=php$offsetphp isphp notphp validphp"php)php;
php php php php php php php php php}

php php php php php php php php php$sqlphp php=php pregphp_replacephp(
php php php php php php php php php php php php php'php/php^SELECTphp\sphp+php(DISTINCTphp\sphp)php?php/iphp'php,
php php php php php php php php php php php php php'SELECTphp php$php1TOPphp php'php php.php php(php$countphp+php$offsetphp)php php.php php'php php'php,
php php php php php php php php php php php php php$sql
php php php php php php php php php php php php php)php;

php php php php php php php php ifphp php(php$offsetphp php>php php0php)php php{
php php php php php php php php php php php php php$orderbyphp php=php stristrphp(php$sqlphp,php php'ORDERphp BYphp'php)php;

php php php php php php php php php php php php ifphp php(php$orderbyphp php!php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php php$orderPartsphp php=php explodephp(php'php,php'php,php substrphp(php$orderbyphp,php php8php)php)php;
php php php php php php php php php php php php php php php php php$pregReplaceCountphp php=php nullphp;
php php php php php php php php php php php php php php php php php$orderbyInversePartsphp php=php arrayphp(php)php;
php php php php php php php php php php php php php php php php foreachphp php(php$orderPartsphp asphp php$orderPartphp)php php{
php php php php php php php php php php php php php php php php php php php php php$orderPartphp php=php rtrimphp(php$orderPartphp)php;
php php php php php php php php php php php php php php php php php php php php php$invphp php=php pregphp_replacephp(php'php/php\sphp+descphp$php/iphp'php,php php'php ASCphp'php,php php$orderPartphp,php php1php,php php$pregReplaceCountphp)php;
php php php php php php php php php php php php php php php php php php php php ifphp php(php$pregReplaceCountphp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php$orderbyInversePartsphp[php]php php=php php$invphp;
php php php php php php php php php php php php php php php php php php php php php php php php continuephp;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php php php php php$invphp php=php pregphp_replacephp(php'php/php\sphp+ascphp$php/iphp'php,php php'php DESCphp'php,php php$orderPartphp,php php1php,php php$pregReplaceCountphp)php;
php php php php php php php php php php php php php php php php php php php php ifphp php(php$pregReplaceCountphp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php$orderbyInversePartsphp[php]php php=php php$invphp;
php php php php php php php php php php php php php php php php php php php php php php php php continuephp;
php php php php php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php php php php php$orderbyInversePartsphp[php]php php=php php$orderPartphp php.php php'php DESCphp'php;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php php$orderbyInversephp php=php php'ORDERphp BYphp php'php php.php implodephp(php'php,php php'php,php php$orderbyInversePartsphp)php;
php php php php php php php php php php php php php}




php php php php php php php php php php php php php$sqlphp php=php php'SELECTphp php*php FROMphp php(SELECTphp TOPphp php'php php.php php$countphp php.php php'php php*php FROMphp php(php'php php.php php$sqlphp php.php php'php)php ASphp innerphp_tblphp'php;
php php php php php php php php php php php php ifphp php(php$orderbyphp php!php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php php$sqlphp php.php=php php'php php'php php.php php$orderbyInversephp php.php php'php php'php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$sqlphp php.php=php php'php)php ASphp outerphp_tblphp'php;
php php php php php php php php php php php php ifphp php(php$orderbyphp php!php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php php$sqlphp php.php=php php'php php'php php.php php$orderbyphp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp php$sqlphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getsphp thephp lastphp IDphp generatedphp automaticallyphp byphp anphp IDENTITYphp/AUTOINCREMENTphp columnphp.
php php php php php php*
php php php php php php*php Asphp aphp conventionphp,php onphp RDBMSphp brandsphp thatphp supportphp sequences
php php php php php php*php php(ephp.gphp.php Oraclephp,php PostgreSQLphp,php DBphp2php)php,php thisphp methodphp formsphp thephp namephp ofphp aphp sequence
php php php php php php*php fromphp thephp argumentsphp andphp returnsphp thephp lastphp idphp generatedphp byphp thatphp sequencephp.
php php php php php php*php Onphp RDBMSphp brandsphp thatphp supportphp IDENTITYphp/AUTOINCREMENTphp columnsphp,php thisphp method
php php php php php php*php returnsphp thephp lastphp valuephp generatedphp forphp suchphp aphp columnphp,php andphp thephp tablephp name
php php php php php php*php argumentphp isphp disregardedphp.
php php php php php php*
php php php php php php*php Microsoftphp SQLphp Serverphp doesphp notphp supportphp sequencesphp,php sophp thephp argumentsphp to
php php php php php php*php thisphp methodphp arephp ignoredphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$tableNamephp php php OPTIONALphp Namephp ofphp tablephp.
php php php php php php*php php@paramphp stringphp php$primaryKeyphp php OPTIONALphp Namephp ofphp primaryphp keyphp columnphp.
php php php php php php*php php@returnphp string
php php php php php php*php php@throwsphp Zendphp_Dbphp_Adapterphp_Exception
php php php php php php*php/
php php php php publicphp functionphp lastInsertIdphp(php$tableNamephp php=php nullphp,php php$primaryKeyphp php=php nullphp)
php php php php php{
php php php php php php php php php$sqlphp php=php php'SELECTphp SCOPEphp_IDENTITYphp(php)php'php;
php php php php php php php php returnphp php(intphp)php$thisphp-php>fetchOnephp(php$sqlphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp serverphp versionphp inphp PHPphp style
php php php php php php*php Pdophp_Mssqlphp doesnphp'tphp supportphp getAttributephp(PDOphp:php:ATTRphp_SERVERphp_VERSIONphp)
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getServerVersionphp(php)
php php php php php{
php php php php php php php php tryphp php{
php php php php php php php php php php php php php$stmtphp php=php php$thisphp-php>queryphp(php"SELECTphp SERVERPROPERTYphp(php'productversionphp'php)php"php)php;
php php php php php php php php php php php php php$resultphp php=php php$stmtphp-php>fetchAllphp(Zendphp_Dbphp:php:FETCHphp_NUMphp)php;
php php php php php php php php php php php php ifphp php(countphp(php$resultphp)php)php php{
php php php php php php php php php php php php php php php php returnphp php$resultphp[php0php]php[php0php]php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php returnphp nullphp;
php php php php php php php php php}php catchphp php(PDOExceptionphp php$ephp)php php{
php php php php php php php php php php php php returnphp nullphp;
php php php php php php php php php}
php php php php php}
php}