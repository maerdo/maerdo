<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Searchphp_Lucene
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Lucenephp.phpphp php2php2php9php8php7php php2php0php1php0php-php0php9php-php2php1php php1php0php:php3php9php:php5php3Zphp alexanderphp php$
php php*php/


php/php*php*php Userphp landphp classesphp andphp interfacesphp turnedphp onphp byphp Zendphp/Searchphp/Lucenephp.phpphp filephp inclusionphp.php php*php/
php/php*php*php php@todophp Sectionphp shouldphp bephp removedphp withphp ZFphp php2php.php0php releasephp asphp obsoletephp php php php php php php php php php php php php php php php php php php php php php php*php/

php/php*php*php Zendphp_Searchphp_Lucenephp_Documentphp_Htmlphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Documentphp/Htmlphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Documentphp_Docxphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Documentphp/Docxphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Documentphp_Pptxphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Documentphp/Pptxphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Documentphp_Xlsxphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Documentphp/Xlsxphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_QueryParserphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/QueryParserphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_QueryHitphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/QueryHitphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Analysisphp_Analyzerphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Analysisphp/Analyzerphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_Queryphp_Termphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/Queryphp/Termphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_Queryphp_Phrasephp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/Queryphp/Phrasephp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_Queryphp_MultiTermphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/Queryphp/MultiTermphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_Queryphp_Wildcardphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/Queryphp/Wildcardphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_Queryphp_Rangephp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/Queryphp/Rangephp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_Queryphp_Fuzzyphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/Queryphp/Fuzzyphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_Queryphp_Booleanphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/Queryphp/Booleanphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_Queryphp_Emptyphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/Queryphp/Emptyphp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_Queryphp_Insignificantphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/Queryphp/Insignificantphp.phpphp'php;




php/php*php*php Internallyphp usedphp classesphp php*php/

php/php*php*php Zendphp_Searchphp_Lucenephp_Interfacephp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Interfacephp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_Indexphp_SegmentInfophp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Indexphp/SegmentInfophp.phpphp'php;

php/php*php*php Zendphp_Searchphp_Lucenephp_LockManagerphp php*php/
requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/LockManagerphp.phpphp'php;


php/php*php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Searchphp_Lucene
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_Searchphp_Lucenephp implementsphp Zendphp_Searchphp_Lucenephp_Interface
php{
php php php php php/php*php*
php php php php php php*php Defaultphp fieldphp namephp forphp search
php php php php php php*
php php php php php php*php Nullphp meansphp searchphp throughphp allphp fields
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php privatephp staticphp php$php_defaultSearchFieldphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php Resultphp setphp limit
php php php php php php*
php php php php php php*php php0php meansphp nophp limit
php php php php php php*
php php php php php php*php php@varphp integer
php php php php php php*php/
php php php php privatephp staticphp php$php_resultSetLimitphp php=php php0php;

php php php php php/php*php*
php php php php php php*php Termsphp perphp queryphp limit
php php php php php php*
php php php php php php*php php0php meansphp nophp limit
php php php php php php*
php php php php php php*php php@varphp integer
php php php php php php*php/
php php php php privatephp staticphp php$php_termsPerQueryLimitphp php=php php1php0php2php4php;

php php php php php/php*php*
php php php php php php*php Filephp systemphp adapterphp.
php php php php php php*
php php php php php php*php php@varphp Zendphp_Searchphp_Lucenephp_Storagephp_Directory
php php php php php php*php/
php php php php privatephp php$php_directoryphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php Filephp systemphp adapterphp closingphp option
php php php php php php*
php php php php php php*php php@varphp boolean
php php php php php php*php/
php php php php privatephp php$php_closeDirOnExitphp php=php truephp;

php php php php php/php*php*
php php php php php php*php Writerphp forphp thisphp indexphp,php notphp instantiatedphp unlessphp requiredphp.
php php php php php php*
php php php php php php*php php@varphp Zendphp_Searchphp_Lucenephp_Indexphp_Writer
php php php php php php*php/
php php php php privatephp php$php_writerphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php Arrayphp ofphp Zendphp_Searchphp_Lucenephp_Indexphp_SegmentInfophp objectsphp forphp currentphp versionphp ofphp indexphp.
php php php php php php*
php php php php php php*php php@varphp arrayphp Zendphp_Searchphp_Lucenephp_Indexphp_SegmentInfo
php php php php php php*php/
php php php php privatephp php$php_segmentInfosphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Numberphp ofphp documentsphp inphp thisphp indexphp.
php php php php php php*
php php php php php php*php php@varphp integer
php php php php php php*php/
php php php php privatephp php$php_docCountphp php=php php0php;

php php php php php/php*php*
php php php php php php*php Flagphp forphp indexphp changes
php php php php php php*
php php php php php php*php php@varphp boolean
php php php php php php*php/
php php php php privatephp php$php_hasChangesphp php=php falsephp;


php php php php php/php*php*
php php php php php php*php Signalphp,php thatphp indexphp isphp alreadyphp closedphp,php changesphp arephp fixedphp andphp resourcesphp arephp cleanedphp up
php php php php php php*
php php php php php php*php php@varphp boolean
php php php php php php*php/
php php php php privatephp php$php_closedphp php=php falsephp;

php php php php php/php*php*
php php php php php php*php Numberphp ofphp referencesphp tophp thephp indexphp object
php php php php php php*
php php php php php php*php php@varphp integer
php php php php php php*php/
php php php php privatephp php$php_refCountphp php=php php0php;

php php php php php/php*php*
php php php php php php*php Currentphp segmentphp generation
php php php php php php*
php php php php php php*php php@varphp integer
php php php php php php*php/
php php php php privatephp php$php_generationphp;

php php php php constphp FORMATphp_PREphp_php2php_php1php php=php php0php;
php php php php constphp FORMATphp_php2php_php1php php php php php php=php php1php;
php php php php constphp FORMATphp_php2php_php3php php php php php php=php php2php;


php php php php php/php*php*
php php php php php php*php Indexphp formatphp version
php php php php php php*
php php php php php php*php php@varphp integer
php php php php php php*php/
php php php php privatephp php$php_formatVersionphp;

php php php php php/php*php*
php php php php php php*php Createphp index
php php php php php php*
php php php php php php*php php@paramphp mixedphp php$directory
php php php php php php*php php@returnphp Zendphp_Searchphp_Lucenephp_Interface
php php php php php php*php/
php php php php publicphp staticphp functionphp createphp(php$directoryphp)
php php php php php{
php php php php php php php php php/php*php*php Zendphp_Searchphp_Lucenephp_Proxyphp php*php/
php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Proxyphp.phpphp'php;

php php php php php php php php returnphp newphp Zendphp_Searchphp_Lucenephp_Proxyphp(newphp Zendphp_Searchphp_Lucenephp(php$directoryphp,php truephp)php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Openphp index
php php php php php php*
php php php php php php*php php@paramphp mixedphp php$directory
php php php php php php*php php@returnphp Zendphp_Searchphp_Lucenephp_Interface
php php php php php php*php/
php php php php publicphp staticphp functionphp openphp(php$directoryphp)
php php php php php{
php php php php php php php php php/php*php*php Zendphp_Searchphp_Lucenephp_Proxyphp php*php/
php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Proxyphp.phpphp'php;

php php php php php php php php returnphp newphp Zendphp_Searchphp_Lucenephp_Proxyphp(newphp Zendphp_Searchphp_Lucenephp(php$directoryphp,php falsephp)php)php;
php php php php php}

php php php php php/php*php*php Generationphp retrievingphp counterphp php*php/
php php php php constphp GENERATIONphp_RETRIEVEphp_COUNTphp php=php php1php0php;

php php php php php/php*php*php Pausephp betweenphp generationphp retrievingphp attemptsphp inphp millisecondsphp php*php/
php php php php constphp GENERATIONphp_RETRIEVEphp_PAUSEphp php=php php5php0php;

php php php php php/php*php*
php php php php php php*php Getphp currentphp generationphp number
php php php php php php*
php php php php php php*php Returnsphp generationphp number
php php php php php php*php php0php meansphp prephp-php2php.php1php indexphp format
php php php php php php*php php-php1php meansphp therephp arephp nophp segmentsphp filesphp.
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Storagephp_Directoryphp php$directory
php php php php php php*php php@returnphp integer
php php php php php php*php php@throwsphp Zendphp_Searchphp_Lucenephp_Exception
php php php php php php*php/
php php php php publicphp staticphp functionphp getActualGenerationphp(Zendphp_Searchphp_Lucenephp_Storagephp_Directoryphp php$directoryphp)
php php php php php{
php php php php php php php php php/php*php*
php php php php php php php php php php*php Zendphp_Searchphp_Lucenephp usesphp segmentsphp.genphp filephp tophp retrievephp currentphp generationphp number
php php php php php php php php php php*
php php php php php php php php php php*php Apachephp Lucenephp indexphp formatphp documentationphp mentionsphp thisphp methodphp onlyphp asphp aphp fallbackphp method
php php php php php php php php php php*
php php php php php php php php php php*php Neverthelessphp wephp usephp itphp accordingphp tophp thephp performancephp considerations
php php php php php php php php php php*
php php php php php php php php php php*php php@todophp checkphp ifphp wephp canphp usephp somephp modificationphp ofphp Apachephp Lucenephp generationphp determinationphp algorithm
php php php php php php php php php php*php php php php php php php withoutphp performancephp problems
php php php php php php php php php php*php/

php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php tryphp php{
php php php php php php php php php php php php forphp php(php$countphp php=php php0php;php php$countphp <php selfphp:php:GENERATIONphp_RETRIEVEphp_COUNTphp;php php$countphp+php+php)php php{
php php php php php php php php php php php php php php php php php/php/php Tryphp tophp getphp generationphp file
php php php php php php php php php php php php php php php php php$genFilephp php=php php$directoryphp-php>getFileObjectphp(php'segmentsphp.genphp'php,php falsephp)php;

php php php php php php php php php php php php php php php php php$formatphp php=php php$genFilephp-php>readIntphp(php)php;
php php php php php php php php php php php php php php php php ifphp php(php$formatphp php!php=php php(intphp)php0xFFFFFFFEphp)php php{
php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Wrongphp segmentsphp.genphp filephp formatphp'php)php;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php php$genphp1php php=php php$genFilephp-php>readLongphp(php)php;
php php php php php php php php php php php php php php php php php$genphp2php php=php php$genFilephp-php>readLongphp(php)php;

php php php php php php php php php php php php php php php php ifphp php(php$genphp1php php=php=php php$genphp2php)php php{
php php php php php php php php php php php php php php php php php php php php returnphp php$genphp1php;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php usleepphp(selfphp:php:GENERATIONphp_RETRIEVEphp_PAUSEphp php*php php1php0php0php0php)php;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php/php/php Allphp passesphp arephp failed
php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Indexphp isphp underphp processingphp nowphp'php)php;
php php php php php php php php php}php catchphp php(Zendphp_Searchphp_Lucenephp_Exceptionphp php$ephp)php php{
php php php php php php php php php php php php ifphp php(strposphp(php$ephp-php>getMessagephp(php)php,php php'isphp notphp readablephp'php)php php!php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php tryphp php{
php php php php php php php php php php php php php php php php php php php php php/php/php Tryphp tophp openphp oldphp stylephp segmentsphp file
php php php php php php php php php php php php php php php php php php php php php$segmentsFilephp php=php php$directoryphp-php>getFileObjectphp(php'segmentsphp'php,php falsephp)php;

php php php php php php php php php php php php php php php php php php php php php/php/php Itphp'sphp prephp-php2php.php1php index
php php php php php php php php php php php php php php php php php php php php returnphp php0php;
php php php php php php php php php php php php php php php php php}php catchphp php(Zendphp_Searchphp_Lucenephp_Exceptionphp php$ephp)php php{
php php php php php php php php php php php php php php php php php php php php ifphp php(strposphp(php$ephp-php>getMessagephp(php)php,php php'isphp notphp readablephp'php)php php!php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php returnphp php-php1php;
php php php php php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php$ephp-php>getMessagephp(php)php,php php$ephp-php>getCodephp(php)php,php php$ephp)php;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php$ephp-php>getMessagephp(php)php,php php$ephp-php>getCodephp(php)php,php php$ephp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp php-php1php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp generationphp numberphp associatedphp withphp thisphp indexphp instance
php php php php php php*
php php php php php php*php Thephp samephp generationphp numberphp inphp pairphp withphp documentphp numberphp orphp queryphp string
php php php php php php*php guaranteesphp tophp givephp thephp samephp resultphp whilephp indexphp retrievingphp.
php php php php php php*php Sophp itphp mayphp bephp usedphp forphp searchphp resultphp cachingphp.
php php php php php php*
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp functionphp getGenerationphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_generationphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Getphp segmentsphp filephp name
php php php php php php*
php php php php php php*php php@paramphp integerphp php$generation
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp staticphp functionphp getSegmentFileNamephp(php$generationphp)
php php php php php{
php php php php php php php php ifphp php(php$generationphp php=php=php php0php)php php{
php php php php php php php php php php php php returnphp php'segmentsphp'php;
php php php php php php php php php}

php php php php php php php php returnphp php'segmentsphp_php'php php.php basephp_convertphp(php$generationphp,php php1php0php,php php3php6php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp indexphp formatphp version
php php php php php php*
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp functionphp getFormatVersionphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_formatVersionphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp indexphp formatphp versionphp.
php php php php php php*php Indexphp isphp convertedphp tophp thisphp formatphp atphp thephp nearestphp upfdatephp time
php php php php php php*
php php php php php php*php php@paramphp intphp php$formatVersion
php php php php php php*php php@throwsphp Zendphp_Searchphp_Lucenephp_Exception
php php php php php php*php/
php php php php publicphp functionphp setFormatVersionphp(php$formatVersionphp)
php php php php php{
php php php php php php php php ifphp php(php$formatVersionphp php!php=php selfphp:php:FORMATphp_PREphp_php2php_php1php php php&php&
php php php php php php php php php php php php php$formatVersionphp php!php=php selfphp:php:FORMATphp_php2php_php1php php php&php&
php php php php php php php php php php php php php$formatVersionphp php!php=php selfphp:php:FORMATphp_php2php_php3php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Unsupportedphp indexphp formatphp'php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_formatVersionphp php=php php$formatVersionphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Readphp segmentsphp filephp forphp prephp-php2php.php1php Lucenephp indexphp format
php php php php php php*
php php php php php php*php php@throwsphp Zendphp_Searchphp_Lucenephp_Exception
php php php php php php*php/
php php php php privatephp functionphp php_readPrephp2php1SegmentsFilephp(php)
php php php php php{
php php php php php php php php php$segmentsFilephp php=php php$thisphp-php>php_directoryphp-php>getFileObjectphp(php'segmentsphp'php)php;

php php php php php php php php php$formatphp php=php php$segmentsFilephp-php>readIntphp(php)php;

php php php php php php php php ifphp php(php$formatphp php!php=php php(intphp)php0xFFFFFFFFphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Wrongphp segmentsphp filephp formatphp'php)php;
php php php php php php php php php}

php php php php php php php php php/php/php readphp version
php php php php php php php php php$segmentsFilephp-php>readLongphp(php)php;

php php php php php php php php php/php/php readphp segmentphp namephp counter
php php php php php php php php php$segmentsFilephp-php>readIntphp(php)php;

php php php php php php php php php$segmentsphp php=php php$segmentsFilephp-php>readIntphp(php)php;

php php php php php php php php php$thisphp-php>php_docCountphp php=php php0php;

php php php php php php php php php/php/php readphp segmentInfos
php php php php php php php php forphp php(php$countphp php=php php0php;php php$countphp <php php$segmentsphp;php php$countphp+php+php)php php{
php php php php php php php php php php php php php$segNamephp php=php php$segmentsFilephp-php>readStringphp(php)php;
php php php php php php php php php php php php php$segSizephp php=php php$segmentsFilephp-php>readIntphp(php)php;
php php php php php php php php php php php php php$thisphp-php>php_docCountphp php+php=php php$segSizephp;

php php php php php php php php php php php php php$thisphp-php>php_segmentInfosphp[php$segNamephp]php php=
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php newphp Zendphp_Searchphp_Lucenephp_Indexphp_SegmentInfophp(php$thisphp-php>php_directoryphp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$segNamephp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$segSizephp)php;
php php php php php php php php php}

php php php php php php php php php/php/php Usephp php2php.php1php asphp aphp targetphp versionphp.php Indexphp willphp bephp reorganizedphp atphp updatephp timephp.
php php php php php php php php php$thisphp-php>php_formatVersionphp php=php selfphp:php:FORMATphp_php2php_php1php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Readphp segmentsphp file
php php php php php php*
php php php php php php*php php@throwsphp Zendphp_Searchphp_Lucenephp_Exception
php php php php php php*php/
php php php php privatephp functionphp php_readSegmentsFilephp(php)
php php php php php{
php php php php php php php php php$segmentsFilephp php=php php$thisphp-php>php_directoryphp-php>getFileObjectphp(selfphp:php:getSegmentFileNamephp(php$thisphp-php>php_generationphp)php)php;

php php php php php php php php php$formatphp php=php php$segmentsFilephp-php>readIntphp(php)php;

php php php php php php php php ifphp php(php$formatphp php=php=php php(intphp)php0xFFFFFFFCphp)php php{
php php php php php php php php php php php php php$thisphp-php>php_formatVersionphp php=php selfphp:php:FORMATphp_php2php_php3php;
php php php php php php php php php}php elsephp ifphp php(php$formatphp php=php=php php(intphp)php0xFFFFFFFDphp)php php{
php php php php php php php php php php php php php$thisphp-php>php_formatVersionphp php=php selfphp:php:FORMATphp_php2php_php1php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Unsupportedphp segmentsphp filephp formatphp'php)php;
php php php php php php php php php}

php php php php php php php php php/php/php readphp version
php php php php php php php php php$segmentsFilephp-php>readLongphp(php)php;

php php php php php php php php php/php/php readphp segmentphp namephp counter
php php php php php php php php php$segmentsFilephp-php>readIntphp(php)php;

php php php php php php php php php$segmentsphp php=php php$segmentsFilephp-php>readIntphp(php)php;

php php php php php php php php php$thisphp-php>php_docCountphp php=php php0php;

php php php php php php php php php/php/php readphp segmentInfos
php php php php php php php php forphp php(php$countphp php=php php0php;php php$countphp <php php$segmentsphp;php php$countphp+php+php)php php{
php php php php php php php php php php php php php$segNamephp php=php php$segmentsFilephp-php>readStringphp(php)php;
php php php php php php php php php php php php php$segSizephp php=php php$segmentsFilephp-php>readIntphp(php)php;

php php php php php php php php php php php php php/php/php php2php.php1php+php specificphp properties
php php php php php php php php php php php php php$delGenphp php=php php$segmentsFilephp-php>readLongphp(php)php;

php php php php php php php php php php php php ifphp php(php$thisphp-php>php_formatVersionphp php=php=php selfphp:php:FORMATphp_php2php_php3php)php php{
php php php php php php php php php php php php php php php php php$docStoreOffsetphp php=php php$segmentsFilephp-php>readIntphp(php)php;

php php php php php php php php php php php php php php php php ifphp php(php$docStoreOffsetphp php!php=php php(intphp)php0xFFFFFFFFphp)php php{
php php php php php php php php php php php php php php php php php php php php php$docStoreSegmentphp php php php php php php php php=php php$segmentsFilephp-php>readStringphp(php)php;
php php php php php php php php php php php php php php php php php php php php php$docStoreIsCompoundFilephp php=php php$segmentsFilephp-php>readBytephp(php)php;

php php php php php php php php php php php php php php php php php php php php php$docStoreOptionsphp php=php arrayphp(php'offsetphp'php php php php php php=php>php php$docStoreOffsetphp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php'segmentphp'php php php php php=php>php php$docStoreSegmentphp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php'isCompoundphp'php php=php>php php(php$docStoreIsCompoundFilephp php=php=php php1php)php)php;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php$docStoreOptionsphp php=php nullphp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$docStoreOptionsphp php=php nullphp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$hasSingleNormFilephp php=php php$segmentsFilephp-php>readBytephp(php)php;
php php php php php php php php php php php php php$numFieldphp php php php php php php php php php php=php php$segmentsFilephp-php>readIntphp(php)php;

php php php php php php php php php php php php php$normGensphp php=php arrayphp(php)php;
php php php php php php php php php php php php ifphp php(php$numFieldphp php!php=php php(intphp)php0xFFFFFFFFphp)php php{
php php php php php php php php php php php php php php php php forphp php(php$countphp1php php=php php0php;php php$countphp1php <php php$numFieldphp;php php$countphp1php+php+php)php php{
php php php php php php php php php php php php php php php php php php php php php$normGensphp[php]php php=php php$segmentsFilephp-php>readLongphp(php)php;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Separatephp normphp filesphp arephp notphp supportedphp.php Optimizephp indexphp tophp usephp itphp withphp Zendphp_Searchphp_Lucenephp.php'php)php;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$isCompoundBytephp php php php php php=php php$segmentsFilephp-php>readBytephp(php)php;

php php php php php php php php php php php php ifphp php(php$isCompoundBytephp php=php=php php0xFFphp)php php{
php php php php php php php php php php php php php php php php php/php/php Thephp segmentphp isphp notphp aphp compoundphp file
php php php php php php php php php php php php php php php php php$isCompoundphp php=php falsephp;
php php php php php php php php php php php php php}php elsephp ifphp php(php$isCompoundBytephp php=php=php php0xphp0php0php)php php{
php php php php php php php php php php php php php php php php php/php/php Thephp statusphp isphp unknown
php php php php php php php php php php php php php php php php php$isCompoundphp php=php nullphp;
php php php php php php php php php php php php php}php elsephp ifphp php(php$isCompoundBytephp php=php=php php0xphp0php1php)php php{
php php php php php php php php php php php php php php php php php/php/php Thephp segmentphp isphp aphp compoundphp file
php php php php php php php php php php php php php php php php php$isCompoundphp php=php truephp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$thisphp-php>php_docCountphp php+php=php php$segSizephp;

php php php php php php php php php php php php php$thisphp-php>php_segmentInfosphp[php$segNamephp]php php=
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php newphp Zendphp_Searchphp_Lucenephp_Indexphp_SegmentInfophp(php$thisphp-php>php_directoryphp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$segNamephp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$segSizephp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$delGenphp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$docStoreOptionsphp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$hasSingleNormFilephp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$isCompoundphp)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Opensphp thephp indexphp.
php php php php php php*
php php php php php php*php IndexReaderphp constructorphp needsphp Directoryphp asphp aphp parameterphp.php Itphp shouldphp be
php php php php php php*php aphp stringphp withphp aphp pathphp tophp thephp indexphp folderphp orphp aphp Directoryphp objectphp.
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Storagephp_Directoryphp_Filesystemphp|stringphp php$directory
php php php php php php*php php@throwsphp Zendphp_Searchphp_Lucenephp_Exception
php php php php php php*php/
php php php php publicphp functionphp php_php_constructphp(php$directoryphp php=php nullphp,php php$createphp php=php falsephp)
php php php php php{
php php php php php php php php ifphp php(php$directoryphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Exceptionphp(php'Nophp indexphp directoryphp specifiedphp'php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(isphp_stringphp(php$directoryphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Storagephp/Directoryphp/Filesystemphp.phpphp'php;
php php php php php php php php php php php php php$thisphp-php>php_directoryphp php php php php php php=php newphp Zendphp_Searchphp_Lucenephp_Storagephp_Directoryphp_Filesystemphp(php$directoryphp)php;
php php php php php php php php php php php php php$thisphp-php>php_closeDirOnExitphp php=php truephp;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$thisphp-php>php_directoryphp php php php php php php=php php$directoryphp;
php php php php php php php php php php php php php$thisphp-php>php_closeDirOnExitphp php=php falsephp;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_segmentInfosphp php=php arrayphp(php)php;

php php php php php php php php php/php/php Markphp indexphp asphp php"underphp processingphp"php tophp preventphp otherphp processesphp fromphp prematurephp indexphp cleaning
php php php php php php php php Zendphp_Searchphp_Lucenephp_LockManagerphp:php:obtainReadLockphp(php$thisphp-php>php_directoryphp)php;

php php php php php php php php php$thisphp-php>php_generationphp php=php selfphp:php:getActualGenerationphp(php$thisphp-php>php_directoryphp)php;

php php php php php php php php ifphp php(php$createphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php tryphp php{
php php php php php php php php php php php php php php php php Zendphp_Searchphp_Lucenephp_LockManagerphp:php:obtainWriteLockphp(php$thisphp-php>php_directoryphp)php;
php php php php php php php php php php php php php}php catchphp php(Zendphp_Searchphp_Lucenephp_Exceptionphp php$ephp)php php{
php php php php php php php php php php php php php php php php Zendphp_Searchphp_Lucenephp_LockManagerphp:php:releaseReadLockphp(php$thisphp-php>php_directoryphp)php;

php php php php php php php php php php php php php php php php ifphp php(strposphp(php$ephp-php>getMessagephp(php)php,php php'Canphp\php'tphp obtainphp exclusivephp indexphp lockphp'php)php php=php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php$ephp-php>getMessagephp(php)php,php php$ephp-php>getCodephp(php)php,php php$ephp)php;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Canphp\php'tphp createphp indexphp.php Itphp\php'sphp underphp processingphp nowphp'php,php php0php,php php$ephp)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}

php php php php php php php php php php php php ifphp php(php$thisphp-php>php_generationphp php=php=php php-php1php)php php{
php php php php php php php php php php php php php php php php php/php/php Directoryphp doesnphp'tphp containphp existingphp indexphp,php startphp fromphp php1
php php php php php php php php php php php php php php php php php$thisphp-php>php_generationphp php=php php1php;
php php php php php php php php php php php php php php php php php$nameCounterphp php=php php0php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php/php/php Directoryphp containsphp existingphp index
php php php php php php php php php php php php php php php php php$segmentsFilephp php=php php$thisphp-php>php_directoryphp-php>getFileObjectphp(selfphp:php:getSegmentFileNamephp(php$thisphp-php>php_generationphp)php)php;
php php php php php php php php php php php php php php php php php$segmentsFilephp-php>seekphp(php1php2php)php;php php/php/php php1php2php php=php php4php php(intphp,php filephp formatphp markerphp)php php+php php8php php(longphp,php indexphp versionphp)

php php php php php php php php php php php php php php php php php$nameCounterphp php=php php$segmentsFilephp-php>readIntphp(php)php;
php php php php php php php php php php php php php php php php php$thisphp-php>php_generationphp+php+php;
php php php php php php php php php php php php php}

php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Indexphp/Writerphp.phpphp'php;
php php php php php php php php php php php php Zendphp_Searchphp_Lucenephp_Indexphp_Writerphp:php:createIndexphp(php$thisphp-php>php_directoryphp,php php$thisphp-php>php_generationphp,php php$nameCounterphp)php;

php php php php php php php php php php php php Zendphp_Searchphp_Lucenephp_LockManagerphp:php:releaseWriteLockphp(php$thisphp-php>php_directoryphp)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$thisphp-php>php_generationphp php=php=php php-php1php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Indexphp doesnphp\php'tphp existsphp inphp thephp specifiedphp directoryphp.php'php)php;
php php php php php php php php php}php elsephp ifphp php(php$thisphp-php>php_generationphp php=php=php php0php)php php{
php php php php php php php php php php php php php$thisphp-php>php_readPrephp2php1SegmentsFilephp(php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$thisphp-php>php_readSegmentsFilephp(php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Closephp currentphp indexphp andphp freephp resources
php php php php php php*php/
php php php php privatephp functionphp php_closephp(php)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_closedphp)php php{
php php php php php php php php php php php php php/php/php indexphp isphp alreadyphp closedphp andphp resourcesphp arephp cleanedphp up
php php php php php php php php php php php php returnphp;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>commitphp(php)php;

php php php php php php php php php/php/php Releasephp php"underphp processingphp"php flag
php php php php php php php php Zendphp_Searchphp_Lucenephp_LockManagerphp:php:releaseReadLockphp(php$thisphp-php>php_directoryphp)php;

php php php php php php php php ifphp php(php$thisphp-php>php_closeDirOnExitphp)php php{
php php php php php php php php php php php php php$thisphp-php>php_directoryphp-php>closephp(php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_directoryphp php php php php=php nullphp;
php php php php php php php php php$thisphp-php>php_writerphp php php php php php php php=php nullphp;
php php php php php php php php php$thisphp-php>php_segmentInfosphp php=php nullphp;

php php php php php php php php php$thisphp-php>php_closedphp php=php truephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Addphp referencephp tophp thephp indexphp object
php php php php php php*
php php php php php php*php php@internal
php php php php php php*php/
php php php php publicphp functionphp addReferencephp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_refCountphp+php+php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Removephp referencephp fromphp thephp indexphp object
php php php php php php*
php php php php php php*php Whenphp referencephp countphp becomesphp zerophp,php indexphp isphp closedphp andphp resourcesphp arephp cleanedphp up
php php php php php php*
php php php php php php*php php@internal
php php php php php php*php/
php php php php publicphp functionphp removeReferencephp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_refCountphp-php-php;

php php php php php php php php ifphp php(php$thisphp-php>php_refCountphp php=php=php php0php)php php{
php php php php php php php php php php php php php$thisphp-php>php_closephp(php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Objectphp destructor
php php php php php php*php/
php php php php publicphp functionphp php_php_destructphp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_closephp(php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp anphp instancephp ofphp Zendphp_Searchphp_Lucenephp_Indexphp_Writerphp forphp thephp index
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Searchphp_Lucenephp_Indexphp_Writer
php php php php php php*php/
php php php php privatephp functionphp php_getIndexWriterphp(php)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_writerphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Indexphp/Writerphp.phpphp'php;
php php php php php php php php php php php php php$thisphp-php>php_writerphp php=php newphp Zendphp_Searchphp_Lucenephp_Indexphp_Writerphp(php$thisphp-php>php_directoryphp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$thisphp-php>php_segmentInfosphp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$thisphp-php>php_formatVersionphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$thisphp-php>php_writerphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Returnsphp thephp Zendphp_Searchphp_Lucenephp_Storagephp_Directoryphp instancephp forphp thisphp indexphp.
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Searchphp_Lucenephp_Storagephp_Directory
php php php php php php*php/
php php php php publicphp functionphp getDirectoryphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_directoryphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Returnsphp thephp totalphp numberphp ofphp documentsphp inphp thisphp indexphp php(includingphp deletedphp documentsphp)php.
php php php php php php*
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp functionphp countphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_docCountphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp onephp greaterphp thanphp thephp largestphp possiblephp documentphp numberphp.
php php php php php php*php Thisphp mayphp bephp usedphp tophp,php ephp.gphp.php,php determinephp howphp bigphp tophp allocatephp aphp structurephp whichphp willphp have
php php php php php php*php anphp elementphp forphp everyphp documentphp numberphp inphp anphp indexphp.
php php php php php php*
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp functionphp maxDocphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>countphp(php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp thephp totalphp numberphp ofphp nonphp-deletedphp documentsphp inphp thisphp indexphp.
php php php php php php*
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp functionphp numDocsphp(php)
php php php php php{
php php php php php php php php php$numDocsphp php=php php0php;

php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segmentInfophp)php php{
php php php php php php php php php php php php php$numDocsphp php+php=php php$segmentInfophp-php>numDocsphp(php)php;
php php php php php php php php php}

php php php php php php php php returnphp php$numDocsphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Checksphp,php thatphp documentphp isphp deleted
php php php php php php*
php php php php php php*php php@paramphp integerphp php$id
php php php php php php*php php@returnphp boolean
php php php php php php*php php@throwsphp Zendphp_Searchphp_Lucenephp_Exceptionphp php php php Exceptionphp isphp thrownphp ifphp php$idphp isphp outphp ofphp thephp range
php php php php php php*php/
php php php php publicphp functionphp isDeletedphp(php$idphp)
php php php php php{
php php php php php php php php php$thisphp-php>commitphp(php)php;

php php php php php php php php ifphp php(php$idphp php>php=php php$thisphp-php>php_docCountphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Documentphp idphp isphp outphp ofphp thephp rangephp.php'php)php;
php php php php php php php php php}

php php php php php php php php php$segmentStartIdphp php=php php0php;
php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segmentInfophp)php php{
php php php php php php php php php php php php ifphp php(php$segmentStartIdphp php+php php$segmentInfophp-php>countphp(php)php php>php php$idphp)php php{
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$segmentStartIdphp php+php=php php$segmentInfophp-php>countphp(php)php;
php php php php php php php php php}

php php php php php php php php returnphp php$segmentInfophp-php>isDeletedphp(php$idphp php-php php$segmentStartIdphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp defaultphp searchphp fieldphp.
php php php php php php*
php php php php php php*php Nullphp meansphp,php thatphp searchphp isphp performedphp throughphp allphp fieldsphp byphp default
php php php php php php*
php php php php php php*php Defaultphp valuephp isphp null
php php php php php php*
php php php php php php*php php@paramphp stringphp php$fieldName
php php php php php php*php/
php php php php publicphp staticphp functionphp setDefaultSearchFieldphp(php$fieldNamephp)
php php php php php{
php php php php php php php php selfphp:php:php$php_defaultSearchFieldphp php=php php$fieldNamephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp defaultphp searchphp fieldphp.
php php php php php php*
php php php php php php*php Nullphp meansphp,php thatphp searchphp isphp performedphp throughphp allphp fieldsphp byphp default
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp staticphp functionphp getDefaultSearchFieldphp(php)
php php php php php{
php php php php php php php php returnphp selfphp:php:php$php_defaultSearchFieldphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp resultphp setphp limitphp.
php php php php php php*
php php php php php php*php php0php php(defaultphp)php meansphp nophp limit
php php php php php php*
php php php php php php*php php@paramphp integerphp php$limit
php php php php php php*php/
php php php php publicphp staticphp functionphp setResultSetLimitphp(php$limitphp)
php php php php php{
php php php php php php php php selfphp:php:php$php_resultSetLimitphp php=php php$limitphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp resultphp setphp limitphp.
php php php php php php*
php php php php php php*php php0php meansphp nophp limit
php php php php php php*
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp staticphp functionphp getResultSetLimitphp(php)
php php php php php{
php php php php php php php php returnphp selfphp:php:php$php_resultSetLimitphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp termsphp perphp queryphp limitphp.
php php php php php php*
php php php php php php*php php0php meansphp nophp limit
php php php php php php*
php php php php php php*php php@paramphp integerphp php$limit
php php php php php php*php/
php php php php publicphp staticphp functionphp setTermsPerQueryLimitphp(php$limitphp)
php php php php php{
php php php php php php php php selfphp:php:php$php_termsPerQueryLimitphp php=php php$limitphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp resultphp setphp limitphp.
php php php php php php*
php php php php php php*php php0php php(defaultphp)php meansphp nophp limit
php php php php php php*
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp staticphp functionphp getTermsPerQueryLimitphp(php)
php php php php php{
php php php php php php php php returnphp selfphp:php:php$php_termsPerQueryLimitphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp indexphp maxBufferedDocsphp option
php php php php php php*
php php php php php php*php maxBufferedDocsphp isphp aphp minimalphp numberphp ofphp documentsphp requiredphp before
php php php php php php*php thephp bufferedphp inphp-memoryphp documentsphp arephp writtenphp intophp aphp newphp Segment
php php php php php php*
php php php php php php*php Defaultphp valuephp isphp php1php0
php php php php php php*
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp functionphp getMaxBufferedDocsphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_getIndexWriterphp(php)php-php>maxBufferedDocsphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp indexphp maxBufferedDocsphp option
php php php php php php*
php php php php php php*php maxBufferedDocsphp isphp aphp minimalphp numberphp ofphp documentsphp requiredphp before
php php php php php php*php thephp bufferedphp inphp-memoryphp documentsphp arephp writtenphp intophp aphp newphp Segment
php php php php php php*
php php php php php php*php Defaultphp valuephp isphp php1php0
php php php php php php*
php php php php php php*php php@paramphp integerphp php$maxBufferedDocs
php php php php php php*php/
php php php php publicphp functionphp setMaxBufferedDocsphp(php$maxBufferedDocsphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_getIndexWriterphp(php)php-php>maxBufferedDocsphp php=php php$maxBufferedDocsphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp indexphp maxMergeDocsphp option
php php php php php php*
php php php php php php*php maxMergeDocsphp isphp aphp largestphp numberphp ofphp documentsphp everphp mergedphp byphp addDocumentphp(php)php.
php php php php php php*php Smallphp valuesphp php(ephp.gphp.php,php lessphp thanphp php1php0php,php0php0php0php)php arephp bestphp forphp interactivephp indexingphp,
php php php php php php*php asphp thisphp limitsphp thephp lengthphp ofphp pausesphp whilephp indexingphp tophp aphp fewphp secondsphp.
php php php php php php*php Largerphp valuesphp arephp bestphp forphp batchedphp indexingphp andphp speedierphp searchesphp.
php php php php php php*
php php php php php php*php Defaultphp valuephp isphp PHPphp_INTphp_MAX
php php php php php php*
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp functionphp getMaxMergeDocsphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_getIndexWriterphp(php)php-php>maxMergeDocsphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp indexphp maxMergeDocsphp option
php php php php php php*
php php php php php php*php maxMergeDocsphp isphp aphp largestphp numberphp ofphp documentsphp everphp mergedphp byphp addDocumentphp(php)php.
php php php php php php*php Smallphp valuesphp php(ephp.gphp.php,php lessphp thanphp php1php0php,php0php0php0php)php arephp bestphp forphp interactivephp indexingphp,
php php php php php php*php asphp thisphp limitsphp thephp lengthphp ofphp pausesphp whilephp indexingphp tophp aphp fewphp secondsphp.
php php php php php php*php Largerphp valuesphp arephp bestphp forphp batchedphp indexingphp andphp speedierphp searchesphp.
php php php php php php*
php php php php php php*php Defaultphp valuephp isphp PHPphp_INTphp_MAX
php php php php php php*
php php php php php php*php php@paramphp integerphp php$maxMergeDocs
php php php php php php*php/
php php php php publicphp functionphp setMaxMergeDocsphp(php$maxMergeDocsphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_getIndexWriterphp(php)php-php>maxMergeDocsphp php=php php$maxMergeDocsphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp indexphp mergeFactorphp option
php php php php php php*
php php php php php php*php mergeFactorphp determinesphp howphp oftenphp segmentphp indicesphp arephp mergedphp byphp addDocumentphp(php)php.
php php php php php php*php Withphp smallerphp valuesphp,php lessphp RAMphp isphp usedphp whilephp indexingphp,
php php php php php php*php andphp searchesphp onphp unoptimizedphp indicesphp arephp fasterphp,
php php php php php php*php butphp indexingphp speedphp isphp slowerphp.
php php php php php php*php Withphp largerphp valuesphp,php morephp RAMphp isphp usedphp duringphp indexingphp,
php php php php php php*php andphp whilephp searchesphp onphp unoptimizedphp indicesphp arephp slowerphp,
php php php php php php*php indexingphp isphp fasterphp.
php php php php php php*php Thusphp largerphp valuesphp php(php>php php1php0php)php arephp bestphp forphp batchphp indexphp creationphp,
php php php php php php*php andphp smallerphp valuesphp php(<php php1php0php)php forphp indicesphp thatphp arephp interactivelyphp maintainedphp.
php php php php php php*
php php php php php php*php Defaultphp valuephp isphp php1php0
php php php php php php*
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp functionphp getMergeFactorphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_getIndexWriterphp(php)php-php>mergeFactorphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp indexphp mergeFactorphp option
php php php php php php*
php php php php php php*php mergeFactorphp determinesphp howphp oftenphp segmentphp indicesphp arephp mergedphp byphp addDocumentphp(php)php.
php php php php php php*php Withphp smallerphp valuesphp,php lessphp RAMphp isphp usedphp whilephp indexingphp,
php php php php php php*php andphp searchesphp onphp unoptimizedphp indicesphp arephp fasterphp,
php php php php php php*php butphp indexingphp speedphp isphp slowerphp.
php php php php php php*php Withphp largerphp valuesphp,php morephp RAMphp isphp usedphp duringphp indexingphp,
php php php php php php*php andphp whilephp searchesphp onphp unoptimizedphp indicesphp arephp slowerphp,
php php php php php php*php indexingphp isphp fasterphp.
php php php php php php*php Thusphp largerphp valuesphp php(php>php php1php0php)php arephp bestphp forphp batchphp indexphp creationphp,
php php php php php php*php andphp smallerphp valuesphp php(<php php1php0php)php forphp indicesphp thatphp arephp interactivelyphp maintainedphp.
php php php php php php*
php php php php php php*php Defaultphp valuephp isphp php1php0
php php php php php php*
php php php php php php*php php@paramphp integerphp php$maxMergeDocs
php php php php php php*php/
php php php php publicphp functionphp setMergeFactorphp(php$mergeFactorphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_getIndexWriterphp(php)php-php>mergeFactorphp php=php php$mergeFactorphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Performsphp aphp queryphp againstphp thephp indexphp andphp returnsphp anphp array
php php php php php php*php ofphp Zendphp_Searchphp_Lucenephp_Searchphp_QueryHitphp objectsphp.
php php php php php php*php Inputphp isphp aphp stringphp orphp Zendphp_Searchphp_Lucenephp_Searchphp_Queryphp.
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Searchphp_QueryParserphp|stringphp php$query
php php php php php php*php php@returnphp arrayphp Zendphp_Searchphp_Lucenephp_Searchphp_QueryHit
php php php php php php*php php@throwsphp Zendphp_Searchphp_Lucenephp_Exception
php php php php php php*php/
php php php php publicphp functionphp findphp(php$queryphp)
php php php php php{
php php php php php php php php ifphp php(isphp_stringphp(php$queryphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/QueryParserphp.phpphp'php;

php php php php php php php php php php php php php$queryphp php=php Zendphp_Searchphp_Lucenephp_Searchphp_QueryParserphp:php:parsephp(php$queryphp)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!php$queryphp instanceofphp Zendphp_Searchphp_Lucenephp_Searchphp_Queryphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Queryphp mustphp bephp aphp stringphp orphp Zendphp_Searchphp_Lucenephp_Searchphp_Queryphp objectphp'php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>commitphp(php)php;

php php php php php php php php php$hitsphp php php php=php arrayphp(php)php;
php php php php php php php php php$scoresphp php=php arrayphp(php)php;
php php php php php php php php php$idsphp php php php php=php arrayphp(php)php;

php php php php php php php php php$queryphp php=php php$queryphp-php>rewritephp(php$thisphp)php-php>optimizephp(php$thisphp)php;

php php php php php php php php php$queryphp-php>executephp(php$thisphp)php;

php php php php php php php php php$topScorephp php=php php0php;

php php php php php php php php php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_QueryHitphp php*php/
php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/QueryHitphp.phpphp'php;

php php php php php php php php foreachphp php(php$queryphp-php>matchedDocsphp(php)php asphp php$idphp php=php>php php$numphp)php php{
php php php php php php php php php php php php php$docScorephp php=php php$queryphp-php>scorephp(php$idphp,php php$thisphp)php;
php php php php php php php php php php php php ifphp(php php$docScorephp php!php=php php0php php)php php{
php php php php php php php php php php php php php php php php php$hitphp php=php newphp Zendphp_Searchphp_Lucenephp_Searchphp_QueryHitphp(php$thisphp)php;
php php php php php php php php php php php php php php php php php$hitphp-php>idphp php=php php$idphp;
php php php php php php php php php php php php php php php php php$hitphp-php>scorephp php=php php$docScorephp;

php php php php php php php php php php php php php php php php php$hitsphp[php]php php php php=php php$hitphp;
php php php php php php php php php php php php php php php php php$idsphp[php]php php php php php=php php$idphp;
php php php php php php php php php php php php php php php php php$scoresphp[php]php php=php php$docScorephp;

php php php php php php php php php php php php php php php php ifphp php(php$docScorephp php>php php$topScorephp)php php{
php php php php php php php php php php php php php php php php php php php php php$topScorephp php=php php$docScorephp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}

php php php php php php php php php php php php ifphp php(selfphp:php:php$php_resultSetLimitphp php!php=php php0php php php&php&php php countphp(php$hitsphp)php php>php=php selfphp:php:php$php_resultSetLimitphp)php php{
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php ifphp php(countphp(php$hitsphp)php php=php=php php0php)php php{
php php php php php php php php php php php php php/php/php skipphp sortingphp,php whichphp mayphp causephp aphp errorphp onphp emptyphp index
php php php php php php php php php php php php returnphp arrayphp(php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$topScorephp php>php php1php)php php{
php php php php php php php php php php php php foreachphp php(php$hitsphp asphp php$hitphp)php php{
php php php php php php php php php php php php php php php php php$hitphp-php>scorephp php/php=php php$topScorephp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php ifphp php(funcphp_numphp_argsphp(php)php php=php=php php1php)php php{
php php php php php php php php php php php php php/php/php sortphp byphp scores
php php php php php php php php php php php php arrayphp_multisortphp(php$scoresphp,php SORTphp_DESCphp,php SORTphp_NUMERICphp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$idsphp,php php php php SORTphp_ASCphp,php php SORTphp_NUMERICphp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$hitsphp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php/php/php sortphp byphp givenphp fieldphp names

php php php php php php php php php php php php php$argListphp php php php php=php funcphp_getphp_argsphp(php)php;
php php php php php php php php php php php php php$fieldNamesphp php=php php$thisphp-php>getFieldNamesphp(php)php;
php php php php php php php php php php php php php$sortArgsphp php php php=php arrayphp(php)php;

php php php php php php php php php php php php php/php/php PHPphp php5php.php3php nowphp expectsphp allphp argumentsphp tophp arrayphp_multisortphp bephp passedphp by
php php php php php php php php php php php php php/php/php referencephp php(ifphp itphp'sphp invokedphp throughphp callphp_userphp_funcphp_arrayphp(php)php)php;
php php php php php php php php php php php php php/php/php sincephp constantsphp canphp'tphp bephp passedphp byphp referencephp,php createphp somephp placeholderphp variablesphp.
php php php php php php php php php php php php php$sortRegphp php php php php=php SORTphp_REGULARphp;
php php php php php php php php php php php php php$sortAscphp php php php php=php SORTphp_ASCphp;
php php php php php php php php php php php php php$sortNumphp php php php php=php SORTphp_NUMERICphp;

php php php php php php php php php php php php php$sortFieldValuesphp php=php arrayphp(php)php;

php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php forphp php(php$countphp php=php php1php;php php$countphp <php countphp(php$argListphp)php;php php$countphp+php+php)php php{
php php php php php php php php php php php php php php php php php$fieldNamephp php=php php$argListphp[php$countphp]php;

php php php php php php php php php php php php php php php php ifphp php(php!isphp_stringphp(php$fieldNamephp)php)php php{
php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Fieldphp namephp mustphp bephp aphp stringphp.php'php)php;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php ifphp php(strtolowerphp(php$fieldNamephp)php php=php=php php'scorephp'php)php php{
php php php php php php php php php php php php php php php php php php php php php$sortArgsphp[php]php php=php php&php$scoresphp;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php ifphp php(php!inphp_arrayphp(php$fieldNamephp,php php$fieldNamesphp)php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Wrongphp fieldphp namephp.php'php)php;
php php php php php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php php php php php ifphp php(php!issetphp(php$sortFieldValuesphp[php$fieldNamephp]php)php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php$valuesArrayphp php=php arrayphp(php)php;
php php php php php php php php php php php php php php php php php php php php php php php php foreachphp php(php$hitsphp asphp php$hitphp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php tryphp php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$valuephp php=php php$hitphp-php>getDocumentphp(php)php-php>getFieldValuephp(php$fieldNamephp)php;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php}php catchphp php(Zendphp_Searchphp_Lucenephp_Exceptionphp php$ephp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php ifphp php(strposphp(php$ephp-php>getMessagephp(php)php,php php'notphp foundphp'php)php php=php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php$ephp-php>getMessagephp(php)php,php php$ephp-php>getCodephp(php)php,php php$ephp)php;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$valuephp php=php nullphp;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$valuesArrayphp[php]php php=php php$valuephp;
php php php php php php php php php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php php php php php php php php php php/php/php Collectphp loadedphp valuesphp inphp php$sortFieldValues
php php php php php php php php php php php php php php php php php php php php php php php php php/php/php Requiredphp forphp PHPphp php5php.php3php whichphp translatesphp referencesphp intophp valuesphp whenphp source
php php php php php php php php php php php php php php php php php php php php php php php php php/php/php variablephp isphp destroyed
php php php php php php php php php php php php php php php php php php php php php php php php php$sortFieldValuesphp[php$fieldNamephp]php php=php php$valuesArrayphp;
php php php php php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php php php php php php$sortArgsphp[php]php php=php php&php$sortFieldValuesphp[php$fieldNamephp]php;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php ifphp php(php$countphp php+php php1php <php countphp(php$argListphp)php php php&php&php php isphp_integerphp(php$argListphp[php$countphp+php1php]php)php)php php{
php php php php php php php php php php php php php php php php php php php php php$countphp+php+php;
php php php php php php php php php php php php php php php php php php php php php$sortArgsphp[php]php php=php php&php$argListphp[php$countphp]php;

php php php php php php php php php php php php php php php php php php php php ifphp php(php$countphp php+php php1php <php countphp(php$argListphp)php php php&php&php php isphp_integerphp(php$argListphp[php$countphp+php1php]php)php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php$countphp+php+php;
php php php php php php php php php php php php php php php php php php php php php php php php php$sortArgsphp[php]php php=php php&php$argListphp[php$countphp]php;
php php php php php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php php php php ifphp php(php$argListphp[php$countphp]php php=php=php SORTphp_ASCphp php php|php|php php$argListphp[php$countphp]php php=php=php SORTphp_DESCphp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$sortArgsphp[php]php php=php php&php$sortRegphp;
php php php php php php php php php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$sortArgsphp[php]php php=php php&php$sortAscphp;
php php php php php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php$sortArgsphp[php]php php=php php&php$sortAscphp;
php php php php php php php php php php php php php php php php php php php php php$sortArgsphp[php]php php=php php&php$sortRegphp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}

php php php php php php php php php php php php php/php/php Sortphp byphp idphp'sphp ifphp valuesphp arephp equal
php php php php php php php php php php php php php$sortArgsphp[php]php php=php php&php$idsphp;
php php php php php php php php php php php php php$sortArgsphp[php]php php=php php&php$sortAscphp;
php php php php php php php php php php php php php$sortArgsphp[php]php php=php php&php$sortNumphp;

php php php php php php php php php php php php php/php/php Arrayphp tophp bephp sorted
php php php php php php php php php php php php php$sortArgsphp[php]php php=php php&php$hitsphp;

php php php php php php php php php php php php php/php/php Dophp sort
php php php php php php php php php php php php callphp_userphp_funcphp_arrayphp(php'arrayphp_multisortphp'php,php php$sortArgsphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$hitsphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Returnsphp aphp listphp ofphp allphp uniquephp fieldphp namesphp thatphp existphp inphp thisphp indexphp.
php php php php php php*
php php php php php php*php php@paramphp booleanphp php$indexed
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp getFieldNamesphp(php$indexedphp php=php falsephp)
php php php php php{
php php php php php php php php php$resultphp php=php arrayphp(php)php;
php php php php php php php php foreachphp(php php$thisphp-php>php_segmentInfosphp asphp php$segmentInfophp php)php php{
php php php php php php php php php php php php php$resultphp php=php arrayphp_mergephp(php$resultphp,php php$segmentInfophp-php>getFieldsphp(php$indexedphp)php)php;
php php php php php php php php php}
php php php php php php php php returnphp php$resultphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Returnsphp aphp Zendphp_Searchphp_Lucenephp_Documentphp objectphp forphp thephp document
php php php php php php*php numberphp php$idphp inphp thisphp indexphp.
php php php php php php*
php php php php php php*php php@paramphp integerphp|Zendphp_Searchphp_Lucenephp_Searchphp_QueryHitphp php$id
php php php php php php*php php@returnphp Zendphp_Searchphp_Lucenephp_Document
php php php php php php*php php@throwsphp Zendphp_Searchphp_Lucenephp_Exceptionphp php php php Exceptionphp isphp thrownphp ifphp php$idphp isphp outphp ofphp thephp range
php php php php php php*php/
php php php php publicphp functionphp getDocumentphp(php$idphp)
php php php php php{
php php php php php php php php ifphp php(php$idphp instanceofphp Zendphp_Searchphp_Lucenephp_Searchphp_QueryHitphp)php php{
php php php php php php php php php php php php php/php*php php@varphp php$idphp Zendphp_Searchphp_Lucenephp_Searchphp_QueryHitphp php*php/
php php php php php php php php php php php php php$idphp php=php php$idphp-php>idphp;
php php php php php php php php php}

php php php php php php php php ifphp php(php$idphp php>php=php php$thisphp-php>php_docCountphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Documentphp idphp isphp outphp ofphp thephp rangephp.php'php)php;
php php php php php php php php php}

php php php php php php php php php$segmentStartIdphp php=php php0php;
php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segmentInfophp)php php{
php php php php php php php php php php php php ifphp php(php$segmentStartIdphp php+php php$segmentInfophp-php>countphp(php)php php>php php$idphp)php php{
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$segmentStartIdphp php+php=php php$segmentInfophp-php>countphp(php)php;
php php php php php php php php php}

php php php php php php php php php$fdxFilephp php=php php$segmentInfophp-php>openCompoundFilephp(php'php.fdxphp'php)php;
php php php php php php php php php$fdxFilephp-php>seekphp(php(php$idphp-php$segmentStartIdphp)php*php8php,php SEEKphp_CURphp)php;
php php php php php php php php php$fieldValuesPositionphp php=php php$fdxFilephp-php>readLongphp(php)php;

php php php php php php php php php$fdtFilephp php=php php$segmentInfophp-php>openCompoundFilephp(php'php.fdtphp'php)php;
php php php php php php php php php$fdtFilephp-php>seekphp(php$fieldValuesPositionphp,php SEEKphp_CURphp)php;
php php php php php php php php php$fieldCountphp php=php php$fdtFilephp-php>readVIntphp(php)php;

php php php php php php php php php$docphp php=php newphp Zendphp_Searchphp_Lucenephp_Documentphp(php)php;
php php php php php php php php forphp php(php$countphp php=php php0php;php php$countphp <php php$fieldCountphp;php php$countphp+php+php)php php{
php php php php php php php php php php php php php$fieldNumphp php=php php$fdtFilephp-php>readVIntphp(php)php;
php php php php php php php php php php php php php$bitsphp php=php php$fdtFilephp-php>readBytephp(php)php;

php php php php php php php php php php php php php$fieldInfophp php=php php$segmentInfophp-php>getFieldphp(php$fieldNumphp)php;

php php php php php php php php php php php php ifphp php(php!php(php$bitsphp php&php php2php)php)php php{php php/php/php Textphp data
php php php php php php php php php php php php php php php php php$fieldphp php=php newphp Zendphp_Searchphp_Lucenephp_Fieldphp(php$fieldInfophp-php>namephp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$fdtFilephp-php>readStringphp(php)php,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php'UTFphp-php8php'php,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php truephp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$fieldInfophp-php>isIndexedphp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$bitsphp php&php php1php php)php;
php php php php php php php php php php php php php}php elsephp php{php php php php php php php php php php php php php/php/php Binaryphp data
php php php php php php php php php php php php php php php php php$fieldphp php=php newphp Zendphp_Searchphp_Lucenephp_Fieldphp(php$fieldInfophp-php>namephp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$fdtFilephp-php>readBinaryphp(php)php,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php'php'php,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php truephp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$fieldInfophp-php>isIndexedphp,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$bitsphp php&php php1php,
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php truephp php)php;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$docphp-php>addFieldphp(php$fieldphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$docphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Returnsphp truephp ifphp indexphp containphp documentsphp withphp specifiedphp termphp.
php php php php php php*
php php php php php php*php Isphp usedphp forphp queryphp optimizationphp.
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$term
php php php php php php*php php@returnphp boolean
php php php php php php*php/
php php php php publicphp functionphp hasTermphp(Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$termphp)
php php php php php{
php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segInfophp)php php{
php php php php php php php php php php php php ifphp php(php$segInfophp-php>getTermInfophp(php$termphp)php php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php returnphp truephp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp falsephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp IDsphp ofphp allphp documentsphp containingphp termphp.
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$term
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Indexphp_DocsFilterphp|nullphp php$docsFilter
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp termDocsphp(Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$termphp,php php$docsFilterphp php=php nullphp)
php php php php php{
php php php php php php php php php$subResultsphp php=php arrayphp(php)php;
php php php php php php php php php$segmentStartDocIdphp php=php php0php;

php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segmentInfophp)php php{
php php php php php php php php php php php php php$subResultsphp[php]php php=php php$segmentInfophp-php>termDocsphp(php$termphp,php php$segmentStartDocIdphp,php php$docsFilterphp)php;

php php php php php php php php php php php php php$segmentStartDocIdphp php+php=php php$segmentInfophp-php>countphp(php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(countphp(php$subResultsphp)php php=php=php php0php)php php{
php php php php php php php php php php php php returnphp arrayphp(php)php;
php php php php php php php php php}php elsephp ifphp php(countphp(php$subResultsphp)php php=php=php php1php)php php{
php php php php php php php php php php php php php/php/php Indexphp isphp optimizedphp php(onlyphp onephp segmentphp)
php php php php php php php php php php php php php/php/php Dophp notphp performphp arrayphp reindexing
php php php php php php php php php php php php returnphp resetphp(php$subResultsphp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$resultphp php=php callphp_userphp_funcphp_arrayphp(php'arrayphp_mergephp'php,php php$subResultsphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$resultphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp documentsphp filterphp forphp allphp documentsphp containingphp termphp.
php php php php php php*
php php php php php php*php Itphp performsphp thephp samephp operationphp asphp termDocsphp,php butphp returnphp resultphp as
php php php php php php*php Zendphp_Searchphp_Lucenephp_Indexphp_DocsFilterphp object
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$term
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Indexphp_DocsFilterphp|nullphp php$docsFilter
php php php php php php*php php@returnphp Zendphp_Searchphp_Lucenephp_Indexphp_DocsFilter
php php php php php php*php/
php php php php publicphp functionphp termDocsFilterphp(Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$termphp,php php$docsFilterphp php=php nullphp)
php php php php php{
php php php php php php php php php$segmentStartDocIdphp php=php php0php;
php php php php php php php php php$resultphp php=php newphp Zendphp_Searchphp_Lucenephp_Indexphp_DocsFilterphp(php)php;

php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segmentInfophp)php php{
php php php php php php php php php php php php php$subResultsphp[php]php php=php php$segmentInfophp-php>termDocsphp(php$termphp,php php$segmentStartDocIdphp,php php$docsFilterphp)php;

php php php php php php php php php php php php php$segmentStartDocIdphp php+php=php php$segmentInfophp-php>countphp(php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(countphp(php$subResultsphp)php php=php=php php0php)php php{
php php php php php php php php php php php php returnphp arrayphp(php)php;
php php php php php php php php php}php elsephp ifphp php(countphp(php$subResultsphp)php php=php=php php1php)php php{
php php php php php php php php php php php php php/php/php Indexphp isphp optimizedphp php(onlyphp onephp segmentphp)
php php php php php php php php php php php php php/php/php Dophp notphp performphp arrayphp reindexing
php php php php php php php php php php php php returnphp resetphp(php$subResultsphp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$resultphp php=php callphp_userphp_funcphp_arrayphp(php'arrayphp_mergephp'php,php php$subResultsphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$resultphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Returnsphp anphp arrayphp ofphp allphp termphp freqsphp.
php php php php php php*php Resultphp arrayphp structurephp:php arrayphp(docIdphp php=php>php freqphp,php php.php.php.php)
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$term
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Indexphp_DocsFilterphp|nullphp php$docsFilter
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp functionphp termFreqsphp(Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$termphp,php php$docsFilterphp php=php nullphp)
php php php php php{
php php php php php php php php php$resultphp php=php arrayphp(php)php;
php php php php php php php php php$segmentStartDocIdphp php=php php0php;
php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segmentInfophp)php php{
php php php php php php php php php php php php php$resultphp php+php=php php$segmentInfophp-php>termFreqsphp(php$termphp,php php$segmentStartDocIdphp,php php$docsFilterphp)php;

php php php php php php php php php php php php php$segmentStartDocIdphp php+php=php php$segmentInfophp-php>countphp(php)php;
php php php php php php php php php}

php php php php php php php php returnphp php$resultphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp anphp arrayphp ofphp allphp termphp positionsphp inphp thephp documentsphp.
php php php php php php*php Resultphp arrayphp structurephp:php arrayphp(docIdphp php=php>php arrayphp(posphp1php,php posphp2php,php php.php.php.php)php,php php.php.php.php)
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$term
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Indexphp_DocsFilterphp|nullphp php$docsFilter
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp termPositionsphp(Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$termphp,php php$docsFilterphp php=php nullphp)
php php php php php{
php php php php php php php php php$resultphp php=php arrayphp(php)php;
php php php php php php php php php$segmentStartDocIdphp php=php php0php;
php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segmentInfophp)php php{
php php php php php php php php php php php php php$resultphp php+php=php php$segmentInfophp-php>termPositionsphp(php$termphp,php php$segmentStartDocIdphp,php php$docsFilterphp)php;

php php php php php php php php php php php php php$segmentStartDocIdphp php+php=php php$segmentInfophp-php>countphp(php)php;
php php php php php php php php php}

php php php php php php php php returnphp php$resultphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Returnsphp thephp numberphp ofphp documentsphp inphp thisphp indexphp containingphp thephp php$termphp.
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$term
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp functionphp docFreqphp(Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$termphp)
php php php php php{
php php php php php php php php php$resultphp php=php php0php;
php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segInfophp)php php{
php php php php php php php php php php php php php$termInfophp php=php php$segInfophp-php>getTermInfophp(php$termphp)php;
php php php php php php php php php php php php ifphp php(php$termInfophp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php$resultphp php+php=php php$termInfophp-php>docFreqphp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp php$resultphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Retrivephp similarityphp usedphp byphp indexphp reader
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Searchphp_Lucenephp_Searchphp_Similarity
php php php php php php*php/
php php php php publicphp functionphp getSimilarityphp(php)
php php php php php{
php php php php php php php php php/php*php*php Zendphp_Searchphp_Lucenephp_Searchphp_Similarityphp php*php/
php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Searchphp/Similarityphp.phpphp'php;

php php php php php php php php returnphp Zendphp_Searchphp_Lucenephp_Searchphp_Similarityphp:php:getDefaultphp(php)php;
php php php php php}


php php php php php/php*php*
php php php php php php*php Returnsphp aphp normalizationphp factorphp forphp php"fieldphp,php documentphp"php pairphp.
php php php php php php*
php php php php php php*php php@paramphp integerphp php$id
php php php php php php*php php@paramphp stringphp php$fieldName
php php php php php php*php php@returnphp float
php php php php php php*php/
php php php php publicphp functionphp normphp(php$idphp,php php$fieldNamephp)
php php php php php{
php php php php php php php php ifphp php(php$idphp php>php=php php$thisphp-php>php_docCountphp)php php{
php php php php php php php php php php php php returnphp nullphp;
php php php php php php php php php}

php php php php php php php php php$segmentStartIdphp php=php php0php;
php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segInfophp)php php{
php php php php php php php php php php php php ifphp php(php$segmentStartIdphp php+php php$segInfophp-php>countphp(php)php php>php php$idphp)php php{
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$segmentStartIdphp php+php=php php$segInfophp-php>countphp(php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$segInfophp-php>isDeletedphp(php$idphp php-php php$segmentStartIdphp)php)php php{
php php php php php php php php php php php php returnphp php0php;
php php php php php php php php php}

php php php php php php php php returnphp php$segInfophp-php>normphp(php$idphp php-php php$segmentStartIdphp,php php$fieldNamephp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp truephp ifphp anyphp documentsphp havephp beenphp deletedphp fromphp thisphp indexphp.
php php php php php php*
php php php php php php*php php@returnphp boolean
php php php php php php*php/
php php php php publicphp functionphp hasDeletionsphp(php)
php php php php php{
php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segmentInfophp)php php{
php php php php php php php php php php php php ifphp php(php$segmentInfophp-php>hasDeletionsphp(php)php)php php{
php php php php php php php php php php php php php php php php returnphp truephp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp falsephp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Deletesphp aphp documentphp fromphp thephp indexphp.
php php php php php php*php php$idphp isphp anphp internalphp documentphp id
php php php php php php*
php php php php php php*php php@paramphp integerphp|Zendphp_Searchphp_Lucenephp_Searchphp_QueryHitphp php$id
php php php php php php*php php@throwsphp Zendphp_Searchphp_Lucenephp_Exception
php php php php php php*php/
php php php php publicphp functionphp deletephp(php$idphp)
php php php php php{
php php php php php php php php ifphp php(php$idphp instanceofphp Zendphp_Searchphp_Lucenephp_Searchphp_QueryHitphp)php php{
php php php php php php php php php php php php php/php*php php@varphp php$idphp Zendphp_Searchphp_Lucenephp_Searchphp_QueryHitphp php*php/
php php php php php php php php php php php php php$idphp php=php php$idphp-php>idphp;
php php php php php php php php php}

php php php php php php php php ifphp php(php$idphp php>php=php php$thisphp-php>php_docCountphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Searchphp_Lucenephp_Exceptionphp(php'Documentphp idphp isphp outphp ofphp thephp rangephp.php'php)php;
php php php php php php php php php}

php php php php php php php php php$segmentStartIdphp php=php php0php;
php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segmentInfophp)php php{
php php php php php php php php php php php php ifphp php(php$segmentStartIdphp php+php php$segmentInfophp-php>countphp(php)php php>php php$idphp)php php{
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$segmentStartIdphp php+php=php php$segmentInfophp-php>countphp(php)php;
php php php php php php php php php}
php php php php php php php php php$segmentInfophp-php>deletephp(php$idphp php-php php$segmentStartIdphp)php;

php php php php php php php php php$thisphp-php>php_hasChangesphp php=php truephp;
php php php php php}



php php php php php/php*php*
php php php php php php*php Addsphp aphp documentphp tophp thisphp indexphp.
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Documentphp php$document
php php php php php php*php/
php php php php publicphp functionphp addDocumentphp(Zendphp_Searchphp_Lucenephp_Documentphp php$documentphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_getIndexWriterphp(php)php-php>addDocumentphp(php$documentphp)php;
php php php php php php php php php$thisphp-php>php_docCountphp+php+php;

php php php php php php php php php$thisphp-php>php_hasChangesphp php=php truephp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Updatephp documentphp counter
php php php php php php*php/
php php php php privatephp functionphp php_updateDocCountphp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_docCountphp php=php php0php;
php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segInfophp)php php{
php php php php php php php php php php php php php$thisphp-php>php_docCountphp php+php=php php$segInfophp-php>countphp(php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Commitphp changesphp resultingphp fromphp deletephp(php)php orphp undeleteAllphp(php)php operationsphp.
php php php php php php*
php php php php php php*php php@todophp undeleteAllphp processingphp.
php php php php php php*php/
php php php php publicphp functionphp commitphp(php)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_hasChangesphp)php php{
php php php php php php php php php php php php php$thisphp-php>php_getIndexWriterphp(php)php-php>commitphp(php)php;

php php php php php php php php php php php php php$thisphp-php>php_updateDocCountphp(php)php;

php php php php php php php php php php php php php$thisphp-php>php_hasChangesphp php=php falsephp;
php php php php php php php php php}
php php php php php}


php php php php php/php*php*
php php php php php php*php Optimizephp indexphp.
php php php php php php*
php php php php php php*php Mergesphp allphp segmentsphp intophp one
php php php php php php*php/
php php php php publicphp functionphp optimizephp(php)
php php php php php{
php php php php php php php php php/php/php Commitphp changesphp ifphp anyphp changesphp havephp beenphp made
php php php php php php php php php$thisphp-php>commitphp(php)php;

php php php php php php php php ifphp php(countphp(php$thisphp-php>php_segmentInfosphp)php php>php php1php php|php|php php$thisphp-php>hasDeletionsphp(php)php)php php{
php php php php php php php php php php php php php$thisphp-php>php_getIndexWriterphp(php)php-php>optimizephp(php)php;
php php php php php php php php php php php php php$thisphp-php>php_updateDocCountphp(php)php;
php php php php php php php php php}
php php php php php}


php php php php php/php*php*
php php php php php php*php Returnsphp anphp arrayphp ofphp allphp termsphp inphp thisphp indexphp.
php php php php php php*
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp termsphp(php)
php php php php php{
php php php php php php php php php$resultphp php=php arrayphp(php)php;

php php php php php php php php php/php*php*php Zendphp_Searchphp_Lucenephp_Indexphp_TermsPriorityQueuephp php*php/
php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/Indexphp/TermsPriorityQueuephp.phpphp'php;

php php php php php php php php php$segmentInfoQueuephp php=php newphp Zendphp_Searchphp_Lucenephp_Indexphp_TermsPriorityQueuephp(php)php;

php php php php php php php php foreachphp php(php$thisphp-php>php_segmentInfosphp asphp php$segmentInfophp)php php{
php php php php php php php php php php php php php$segmentInfophp-php>resetTermsStreamphp(php)php;

php php php php php php php php php php php php php/php/php Skipphp php"emptyphp"php segments
php php php php php php php php php php php php ifphp php(php$segmentInfophp-php>currentTermphp(php)php php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php$segmentInfoQueuephp-php>putphp(php$segmentInfophp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php whilephp php(php(php$segmentInfophp php=php php$segmentInfoQueuephp-php>popphp(php)php)php php!php=php=php nullphp)php php{
php php php php php php php php php php php php ifphp php(php$segmentInfoQueuephp-php>topphp(php)php php=php=php=php nullphp php|php|
php php php php php php php php php php php php php php php php php$segmentInfoQueuephp-php>topphp(php)php-php>currentTermphp(php)php-php>keyphp(php)php php!php=
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$segmentInfophp-php>currentTermphp(php)php-php>keyphp(php)php)php php{
php php php php php php php php php php php php php php php php php/php/php Wephp gotphp newphp term
php php php php php php php php php php php php php php php php php$resultphp[php]php php=php php$segmentInfophp-php>currentTermphp(php)php;
php php php php php php php php php php php php php}

php php php php php php php php php php php php ifphp php(php$segmentInfophp-php>nextTermphp(php)php php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php/php/php Putphp segmentphp backphp intophp thephp priorityphp queue
php php php php php php php php php php php php php php php php php$segmentInfoQueuephp-php>putphp(php$segmentInfophp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp php$resultphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Termsphp streamphp priorityphp queuephp object
php php php php php php*
php php php php php php*php php@varphp Zendphp_Searchphp_Lucenephp_TermStreamsPriorityQueue
php php php php php php*php/
php php php php privatephp php$php_termsStreamphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php Resetphp termsphp streamphp.
php php php php php php*php/
php php php php publicphp functionphp resetTermsStreamphp(php)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_termsStreamphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php php/php*php*php Zendphp_Searchphp_Lucenephp_TermStreamsPriorityQueuephp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Searchphp/Lucenephp/TermStreamsPriorityQueuephp.phpphp'php;

php php php php php php php php php php php php php$thisphp-php>php_termsStreamphp php=php newphp Zendphp_Searchphp_Lucenephp_TermStreamsPriorityQueuephp(php$thisphp-php>php_segmentInfosphp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$thisphp-php>php_termsStreamphp-php>resetTermsStreamphp(php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Skipphp termsphp streamphp upphp tophp thephp specifiedphp termphp preffixphp.
php php php php php php*
php php php php php php*php Prefixphp containsphp fullyphp specifiedphp fieldphp infophp andphp portionphp ofphp searchedphp term
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$prefix
php php php php php php*php/
php php php php publicphp functionphp skipTophp(Zendphp_Searchphp_Lucenephp_Indexphp_Termphp php$prefixphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_termsStreamphp-php>skipTophp(php$prefixphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Scansphp termsphp dictionaryphp andphp returnsphp nextphp term
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Searchphp_Lucenephp_Indexphp_Termphp|null
php php php php php php*php/
php php php php publicphp functionphp nextTermphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_termsStreamphp-php>nextTermphp(php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp termphp inphp currentphp position
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Searchphp_Lucenephp_Indexphp_Termphp|null
php php php php php php*php/
php php php php publicphp functionphp currentTermphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_termsStreamphp-php>currentTermphp(php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Closephp termsphp stream
php php php php php php*
php php php php php php*php Shouldphp bephp usedphp forphp resourcesphp cleanphp upphp ifphp streamphp isphp notphp readphp upphp tophp thephp end
php php php php php php*php/
php php php php publicphp functionphp closeTermsStreamphp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_termsStreamphp-php>closeTermsStreamphp(php)php;
php php php php php php php php php$thisphp-php>php_termsStreamphp php=php nullphp;
php php php php php}


php php php php php/php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*
php php php php php@todophp UNIMPLEMENTED
php php php php php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php*php/
php php php php php/php*php*
php php php php php php*php Undeletesphp allphp documentsphp currentlyphp markedphp asphp deletedphp inphp thisphp indexphp.
php php php php php php*
php php php php php php*php php@todophp Implementation
php php php php php php*php/
php php php php publicphp functionphp undeleteAllphp(php)
php php php php php{php}
php}
