<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Pdf
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Pdfphp.phpphp php2php2php9php0php8php php2php0php1php0php-php0php8php-php2php5php php2php0php:php5php2php:php4php7Zphp alexanderphp php$
php php*php/


php/php*php*php Userphp landphp classesphp andphp interfacesphp turnedphp onphp byphp Zendphp/Pdfphp.phpphp filephp inclusionphp.php php*php/
php/php*php*php php@todophp Sectionphp shouldphp bephp removedphp withphp ZFphp php2php.php0php releasephp asphp obsoletephp php php php php php php php php php php php php*php/

php/php*php*php Zendphp_Pdfphp_Pagephp php*php/
requirephp_oncephp php'Zendphp/Pdfphp/Pagephp.phpphp'php;

php/php*php*php Zendphp_Pdfphp_Stylephp php*php/
requirephp_oncephp php'Zendphp/Pdfphp/Stylephp.phpphp'php;

php/php*php*php Zendphp_Pdfphp_Colorphp_GrayScalephp php*php/
requirephp_oncephp php'Zendphp/Pdfphp/Colorphp/GrayScalephp.phpphp'php;

php/php*php*php Zendphp_Pdfphp_Colorphp_Rgbphp php*php/
requirephp_oncephp php'Zendphp/Pdfphp/Colorphp/Rgbphp.phpphp'php;

php/php*php*php Zendphp_Pdfphp_Colorphp_Cmykphp php*php/
requirephp_oncephp php'Zendphp/Pdfphp/Colorphp/Cmykphp.phpphp'php;

php/php*php*php Zendphp_Pdfphp_Colorphp_Htmlphp php*php/
requirephp_oncephp php'Zendphp/Pdfphp/Colorphp/Htmlphp.phpphp'php;

php/php*php*php Zendphp_Pdfphp_Imagephp php*php/
requirephp_oncephp php'Zendphp/Pdfphp/Imagephp.phpphp'php;

php/php*php*php Zendphp_Pdfphp_Fontphp php*php/
requirephp_oncephp php'Zendphp/Pdfphp/Fontphp.phpphp'php;

php/php*php*php Zendphp_Pdfphp_Resourcephp_Extractorphp php*php/
requirephp_oncephp php'Zendphp/Pdfphp/Resourcephp/Extractorphp.phpphp'php;

php/php*php*php Zendphp_Pdfphp_Canvasphp php*php/
requirephp_oncephp php'Zendphp/Pdfphp/Canvasphp.phpphp'php;


php/php*php*php Internallyphp usedphp classesphp php*php/
requirephp_oncephp php'Zendphp/Pdfphp/Elementphp.phpphp'php;
requirephp_oncephp php'Zendphp/Pdfphp/Elementphp/Arrayphp.phpphp'php;
requirephp_oncephp php'Zendphp/Pdfphp/Elementphp/Stringphp/Binaryphp.phpphp'php;
requirephp_oncephp php'Zendphp/Pdfphp/Elementphp/Booleanphp.phpphp'php;
requirephp_oncephp php'Zendphp/Pdfphp/Elementphp/Dictionaryphp.phpphp'php;
requirephp_oncephp php'Zendphp/Pdfphp/Elementphp/Namephp.phpphp'php;
requirephp_oncephp php'Zendphp/Pdfphp/Elementphp/Nullphp.phpphp'php;
requirephp_oncephp php'Zendphp/Pdfphp/Elementphp/Numericphp.phpphp'php;
requirephp_oncephp php'Zendphp/Pdfphp/Elementphp/Stringphp.phpphp'php;


php/php*php*
php php*php Generalphp entityphp whichphp describesphp PDFphp documentphp.
php php*php Itphp implementsphp documentphp abstractionphp withphp aphp documentphp levelphp operationsphp.
php php*
php php*php Classphp isphp usedphp tophp createphp newphp PDFphp documentphp orphp loadphp existingphp documentphp.
php php*php Seephp detailsphp inphp aphp classphp constructorphp description
php php*
php php*php Classphp agregatesphp documentphp levelphp propertiesphp andphp entitiesphp php(pagesphp,php bookmarksphp,
php php*php documentphp levelphp actionsphp,php attachmentsphp,php formphp objectphp,php etcphp)
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Pdf
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_Pdf
php{
php php php/php*php*php*php*php Classphp Constantsphp php*php*php*php*php/

php php php php php/php*php*
php php php php php php*php Versionphp numberphp ofphp generatedphp PDFphp documentsphp.
php php php php php php*php/
php php php php constphp PDFphp_VERSIONphp php=php php'php1php.php4php'php;

php php php php php/php*php*
php php php php php php*php PDFphp filephp headerphp.
php php php php php php*php/
php php php php constphp PDFphp_HEADERphp php php=php php"php%PDFphp-php1php.php4php\nphp%php\xEphp2php\xEphp3php\xCFphp\xDphp3php\nphp"php;



php php php php php/php*php*
php php php php php php*php Pagesphp collection
php php php php php php*
php php php php php php*php php@todophp implementphp itphp asphp aphp classphp,php whichphp supportsphp ArrayAccessphp andphp Iteratorphp interfacesphp,
php php php php php php*php php php php php php php tophp providephp incrementalphp parsingphp andphp pagesphp treephp updatingphp.
php php php php php php*php php php php php php php Thatphp willphp givephp goodphp performancephp andphp memoryphp php(PDFphp sizephp)php benefitsphp.
php php php php php php*
php php php php php php*php php@varphp arrayphp php php php-php arrayphp ofphp Zendphp_Pdfphp_Pagephp object
php php php php php php*php/
php php php php publicphp php$pagesphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Documentphp properties
php php php php php php*
php php php php php php*php Itphp'sphp anphp associativephp arrayphp withphp PDFphp metaphp informationphp,php valuesphp may
php php php php php php*php bephp stringphp,php booleanphp orphp floatphp.
php php php php php php*php Returnedphp arrayphp couldphp bephp usedphp directlyphp tophp accessphp,php addphp,php modifyphp orphp remove
php php php php php php*php documentphp propertiesphp.
php php php php php php*
php php php php php php*php Standardphp documentphp propertiesphp:php Titlephp php(mustphp bephp setphp forphp PDFphp/Xphp documentsphp)php,php Authorphp,
php php php php php php*php Subjectphp,php Keywordsphp php(commaphp separatedphp listphp)php,php Creatorphp php(thephp namephp ofphp thephp applicationphp,
php php php php php php*php thatphp createdphp documentphp,php ifphp itphp wasphp convertedphp fromphp otherphp formatphp)php,php Trappedphp php(mustphp be
php php php php php php*php truephp,php falsephp orphp nullphp,php canphp notphp bephp nullphp forphp PDFphp/Xphp documentsphp)
php php php php php php*
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php publicphp php$propertiesphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Originalphp propertiesphp setphp.
php php php php php php*
php php php php php php*php Usedphp forphp trackingphp propertiesphp changes
php php php php php php*
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_originalPropertiesphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Documentphp levelphp javascript
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_javaScriptphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php Documentphp namedphp destinationsphp orphp php"GoTophp.php.php.php"php actionsphp,php usedphp tophp refer
php php php php php php*php documentphp partsphp fromphp outsidephp PDF
php php php php php php*
php php php php php php*php php@varphp arrayphp php php php-php arrayphp ofphp Zendphp_Pdfphp_Targetphp objects
php php php php php php*php/
php php php php protectedphp php$php_namedTargetsphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Documentphp outlines
php php php php php php*
php php php php php php*php php@varphp arrayphp php-php arrayphp ofphp Zendphp_Pdfphp_Outlinephp objects
php php php php php php*php/
php php php php publicphp php$outlinesphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Originalphp documentphp outlinesphp list
php php php php php php*php Usedphp tophp trackphp outlinesphp update
php php php php php php*
php php php php php php*php php@varphp arrayphp php-php arrayphp ofphp Zendphp_Pdfphp_Outlinephp objects
php php php php php php*php/
php php php php protectedphp php$php_originalOutlinesphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Originalphp documentphp outlinesphp openphp elementsphp count
php php php php php php*php Usedphp tophp trackphp outlinesphp update
php php php php php php*
php php php php php php*php php@varphp integer
php php php php php php*php/
php php php php protectedphp php$php_originalOpenOutlinesCountphp php=php php0php;

php php php php php/php*php*
php php php php php php*php Pdfphp trailerphp php(lastphp orphp justphp createdphp)
php php php php php php*
php php php php php php*php php@varphp Zendphp_Pdfphp_Trailer
php php php php php php*php/
php php php php protectedphp php$php_trailerphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php PDFphp objectsphp factoryphp.
php php php php php php*
php php php php php php*php php@varphp Zendphp_Pdfphp_ElementFactoryphp_Interface
php php php php php php*php/
php php php php protectedphp php$php_objFactoryphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php Memoryphp managerphp forphp streamphp objects
php php php php php php*
php php php php php php*php php@varphp Zendphp_Memoryphp_Managerphp|null
php php php php php php*php/
php php php php protectedphp staticphp php$php_memoryManagerphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php Pdfphp filephp parserphp.
php php php php php php*php Itphp'sphp notphp usedphp,php butphp hasphp tophp bephp destroyedphp onlyphp withphp Zendphp_Pdfphp object
php php php php php php*
php php php php php php*php php@varphp Zendphp_Pdfphp_Parser
php php php php php php*php/
php php php php protectedphp php$php_parserphp;


php php php php php/php*php*
php php php php php php*php Listphp ofphp inheritablephp attributesforphp pagesphp tree
php php php php php php*
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp staticphp php$php_inheritableAttributesphp php=php arrayphp(php'Resourcesphp'php,php php'MediaBoxphp'php,php php'CropBoxphp'php,php php'Rotatephp'php)php;

php php php php php/php*php*
php php php php php php*php Requestphp usedphp memoryphp manager
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Memoryphp_Manager
php php php php php php*php/
php php php php staticphp publicphp functionphp getMemoryManagerphp(php)
php php php php php{
php php php php php php php php ifphp php(selfphp:php:php$php_memoryManagerphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Memoryphp.phpphp'php;
php php php php php php php php php php php php selfphp:php:php$php_memoryManagerphp php=php Zendphp_Memoryphp:php:factoryphp(php'nonephp'php)php;
php php php php php php php php php}

php php php php php php php php returnphp selfphp:php:php$php_memoryManagerphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp userphp definedphp memoryphp manager
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Memoryphp_Managerphp php$memoryManager
php php php php php php*php/
php php php php staticphp publicphp functionphp setMemoryManagerphp(Zendphp_Memoryphp_Managerphp php$memoryManagerphp)
php php php php php{
php php php php php php php php selfphp:php:php$php_memoryManagerphp php=php php$memoryManagerphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Createphp newphp PDFphp documentphp fromphp aphp php$sourcephp string
php php php php php php*
php php php php php php*php php@paramphp stringphp php$source
php php php php php php*php php@paramphp integerphp php$revision
php php php php php php*php php@returnphp Zendphp_Pdf
php php php php php php*php/
php php php php publicphp staticphp functionphp parsephp(php&php$sourcephp php=php nullphp,php php$revisionphp php=php nullphp)
php php php php php{
php php php php php php php php returnphp newphp Zendphp_Pdfphp(php$sourcephp,php php$revisionphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Loadphp PDFphp documentphp fromphp aphp file
php php php php php php*
php php php php php php*php php@paramphp stringphp php$source
php php php php php php*php php@paramphp integerphp php$revision
php php php php php php*php php@returnphp Zendphp_Pdf
php php php php php php*php/
php php php php publicphp staticphp functionphp loadphp(php$sourcephp php=php nullphp,php php$revisionphp php=php nullphp)
php php php php php{
php php php php php php php php returnphp newphp Zendphp_Pdfphp(php$sourcephp,php php$revisionphp,php truephp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Renderphp PDFphp documentphp andphp savephp itphp.
php php php php php php*
php php php php php php*php Ifphp php$updateOnlyphp isphp truephp,php thenphp itphp onlyphp appendsphp newphp sectionphp tophp thephp endphp ofphp filephp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$filename
php php php php php php*php php@paramphp booleanphp php$updateOnly
php php php php php php*php php@throwsphp Zendphp_Pdfphp_Exception
php php php php php php*php/
php php php php publicphp functionphp savephp(php$filenamephp,php php$updateOnlyphp php=php falsephp)
php php php php php{
php php php php php php php php ifphp php(php(php$filephp php=php php@fopenphp(php$filenamephp,php php$updateOnlyphp php?php php'abphp'php:php'wbphp'php)php)php php=php=php=php falsephp php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php php"Canphp notphp openphp php'php$filenamephp'php filephp forphp writingphp.php"php php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>renderphp(php$updateOnlyphp,php php$filephp)php;

php php php php php php php php fclosephp(php$filephp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Createsphp orphp loadsphp PDFphp documentphp.
php php php php php php*
php php php php php php*php Ifphp php$sourcephp isphp nullphp,php thenphp itphp createsphp aphp newphp documentphp.
php php php php php php*
php php php php php php*php Ifphp php$sourcephp isphp aphp stringphp andphp php$loadphp isphp falsephp,php thenphp itphp loadsphp document
php php php php php php*php fromphp aphp binaryphp stringphp.
php php php php php php*
php php php php php php*php Ifphp php$sourcephp isphp aphp stringphp andphp php$loadphp isphp truephp,php thenphp itphp loadsphp document
php php php php php php*php fromphp aphp filephp.

php php php php php php*php php$revisionphp usedphp tophp rollphp backphp documentphp tophp specifiedphp version
php php php php php php*php php(php0php php-php currentphp versionphp,php php1php php-php previousphp versionphp,php php2php php-php php.php.php.php)
php php php php php php*
php php php php php php*php php@paramphp stringphp php php$sourcephp php-php PDFphp filephp tophp load
php php php php php php*php php@paramphp integerphp php$revision
php php php php php php*php php@throwsphp Zendphp_Pdfphp_Exception
php php php php php php*php php@returnphp Zendphp_Pdf
php php php php php php*php/
php php php php publicphp functionphp php_php_constructphp(php$sourcephp php=php nullphp,php php$revisionphp php=php nullphp,php php$loadphp php=php falsephp)
php php php php php{
php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/ElementFactoryphp.phpphp'php;
php php php php php php php php php$thisphp-php>php_objFactoryphp php=php Zendphp_Pdfphp_ElementFactoryphp:php:createFactoryphp(php1php)php;

php php php php php php php php ifphp php(php$sourcephp php!php=php=php nullphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Parserphp.phpphp'php;
php php php php php php php php php php php php php$thisphp-php>php_parserphp php php php php php php php php php php php=php newphp Zendphp_Pdfphp_Parserphp(php$sourcephp,php php$thisphp-php>php_objFactoryphp,php php$loadphp)php;
php php php php php php php php php php php php php$thisphp-php>php_pdfHeaderVersionphp php=php php$thisphp-php>php_parserphp-php>getPDFVersionphp(php)php;
php php php php php php php php php php php php php$thisphp-php>php_trailerphp php php php php php php php php php php=php php$thisphp-php>php_parserphp-php>getTrailerphp(php)php;
php php php php php php php php php php php php ifphp php(php$thisphp-php>php_trailerphp-php>Encryptphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'Encryptedphp documentphp modificationphp isphp notphp supportedphp'php)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php ifphp php(php$revisionphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php$thisphp-php>rollbackphp(php$revisionphp)php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$thisphp-php>php_loadPagesphp(php$thisphp-php>php_trailerphp-php>Rootphp-php>Pagesphp)php;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$thisphp-php>php_loadNamedDestinationsphp(php$thisphp-php>php_trailerphp-php>Rootphp,php php$thisphp-php>php_parserphp-php>getPDFVersionphp(php)php)php;
php php php php php php php php php php php php php$thisphp-php>php_loadOutlinesphp(php$thisphp-php>php_trailerphp-php>Rootphp)php;

php php php php php php php php php php php php ifphp php(php$thisphp-php>php_trailerphp-php>Infophp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php$thisphp-php>propertiesphp php=php php$thisphp-php>php_trailerphp-php>Infophp-php>toPhpphp(php)php;

php php php php php php php php php php php php php php php php ifphp php(issetphp(php$thisphp-php>propertiesphp[php'Trappedphp'php]php)php)php php{
php php php php php php php php php php php php php php php php php php php php switchphp php(php$thisphp-php>propertiesphp[php'Trappedphp'php]php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php casephp php'Truephp'php:
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$thisphp-php>propertiesphp[php'Trappedphp'php]php php=php truephp;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php breakphp;

php php php php php php php php php php php php php php php php php php php php php php php php casephp php'Falsephp'php:
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$thisphp-php>propertiesphp[php'Trappedphp'php]php php=php falsephp;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php breakphp;

php php php php php php php php php php php php php php php php php php php php php php php php casephp php'Unknownphp'php:
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$thisphp-php>propertiesphp[php'Trappedphp'php]php php=php nullphp;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php breakphp;

php php php php php php php php php php php php php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php/php/php Wrongphp propertyphp value
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php/php/php Dophp nothing
php php php php php php php php php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php php$thisphp-php>php_originalPropertiesphp php=php php$thisphp-php>propertiesphp;
php php php php php php php php php php php php php}
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$thisphp-php>php_pdfHeaderVersionphp php=php Zendphp_Pdfphp:php:PDFphp_VERSIONphp;

php php php php php php php php php php php php php$trailerDictionaryphp php=php newphp Zendphp_Pdfphp_Elementphp_Dictionaryphp(php)php;

php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php*php Documentphp id
php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php php$docIdphp php=php mdphp5php(uniqidphp(randphp(php)php,php truephp)php)php;php php php php/php/php php3php2php bytephp php(php1php2php8php bitphp)php identifier
php php php php php php php php php php php php php$docIdLowphp php php=php substrphp(php$docIdphp,php php php0php,php php1php6php)php;php php php/php/php firstphp php1php6php bytes
php php php php php php php php php php php php php$docIdHighphp php=php substrphp(php$docIdphp,php php1php6php,php php1php6php)php;php php php/php/php secondphp php1php6php bytes

php php php php php php php php php php php php php$trailerDictionaryphp-php>IDphp php=php newphp Zendphp_Pdfphp_Elementphp_Arrayphp(php)php;
php php php php php php php php php php php php php$trailerDictionaryphp-php>IDphp-php>itemsphp[php]php php=php newphp Zendphp_Pdfphp_Elementphp_Stringphp_Binaryphp(php$docIdLowphp)php;
php php php php php php php php php php php php php$trailerDictionaryphp-php>IDphp-php>itemsphp[php]php php=php newphp Zendphp_Pdfphp_Elementphp_Stringphp_Binaryphp(php$docIdHighphp)php;

php php php php php php php php php php php php php$trailerDictionaryphp-php>Sizephp php=php newphp Zendphp_Pdfphp_Elementphp_Numericphp(php0php)php;

php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Trailerphp/Generatorphp.phpphp'php;
php php php php php php php php php php php php php$thisphp-php>php_trailerphp php=php newphp Zendphp_Pdfphp_Trailerphp_Generatorphp(php$trailerDictionaryphp)php;

php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php*php Documentphp catalogphp indirectphp objectphp.
php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php php$docCatalogphp php=php php$thisphp-php>php_objFactoryphp-php>newObjectphp(newphp Zendphp_Pdfphp_Elementphp_Dictionaryphp(php)php)php;
php php php php php php php php php php php php php$docCatalogphp-php>Typephp php php php php=php newphp Zendphp_Pdfphp_Elementphp_Namephp(php'Catalogphp'php)php;
php php php php php php php php php php php php php$docCatalogphp-php>Versionphp php=php newphp Zendphp_Pdfphp_Elementphp_Namephp(Zendphp_Pdfphp:php:PDFphp_VERSIONphp)php;
php php php php php php php php php php php php php$thisphp-php>php_trailerphp-php>Rootphp php=php php$docCatalogphp;

php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php*php Pagesphp container
php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php php$docPagesphp php=php php$thisphp-php>php_objFactoryphp-php>newObjectphp(newphp Zendphp_Pdfphp_Elementphp_Dictionaryphp(php)php)php;
php php php php php php php php php php php php php$docPagesphp-php>Typephp php php=php newphp Zendphp_Pdfphp_Elementphp_Namephp(php'Pagesphp'php)php;
php php php php php php php php php php php php php$docPagesphp-php>Kidsphp php php=php newphp Zendphp_Pdfphp_Elementphp_Arrayphp(php)php;
php php php php php php php php php php php php php$docPagesphp-php>Countphp php=php newphp Zendphp_Pdfphp_Elementphp_Numericphp(php0php)php;
php php php php php php php php php php php php php$docCatalogphp-php>Pagesphp php=php php$docPagesphp;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrivephp numberphp ofphp revisionsphp.
php php php php php php*
php php php php php php*php php@returnphp integer
php php php php php php*php/
php php php php publicphp functionphp revisionsphp(php)
php php php php php{
php php php php php php php php php$revisionsphp php=php php1php;
php php php php php php php php php$currentTrailerphp php=php php$thisphp-php>php_trailerphp;

php php php php php php php php whilephp php(php$currentTrailerphp-php>getPrevphp(php)php php!php=php=php nullphp php&php&php php$currentTrailerphp-php>getPrevphp(php)php-php>Rootphp php!php=php=php nullphp php)php php{
php php php php php php php php php php php php php$revisionsphp+php+php;
php php php php php php php php php php php php php$currentTrailerphp php=php php$currentTrailerphp-php>getPrevphp(php)php;
php php php php php php php php php}

php php php php php php php php returnphp php$revisionsphp+php+php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Rollbackphp documentphp php$stepsphp numberphp ofphp revisionsphp.
php php php php php php*php Thisphp methodphp mustphp bephp invokedphp beforephp anyphp changesphp,php appliedphp tophp thephp documentphp.
php php php php php php*php Otherwisephp behaviorphp isphp undefinedphp.
php php php php php php*
php php php php php php*php php@paramphp integerphp php$steps
php php php php php php*php/
php php php php publicphp functionphp rollbackphp(php$stepsphp)
php php php php php{
php php php php php php php php forphp php(php$countphp php=php php0php;php php$countphp <php php$stepsphp;php php$countphp+php+php)php php{
php php php php php php php php php php php php ifphp php(php$thisphp-php>php_trailerphp-php>getPrevphp(php)php php!php=php=php nullphp php&php&php php$thisphp-php>php_trailerphp-php>getPrevphp(php)php-php>Rootphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php$thisphp-php>php_trailerphp php=php php$thisphp-php>php_trailerphp-php>getPrevphp(php)php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php php$thisphp-php>php_objFactoryphp-php>setObjectCountphp(php$thisphp-php>php_trailerphp-php>Sizephp-php>valuephp)php;

php php php php php php php php php/php/php Markphp contentphp asphp modifiedphp tophp forcephp newphp trailerphp generationphp atphp renderphp time
php php php php php php php php php$thisphp-php>php_trailerphp-php>Rootphp-php>touchphp(php)php;

php php php php php php php php php$thisphp-php>pagesphp php=php arrayphp(php)php;
php php php php php php php php php$thisphp-php>php_loadPagesphp(php$thisphp-php>php_trailerphp-php>Rootphp-php>Pagesphp)php;
php php php php php}


php php php php php/php*php*
php php php php php php*php Loadphp pagesphp recursively
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Pdfphp_Elementphp_Referencephp php$pages
php php php php php php*php php@paramphp arrayphp|nullphp php$attributes
php php php php php php*php/
php php php php protectedphp functionphp php_loadPagesphp(Zendphp_Pdfphp_Elementphp_Referencephp php$pagesphp,php php$attributesphp php=php arrayphp(php)php)
php php php php php{
php php php php php php php php ifphp php(php$pagesphp-php>getTypephp(php)php php!php=php Zendphp_Pdfphp_Elementphp:php:TYPEphp_DICTIONARYphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'Wrongphp argumentphp'php)php;
php php php php php php php php php}

php php php php php php php php foreachphp php(php$pagesphp-php>getKeysphp(php)php asphp php$propertyphp)php php{
php php php php php php php php php php php php ifphp php(inphp_arrayphp(php$propertyphp,php selfphp:php:php$php_inheritableAttributesphp)php)php php{
php php php php php php php php php php php php php php php php php$attributesphp[php$propertyphp]php php=php php$pagesphp-php>php$propertyphp;
php php php php php php php php php php php php php php php php php$pagesphp-php>php$propertyphp php=php nullphp;
php php php php php php php php php php php php php}
php php php php php php php php php}


php php php php php php php php foreachphp php(php$pagesphp-php>Kidsphp-php>itemsphp asphp php$childphp)php php{
php php php php php php php php php php php php ifphp php(php$childphp-php>Typephp-php>valuephp php=php=php php'Pagesphp'php)php php{
php php php php php php php php php php php php php php php php php$thisphp-php>php_loadPagesphp(php$childphp,php php$attributesphp)php;
php php php php php php php php php php php php php}php elsephp ifphp php(php$childphp-php>Typephp-php>valuephp php=php=php php'Pagephp'php)php php{
php php php php php php php php php php php php php php php php foreachphp php(selfphp:php:php$php_inheritableAttributesphp asphp php$propertyphp)php php{
php php php php php php php php php php php php php php php php php php php php ifphp php(php$childphp-php>php$propertyphp php=php=php=php nullphp php&php&php arrayphp_keyphp_existsphp(php$propertyphp,php php$attributesphp)php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php/php*php*
php php php php php php php php php php php php php php php php php php php php php php php php php php*php Importantphp notephp.
php php php php php php php php php php php php php php php php php php php php php php php php php php*php Ifphp anyphp attributephp orphp dependantphp objectphp isphp anphp indirectphp objectphp,php thenphp itphp'sphp still
php php php php php php php php php php php php php php php php php php php php php php php php php php*php sharedphp betweenphp pagesphp.
php php php php php php php php php php php php php php php php php php php php php php php php php php*php/
php php php php php php php php php php php php php php php php php php php php php php php php ifphp php(php$attributesphp[php$propertyphp]php instanceofphp Zendphp_Pdfphp_Elementphp_Objectphp php php|php|
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$attributesphp[php$propertyphp]php instanceofphp Zendphp_Pdfphp_Elementphp_Referencephp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$childphp-php>php$propertyphp php=php php$attributesphp[php$propertyphp]php;
php php php php php php php php php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$childphp-php>php$propertyphp php=php php$thisphp-php>php_objFactoryphp-php>newObjectphp(php$attributesphp[php$propertyphp]php)php;
php php php php php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Pagephp.phpphp'php;
php php php php php php php php php php php php php php php php php$thisphp-php>pagesphp[php]php php=php newphp Zendphp_Pdfphp_Pagephp(php$childphp,php php$thisphp-php>php_objFactoryphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Loadphp namedphp destinationsphp recursively
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Pdfphp_Elementphp_Referencephp php$rootphp Documentphp catalogphp entry
php php php php php php*php php@paramphp stringphp php$pdfHeaderVersion
php php php php php php*php php@throwsphp Zendphp_Pdfphp_Exception
php php php php php php*php/
php php php php protectedphp functionphp php_loadNamedDestinationsphp(Zendphp_Pdfphp_Elementphp_Referencephp php$rootphp,php php$pdfHeaderVersionphp)
php php php php php{
php php php php php php php php ifphp php(php$rootphp-php>Versionphp php!php=php=php nullphp php php&php&php php versionphp_comparephp(php$rootphp-php>Versionphp-php>valuephp,php php$pdfHeaderVersionphp,php php'php>php'php)php)php php{
php php php php php php php php php php php php php$versionIsphp_php1php_php2php_plusphp php=php versionphp_comparephp(php$rootphp-php>Versionphp-php>valuephp,php php php php php'php1php.php1php'php,php php'php>php'php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$versionIsphp_php1php_php2php_plusphp php=php versionphp_comparephp(php$pdfHeaderVersionphp,php php'php1php.php1php'php,php php'php>php'php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$versionIsphp_php1php_php2php_plusphp)php php{
php php php php php php php php php php php php php/php/php PDFphp versionphp isphp php1php.php2php+
php php php php php php php php php php php php php/php/php Lookphp forphp Destinationsphp structurephp atphp Namephp dictionary
php php php php php php php php php php php php ifphp php(php$rootphp-php>Namesphp php!php=php=php nullphp php php&php&php php php$rootphp-php>Namesphp-php>Destsphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/NameTreephp.phpphp'php;
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Targetphp.phpphp'php;
php php php php php php php php php php php php php php php php foreachphp php(newphp Zendphp_Pdfphp_NameTreephp(php$rootphp-php>Namesphp-php>Destsphp)php asphp php$namephp php=php>php php$destinationphp)php php{
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>php_namedTargetsphp[php$namephp]php php=php Zendphp_Pdfphp_Targetphp:php:loadphp(php$destinationphp)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php/php/php PDFphp versionphp isphp php1php.php1php php(orphp earlierphp)
php php php php php php php php php php php php php/php/php Lookphp forphp Destinationsphp sructurephp atphp Destphp entryphp ofphp documentphp catalog
php php php php php php php php php php php php ifphp php(php$rootphp-php>Destsphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php ifphp php(php$rootphp-php>Destsphp-php>getTypephp(php)php php!php=php Zendphp_Pdfphp_Elementphp:php:TYPEphp_DICTIONARYphp)php php{
php php php php php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'Documentphp catalogphp Destsphp entryphp mustphp bephp aphp dictionaryphp.php'php)php;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Targetphp.phpphp'php;
php php php php php php php php php php php php php php php php foreachphp php(php$rootphp-php>Destsphp-php>getKeysphp(php)php asphp php$destKeyphp)php php{
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>php_namedTargetsphp[php$destKeyphp]php php=php Zendphp_Pdfphp_Targetphp:php:loadphp(php$rootphp-php>Destsphp-php>php$destKeyphp)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Loadphp outlinesphp recursively
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Pdfphp_Elementphp_Referencephp php$rootphp Documentphp catalogphp entry
php php php php php php*php/
php php php php protectedphp functionphp php_loadOutlinesphp(Zendphp_Pdfphp_Elementphp_Referencephp php$rootphp)
php php php php php{
php php php php php php php php ifphp php(php$rootphp-php>Outlinesphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php returnphp;
php php php php php php php php php}

php php php php php php php php ifphp php(php$rootphp-php>Outlinesphp-php>getTypephp(php)php php!php=php Zendphp_Pdfphp_Elementphp:php:TYPEphp_DICTIONARYphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'Documentphp catalogphp Outlinesphp entryphp mustphp bephp aphp dictionaryphp.php'php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$rootphp-php>Outlinesphp-php>Typephp php!php=php=php nullphp php php&php&php php php$rootphp-php>Outlinesphp-php>Typephp-php>valuephp php!php=php php'Outlinesphp'php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'Outlinesphp Typephp entryphp mustphp bephp anphp php\php'Outlinesphp\php'php stringphp.php'php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$rootphp-php>Outlinesphp-php>Firstphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php returnphp;
php php php php php php php php php}

php php php php php php php php php$outlineDictionaryphp php=php php$rootphp-php>Outlinesphp-php>Firstphp;
php php php php php php php php php$processedDictionariesphp php=php newphp SplObjectStoragephp(php)php;
php php php php php php php php whilephp php(php$outlineDictionaryphp php!php=php=php nullphp php php&php&php php php!php$processedDictionariesphp-php>containsphp(php$outlineDictionaryphp)php)php php{
php php php php php php php php php php php php php$processedDictionariesphp-php>attachphp(php$outlineDictionaryphp)php;

php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Outlinephp/Loadedphp.phpphp'php;
php php php php php php php php php php php php php$thisphp-php>outlinesphp[php]php php=php newphp Zendphp_Pdfphp_Outlinephp_Loadedphp(php$outlineDictionaryphp)php;

php php php php php php php php php php php php php$outlineDictionaryphp php=php php$outlineDictionaryphp-php>Nextphp;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_originalOutlinesphp php=php php$thisphp-php>outlinesphp;

php php php php php php php php ifphp php(php$rootphp-php>Outlinesphp-php>Countphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php$thisphp-php>php_originalOpenOutlinesCountphp php=php php$rootphp-php>Outlinesphp-php>Countphp-php>valuephp;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Orginizephp pagesphp tophp thaphp pagesphp treephp structurephp.
php php php php php php*
php php php php php php*php php@todophp atomaticallyphp attachphp pagephp tophp thephp documentphp,php ifphp itphp'sphp notphp donephp yetphp.
php php php php php php*php php@todophp checkphp,php thatphp pagephp isphp attachedphp tophp thephp currentphp document
php php php php php php*
php php php php php php*php php@todophp Dumpphp pagesphp asphp aphp balancedphp treephp insteadphp ofphp aphp plainphp setphp.
php php php php php php*php/
php php php php protectedphp functionphp php_dumpPagesphp(php)
php php php php php{
php php php php php php php php php$rootphp php=php php$thisphp-php>php_trailerphp-php>Rootphp;
php php php php php php php php php$pagesContainerphp php=php php$rootphp-php>Pagesphp;

php php php php php php php php php$pagesContainerphp-php>touchphp(php)php;
php php php php php php php php php$pagesContainerphp-php>Kidsphp-php>itemsphp php=php arrayphp(php)php;

php php php php php php php php foreachphp php(php$thisphp-php>pagesphp asphp php$pagephp php)php php{
php php php php php php php php php php php php php$pagephp-php>renderphp(php$thisphp-php>php_objFactoryphp)php;

php php php php php php php php php php php php php$pageDictionaryphp php=php php$pagephp-php>getPageDictionaryphp(php)php;
php php php php php php php php php php php php php$pageDictionaryphp-php>touchphp(php)php;
php php php php php php php php php php php php php$pageDictionaryphp-php>Parentphp php=php php$pagesContainerphp;

php php php php php php php php php php php php php$pagesContainerphp-php>Kidsphp-php>itemsphp[php]php php=php php$pageDictionaryphp;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_refreshPagesHashphp(php)php;

php php php php php php php php php$pagesContainerphp-php>Countphp-php>touchphp(php)php;
php php php php php php php php php$pagesContainerphp-php>Countphp-php>valuephp php=php countphp(php$thisphp-php>pagesphp)php;


php php php php php php php php php/php/php Refreshphp namedphp destinationsphp list
php php php php php php php php foreachphp php(php$thisphp-php>php_namedTargetsphp asphp php$namephp php=php>php php$namedTargetphp)php php{
php php php php php php php php php php php php ifphp php(php$namedTargetphp instanceofphp Zendphp_Pdfphp_Destinationphp_Explicitphp)php php{
php php php php php php php php php php php php php php php php php/php/php Namedphp targetphp isphp anphp explicitphp destination
php php php php php php php php php php php php php php php php ifphp php(php$thisphp-php>resolveDestinationphp(php$namedTargetphp,php falsephp)php php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php php php php unsetphp(php$thisphp-php>php_namedTargetsphp[php$namephp]php)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}php elsephp ifphp php(php$namedTargetphp instanceofphp Zendphp_Pdfphp_Actionphp)php php{
php php php php php php php php php php php php php php php php php/php/php Namedphp targetphp isphp anphp action
php php php php php php php php php php php php php php php php ifphp php(php$thisphp-php>php_cleanUpActionphp(php$namedTargetphp,php falsephp)php php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php php php php php/php/php Actionphp isphp aphp GoTophp actionphp withphp anphp unresolvedphp destination
php php php php php php php php php php php php php php php php php php php php unsetphp(php$thisphp-php>php_namedTargetsphp[php$namephp]php)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'Wrongphp typephp ofphp namedphp targedphp php(php\php'php'php php.php getphp_classphp(php$namedTargetphp)php php.php php'php\php'php)php.php'php)php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php/php/php Refreshphp outlines
php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/RecursivelyIteratableObjectsContainerphp.phpphp'php;
php php php php php php php php php$iteratorphp php=php newphp RecursiveIteratorIteratorphp(newphp Zendphp_Pdfphp_RecursivelyIteratableObjectsContainerphp(php$thisphp-php>outlinesphp)php,php RecursiveIteratorIteratorphp:php:SELFphp_FIRSTphp)php;
php php php php php php php php foreachphp php(php$iteratorphp asphp php$outlinephp)php php{
php php php php php php php php php php php php php$targetphp php=php php$outlinephp-php>getTargetphp(php)php;

php php php php php php php php php php php php ifphp php(php$targetphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php ifphp php(php$targetphp instanceofphp Zendphp_Pdfphp_Destinationphp)php php{
php php php php php php php php php php php php php php php php php php php php php/php/php Outlinephp targetphp isphp aphp destination
php php php php php php php php php php php php php php php php php php php php ifphp php(php$thisphp-php>resolveDestinationphp(php$targetphp,php falsephp)php php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php$outlinephp-php>setTargetphp(nullphp)php;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}php elsephp ifphp php(php$targetphp instanceofphp Zendphp_Pdfphp_Actionphp)php php{
php php php php php php php php php php php php php php php php php php php php php/php/php Outlinephp targetphp isphp anphp action
php php php php php php php php php php php php php php php php php php php php ifphp php(php$thisphp-php>php_cleanUpActionphp(php$targetphp,php falsephp)php php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php/php/php Actionphp isphp aphp GoTophp actionphp withphp anphp unresolvedphp destination
php php php php php php php php php php php php php php php php php php php php php php php php php$outlinephp-php>setTargetphp(nullphp)php;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'Wrongphp outlinephp targetphp.php'php)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php$openActionphp php=php php$thisphp-php>getOpenActionphp(php)php;
php php php php php php php php ifphp php(php$openActionphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php ifphp php(php$openActionphp instanceofphp Zendphp_Pdfphp_Actionphp)php php{
php php php php php php php php php php php php php php php php php/php/php OpenActionphp isphp anphp action
php php php php php php php php php php php php php php php php ifphp php(php$thisphp-php>php_cleanUpActionphp(php$openActionphp,php falsephp)php php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php php php php php/php/php Actionphp isphp aphp GoTophp actionphp withphp anphp unresolvedphp destination
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setOpenActionphp(nullphp)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}php elsephp ifphp php(php$openActionphp instanceofphp Zendphp_Pdfphp_Destinationphp)php php{
php php php php php php php php php php php php php php php php php/php/php OpenActionphp targetphp isphp aphp destination
php php php php php php php php php php php php php php php php ifphp php(php$thisphp-php>resolveDestinationphp(php$openActionphp,php falsephp)php php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setOpenActionphp(nullphp)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'OpenActionphp hasphp tophp bephp eitherphp PDFphp Actionphp orphp Destinationphp.php'php)php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Dumpphp namedphp destinations
php php php php php php*
php php php php php php*php php@todophp Createphp aphp balancedphp treephp insteadphp ofphp plainphp structurephp.
php php php php php php*php/
php php php php protectedphp functionphp php_dumpNamedDestinationsphp(php)
php php php php php{
php php php php php php php php ksortphp(php$thisphp-php>php_namedTargetsphp,php SORTphp_STRINGphp)php;

php php php php php php php php php$destArrayItemsphp php=php arrayphp(php)php;
php php php php php php php php foreachphp php(php$thisphp-php>php_namedTargetsphp asphp php$namephp php=php>php php$destinationphp)php php{
php php php php php php php php php php php php php$destArrayItemsphp[php]php php=php newphp Zendphp_Pdfphp_Elementphp_Stringphp(php$namephp)php;

php php php php php php php php php php php php ifphp php(php$destinationphp instanceofphp Zendphp_Pdfphp_Targetphp)php php{
php php php php php php php php php php php php php php php php php$destArrayItemsphp[php]php php=php php$destinationphp-php>getResourcephp(php)php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'PDFphp namedphp destinationsphp mustphp bephp aphp Zendphp_Pdfphp_Targetphp objectphp.php'php)php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php php$destArrayphp php=php php$thisphp-php>php_objFactoryphp-php>newObjectphp(newphp Zendphp_Pdfphp_Elementphp_Arrayphp(php$destArrayItemsphp)php)php;

php php php php php php php php php$DestTreephp php=php php$thisphp-php>php_objFactoryphp-php>newObjectphp(newphp Zendphp_Pdfphp_Elementphp_Dictionaryphp(php)php)php;
php php php php php php php php php$DestTreephp-php>Namesphp php=php php$destArrayphp;

php php php php php php php php php$rootphp php=php php$thisphp-php>php_trailerphp-php>Rootphp;

php php php php php php php php ifphp php(php$rootphp-php>Namesphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php php$rootphp-php>touchphp(php)php;
php php php php php php php php php php php php php$rootphp-php>Namesphp php=php php$thisphp-php>php_objFactoryphp-php>newObjectphp(newphp Zendphp_Pdfphp_Elementphp_Dictionaryphp(php)php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$rootphp-php>Namesphp-php>touchphp(php)php;
php php php php php php php php php}
php php php php php php php php php$rootphp-php>Namesphp-php>Destsphp php=php php$DestTreephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Dumpphp outlinesphp recursively
php php php php php php*php/
php php php php protectedphp functionphp php_dumpOutlinesphp(php)
php php php php php{
php php php php php php php php php$rootphp php=php php$thisphp-php>php_trailerphp-php>Rootphp;

php php php php php php php php ifphp php(php$rootphp-php>Outlinesphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php ifphp php(countphp(php$thisphp-php>outlinesphp)php php=php=php php0php)php php{
php php php php php php php php php php php php php php php php returnphp;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$rootphp-php>Outlinesphp php=php php$thisphp-php>php_objFactoryphp-php>newObjectphp(newphp Zendphp_Pdfphp_Elementphp_Dictionaryphp(php)php)php;
php php php php php php php php php php php php php php php php php$rootphp-php>Outlinesphp-php>Typephp php=php newphp Zendphp_Pdfphp_Elementphp_Namephp(php'Outlinesphp'php)php;
php php php php php php php php php php php php php php php php php$updateOutlinesNavigationphp php=php truephp;
php php php php php php php php php php php php php}
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$updateOutlinesNavigationphp php=php falsephp;
php php php php php php php php php php php php ifphp php(countphp(php$thisphp-php>php_originalOutlinesphp)php php!php=php countphp(php$thisphp-php>outlinesphp)php)php php{
php php php php php php php php php php php php php php php php php/php/php Ifphp originalphp andphp currentphp outlinesphp arraysphp havephp differentphp sizephp thenphp outlinesphp listphp wasphp updated
php php php php php php php php php php php php php php php php php$updateOutlinesNavigationphp php=php truephp;
php php php php php php php php php php php php php}php elsephp ifphp php(php php!php(arrayphp_keysphp(php$thisphp-php>php_originalOutlinesphp)php php=php=php=php arrayphp_keysphp(php$thisphp-php>outlinesphp)php)php php)php php{
php php php php php php php php php php php php php php php php php/php/php Ifphp originalphp andphp currentphp outlinesphp arraysphp havephp differentphp keysphp php(withphp aphp glancephp tophp anphp orderphp)php thenphp outlinesphp listphp wasphp updated
php php php php php php php php php php php php php php php php php$updateOutlinesNavigationphp php=php truephp;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php foreachphp php(php$thisphp-php>outlinesphp asphp php$keyphp php=php>php php$outlinephp)php php{
php php php php php php php php php php php php php php php php php php php php ifphp php(php$thisphp-php>php_originalOutlinesphp[php$keyphp]php php!php=php=php php$outlinephp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php$updateOutlinesNavigationphp php=php truephp;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php$lastOutlinephp php=php nullphp;
php php php php php php php php php$openOutlinesCountphp php=php php0php;
php php php php php php php php ifphp php(php$updateOutlinesNavigationphp)php php{
php php php php php php php php php php php php php$rootphp-php>Outlinesphp-php>touchphp(php)php;
php php php php php php php php php php php php php$rootphp-php>Outlinesphp-php>Firstphp php=php nullphp;

php php php php php php php php php php php php foreachphp php(php$thisphp-php>outlinesphp asphp php$outlinephp)php php{
php php php php php php php php php php php php php php php php ifphp php(php$lastOutlinephp php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php php php php php/php/php Firstphp passphp.php Updatephp Outlinesphp dictionaryphp Firstphp entryphp usingphp correspondingphp value
php php php php php php php php php php php php php php php php php php php php php$lastOutlinephp php=php php$outlinephp-php>dumpOutlinephp(php$thisphp-php>php_objFactoryphp,php php$updateOutlinesNavigationphp,php php$rootphp-php>Outlinesphp)php;
php php php php php php php php php php php php php php php php php php php php php$rootphp-php>Outlinesphp-php>Firstphp php=php php$lastOutlinephp;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php/php/php Updatephp previousphp outlinephp dictionaryphp Nextphp entryphp php(Prevphp isphp updatedphp withinphp dumpOutlinephp(php)php methodphp)
php php php php php php php php php php php php php php php php php php php php php$currentOutlineDictionaryphp php=php php$outlinephp-php>dumpOutlinephp(php$thisphp-php>php_objFactoryphp,php php$updateOutlinesNavigationphp,php php$rootphp-php>Outlinesphp,php php$lastOutlinephp)php;
php php php php php php php php php php php php php php php php php php php php php$lastOutlinephp-php>Nextphp php=php php$currentOutlineDictionaryphp;
php php php php php php php php php php php php php php php php php php php php php$lastOutlinephp php php php php php php php=php php$currentOutlineDictionaryphp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php$openOutlinesCountphp php+php=php php$outlinephp-php>openOutlinesCountphp(php)php;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$rootphp-php>Outlinesphp-php>Lastphp php php=php php$lastOutlinephp;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php foreachphp php(php$thisphp-php>outlinesphp asphp php$outlinephp)php php{
php php php php php php php php php php php php php php php php php$lastOutlinephp php=php php$outlinephp-php>dumpOutlinephp(php$thisphp-php>php_objFactoryphp,php php$updateOutlinesNavigationphp,php php$rootphp-php>Outlinesphp,php php$lastOutlinephp)php;
php php php php php php php php php php php php php php php php php$openOutlinesCountphp php+php=php php$outlinephp-php>openOutlinesCountphp(php)php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php ifphp php(php$openOutlinesCountphp php!php=php php$thisphp-php>php_originalOpenOutlinesCountphp)php php{
php php php php php php php php php php php php php$rootphp-php>Outlinesphp-php>touchphp;
php php php php php php php php php php php php php$rootphp-php>Outlinesphp-php>Countphp php=php newphp Zendphp_Pdfphp_Elementphp_Numericphp(php$openOutlinesCountphp)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Createphp pagephp objectphp,php attachedphp tophp thephp PDFphp documentphp.
php php php php php php*php Methodphp signaturesphp:
php php php php php php*
php php php php php php*php php1php.php Createphp newphp pagephp withphp aphp specifiedphp pagesizephp.
php php php php php php*php php php php Ifphp php$factoryphp isphp nullphp thenphp itphp willphp bephp createdphp andphp pagephp mustphp bephp attachedphp tophp thephp documentphp tophp be
php php php php php php*php php php php includedphp intophp outputphp.
php php php php php php*php php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-
php php php php php php*php newphp Zendphp_Pdfphp_Pagephp(stringphp php$pagesizephp)php;
php php php php php php*php php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-
php php php php php php*
php php php php php php*php php2php.php Createphp newphp pagephp withphp aphp specifiedphp pagesizephp php(inphp defaultphp userphp spacephp unitsphp)php.
php php php php php php*php php php php Ifphp php$factoryphp isphp nullphp thenphp itphp willphp bephp createdphp andphp pagephp mustphp bephp attachedphp tophp thephp documentphp tophp be
php php php php php php*php php php php includedphp intophp outputphp.
php php php php php php*php php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-
php php php php php php*php newphp Zendphp_Pdfphp_Pagephp(numericphp php$widthphp,php numericphp php$heightphp)php;
php php php php php php*php php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-php-
php php php php php php*
php php php php php php*php php@paramphp mixedphp php$paramphp1
php php php php php php*php php@paramphp mixedphp php$paramphp2
php php php php php php*php php@returnphp Zendphp_Pdfphp_Page
php php php php php php*php/
php php php php publicphp functionphp newPagephp(php$paramphp1php,php php$paramphp2php php=php nullphp)
php php php php php{
php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Pagephp.phpphp'php;
php php php php php php php php ifphp php(php$paramphp2php php=php=php=php nullphp)php php{
php php php php php php php php php php php php returnphp newphp Zendphp_Pdfphp_Pagephp(php$paramphp1php,php php$thisphp-php>php_objFactoryphp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php returnphp newphp Zendphp_Pdfphp_Pagephp(php$paramphp1php,php php$paramphp2php,php php$thisphp-php>php_objFactoryphp)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnphp thephp documentphp-levelphp Metadata
php php php php php php*php orphp nullphp Metadataphp streamphp isphp notphp presented
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getMetadataphp(php)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_trailerphp-php>Rootphp-php>Metadataphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php returnphp php$thisphp-php>php_trailerphp-php>Rootphp-php>Metadataphp-php>valuephp;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php returnphp nullphp;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Setsphp thephp documentphp-levelphp Metadataphp php(mastphp bephp validphp XMPphp documentphp)
php php php php php php*
php php php php php php*php php@paramphp stringphp php$metadata
php php php php php php*php/
php php php php publicphp functionphp setMetadataphp(php$metadataphp)
php php php php php{
php php php php php php php php php$metadataObjectphp php=php php$thisphp-php>php_objFactoryphp-php>newStreamObjectphp(php$metadataphp)php;
php php php php php php php php php$metadataObjectphp-php>dictionaryphp-php>Typephp php php php php=php newphp Zendphp_Pdfphp_Elementphp_Namephp(php'Metadataphp'php)php;
php php php php php php php php php$metadataObjectphp-php>dictionaryphp-php>Subtypephp php=php newphp Zendphp_Pdfphp_Elementphp_Namephp(php'XMLphp'php)php;

php php php php php php php php php$thisphp-php>php_trailerphp-php>Rootphp-php>Metadataphp php=php php$metadataObjectphp;
php php php php php php php php php$thisphp-php>php_trailerphp-php>Rootphp-php>touchphp(php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnphp thephp documentphp-levelphp JavaScript
php php php php php php*php orphp nullphp ifphp therephp isphp nophp JavaScriptphp forphp thisphp document
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getJavaScriptphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_javaScriptphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp openphp Action
php php php php php php*php Returnsphp Zendphp_Pdfphp_Targetphp php(Zendphp_Pdfphp_Destinationphp orphp Zendphp_Pdfphp_Actionphp objectphp)
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Pdfphp_Target
php php php php php php*php/
php php php php publicphp functionphp getOpenActionphp(php)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_trailerphp-php>Rootphp-php>OpenActionphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Targetphp.phpphp'php;
php php php php php php php php php php php php returnphp Zendphp_Pdfphp_Targetphp:php:loadphp(php$thisphp-php>php_trailerphp-php>Rootphp-php>OpenActionphp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php returnphp nullphp;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp openphp Actionphp whichphp isphp actuallyphp Zendphp_Pdfphp_Destinationphp orphp Zendphp_Pdfphp_Actionphp object
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Pdfphp_Targetphp php$openAction
php php php php php php*php php@returnsphp Zendphp_Pdf
php php php php php php*php/
php php php php publicphp functionphp setOpenActionphp(Zendphp_Pdfphp_Targetphp php$openActionphp php=php nullphp)
php php php php php{
php php php php php php php php php$rootphp php=php php$thisphp-php>php_trailerphp-php>Rootphp;
php php php php php php php php php$rootphp-php>touchphp(php)php;

php php php php php php php php ifphp php(php$openActionphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php php$rootphp-php>OpenActionphp php=php nullphp;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$rootphp-php>OpenActionphp php=php php$openActionphp-php>getResourcephp(php)php;

php php php php php php php php php php php php ifphp php(php$openActionphp instanceofphp Zendphp_Pdfphp_Actionphp)php php php{
php php php php php php php php php php php php php php php php php$openActionphp-php>dumpActionphp(php$thisphp-php>php_objFactoryphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnphp anphp associativephp arrayphp containingphp allphp thephp namedphp destinationsphp php(orphp GoTophp actionsphp)php inphp thephp PDFphp.
php php php php php php*php Namedphp targetsphp canphp bephp usedphp tophp referencephp fromphp outside
php php php php php php*php thephp PDFphp,php exphp:php php'httpphp:php/php/wwwphp.somethingphp.comphp/mydocumentphp.pdfphp#MyActionphp'
php php php php php php*
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp getNamedDestinationsphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_namedTargetsphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnphp specifiedphp namedphp destination
php php php php php php*
php php php php php php*php php@paramphp stringphp php$name
php php php php php php*php php@returnphp Zendphp_Pdfphp_Destinationphp_Explicitphp|Zendphp_Pdfphp_Actionphp_GoTo
php php php php php php*php/
php php php php publicphp functionphp getNamedDestinationphp(php$namephp)
php php php php php{
php php php php php php php php ifphp php(issetphp(php$thisphp-php>php_namedTargetsphp[php$namephp]php)php)php php{
php php php php php php php php php php php php returnphp php$thisphp-php>php_namedTargetsphp[php$namephp]php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php returnphp nullphp;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp specifiedphp namedphp destination
php php php php php php*
php php php php php php*php php@paramphp stringphp php$name
php php php php php php*php php@paramphp Zendphp_Pdfphp_Destinationphp_Explicitphp|Zendphp_Pdfphp_Actionphp_GoTophp php$target
php php php php php php*php/
php php php php publicphp functionphp setNamedDestinationphp(php$namephp,php php$destinationphp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(php$destinationphp php!php=php=php nullphp php php&php&
php php php php php php php php php php php php php!php$destinationphp instanceofphp Zendphp_Pdfphp_Actionphp_GoTophp php php&php&
php php php php php php php php php php php php php!php$destinationphp instanceofphp Zendphp_Pdfphp_Destinationphp_Explicitphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'PDFphp namedphp destinationphp mustphp referphp anphp explicitphp destinationphp orphp aphp GoTophp PDFphp actionphp.php'php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$destinationphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php$thisphp-php>php_namedTargetsphp[php$namephp]php php=php php$destinationphp;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php unsetphp(php$thisphp-php>php_namedTargetsphp[php$namephp]php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Pagesphp collectionphp hashphp:
php php php php php php*php php<pagephp dictionaryphp objectphp hashphp idphp>php php=php>php Zendphp_Pdfphp_Page
php php php php php php*
php php php php php php*php php@varphp SplObjectStorage
php php php php php php*php/
php php php php protectedphp php$php_pageReferencesphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php Pagesphp collectionphp hashphp:
php php php php php php*php php<pagephp numberphp>php php=php>php Zendphp_Pdfphp_Page
php php php php php php*
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_pageNumbersphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php Refreshphp pagephp collectionphp hashes
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Pdf
php php php php php php*php/
php php php php protectedphp functionphp php_refreshPagesHashphp(php)
php php php php php{
php php php php php php php php php$thisphp-php>php_pageReferencesphp php=php arrayphp(php)php;
php php php php php php php php php$thisphp-php>php_pageNumbersphp php php php php=php arrayphp(php)php;
php php php php php php php php php$countphp php=php php1php;
php php php php php php php php foreachphp php(php$thisphp-php>pagesphp asphp php$pagephp)php php{
php php php php php php php php php php php php php$pageDictionaryHashIdphp php=php splphp_objectphp_hashphp(php$pagephp-php>getPageDictionaryphp(php)php-php>getObjectphp(php)php)php;
php php php php php php php php php php php php php$thisphp-php>php_pageReferencesphp[php$pageDictionaryHashIdphp]php php=php php$pagephp;
php php php php php php php php php php php php php$thisphp-php>php_pageNumbersphp[php$countphp+php+php]php php php php php php php php php php php php php php php php php php=php php$pagephp;
php php php php php php php php php}

php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Resolvephp destinationphp.
php php php php php php*
php php php php php php*php Returnsphp Zendphp_Pdfphp_Pagephp pagephp objectphp orphp nullphp ifphp destinationphp isphp notphp foundphp withinphp PDFphp documentphp.
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Pdfphp_Destinationphp php$destinationphp php Destinationphp tophp resolve
php php php php php php*php php@paramphp booleanphp php$refreshPagesHashphp php Refreshphp pagephp collectionphp hashesphp beforephp processing
php php php php php php*php php@returnphp Zendphp_Pdfphp_Pagephp|null
php php php php php php*php php@throwsphp Zendphp_Pdfphp_Exception
php php php php php php*php/
php php php php publicphp functionphp resolveDestinationphp(Zendphp_Pdfphp_Destinationphp php$destinationphp,php php$refreshPageCollectionHashesphp php=php truephp)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_pageReferencesphp php=php=php=php nullphp php php|php|php php php$refreshPageCollectionHashesphp)php php{
php php php php php php php php php php php php php$thisphp-php>php_refreshPagesHashphp(php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$destinationphp instanceofphp Zendphp_Pdfphp_Destinationphp_Namedphp)php php{
php php php php php php php php php php php php ifphp php(php!issetphp(php$thisphp-php>php_namedTargetsphp[php$destinationphp-php>getNamephp(php)php]php)php)php php{
php php php php php php php php php php php php php php php php returnphp nullphp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$destinationphp php=php php$thisphp-php>getNamedDestinationphp(php$destinationphp-php>getNamephp(php)php)php;

php php php php php php php php php php php php ifphp php(php$destinationphp instanceofphp Zendphp_Pdfphp_Actionphp)php php{
php php php php php php php php php php php php php php php php ifphp php(php!php$destinationphp instanceofphp Zendphp_Pdfphp_Actionphp_GoTophp)php php{
php php php php php php php php php php php php php php php php php php php php returnphp nullphp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php$destinationphp php=php php$destinationphp-php>getDestinationphp(php)php;
php php php php php php php php php php php php php}

php php php php php php php php php php php php ifphp php(php!php$destinationphp instanceofphp Zendphp_Pdfphp_Destinationphp_Explicitphp)php php{
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'Namedphp destinationphp targetphp hasphp tophp bephp anphp explicitphp destinationphp.php'php)php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php/php/php Namedphp targetphp isphp anphp explicitphp destination
php php php php php php php php php$pageElementphp php=php php$destinationphp-php>getResourcephp(php)php-php>itemsphp[php0php]php;

php php php php php php php php ifphp php(php$pageElementphp-php>getTypephp(php)php php=php=php Zendphp_Pdfphp_Elementphp:php:TYPEphp_NUMERICphp)php php{
php php php php php php php php php php php php php/php/php Pagephp referencephp isphp aphp PDFphp number
php php php php php php php php php php php php ifphp php(php!issetphp(php$thisphp-php>php_pageNumbersphp[php$pageElementphp-php>valuephp]php)php)php php{
php php php php php php php php php php php php php php php php returnphp nullphp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php returnphp php$thisphp-php>php_pageNumbersphp[php$pageElementphp-php>valuephp]php;
php php php php php php php php php}

php php php php php php php php php/php/php Pagephp referencephp isphp aphp PDFphp pagephp dictionaryphp reference
php php php php php php php php php$pageDictionaryHashIdphp php=php splphp_objectphp_hashphp(php$pageElementphp-php>getObjectphp(php)php)php;
php php php php php php php php ifphp php(php!issetphp(php$thisphp-php>php_pageReferencesphp[php$pageDictionaryHashIdphp]php)php)php php{
php php php php php php php php php php php php returnphp nullphp;
php php php php php php php php php}
php php php php php php php php returnphp php$thisphp-php>php_pageReferencesphp[php$pageDictionaryHashIdphp]php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Walkphp throughphp actionphp andphp itsphp chainedphp actionsphp treephp andphp removephp nodes
php php php php php php*php ifphp theyphp arephp GoTophp actionsphp withphp anphp unresolvedphp targetphp.
php php php php php php*
php php php php php php*php Returnsphp nullphp ifphp rootphp nodephp isphp deletedphp orphp updatedphp actionphp overwisephp.
php php php php php php*
php php php php php php*php php@todophp Givephp appropriatephp namephp andphp makephp methodphp public
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Pdfphp_Actionphp php$action
php php php php php php*php php@paramphp booleanphp php$refreshPagesHashphp php Refreshphp pagephp collectionphp hashesphp beforephp processing
php php php php php php*php php@returnphp Zendphp_Pdfphp_Actionphp|null
php php php php php php*php/
php php php php protectedphp functionphp php_cleanUpActionphp(Zendphp_Pdfphp_Actionphp php$actionphp,php php$refreshPageCollectionHashesphp php=php truephp)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_pageReferencesphp php=php=php=php nullphp php php|php|php php php$refreshPageCollectionHashesphp)php php{
php php php php php php php php php php php php php$thisphp-php>php_refreshPagesHashphp(php)php;
php php php php php php php php php}

php php php php php php php php php/php/php Namedphp targetphp isphp anphp action
php php php php php php php php ifphp php(php$actionphp instanceofphp Zendphp_Pdfphp_Actionphp_GoTophp php php&php&
php php php php php php php php php php php php php$thisphp-php>resolveDestinationphp(php$actionphp-php>getDestinationphp(php)php,php falsephp)php php=php=php=php nullphp)php php{
php php php php php php php php php php php php php/php/php Actionphp itselfphp isphp aphp GoTophp actionphp withphp anphp unresolvedphp destination
php php php php php php php php php php php php returnphp nullphp;
php php php php php php php php php}

php php php php php php php php php/php/php Walkphp throughphp childphp actions
php php php php php php php php php$iteratorphp php=php newphp RecursiveIteratorIteratorphp(php$actionphp,php RecursiveIteratorIteratorphp:php:SELFphp_FIRSTphp)php;

php php php php php php php php php$actionsToCleanphp php php php php php php php php=php arrayphp(php)php;
php php php php php php php php php$deletionCandidateKeysphp php=php arrayphp(php)php;
php php php php php php php php foreachphp php(php$iteratorphp asphp php$chainedActionphp)php php{
php php php php php php php php php php php php ifphp php(php$chainedActionphp instanceofphp Zendphp_Pdfphp_Actionphp_GoTophp php php&php&
php php php php php php php php php php php php php php php php php$thisphp-php>resolveDestinationphp(php$chainedActionphp-php>getDestinationphp(php)php,php falsephp)php php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php/php/php Somephp childphp actionphp isphp aphp GoTophp actionphp withphp anphp unresolvedphp destination
php php php php php php php php php php php php php php php php php/php/php Markphp itphp asphp aphp candidatephp forphp deletion
php php php php php php php php php php php php php php php php php$actionsToCleanphp[php]php php php php php php php php php=php php$iteratorphp-php>getSubIteratorphp(php)php;
php php php php php php php php php php php php php php php php php$deletionCandidateKeysphp[php]php php=php php$iteratorphp-php>getSubIteratorphp(php)php-php>keyphp(php)php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php foreachphp php(php$actionsToCleanphp asphp php$idphp php=php>php php$actionphp)php php{
php php php php php php php php php php php php unsetphp(php$actionphp-php>nextphp[php$deletionCandidateKeysphp[php$idphp]php]php)php;
php php php php php php php php php}

php php php php php php php php returnphp php$actionphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Extractphp fontsphp attachedphp tophp thephp document
php php php php php php*
php php php php php php*php returnsphp arrayphp ofphp Zendphp_Pdfphp_Resourcephp_Fontphp_Extractedphp objects
php php php php php php*
php php php php php php*php php@returnphp array
php php php php php php*php php@throwsphp Zendphp_Pdfphp_Exception
php php php php php php*php/
php php php php publicphp functionphp extractFontsphp(php)
php php php php php{
php php php php php php php php php$fontResourcesUniquephp php=php arrayphp(php)php;
php php php php php php php php foreachphp php(php$thisphp-php>pagesphp asphp php$pagephp)php php{
php php php php php php php php php php php php php$pageResourcesphp php=php php$pagephp-php>extractResourcesphp(php)php;

php php php php php php php php php php php php ifphp php(php$pageResourcesphp-php>Fontphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php/php/php Pagephp doesnphp'tphp containphp havephp anyphp fontphp reference
php php php php php php php php php php php php php php php php continuephp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$fontResourcesphp php=php php$pageResourcesphp-php>Fontphp;

php php php php php php php php php php php php foreachphp php(php$fontResourcesphp-php>getKeysphp(php)php asphp php$fontResourceNamephp)php php{
php php php php php php php php php php php php php php php php php$fontDictionaryphp php=php php$fontResourcesphp-php>php$fontResourceNamephp;

php php php php php php php php php php php php php php php php ifphp php(php!php php(php$fontDictionaryphp instanceofphp Zendphp_Pdfphp_Elementphp_Referencephp php php|php|
php php php php php php php php php php php php php php php php php php php php php php php php$fontDictionaryphp instanceofphp Zendphp_Pdfphp_Elementphp_Objectphp)php php)php php{
php php php php php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'Fontphp dictionaryphp hasphp tophp bephp anphp indirectphp objectphp orphp objectphp referencephp.php'php)php;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php php$fontResourcesUniquephp[splphp_objectphp_hashphp(php$fontDictionaryphp-php>getObjectphp(php)php)php]php php=php php$fontDictionaryphp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php$fontsphp php=php arrayphp(php)php;
php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php foreachphp php(php$fontResourcesUniquephp asphp php$resourceIdphp php=php>php php$fontDictionaryphp)php php{
php php php php php php php php php php php php tryphp php{
php php php php php php php php php php php php php php php php php/php/php Tryphp tophp extractphp font
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Resourcephp/Fontphp/Extractedphp.phpphp'php;
php php php php php php php php php php php php php php php php php$extractedFontphp php=php newphp Zendphp_Pdfphp_Resourcephp_Fontphp_Extractedphp(php$fontDictionaryphp)php;

php php php php php php php php php php php php php php php php php$fontsphp[php$resourceIdphp]php php=php php$extractedFontphp;
php php php php php php php php php php php php php}php catchphp php(Zendphp_Pdfphp_Exceptionphp php$ephp)php php{
php php php php php php php php php php php php php php php php ifphp php(php$ephp-php>getMessagephp(php)php php!php=php php'Unsupportedphp fontphp typephp.php'php)php php{
php php php php php php php php php php php php php php php php php php php php throwphp php$ephp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp php$fontsphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Extractphp fontphp attachedphp tophp thephp pagephp byphp specificphp fontphp name
php php php php php php*
php php php php php php*php php$fontNamephp shouldphp bephp specifiedphp inphp UTFphp-php8php encoding
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Pdfphp_Resourcephp_Fontphp_Extractedphp|null
php php php php php php*php php@throwsphp Zendphp_Pdfphp_Exception
php php php php php php*php/
php php php php publicphp functionphp extractFontphp(php$fontNamephp)
php php php php php{
php php php php php php php php php$fontResourcesUniquephp php=php arrayphp(php)php;
php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php foreachphp php(php$thisphp-php>pagesphp asphp php$pagephp)php php{
php php php php php php php php php php php php php$pageResourcesphp php=php php$pagephp-php>extractResourcesphp(php)php;

php php php php php php php php php php php php ifphp php(php$pageResourcesphp-php>Fontphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php/php/php Pagephp doesnphp'tphp containphp havephp anyphp fontphp reference
php php php php php php php php php php php php php php php php continuephp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$fontResourcesphp php=php php$pageResourcesphp-php>Fontphp;

php php php php php php php php php php php php foreachphp php(php$fontResourcesphp-php>getKeysphp(php)php asphp php$fontResourceNamephp)php php{
php php php php php php php php php php php php php php php php php$fontDictionaryphp php=php php$fontResourcesphp-php>php$fontResourceNamephp;

php php php php php php php php php php php php php php php php ifphp php(php!php php(php$fontDictionaryphp instanceofphp Zendphp_Pdfphp_Elementphp_Referencephp php php|php|
php php php php php php php php php php php php php php php php php php php php php php php php$fontDictionaryphp instanceofphp Zendphp_Pdfphp_Elementphp_Objectphp)php php)php php{
php php php php php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'Fontphp dictionaryphp hasphp tophp bephp anphp indirectphp objectphp orphp objectphp referencephp.php'php)php;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php php$resourceIdphp php=php splphp_objectphp_hashphp(php$fontDictionaryphp-php>getObjectphp(php)php)php;
php php php php php php php php php php php php php php php php ifphp php(issetphp(php$fontResourcesUniquephp[php$resourceIdphp]php)php)php php{
php php php php php php php php php php php php php php php php php php php php continuephp;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php/php/php Markphp resourcephp asphp processed
php php php php php php php php php php php php php php php php php php php php php$fontResourcesUniquephp[php$resourceIdphp]php php=php php1php;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php ifphp php(php$fontDictionaryphp-php>BaseFontphp-php>valuephp php!php=php php$fontNamephp)php php{
php php php php php php php php php php php php php php php php php php php php continuephp;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php tryphp php{
php php php php php php php php php php php php php php php php php php php php php/php/php Tryphp tophp extractphp font
php php php php php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Resourcephp/Fontphp/Extractedphp.phpphp'php;
php php php php php php php php php php php php php php php php php php php php returnphp newphp Zendphp_Pdfphp_Resourcephp_Fontphp_Extractedphp(php$fontDictionaryphp)php;
php php php php php php php php php php php php php php php php php}php catchphp php(Zendphp_Pdfphp_Exceptionphp php$ephp)php php{
php php php php php php php php php php php php php php php php php php php php ifphp php(php$ephp-php>getMessagephp(php)php php!php=php php'Unsupportedphp fontphp typephp.php'php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php throwphp php$ephp;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php php php php php/php/php Continuephp searhing
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp nullphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Renderphp thephp completedphp PDFphp tophp aphp stringphp.
php php php php php php*php Ifphp php$newSegmentOnlyphp isphp truephp,php thenphp onlyphp appendedphp partphp ofphp PDFphp isphp returnedphp.
php php php php php php*
php php php php php php*php php@paramphp booleanphp php$newSegmentOnly
php php php php php php*php php@paramphp resourcephp php$outputStream
php php php php php php*php php@returnphp string
php php php php php php*php php@throwsphp Zendphp_Pdfphp_Exception
php php php php php php*php/
php php php php publicphp functionphp renderphp(php$newSegmentOnlyphp php=php falsephp,php php$outputStreamphp php=php nullphp)
php php php php php{
php php php php php php php php php/php/php Savephp documentphp propertiesphp ifphp necessary
php php php php php php php php ifphp php(php$thisphp-php>propertiesphp php!php=php php$thisphp-php>php_originalPropertiesphp)php php{
php php php php php php php php php php php php php$docInfophp php=php php$thisphp-php>php_objFactoryphp-php>newObjectphp(newphp Zendphp_Pdfphp_Elementphp_Dictionaryphp(php)php)php;

php php php php php php php php php php php php foreachphp php(php$thisphp-php>propertiesphp asphp php$keyphp php=php>php php$valuephp)php php{
php php php php php php php php php php php php php php php php switchphp php(php$keyphp)php php{
php php php php php php php php php php php php php php php php php php php php casephp php'Trappedphp'php:
php php php php php php php php php php php php php php php php php php php php php php php php switchphp php(php$valuephp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php casephp truephp:
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$docInfophp-php>php$keyphp php=php newphp Zendphp_Pdfphp_Elementphp_Namephp(php'Truephp'php)php;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php breakphp;

php php php php php php php php php php php php php php php php php php php php php php php php php php php php casephp falsephp:
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$docInfophp-php>php$keyphp php=php newphp Zendphp_Pdfphp_Elementphp_Namephp(php'Falsephp'php)php;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php breakphp;

php php php php php php php php php php php php php php php php php php php php php php php php php php php php casephp nullphp:
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$docInfophp-php>php$keyphp php=php newphp Zendphp_Pdfphp_Elementphp_Namephp(php'Unknownphp'php)php;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php breakphp;

php php php php php php php php php php php php php php php php php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Pdfphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Pdfphp_Exceptionphp(php'Wrongphp Trappedphp documentphp propertyphp valephp:php php\php'php'php php.php php$valuephp php.php php'php\php'php.php Onlyphp truephp,php falsephp andphp nullphp valuesphp arephp allowedphp.php'php)php;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php php php php php casephp php'CreationDatephp'php:
php php php php php php php php php php php php php php php php php php php php php php php php php/php/php breakphp intentionallyphp omitted
php php php php php php php php php php php php php php php php php php php php casephp php'ModDatephp'php:
php php php php php php php php php php php php php php php php php php php php php php php php php$docInfophp-php>php$keyphp php=php newphp Zendphp_Pdfphp_Elementphp_Stringphp(php(stringphp)php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php php php php php breakphp;

php php php php php php php php php php php php php php php php php php php php casephp php'Titlephp'php:
php php php php php php php php php php php php php php php php php php php php php php php php php/php/php breakphp intentionallyphp omitted
php php php php php php php php php php php php php php php php php php php php casephp php'Authorphp'php:
php php php php php php php php php php php php php php php php php php php php php php php php php/php/php breakphp intentionallyphp omitted
php php php php php php php php php php php php php php php php php php php php casephp php'Subjectphp'php:
php php php php php php php php php php php php php php php php php php php php php php php php php/php/php breakphp intentionallyphp omitted
php php php php php php php php php php php php php php php php php php php php casephp php'Keywordsphp'php:
php php php php php php php php php php php php php php php php php php php php php php php php php/php/php breakphp intentionallyphp omitted
php php php php php php php php php php php php php php php php php php php php casephp php'Creatorphp'php:
php php php php php php php php php php php php php php php php php php php php php php php php php/php/php breakphp intentionallyphp omitted
php php php php php php php php php php php php php php php php php php php php casephp php'Producerphp'php:
php php php php php php php php php php php php php php php php php php php php php php php php ifphp php(extensionphp_loadedphp(php'mbstringphp'php)php php=php=php=php truephp)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$detectedphp php=php mbphp_detectphp_encodingphp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php ifphp php(php$detectedphp php!php=php=php php'ASCIIphp'php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$valuephp php=php php"php\xfephp\xffphp"php php.php mbphp_convertphp_encodingphp(php$valuephp,php php'UTFphp-php1php6php'php,php php$detectedphp)php;
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php php php php php php php php php$docInfophp-php>php$keyphp php=php newphp Zendphp_Pdfphp_Elementphp_Stringphp(php(stringphp)php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php php php php php breakphp;

php php php php php php php php php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php php php php php php php php php php/php/php Setphp propertyphp usingphp PDFphp typephp basedphp onphp PHPphp type
php php php php php php php php php php php php php php php php php php php php php php php php php$docInfophp-php>php$keyphp php=php Zendphp_Pdfphp_Elementphp:php:phpToPdfphp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$thisphp-php>php_trailerphp-php>Infophp php=php php$docInfophp;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_dumpPagesphp(php)php;
php php php php php php php php php$thisphp-php>php_dumpNamedDestinationsphp(php)php;
php php php php php php php php php$thisphp-php>php_dumpOutlinesphp(php)php;

php php php php php php php php php/php/php Checkphp,php thatphp PDFphp filephp wasphp modified
php php php php php php php php php/php/php Filephp isphp alwaysphp modifiedphp byphp php_dumpPagesphp(php)php nowphp,php butphp futurephp implementationsphp mayphp eliminatephp thisphp.
php php php php php php php php ifphp php(php!php$thisphp-php>php_objFactoryphp-php>isModifiedphp(php)php)php php{
php php php php php php php php php php php php ifphp php(php$newSegmentOnlyphp)php php{
php php php php php php php php php php php php php php php php php/php/php Dophp nothingphp,php return
php php php php php php php php php php php php php php php php returnphp php'php'php;
php php php php php php php php php php php php php}

php php php php php php php php php php php php ifphp php(php$outputStreamphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php returnphp php$thisphp-php>php_trailerphp-php>getPDFStringphp(php)php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$pdfDataphp php=php php$thisphp-php>php_trailerphp-php>getPDFStringphp(php)php;
php php php php php php php php php php php php php php php php whilephp php(php strlenphp(php$pdfDataphp)php php>php php0php php&php&php php(php$byteCountphp php=php fwritephp(php$outputStreamphp,php php$pdfDataphp)php)php php!php=php falsephp php)php php{
php php php php php php php php php php php php php php php php php php php php php$pdfDataphp php=php substrphp(php$pdfDataphp,php php$byteCountphp)php;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php returnphp php'php'php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php/php/php offsetphp php(fromphp aphp startphp ofphp PDFphp filephp)php ofphp newphp PDFphp filephp segment
php php php php php php php php php$offsetphp php=php php$thisphp-php>php_trailerphp-php>getPDFLengthphp(php)php;
php php php php php php php php php/php/php Lastphp Objectphp numberphp inphp aphp listphp ofphp freephp objects
php php php php php php php php php$lastFreeObjectphp php=php php$thisphp-php>php_trailerphp-php>getLastFreeObjectphp(php)php;

php php php php php php php php php/php/php Arrayphp ofphp crossphp-referencephp tablephp subsections
php php php php php php php php php$xrefTablephp php=php arrayphp(php)php;
php php php php php php php php php/php/php Objectphp numbersphp ofphp firstphp objectsphp inphp eachphp subsection
php php php php php php php php php$xrefSectionStartNumsphp php=php arrayphp(php)php;

php php php php php php php php php/php/php Lastphp crossphp-referencephp tablephp subsection
php php php php php php php php php$xrefSectionphp php=php arrayphp(php)php;
php php php php php php php php php/php/php Dummyphp initializationphp ofphp thephp firstphp elementphp php(specailphp casephp php-php headerphp ofphp linkedphp listphp ofphp freephp objectsphp)php.
php php php php php php php php php$xrefSectionphp[php]php php=php php0php;
php php php php php php php php php$xrefSectionStartNumsphp[php]php php=php php0php;
php php php php php php php php php/php/php Objectphp numberphp ofphp lastphp processedphp PDFphp objectphp.
php php php php php php php php php/php/php Usedphp tophp managephp crossphp-referencephp subsectionsphp.
php php php php php php php php php/php/php Initializedphp byphp zerophp php(specailphp casephp php-php headerphp ofphp linkedphp listphp ofphp freephp objectsphp)php.
php php php php php php php php php$lastObjNumphp php=php php0php;

php php php php php php php php ifphp php(php$outputStreamphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php ifphp php(php!php$newSegmentOnlyphp)php php{
php php php php php php php php php php php php php php php php php$pdfDataphp php=php php$thisphp-php>php_trailerphp-php>getPDFStringphp(php)php;
php php php php php php php php php php php php php php php php whilephp php(php strlenphp(php$pdfDataphp)php php>php php0php php&php&php php(php$byteCountphp php=php fwritephp(php$outputStreamphp,php php$pdfDataphp)php)php php!php=php falsephp php)php php{
php php php php php php php php php php php php php php php php php php php php php$pdfDataphp php=php substrphp(php$pdfDataphp,php php$byteCountphp)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$pdfSegmentBlocksphp php=php php(php$newSegmentOnlyphp)php php?php arrayphp(php)php php:php arrayphp(php$thisphp-php>php_trailerphp-php>getPDFStringphp(php)php)php;
php php php php php php php php php}

php php php php php php php php php/php/php Iteratephp objectsphp tophp createphp newphp referencephp table
php php php php php php php php foreachphp php(php$thisphp-php>php_objFactoryphp-php>listModifiedObjectsphp(php)php asphp php$updateInfophp)php php{
php php php php php php php php php php php php php$objNumphp php=php php$updateInfophp-php>getObjNumphp(php)php;

php php php php php php php php php php php php ifphp php(php$objNumphp php-php php$lastObjNumphp php!php=php php1php)php php{
php php php php php php php php php php php php php php php php php/php/php Savephp crossphp-referencephp tablephp subsectionphp andphp startphp newphp one
php php php php php php php php php php php php php php php php php$xrefTablephp[php]php php=php php$xrefSectionphp;
php php php php php php php php php php php php php php php php php$xrefSectionphp php=php arrayphp(php)php;
php php php php php php php php php php php php php php php php php$xrefSectionStartNumsphp[php]php php=php php$objNumphp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php ifphp php(php$updateInfophp-php>isFreephp(php)php)php php{
php php php php php php php php php php php php php php php php php/php/php Freephp objectphp crossphp-referencephp tablephp entry
php php php php php php php php php php php php php php php php php$xrefSectionphp[php]php php php=php sprintfphp(php"php%php0php1php0dphp php%php0php5dphp fphp php\nphp"php,php php$lastFreeObjectphp,php php$updateInfophp-php>getGenNumphp(php)php)php;
php php php php php php php php php php php php php php php php php$lastFreeObjectphp php=php php$objNumphp;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php/php/php Inphp-usephp objectphp crossphp-referencephp tablephp entry
php php php php php php php php php php php php php php php php php$xrefSectionphp[php]php php php=php sprintfphp(php"php%php0php1php0dphp php%php0php5dphp nphp php\nphp"php,php php$offsetphp,php php$updateInfophp-php>getGenNumphp(php)php)php;

php php php php php php php php php php php php php php php php php$pdfBlockphp php=php php$updateInfophp-php>getObjectDumpphp(php)php;
php php php php php php php php php php php php php php php php php$offsetphp php+php=php strlenphp(php$pdfBlockphp)php;

php php php php php php php php php php php php php php php php ifphp php(php$outputStreamphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php php php php php php php php php php$pdfSegmentBlocksphp[php]php php=php php$pdfBlockphp;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php whilephp php(php strlenphp(php$pdfBlockphp)php php>php php0php php&php&php php(php$byteCountphp php=php fwritephp(php$outputStreamphp,php php$pdfBlockphp)php)php php!php=php falsephp php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php$pdfBlockphp php=php substrphp(php$pdfBlockphp,php php$byteCountphp)php;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$lastObjNumphp php=php php$objNumphp;
php php php php php php php php php}
php php php php php php php php php/php/php Savephp lastphp crossphp-referencephp tablephp subsection
php php php php php php php php php$xrefTablephp[php]php php=php php$xrefSectionphp;

php php php php php php php php php/php/php Modifyphp firstphp entryphp php(specailphp casephp php-php headerphp ofphp linkedphp listphp ofphp freephp objectsphp)php.
php php php php php php php php php$xrefTablephp[php0php]php[php0php]php php=php sprintfphp(php"php%php0php1php0dphp php6php5php5php3php5php fphp php\nphp"php,php php$lastFreeObjectphp)php;

php php php php php php php php php$xrefTableStrphp php=php php"xrefphp\nphp"php;
php php php php php php php php foreachphp php(php$xrefTablephp asphp php$sectIdphp php=php>php php$xrefSectionphp)php php{
php php php php php php php php php php php php php$xrefTableStrphp php.php=php sprintfphp(php"php%dphp php%dphp php\nphp"php,php php$xrefSectionStartNumsphp[php$sectIdphp]php,php countphp(php$xrefSectionphp)php)php;
php php php php php php php php php php php php foreachphp php(php$xrefSectionphp asphp php$xrefTableEntryphp)php php{
php php php php php php php php php php php php php php php php php$xrefTableStrphp php.php=php php$xrefTableEntryphp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_trailerphp-php>Sizephp-php>valuephp php=php php$thisphp-php>php_objFactoryphp-php>getObjectCountphp(php)php;

php php php php php php php php php$pdfBlockphp php=php php$xrefTableStr
php php php php php php php php php php php php php php php php php php.php php php$thisphp-php>php_trailerphp-php>toStringphp(php)
php php php php php php php php php php php php php php php php php php.php php"startxrefphp\nphp"php php.php php$offsetphp php.php php"php\nphp"
php php php php php php php php php php php php php php php php php php.php php"php%php%EOFphp\nphp"php;

php php php php php php php php php$thisphp-php>php_objFactoryphp-php>cleanEnumerationShiftCachephp(php)php;

php php php php php php php php ifphp php(php$outputStreamphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php php$pdfSegmentBlocksphp[php]php php=php php$pdfBlockphp;

php php php php php php php php php php php php returnphp implodephp(php'php'php,php php$pdfSegmentBlocksphp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php whilephp php(php strlenphp(php$pdfBlockphp)php php>php php0php php&php&php php(php$byteCountphp php=php fwritephp(php$outputStreamphp,php php$pdfBlockphp)php)php php!php=php falsephp php)php php{
php php php php php php php php php php php php php php php php php$pdfBlockphp php=php substrphp(php$pdfBlockphp,php php$byteCountphp)php;
php php php php php php php php php php php php php}

php php php php php php php php php php php php returnphp php'php'php;
php php php php php php php php php}
php php php php php}


php php php php php/php*php*
php php php php php php*php Setphp thephp documentphp-levelphp JavaScript
php php php php php php*
php php php php php php*php php@paramphp stringphp php$javascript
php php php php php php*php/
php php php php publicphp functionphp setJavaScriptphp(php$javascriptphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_javaScriptphp php=php php$javascriptphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Convertphp datephp tophp PDFphp formatphp php(itphp'sphp closephp tophp ASNphp.php1php php(Abstractphp Syntaxphp Notation
php php php php php php*php Onephp)php definedphp inphp ISOphp/IECphp php8php8php2php4php)php.
php php php php php php*
php php php php php php*php php@todophp Thisphp reallyphp isnphp'tphp thephp bestphp locationphp forphp thisphp methodphp.php Itphp should
php php php php php php*php php php probablyphp actuallyphp existphp asphp Zendphp_Pdfphp_Elementphp_Datephp orphp somethingphp likephp thatphp.
php php php php php php*
php php php php php php*php php@todophp Addressphp thephp followingphp Ephp_STRICTphp issuephp:
php php php php php php*php php php PHPphp Strictphp Standardsphp:php php datephp(php)php:php Itphp isphp notphp safephp tophp relyphp onphp thephp systemphp's
php php php php php php*php php php timezonephp settingsphp.php Pleasephp usephp thephp datephp.timezonephp settingphp,php thephp TZ
php php php php php php*php php php environmentphp variablephp orphp thephp datephp_defaultphp_timezonephp_setphp(php)php functionphp.php In
php php php php php php*php php php casephp youphp usedphp anyphp ofphp thosephp methodsphp andphp youphp arephp stillphp gettingphp this
php php php php php php*php php php warningphp,php youphp mostphp likelyphp misspelledphp thephp timezonephp identifierphp.
php php php php php php*
php php php php php php*php php@paramphp integerphp php$timestampphp php(optionalphp)php Ifphp omittedphp,php usesphp thephp currentphp timephp.
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp staticphp functionphp pdfDatephp(php$timestampphp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(php$timestampphp php=php=php=php nullphp)php php{
php php php php php php php php php php php php php$datephp php=php datephp(php'php\Dphp\php:YmdHisOphp'php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$datephp php=php datephp(php'php\Dphp\php:YmdHisOphp'php,php php$timestampphp)php;
php php php php php php php php php}
php php php php php php php php returnphp substrphp_replacephp(php$datephp,php php'php\php'php'php,php php-php2php,php php0php)php php.php php'php\php'php'php;
php php php php php}

php}
