<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_InfoCard
php php*php php@subpackagephp Zendphp_InfoCardphp_Xmlphp_Security
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Securityphp.phpphp php2php3php2php8php0php php2php0php1php0php-php1php0php-php3php1php php1php0php:php2php8php:php5php8Zphp ramonphp php$
php php*php/

php/php*php*
php php*php Zendphp_InfoCardphp_Xmlphp_Securityphp_Transform
php php*php/
requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Transformphp.phpphp'php;

php/php*php*
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_InfoCard
php php*php php@subpackagephp Zendphp_InfoCardphp_Xmlphp_Security
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_InfoCardphp_Xmlphp_Security
php{
php php php php php/php*php*
php php php php php php*php ASNphp.php1php typephp INTEGERphp class
php php php php php php*php/
php php php php constphp ASNphp_TYPEphp_INTEGERphp php=php php0xphp0php2php;

php php php php php/php*php*
php php php php php php*php ASNphp.php1php typephp BITphp STRINGphp class
php php php php php php*php/
php php php php constphp ASNphp_TYPEphp_BITSTRINGphp php=php php0xphp0php3php;

php php php php php/php*php*
php php php php php php*php ASNphp.php1php typephp SEQUENCEphp class
php php php php php php*php/
php php php php constphp ASNphp_TYPEphp_SEQUENCEphp php=php php0xphp3php0php;

php php php php php/php*php*
php php php php php php*php Thephp URIphp forphp Canonicalphp Methodphp Cphp1php4Nphp Exclusive
php php php php php php*php/
php php php php constphp CANONICALphp_METHODphp_Cphp1php4Nphp_EXCphp php=php php'httpphp:php/php/wwwphp.wphp3php.orgphp/php2php0php0php1php/php1php0php/xmlphp-excphp-cphp1php4nphp#php'php;

php php php php php/php*php*
php php php php php php*php Thephp URIphp forphp Signaturephp Methodphp SHAphp1
php php php php php php*php/
php php php php constphp SIGNATUREphp_METHODphp_SHAphp1php php=php php'httpphp:php/php/wwwphp.wphp3php.orgphp/php2php0php0php0php/php0php9php/xmldsigphp#rsaphp-shaphp1php'php;

php php php php php/php*php*
php php php php php php*php Thephp URIphp forphp Digestphp Methodphp SHAphp1
php php php php php php*php/
php php php php constphp DIGESTphp_METHODphp_SHAphp1php php=php php'httpphp:php/php/wwwphp.wphp3php.orgphp/php2php0php0php0php/php0php9php/xmldsigphp#shaphp1php'php;

php php php php php/php*php*
php php php php php php*php Thephp Identifierphp forphp RSAphp Keys
php php php php php php*php/
php php php php constphp RSAphp_KEYphp_IDENTIFIERphp php=php php'php3php0php0Dphp0php6php0php9php2Aphp8php6php4php8php8php6Fphp7php0Dphp0php1php0php1php0php1php0php5php0php0php'php;

php php php php php/php*php*
php php php php php php*php Constructorphp php php(disabledphp)
php php php php php php*
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php privatephp functionphp php_php_constructphp(php)
php php php php php{
php php php php php}

php php php php php/php*php*
php php php php php php*php Validatesphp thephp signaturephp ofphp aphp providedphp XMLphp block
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$strXMLInputphp Anphp XMLphp blockphp containingphp aphp Signature
php php php php php php*php php@returnphp boolphp Truephp ifphp thephp signaturephp validatedphp,php falsephp otherwise
php php php php php php*php php@throwsphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exception
php php php php php php*php/
php php php php staticphp publicphp functionphp validateXMLSignaturephp(php$strXMLInputphp)
php php php php php{
php php php php php php php php ifphp(php!extensionphp_loadedphp(php'opensslphp'php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Youphp mustphp havephp thephp opensslphp extensionphp installedphp tophp usephp thisphp classphp"php)php;
php php php php php php php php php}

php php php php php php php php php$sxephp php=php simplexmlphp_loadphp_stringphp(php$strXMLInputphp)php;

php php php php php php php php ifphp(php!issetphp(php$sxephp-php>Signaturephp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Couldphp notphp identifyphp XMLphp Signaturephp elementphp"php)php;
php php php php php php php php php}

php php php php php php php php ifphp(php!issetphp(php$sxephp-php>Signaturephp-php>SignedInfophp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Signaturephp isphp missingphp aphp SignedInfophp blockphp"php)php;
php php php php php php php php php}

php php php php php php php php ifphp(php!issetphp(php$sxephp-php>Signaturephp-php>SignatureValuephp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Signaturephp isphp missingphp aphp SignatureValuephp blockphp"php)php;
php php php php php php php php php}

php php php php php php php php ifphp(php!issetphp(php$sxephp-php>Signaturephp-php>KeyInfophp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Signaturephp isphp missingphp aphp KeyInfophp blockphp"php)php;
php php php php php php php php php}

php php php php php php php php ifphp(php!issetphp(php$sxephp-php>Signaturephp-php>KeyInfophp-php>KeyValuephp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Signaturephp isphp missingphp aphp KeyValuephp blockphp"php)php;
php php php php php php php php php}

php php php php php php php php switchphp(php(stringphp)php$sxephp-php>Signaturephp-php>SignedInfophp-php>CanonicalizationMethodphp[php'Algorithmphp'php]php)php php{
php php php php php php php php php php php php casephp selfphp:php:CANONICALphp_METHODphp_Cphp1php4Nphp_EXCphp:
php php php php php php php php php php php php php php php php php$cMethodphp php=php php(stringphp)php$sxephp-php>Signaturephp-php>SignedInfophp-php>CanonicalizationMethodphp[php'Algorithmphp'php]php;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Unknownphp orphp unsupportedphp CanonicalizationMethodphp Requestedphp"php)php;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php}

php php php php php php php php switchphp(php(stringphp)php$sxephp-php>Signaturephp-php>SignedInfophp-php>SignatureMethodphp[php'Algorithmphp'php]php)php php{
php php php php php php php php php php php php casephp selfphp:php:SIGNATUREphp_METHODphp_SHAphp1php:
php php php php php php php php php php php php php php php php php$sMethodphp php=php php(stringphp)php$sxephp-php>Signaturephp-php>SignedInfophp-php>SignatureMethodphp[php'Algorithmphp'php]php;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Unknownphp orphp unsupportedphp SignatureMethodphp Requestedphp"php)php;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php}

php php php php php php php php switchphp(php(stringphp)php$sxephp-php>Signaturephp-php>SignedInfophp-php>Referencephp-php>DigestMethodphp[php'Algorithmphp'php]php)php php{
php php php php php php php php php php php php casephp selfphp:php:DIGESTphp_METHODphp_SHAphp1php:
php php php php php php php php php php php php php php php php php$dMethodphp php=php php(stringphp)php$sxephp-php>Signaturephp-php>SignedInfophp-php>Referencephp-php>DigestMethodphp[php'Algorithmphp'php]php;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Unknownphp orphp unsupportedphp DigestMethodphp Requestedphp"php)php;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php}

php php php php php php php php php$basephp6php4DecodeSupportsStrictParamphp php=php versionphp_comparephp(PHPphp_VERSIONphp,php php'php5php.php2php.php0php'php,php php'php>php=php'php)php;

php php php php php php php php ifphp php(php$basephp6php4DecodeSupportsStrictParamphp)php php{
php php php php php php php php php php php php php$dValuephp php=php basephp6php4php_decodephp(php(stringphp)php$sxephp-php>Signaturephp-php>SignedInfophp-php>Referencephp-php>DigestValuephp,php truephp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$dValuephp php=php basephp6php4php_decodephp(php(stringphp)php$sxephp-php>Signaturephp-php>SignedInfophp-php>Referencephp-php>DigestValuephp)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$basephp6php4DecodeSupportsStrictParamphp)php php{
php php php php php php php php php php php php php$signatureValuephp php=php basephp6php4php_decodephp(php(stringphp)php$sxephp-php>Signaturephp-php>SignatureValuephp,php truephp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$signatureValuephp php=php basephp6php4php_decodephp(php(stringphp)php$sxephp-php>Signaturephp-php>SignatureValuephp)php;
php php php php php php php php php}

php php php php php php php php php$transformerphp php=php newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Transformphp(php)php;

php php php php php php php php foreachphp(php$sxephp-php>Signaturephp-php>SignedInfophp-php>Referencephp-php>Transformsphp-php>childrenphp(php)php asphp php$transformphp)php php{
php php php php php php php php php php php php php$transformerphp-php>addTransformphp(php(stringphp)php$transformphp[php'Algorithmphp'php]php)php;
php php php php php php php php php}

php php php php php php php php php$transformedphp_xmlphp php=php php$transformerphp-php>applyTransformsphp(php$strXMLInputphp)php;

php php php php php php php php php$transformedphp_xmlphp_binhashphp php=php packphp(php"Hphp*php"php,php shaphp1php(php$transformedphp_xmlphp)php)php;

php php php php php php php php ifphp(php!selfphp:php:php_secureStringComparephp(php$transformedphp_xmlphp_binhashphp,php php$dValuephp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Locallyphp Transformedphp XMLphp doesphp notphp matchphp XMLphp Documentphp.php Cannotphp Verifyphp Signaturephp"php)php;
php php php php php php php php php}

php php php php php php php php php$publicphp_keyphp php=php nullphp;

php php php php php php php php switchphp(truephp)php php{
php php php php php php php php php php php php casephp issetphp(php$sxephp-php>Signaturephp-php>KeyInfophp-php>KeyValuephp-php>Xphp5php0php9Certificatephp)php:

php php php php php php php php php php php php php php php php php$certificatephp php=php php(stringphp)php$sxephp-php>Signaturephp-php>KeyInfophp-php>KeyValuephp-php>Xphp5php0php9Certificatephp;


php php php php php php php php php php php php php php php php php$pemphp php=php php"php-php-php-php-php-BEGINphp CERTIFICATEphp-php-php-php-php-php\nphp"php php.
php php php php php php php php php php php php php php php php php php php php php php php wordwrapphp(php$certificatephp,php php6php4php,php php"php\nphp"php,php truephp)php php.
php php php php php php php php php php php php php php php php php php php php php php php php"php\nphp-php-php-php-php-ENDphp CERTIFICATEphp-php-php-php-php-php"php;

php php php php php php php php php php php php php php php php php$publicphp_keyphp php=php opensslphp_pkeyphp_getphp_publicphp(php$pemphp)php;

php php php php php php php php php php php php php php php php ifphp(php!php$publicphp_keyphp)php php{
php php php php php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Unablephp tophp extractphp andphp prcoessphp Xphp5php0php9php Certificatephp fromphp KeyValuephp"php)php;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php casephp issetphp(php$sxephp-php>Signaturephp-php>KeyInfophp-php>KeyValuephp-php>RSAKeyValuephp)php:

php php php php php php php php php php php php php php php php ifphp(php!issetphp(php$sxephp-php>Signaturephp-php>KeyInfophp-php>KeyValuephp-php>RSAKeyValuephp-php>Modulusphp)php php|php|
php php php php php php php php php php php php php php php php php php php php!issetphp(php$sxephp-php>Signaturephp-php>KeyInfophp-php>KeyValuephp-php>RSAKeyValuephp-php>Exponentphp)php)php php{
php php php php php php php php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"RSAphp Keyphp Valuephp notphp inphp Modulusphp/Exponentphp formphp"php)php;
php php php php php php php php php php php php php php php php php}

php php php php php php php php php php php php php php php php php$modulusphp php=php basephp6php4php_decodephp(php(stringphp)php$sxephp-php>Signaturephp-php>KeyInfophp-php>KeyValuephp-php>RSAKeyValuephp-php>Modulusphp)php;
php php php php php php php php php php php php php php php php php$exponentphp php=php basephp6php4php_decodephp(php(stringphp)php$sxephp-php>Signaturephp-php>KeyInfophp-php>KeyValuephp-php>RSAKeyValuephp-php>Exponentphp)php;

php php php php php php php php php php php php php php php php php$pemphp_publicphp_keyphp php=php selfphp:php:php_getPublicKeyFromModExpphp(php$modulusphp,php php$exponentphp)php;

php php php php php php php php php php php php php php php php php$publicphp_keyphp php=php opensslphp_pkeyphp_getphp_publicphp php(php$pemphp_publicphp_keyphp)php;

php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Unablephp tophp determinephp orphp unsupportedphp representationphp ofphp thephp KeyValuephp blockphp"php)php;
php php php php php php php php php}

php php php php php php php php php$transformerphp php=php newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Transformphp(php)php;
php php php php php php php php php$transformerphp-php>addTransformphp(php(stringphp)php$sxephp-php>Signaturephp-php>SignedInfophp-php>CanonicalizationMethodphp[php'Algorithmphp'php]php)php;

php php php php php php php php php/php/php Thephp wayphp wephp arephp doingphp ourphp XMLphp processingphp requiresphp thatphp wephp specificallyphp addphp this
php php php php php php php php php/php/php php(evenphp thoughphp itphp'sphp inphp thephp php<Signaturephp>php parentphp-blockphp)php.php.php otherwisephp,php ourphp canonicalphp form
php php php php php php php php php/php/php failsphp signaturephp verification
php php php php php php php php php$sxephp-php>Signaturephp-php>SignedInfophp-php>addAttributephp(php'xmlnsphp'php,php php'httpphp:php/php/wwwphp.wphp3php.orgphp/php2php0php0php0php/php0php9php/xmldsigphp#php'php)php;

php php php php php php php php php$canonicalphp_signedinfophp php=php php$transformerphp-php>applyTransformsphp(php$sxephp-php>Signaturephp-php>SignedInfophp-php>asXMLphp(php)php)php;

php php php php php php php php ifphp(php@opensslphp_verifyphp(php$canonicalphp_signedinfophp,php php$signatureValuephp,php php$publicphp_keyphp)php)php php{
php php php php php php php php php php php php returnphp php(stringphp)php$sxephp-php>Signaturephp-php>SignedInfophp-php>Referencephp[php'URIphp'php]php;
php php php php php php php php php}

php php php php php php php php returnphp falsephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Transformphp anphp RSAphp Keyphp inphp Modulusphp/Exponentphp formatphp intophp aphp PEMphp encodingphp and
php php php php php php*php returnphp anphp opensslphp resourcephp forphp it
php php php php php php*
php php php php php php*php php@paramphp stringphp php$modulusphp Thephp RSAphp Modulusphp inphp binaryphp format
php php php php php php*php php@paramphp stringphp php$exponentphp Thephp RSAphp exponentphp inphp binaryphp format
php php php php php php*php php@returnphp stringphp Thephp PEMphp encodedphp versionphp ofphp thephp key
php php php php php php*php/
php php php php staticphp protectedphp functionphp php_getPublicKeyFromModExpphp(php$modulusphp,php php$exponentphp)
php php php php php{
php php php php php php php php php$modulusIntegerphp php php=php selfphp:php:php_encodeValuephp(php$modulusphp,php selfphp:php:ASNphp_TYPEphp_INTEGERphp)php;
php php php php php php php php php$exponentIntegerphp php=php selfphp:php:php_encodeValuephp(php$exponentphp,php selfphp:php:ASNphp_TYPEphp_INTEGERphp)php;
php php php php php php php php php$modExpSequencephp php php=php selfphp:php:php_encodeValuephp(php$modulusIntegerphp php.php php$exponentIntegerphp,php selfphp:php:ASNphp_TYPEphp_SEQUENCEphp)php;
php php php php php php php php php$modExpBitStringphp php=php selfphp:php:php_encodeValuephp(php$modExpSequencephp,php selfphp:php:ASNphp_TYPEphp_BITSTRINGphp)php;

php php php php php php php php php$binRsaKeyIdentifierphp php=php packphp(php php"Hphp*php"php,php selfphp:php:RSAphp_KEYphp_IDENTIFIERphp php)php;

php php php php php php php php php$publicKeySequencephp php=php selfphp:php:php_encodeValuephp(php$binRsaKeyIdentifierphp php.php php$modExpBitStringphp,php selfphp:php:ASNphp_TYPEphp_SEQUENCEphp)php;

php php php php php php php php php$publicKeyInfoBasephp6php4php php=php basephp6php4php_encodephp(php php$publicKeySequencephp php)php;

php php php php php php php php php$publicKeyStringphp php=php php"php-php-php-php-php-BEGINphp PUBLICphp KEYphp-php-php-php-php-php\nphp"php;
php php php php php php php php php$publicKeyStringphp php.php=php wordwrapphp(php$publicKeyInfoBasephp6php4php,php php6php4php,php php"php\nphp"php,php truephp)php;
php php php php php php php php php$publicKeyStringphp php.php=php php"php\nphp-php-php-php-php-ENDphp PUBLICphp KEYphp-php-php-php-php-php\nphp"php;

php php php php php php php php returnphp php$publicKeyStringphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Encodephp aphp limitedphp setphp ofphp dataphp typesphp intophp ASNphp.php1php encodingphp format
php php php php php php*php whichphp isphp usedphp inphp Xphp.php5php0php9php certificates
php php php php php php*
php php php php php php*php php@paramphp stringphp php$dataphp Thephp dataphp tophp encode
php php php php php php*php php@paramphp constphp php$typephp Thephp encodingphp formatphp constant
php php php php php php*php php@returnphp stringphp Thephp encodedphp value
php php php php php php*php php@throwsphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exception
php php php php php php*php/
php php php php staticphp protectedphp functionphp php_encodeValuephp(php$dataphp,php php$typephp)
php php php php php{
php php php php php php php php php/php/php Nullphp padphp somephp dataphp whenphp wephp getphp itphp php(integerphp valuesphp php>php php1php2php8php andphp bitstringsphp)
php php php php php php php php ifphp(php php(php(php$typephp php=php=php selfphp:php:ASNphp_TYPEphp_INTEGERphp)php php&php&php php(ordphp(php$dataphp)php php>php php0xphp7fphp)php)php php|php|
php php php php php php php php php php php php php(php$typephp php=php=php selfphp:php:ASNphp_TYPEphp_BITSTRINGphp)php)php php{
php php php php php php php php php php php php php php php php php$dataphp php=php php"php\php0php$dataphp"php;
php php php php php php php php php}

php php php php php php php php php$lenphp php=php strlenphp(php$dataphp)php;

php php php php php php php php php/php/php encodephp thephp valuephp basedphp onphp lengthphp ofphp thephp string
php php php php php php php php php/php/php Iphp'mphp fairlyphp confidentphp thatphp thisphp isphp byphp nophp meansphp aphp completephp implementation
php php php php php php php php php/php/php butphp itphp isphp enoughphp forphp ourphp purposes
php php php php php php php php switchphp(truephp)php php{
php php php php php php php php php php php php casephp php(php$lenphp <php php1php2php8php)php:
php php php php php php php php php php php php php php php php returnphp sprintfphp(php"php%cphp%cphp%sphp"php,php php$typephp,php php$lenphp,php php$dataphp)php;
php php php php php php php php php php php php casephp php(php$lenphp <php php0xphp0php1php0php0php)php:
php php php php php php php php php php php php php php php php returnphp sprintfphp(php"php%cphp%cphp%cphp%sphp"php,php php$typephp,php php0xphp8php1php,php php$lenphp,php php$dataphp)php;
php php php php php php php php php php php php casephp php(php$lenphp <php php0xphp0php1php0php0php0php0php)php:
php php php php php php php php php php php php php php php php returnphp sprintfphp(php"php%cphp%cphp%cphp%cphp%sphp"php,php php$typephp,php php0xphp8php2php,php php$lenphp php/php php0xphp0php1php0php0php,php php$lenphp php%php php0xphp0php1php0php0php,php php$dataphp)php;
php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Couldphp notphp encodephp valuephp"php)php;
php php php php php php php php php}

php php php php php php php php requirephp_oncephp php'Zendphp/InfoCardphp/Xmlphp/Securityphp/Exceptionphp.phpphp'php;
php php php php php php php php throwphp newphp Zendphp_InfoCardphp_Xmlphp_Securityphp_Exceptionphp(php"Invalidphp codephp pathphp"php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Securelyphp comparephp twophp stringsphp forphp equalityphp whilephp avoidedphp Cphp levelphp memcmpphp(php)
php php php php php php*php optimisationsphp capablephp ofphp leakingphp timingphp informationphp usefulphp tophp anphp attacker
php php php php php php*php attemptingphp tophp iterativelyphp guessphp thephp unknownphp stringphp php(ephp.gphp.php passwordphp)php being
php php php php php php*php comparedphp againstphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$a
php php php php php php*php php@paramphp stringphp php$b
php php php php php php*php php@returnphp bool
php php php php php php*php/
php php php php staticphp protectedphp functionphp php_secureStringComparephp(php$aphp,php php$bphp)
php php php php php{
php php php php php php php php ifphp php(strlenphp(php$aphp)php php!php=php=php strlenphp(php$bphp)php)php php{
php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php}
php php php php php php php php php$resultphp php=php php0php;
php php php php php php php php forphp php(php$iphp php=php php0php;php php$iphp <php strlenphp(php$aphp)php;php php$iphp+php+php)php php{
php php php php php php php php php php php php php$resultphp php|php=php ordphp(php$aphp[php$iphp]php)php php^php ordphp(php$bphp[php$iphp]php)php;
php php php php php php php php php}
php php php php php php php php returnphp php$resultphp php=php=php php0php;
php php php php php}
php}
