<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_CodeGenerator
php php*php php@subpackagephp PHP
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Filephp.phpphp php2php3php5php6php2php php2php0php1php0php-php1php2php-php1php9php php2php3php:php2php3php:php2php2Zphp mjhphp_caphp php$
php php*php/

php/php*php*
php php*php php@seephp Zendphp_CodeGeneratorphp_Phpphp_Abstract
php php*php/
requirephp_oncephp php'Zendphp/CodeGeneratorphp/Phpphp/Abstractphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_CodeGeneratorphp_Phpphp_Class
php php*php/
requirephp_oncephp php'Zendphp/CodeGeneratorphp/Phpphp/Classphp.phpphp'php;

php/php*php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_CodeGenerator
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_CodeGeneratorphp_Phpphp_Filephp extendsphp Zendphp_CodeGeneratorphp_Phpphp_Abstract
php{

php php php php php/php*php*
php php php php php php*php php@varphp arrayphp Arrayphp ofphp Zendphp_CodeGeneratorphp_Phpphp_File
php php php php php php*php/
php php php php protectedphp staticphp php$php_fileCodeGeneratorsphp php=php arrayphp(php)php;

php php php php php/php*php*php#php@php+
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp staticphp php$php_markerDocblockphp php=php php'php/php*php Zendphp_CodeGeneratorphp_Phpphp_Filephp-DocblockMarkerphp php*php/php'php;
php php php php protectedphp staticphp php$php_markerRequirephp php=php php'php/php*php Zendphp_CodeGeneratorphp_Phpphp_Filephp-RequireMarkerphp:php php{php?php}php php*php/php'php;
php php php php protectedphp staticphp php$php_markerClassphp php=php php'php/php*php Zendphp_CodeGeneratorphp_Phpphp_Filephp-ClassMarkerphp:php php{php?php}php php*php/php'php;
php php php php php/php*php*php#php@php-php*php/

php php php php php/php*php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_filenamephp php=php nullphp;

php php php php php/php*php*
php php php php php php*php php@varphp Zendphp_CodeGeneratorphp_Phpphp_Docblock
php php php php php php*php/
php php php php protectedphp php$php_docblockphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_requiredFilesphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_classesphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_bodyphp php=php nullphp;

php php php php publicphp staticphp functionphp registerFileCodeGeneratorphp(Zendphp_CodeGeneratorphp_Phpphp_Filephp php$fileCodeGeneratorphp,php php$fileNamephp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(php$fileNamephp php=php=php nullphp)php php{
php php php php php php php php php php php php php$fileNamephp php=php php$fileCodeGeneratorphp-php>getFilenamephp(php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$fileNamephp php=php=php php'php'php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/CodeGeneratorphp/Phpphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_CodeGeneratorphp_Phpphp_Exceptionphp(php'FileNamephp doesphp notphp existphp.php'php)php;
php php php php php php php php php}

php php php php php php php php php/php/php cannotphp usephp realpathphp sincephp thephp filephp mightphp notphp existphp,php butphp wephp dophp needphp tophp havephp thephp index
php php php php php php php php php/php/php inphp thephp samephp DIRECTORYphp_SEPARATORphp thatphp realpathphp wouldphp usephp:
php php php php php php php php php$fileNamephp php=php strphp_replacephp(arrayphp(php'php\php\php'php,php php'php/php'php)php,php DIRECTORYphp_SEPARATORphp,php php$fileNamephp)php;

php php php php php php php php selfphp:php:php$php_fileCodeGeneratorsphp[php$fileNamephp]php php=php php$fileCodeGeneratorphp;

php php php php php}

php php php php php/php*php*
php php php php php php*php fromReflectedFileNamephp(php)php php-php usephp thisphp ifphp youphp intendphp onphp generatingphp codephp generationphp objectsphp basedphp onphp thephp samephp filephp.
php php php php php php*php Thisphp willphp keepphp previousphp changesphp tophp thephp filephp inphp tactphp duringphp thephp samephp PHPphp process
php php php php php php*
php php php php php php*php php@paramphp stringphp php$filePath
php php php php php php*php php@paramphp boolphp php$usePreviousCodeGeneratorIfItExists
php php php php php php*php php@paramphp boolphp php$includeIfNotAlreadyIncluded
php php php php php php*php php@returnphp Zendphp_CodeGeneratorphp_Phpphp_File
php php php php php php*php/
php php php php publicphp staticphp functionphp fromReflectedFileNamephp(php$filePathphp,php php$usePreviousCodeGeneratorIfItExistsphp php=php truephp,php php$includeIfNotAlreadyIncludedphp php=php truephp)
php php php php php{
php php php php php php php php php$realpathphp php=php realpathphp(php$filePathphp)php;

php php php php php php php php ifphp php(php$realpathphp php=php=php=php falsephp)php php{
php php php php php php php php php php php php ifphp php(php php(php$realpathphp php=php Zendphp_Reflectionphp_filephp:php:findRealpathInIncludePathphp(php$filePathphp)php)php php=php=php=php falsephp)php php{
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/CodeGeneratorphp/Phpphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php throwphp newphp Zendphp_CodeGeneratorphp_Phpphp_Exceptionphp(php'Nophp filephp forphp php'php php.php php$realpathphp php.php php'php wasphp foundphp.php'php)php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php ifphp php(php$usePreviousCodeGeneratorIfItExistsphp php&php&php issetphp(selfphp:php:php$php_fileCodeGeneratorsphp[php$realpathphp]php)php)php php{
php php php php php php php php php php php php returnphp selfphp:php:php$php_fileCodeGeneratorsphp[php$realpathphp]php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$includeIfNotAlreadyIncludedphp php&php&php php!inphp_arrayphp(php$realpathphp,php getphp_includedphp_filesphp(php)php)php)php php{
php php php php php php php php php php php php includephp php$realpathphp;
php php php php php php php php php}

php php php php php php php php php$codeGeneratorphp php=php selfphp:php:fromReflectionphp(php(php$fileReflectorphp php=php newphp Zendphp_Reflectionphp_Filephp(php$realpathphp)php)php)php;

php php php php php php php php ifphp php(php!issetphp(selfphp:php:php$php_fileCodeGeneratorsphp[php$fileReflectorphp-php>getFileNamephp(php)php]php)php)php php{
php php php php php php php php php php php php selfphp:php:php$php_fileCodeGeneratorsphp[php$fileReflectorphp-php>getFileNamephp(php)php]php php=php php$codeGeneratorphp;
php php php php php php php php php}

php php php php php php php php returnphp php$codeGeneratorphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php fromReflectionphp(php)
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Reflectionphp_Filephp php$reflectionFile
php php php php php php*php php@returnphp Zendphp_CodeGeneratorphp_Phpphp_File
php php php php php php*php/
php php php php publicphp staticphp functionphp fromReflectionphp(Zendphp_Reflectionphp_Filephp php$reflectionFilephp)
php php php php php{
php php php php php php php php php$filephp php=php newphp selfphp(php)php;

php php php php php php php php php$filephp-php>setSourceContentphp(php$reflectionFilephp-php>getContentsphp(php)php)php;
php php php php php php php php php$filephp-php>setSourceDirtyphp(falsephp)php;

php php php php php php php php php$bodyphp php=php php$reflectionFilephp-php>getContentsphp(php)php;

php php php php php php php php php/php/php php@todophp thisphp wholephp areaphp needsphp tophp bephp reworkedphp withphp respectphp tophp howphp bodyphp linesphp arephp processed
php php php php php php php php foreachphp php(php$reflectionFilephp-php>getClassesphp(php)php asphp php$classphp)php php{
php php php php php php php php php php php php php$filephp-php>setClassphp(Zendphp_CodeGeneratorphp_Phpphp_Classphp:php:fromReflectionphp(php$classphp)php)php;
php php php php php php php php php php php php php$classStartLinephp php=php php$classphp-php>getStartLinephp(truephp)php;
php php php php php php php php php php php php php$classEndLinephp php=php php$classphp-php>getEndLinephp(php)php;

php php php php php php php php php php php php php$bodyLinesphp php=php explodephp(php"php\nphp"php,php php$bodyphp)php;
php php php php php php php php php php php php php$bodyReturnphp php=php arrayphp(php)php;
php php php php php php php php php php php php forphp php(php$lineNumphp php=php php1php;php php$lineNumphp <php=php countphp(php$bodyLinesphp)php;php php$lineNumphp+php+php)php php{
php php php php php php php php php php php php php php php php ifphp php(php$lineNumphp php=php=php php$classStartLinephp)php php{
php php php php php php php php php php php php php php php php php php php php php$bodyReturnphp[php]php php=php strphp_replacephp(php'php?php'php,php php$classphp-php>getNamephp(php)php,php selfphp:php:php$php_markerClassphp)php;php php php/php/php'php/php*php Zendphp_CodeGeneratorphp_Phpphp_Filephp-ClassMarkerphp:php php{php'php php.php php$classphp-php>getNamephp(php)php php.php php'php}php php*php/php'php;
php php php php php php php php php php php php php php php php php php php php php$lineNumphp php=php php$classEndLinephp;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php$bodyReturnphp[php]php php=php php$bodyLinesphp[php$lineNumphp php-php php1php]php;php php/php/php adjustphp forphp indexphp php-php>php linephp conversion
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$bodyphp php=php implodephp(php"php\nphp"php,php php$bodyReturnphp)php;
php php php php php php php php php php php php unsetphp(php$bodyLinesphp,php php$bodyReturnphp,php php$classStartLinephp,php php$classEndLinephp)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php(php$reflectionFilephp-php>getDocCommentphp(php)php php!php=php php'php'php)php)php php{
php php php php php php php php php php php php php$docblockphp php=php php$reflectionFilephp-php>getDocblockphp(php)php;
php php php php php php php php php php php php php$filephp-php>setDocblockphp(Zendphp_CodeGeneratorphp_Phpphp_Docblockphp:php:fromReflectionphp(php$docblockphp)php)php;

php php php php php php php php php php php php php$bodyLinesphp php=php explodephp(php"php\nphp"php,php php$bodyphp)php;
php php php php php php php php php php php php php$bodyReturnphp php=php arrayphp(php)php;
php php php php php php php php php php php php forphp php(php$lineNumphp php=php php1php;php php$lineNumphp <php=php countphp(php$bodyLinesphp)php;php php$lineNumphp+php+php)php php{
php php php php php php php php php php php php php php php php ifphp php(php$lineNumphp php=php=php php$docblockphp-php>getStartLinephp(php)php)php php{
php php php php php php php php php php php php php php php php php php php php php$bodyReturnphp[php]php php=php strphp_replacephp(php'php?php'php,php php$classphp-php>getNamephp(php)php,php selfphp:php:php$php_markerDocblockphp)php;php php php/php/php'php/php*php Zendphp_CodeGeneratorphp_Phpphp_Filephp-ClassMarkerphp:php php{php'php php.php php$classphp-php>getNamephp(php)php php.php php'php}php php*php/php'php;
php php php php php php php php php php php php php php php php php php php php php$lineNumphp php=php php$docblockphp-php>getEndLinephp(php)php;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php$bodyReturnphp[php]php php=php php$bodyLinesphp[php$lineNumphp php-php php1php]php;php php/php/php adjustphp forphp indexphp php-php>php linephp conversion
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$bodyphp php=php implodephp(php"php\nphp"php,php php$bodyReturnphp)php;
php php php php php php php php php php php php unsetphp(php$bodyLinesphp,php php$bodyReturnphp,php php$classStartLinephp,php php$classEndLinephp)php;
php php php php php php php php php}

php php php php php php php php php$filephp-php>setBodyphp(php$bodyphp)php;

php php php php php php php php returnphp php$filephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php setDocblockphp(php)php Setphp thephp docblock
php php php php php php*
php php php php php php*php php@paramphp Zendphp_CodeGeneratorphp_Phpphp_Docblockphp|arrayphp|stringphp php$docblock
php php php php php php*php php@returnphp Zendphp_CodeGeneratorphp_Phpphp_File
php php php php php php*php/
php php php php publicphp functionphp setDocblockphp(php$docblockphp)
php php php php php{
php php php php php php php php ifphp php(isphp_stringphp(php$docblockphp)php)php php{
php php php php php php php php php php php php php$docblockphp php=php arrayphp(php'shortDescriptionphp'php php=php>php php$docblockphp)php;
php php php php php php php php php}

php php php php php php php php ifphp php(isphp_arrayphp(php$docblockphp)php)php php{
php php php php php php php php php php php php php$docblockphp php=php newphp Zendphp_CodeGeneratorphp_Phpphp_Docblockphp(php$docblockphp)php;
php php php php php php php php php}php elseifphp php(php!php$docblockphp instanceofphp Zendphp_CodeGeneratorphp_Phpphp_Docblockphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/CodeGeneratorphp/Phpphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_CodeGeneratorphp_Phpphp_Exceptionphp(php'setDocblockphp(php)php isphp expectingphp eitherphp aphp stringphp,php arrayphp orphp anphp instancephp ofphp Zendphp_CodeGeneratorphp_Phpphp_Docblockphp'php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_docblockphp php=php php$docblockphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp docblock
php php php php php php*
php php php php php php*php php@returnphp Zendphp_CodeGeneratorphp_Phpphp_Docblock
php php php php php php*php/
php php php php publicphp functionphp getDocblockphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_docblockphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php setRequiredFiles
php php php php php php*
php php php php php php*php php@paramphp arrayphp php$requiredFiles
php php php php php php*php php@returnphp Zendphp_CodeGeneratorphp_Phpphp_File
php php php php php php*php/
php php php php publicphp functionphp setRequiredFilesphp(php$requiredFilesphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_requiredFilesphp php=php php$requiredFilesphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php getRequiredFilesphp(php)
php php php php php php*
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp getRequiredFilesphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_requiredFilesphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php setClassesphp(php)
php php php php php php*
php php php php php php*php php@paramphp arrayphp php$classes
php php php php php php*php php@returnphp Zendphp_CodeGeneratorphp_Phpphp_File
php php php php php php*php/
php php php php publicphp functionphp setClassesphp(Arrayphp php$classesphp)
php php php php php{
php php php php php php php php foreachphp php(php$classesphp asphp php$classphp)php php{
php php php php php php php php php php php php php$thisphp-php>setClassphp(php$classphp)php;
php php php php php php php php php}
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php getClassphp(php)
php php php php php php*
php php php php php php*php php@paramphp stringphp php$name
php php php php php php*php php@returnphp Zendphp_CodeGeneratorphp_Phpphp_Class
php php php php php php*php/
php php php php publicphp functionphp getClassphp(php$namephp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(php$namephp php=php=php nullphp)php php{
php php php php php php php php php php php php resetphp(php$thisphp-php>php_classesphp)php;
php php php php php php php php php php php php returnphp currentphp(php$thisphp-php>php_classesphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$thisphp-php>php_classesphp[php$namephp]php;
php php php php php}

php php php php php/php*php*
php php php php php php*php setClassphp(php)
php php php php php php*
php php php php php php*php php@paramphp Zendphp_CodeGeneratorphp_Phpphp_Classphp|arrayphp php$class
php php php php php php*php php@returnphp Zendphp_CodeGeneratorphp_Phpphp_File
php php php php php php*php/
php php php php publicphp functionphp setClassphp(php$classphp)
php php php php php{
php php php php php php php php ifphp php(isphp_arrayphp(php$classphp)php)php php{
php php php php php php php php php php php php php$classphp php=php newphp Zendphp_CodeGeneratorphp_Phpphp_Classphp(php$classphp)php;
php php php php php php php php php php php php php$classNamephp php=php php$classphp-php>getNamephp(php)php;
php php php php php php php php php}php elseifphp php(php$classphp instanceofphp Zendphp_CodeGeneratorphp_Phpphp_Classphp)php php{
php php php php php php php php php php php php php$classNamephp php=php php$classphp-php>getNamephp(php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/CodeGeneratorphp/Phpphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_CodeGeneratorphp_Phpphp_Exceptionphp(php'Expectingphp eitherphp anphp arrayphp orphp anphp instancephp ofphp Zendphp_CodeGeneratorphp_Phpphp_Classphp'php)php;
php php php php php php php php php}

php php php php php php php php php/php/php php@todophp checkphp forphp dupphp here

php php php php php php php php php$thisphp-php>php_classesphp[php$classNamephp]php php=php php$classphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php setFilenamephp(php)
php php php php php php*
php php php php php php*php php@paramphp stringphp php$filename
php php php php php php*php php@returnphp Zendphp_CodeGeneratorphp_Phpphp_File
php php php php php php*php/
php php php php publicphp functionphp setFilenamephp(php$filenamephp)
php php php php php{
php php php php php php php php php$thisphp-php>php_filenamephp php=php php$filenamephp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php getFilenamephp(php)
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getFilenamephp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_filenamephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php getClassesphp(php)
php php php php php php*
php php php php php php*php php@returnphp arrayphp Arrayphp ofphp Zendphp_CodeGeneratorphp_Phpphp_Class
php php php php php php*php/
php php php php publicphp functionphp getClassesphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_classesphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php setBodyphp(php)
php php php php php php*
php php php php php php*php php@paramphp stringphp php$body
php php php php php php*php php@returnphp Zendphp_CodeGeneratorphp_Phpphp_File
php php php php php php*php/
php php php php publicphp functionphp setBodyphp(php$bodyphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_bodyphp php=php php$bodyphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php getBodyphp(php)
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getBodyphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_bodyphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php isSourceDirtyphp(php)
php php php php php php*
php php php php php php*php php@returnphp bool
php php php php php php*php/
php php php php publicphp functionphp isSourceDirtyphp(php)
php php php php php{
php php php php php php php php ifphp php(php(php$docblockphp php=php php$thisphp-php>getDocblockphp(php)php)php php&php&php php$docblockphp-php>isSourceDirtyphp(php)php)php php{
php php php php php php php php php php php php returnphp truephp;
php php php php php php php php php}

php php php php php php php php foreachphp php(php$thisphp-php>php_classesphp asphp php$classphp)php php{
php php php php php php php php php php php php ifphp php(php$classphp-php>isSourceDirtyphp(php)php)php php{
php php php php php php php php php php php php php php php php returnphp truephp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp parentphp:php:isSourceDirtyphp(php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php generatephp(php)
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp generatephp(php)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>isSourceDirtyphp(php)php php=php=php=php falsephp)php php{
php php php php php php php php php php php php returnphp php$thisphp-php>php_sourceContentphp;
php php php php php php php php php}

php php php php php php php php php$outputphp php=php php'php'php;

php php php php php php php php php/php/php startphp withphp thephp bodyphp php(ifphp therephp)php,php orphp openphp tag
php php php php php php php php ifphp php(pregphp_matchphp(php'php#php(php?php:php\sphp*php)<php\php?phpphp#php'php,php php$thisphp-php>getBodyphp(php)php)php php=php=php falsephp)php php{
php php php php php php php php php php php php php$outputphp php=php php'<php?phpphp'php php.php selfphp:php:LINEphp_FEEDphp;
php php php php php php php php php}

php php php php php php php php php/php/php ifphp therephp arephp markersphp,php putphp thephp bodyphp intophp thephp output
php php php php php php php php php$bodyphp php=php php$thisphp-php>getBodyphp(php)php;
php php php php php php php php ifphp php(pregphp_matchphp(php'php#php/php\php*php Zendphp_CodeGeneratorphp_Phpphp_Filephp-php(php.php*php?php)Markerphp:php#php'php,php php$bodyphp)php)php php{
php php php php php php php php php php php php php$outputphp php.php=php php$bodyphp;
php php php php php php php php php php php php php$bodyphp php php php php=php php'php'php;
php php php php php php php php php}

php php php php php php php php php/php/php Addphp filephp docblockphp,php ifphp any
php php php php php php php php ifphp php(nullphp php!php=php=php php(php$docblockphp php=php php$thisphp-php>getDocblockphp(php)php)php)php php{
php php php php php php php php php php php php php$docblockphp-php>setIndentationphp(php'php'php)php;
php php php php php php php php php php php php php$regexphp php=php pregphp_quotephp(selfphp:php:php$php_markerDocblockphp,php php'php#php'php)php;
php php php php php php php php php php php php ifphp php(pregphp_matchphp(php'php#php'php.php$regexphp.php'php#php'php,php php$outputphp)php)php php{
php php php php php php php php php php php php php php php php php$outputphp php php=php pregphp_replacephp(php'php#php'php.php$regexphp.php'php#php'php,php php$docblockphp-php>generatephp(php)php,php php$outputphp,php php1php)php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$outputphp php.php=php php$docblockphp-php>generatephp(php)php php.php selfphp:php:LINEphp_FEEDphp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php/php/php newline
php php php php php php php php php$outputphp php.php=php selfphp:php:LINEphp_FEEDphp;

php php php php php php php php php/php/php processphp requiredphp files
php php php php php php php php php/php/php php@todophp markerphp replacementphp forphp requiredphp files
php php php php php php php php php$requiredFilesphp php=php php$thisphp-php>getRequiredFilesphp(php)php;
php php php php php php php php ifphp php(php!emptyphp(php$requiredFilesphp)php)php php{
php php php php php php php php php php php php foreachphp php(php$requiredFilesphp asphp php$requiredFilephp)php php{
php php php php php php php php php php php php php php php php php$outputphp php.php=php php'requirephp_oncephp php\php'php'php php.php php$requiredFilephp php.php php'php\php'php;php'php php.php selfphp:php:LINEphp_FEEDphp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$outputphp php.php=php selfphp:php:LINEphp_FEEDphp;
php php php php php php php php php}

php php php php php php php php php/php/php processphp classes
php php php php php php php php php$classesphp php=php php$thisphp-php>getClassesphp(php)php;
php php php php php php php php ifphp php(php!emptyphp(php$classesphp)php)php php{
php php php php php php php php php php php php foreachphp php(php$classesphp asphp php$classphp)php php{
php php php php php php php php php php php php php php php php php$regexphp php=php strphp_replacephp(php'php?php'php,php php$classphp-php>getNamephp(php)php,php selfphp:php:php$php_markerClassphp)php;
php php php php php php php php php php php php php php php php php$regexphp php=php pregphp_quotephp(php$regexphp,php php'php#php'php)php;
php php php php php php php php php php php php php php php php ifphp php(pregphp_matchphp(php'php#php'php.php$regexphp.php'php#php'php,php php$outputphp)php)php php{
php php php php php php php php php php php php php php php php php php php php php$outputphp php=php pregphp_replacephp(php'php#php'php.php$regexphp.php'php#php'php,php php$classphp-php>generatephp(php)php,php php$outputphp,php php1php)php;
php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php$outputphp php.php=php php$classphp-php>generatephp(php)php php.php selfphp:php:LINEphp_FEEDphp;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}

php php php php php php php php php}

php php php php php php php php ifphp php(php!emptyphp(php$bodyphp)php)php php{

php php php php php php php php php php php php php/php/php addphp anphp extraphp spacephp betweephp clssesphp and
php php php php php php php php php php php php ifphp php(php!emptyphp(php$classesphp)php)php php{
php php php php php php php php php php php php php php php php php$outputphp php.php=php selfphp:php:LINEphp_FEEDphp;
php php php php php php php php php php php php php}

php php php php php php php php php php php php php$outputphp php.php=php php$bodyphp;
php php php php php php php php php}

php php php php php php php php returnphp php$outputphp;
php php php php php}

php php php php publicphp functionphp writephp(php)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_filenamephp php=php=php php'php'php php|php|php php!isphp_writablephp(dirnamephp(php$thisphp-php>php_filenamephp)php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/CodeGeneratorphp/Phpphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_CodeGeneratorphp_Phpphp_Exceptionphp(php'Thisphp codephp generatorphp objectphp isphp notphp writablephp.php'php)php;
php php php php php php php php php}
php php php php php php php php filephp_putphp_contentsphp(php$thisphp-php>php_filenamephp,php php$thisphp-php>generatephp(php)php)php;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php}
