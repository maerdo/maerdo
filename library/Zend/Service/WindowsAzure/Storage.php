<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Servicephp_WindowsAzure
php php*php php@subpackagephp Storage
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Storagephp.phpphp php2php3php5php8php4php php2php0php1php0php-php1php2php-php2php8php php1php9php:php5php1php:php4php9Zphp matthewphp php$
php php*php/

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstract
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Credentialsphp/CredentialsAbstractphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_SharedKey
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Credentialsphp/SharedKeyphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_RetryPolicyphp_RetryPolicyAbstract
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/RetryPolicyphp/RetryPolicyAbstractphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Exception
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Exceptionphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Httpphp_Client
php php*php/
requirephp_oncephp php'Zendphp/Httpphp/Clientphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Httpphp_Response
php php*php/
requirephp_oncephp php'Zendphp/Httpphp/Responsephp.phpphp'php;

php/php*php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Servicephp_WindowsAzure
php php*php php@subpackagephp Storage
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_Servicephp_WindowsAzurephp_Storage
php{
php	php/php*php*
php	php php*php Developmentphp storagephp URLS
php	php php*php/
php	constphp URLphp_DEVphp_BLOBphp php php php php php php=php php"php1php2php7php.php0php.php0php.php1php:php1php0php0php0php0php"php;
php	constphp URLphp_DEVphp_QUEUEphp php php php php php=php php"php1php2php7php.php0php.php0php.php1php:php1php0php0php0php1php"php;
php	constphp URLphp_DEVphp_TABLEphp php php php php php=php php"php1php2php7php.php0php.php0php.php1php:php1php0php0php0php2php"php;
php	
php	php/php*php*
php	php php*php Livephp storagephp URLS
php	php php*php/
php	constphp URLphp_CLOUDphp_BLOBphp php php php php=php php"blobphp.corephp.windowsphp.netphp"php;
php	constphp URLphp_CLOUDphp_QUEUEphp php php php=php php"queuephp.corephp.windowsphp.netphp"php;
php	constphp URLphp_CLOUDphp_TABLEphp php php php=php php"tablephp.corephp.windowsphp.netphp"php;
php	
php	php/php*php*
php	php php*php Resourcephp types
php	php php*php/
php	constphp RESOURCEphp_UNKNOWNphp php php php php php=php php"unknownphp"php;
php	constphp RESOURCEphp_CONTAINERphp php php php=php php"cphp"php;
php	constphp RESOURCEphp_BLOBphp php php php php php php php php=php php"bphp"php;
php	constphp RESOURCEphp_TABLEphp php php php php php php php=php php"tphp"php;
php	constphp RESOURCEphp_ENTITYphp php php php php php php=php php"ephp"php;
php	constphp RESOURCEphp_QUEUEphp php php php php php php php=php php"qphp"php;
php	
php	php/php*php*
php	php php*php HTTPphp headerphp prefixes
php	php php*php/
php	constphp PREFIXphp_PROPERTIESphp php php php php php php=php php"xphp-msphp-propphp-php"php;
php	constphp PREFIXphp_METADATAphp php php php php php php php php=php php"xphp-msphp-metaphp-php"php;
php	constphp PREFIXphp_STORAGEphp_HEADERphp php php=php php"xphp-msphp-php"php;
php	
php	php/php*php*
php	php php*php Currentphp APIphp version
php	php php*
php	php php*php php@varphp string
php	php php*php/
php	protectedphp php$php_apiVersionphp php=php php'php2php0php0php9php-php0php9php-php1php9php'php;
php	
php	php/php*php*
php	php php*php Storagephp hostphp name
php	php php*
php	php php*php php@varphp string
php	php php*php/
php	protectedphp php$php_hostphp php=php php'php'php;
php	
php	php/php*php*
php	php php*php Accountphp namephp forphp Windowsphp Azure
php	php php*
php	php php*php php@varphp string
php	php php*php/
php	protectedphp php$php_accountNamephp php=php php'php'php;
php	
php	php/php*php*
php	php php*php Accountphp keyphp forphp Windowsphp Azure
php	php php*
php	php php*php php@varphp string
php	php php*php/
php	protectedphp php$php_accountKeyphp php=php php'php'php;
php	
php	php/php*php*
php	php php*php Usephp pathphp-stylephp URIphp's
php	php php*
php	php php*php php@varphp boolean
php	php php*php/
php	protectedphp php$php_usePathStyleUriphp php=php falsephp;
php	
php	php/php*php*
php	php php*php Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstractphp instance
php	php php*
php	php php*php php@varphp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstract
php	php php*php/
php	protectedphp php$php_credentialsphp php=php nullphp;
php	
php	php/php*php*
php	php php*php Zendphp_Servicephp_WindowsAzurephp_RetryPolicyphp_RetryPolicyAbstractphp instance
php	php php*
php	php php*php php@varphp Zendphp_Servicephp_WindowsAzurephp_RetryPolicyphp_RetryPolicyAbstract
php	php php*php/
php	protectedphp php$php_retryPolicyphp php=php nullphp;
php	
php	php/php*php*
php	php php*php Zendphp_Httpphp_Clientphp channelphp usedphp forphp communicationphp withphp RESTphp services
php	php php*
php	php php*php php@varphp Zendphp_Httpphp_Client
php	php php*php/
php	protectedphp php$php_httpClientChannelphp php=php nullphp;
php	
php	php/php*php*
php	php php*php Usephp proxyphp?
php	php php*
php	php php*php php@varphp boolean
php	php php*php/
php	protectedphp php$php_useProxyphp php=php falsephp;
php	
php	php/php*php*
php	php php*php Proxyphp url
php	php php*
php	php php*php php@varphp string
php	php php*php/
php	protectedphp php$php_proxyUrlphp php=php php'php'php;
php	
php	php/php*php*
php	php php*php Proxyphp port
php	php php*
php	php php*php php@varphp int
php	php php*php/
php	protectedphp php$php_proxyPortphp php=php php8php0php;
php	
php	php/php*php*
php	php php*php Proxyphp credentials
php	php php*
php	php php*php php@varphp string
php	php php*php/
php	protectedphp php$php_proxyCredentialsphp php=php php'php'php;
php	
php	php/php*php*
php	php php*php Createsphp aphp newphp Zendphp_Servicephp_WindowsAzurephp_Storagephp instance
php	php php*
php	php php*php php@paramphp stringphp php$hostphp Storagephp hostphp name
php	php php*php php@paramphp stringphp php$accountNamephp Accountphp namephp forphp Windowsphp Azure
php	php php*php php@paramphp stringphp php$accountKeyphp Accountphp keyphp forphp Windowsphp Azure
php	php php*php php@paramphp booleanphp php$usePathStyleUriphp Usephp pathphp-stylephp URIphp's
php	php php*php php@paramphp Zendphp_Servicephp_WindowsAzurephp_RetryPolicyphp_RetryPolicyAbstractphp php$retryPolicyphp Retryphp policyphp tophp usephp whenphp makingphp requests
php	php php*php/
php	publicphp functionphp php_php_constructphp(
php	php	php$hostphp php=php selfphp:php:URLphp_DEVphp_BLOBphp,
php	php	php$accountNamephp php=php Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstractphp:php:DEVSTOREphp_ACCOUNTphp,
php	php	php$accountKeyphp php=php Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstractphp:php:DEVSTOREphp_KEYphp,
php	php	php$usePathStyleUriphp php=php falsephp,
php	php	Zendphp_Servicephp_WindowsAzurephp_RetryPolicyphp_RetryPolicyAbstractphp php$retryPolicyphp php=php null
php	php)php php{
php	php	php$thisphp-php>php_hostphp php=php php$hostphp;
php	php	php$thisphp-php>php_accountNamephp php=php php$accountNamephp;
php	php	php$thisphp-php>php_accountKeyphp php=php php$accountKeyphp;
php	php	php$thisphp-php>php_usePathStyleUriphp php=php php$usePathStyleUriphp;
php	php	
php	php	php/php/php Usingphp localphp storagephp?
php	php	ifphp php(php!php$thisphp-php>php_usePathStyleUri
php	php	php	php&php&php php(php$thisphp-php>php_hostphp php=php=php selfphp:php:URLphp_DEVphp_BLOB
php	php	php	php	php|php|php php$thisphp-php>php_hostphp php=php=php selfphp:php:URLphp_DEVphp_QUEUE
php	php	php	php	php|php|php php$thisphp-php>php_hostphp php=php=php selfphp:php:URLphp_DEVphp_TABLEphp)
php	php	php)php php{
php	php	php	php/php/php Localphp storage
php	php	php	php$thisphp-php>php_usePathStyleUriphp php=php truephp;
php	php	php}
php	php	
php	php	ifphp php(php$thisphp-php>php_credentialsphp php=php=php=php nullphp)php php{
php	php	php php php php php$thisphp-php>php_credentialsphp php=php newphp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_SharedKeyphp(
php	php	php php php php php	php$thisphp-php>php_accountNamephp,php php$thisphp-php>php_accountKeyphp,php php$thisphp-php>php_usePathStyleUriphp)php;
php	php	php}
php	php	
php	php	php$thisphp-php>php_retryPolicyphp php=php php$retryPolicyphp;
php	php	ifphp php(php$thisphp-php>php_retryPolicyphp php=php=php=php nullphp)php php{
php	php	php php php php php$thisphp-php>php_retryPolicyphp php=php Zendphp_Servicephp_WindowsAzurephp_RetryPolicyphp_RetryPolicyAbstractphp:php:noRetryphp(php)php;
php	php	php}
php	php	
php	php	php/php/php Setupphp defaultphp Zendphp_Httpphp_Clientphp channel
php	php	php$optionsphp php=php arrayphp(
php	php	php	php'adapterphp'php php=php>php php'Zendphp_Httpphp_Clientphp_Adapterphp_Proxyphp'
php	php	php)php;
php	php	ifphp php(functionphp_existsphp(php'curlphp_initphp'php)php)php php{
php	php	php	php/php/php Setphp cURLphp optionsphp ifphp cURLphp isphp usedphp afterwards
php	php	php	php$optionsphp[php'curloptionsphp'php]php php=php arrayphp(
php	php	php	php	php	CURLOPTphp_FOLLOWLOCATIONphp php=php>php truephp,
php	php	php	php	php	CURLOPTphp_TIMEOUTphp php=php>php php1php2php0php,
php	php	php	php)php;
php	php	php}
php	php	php$thisphp-php>php_httpClientChannelphp php=php newphp Zendphp_Httpphp_Clientphp(nullphp,php php$optionsphp)php;
php	php}
php	
php	php/php*php*
php	php php*php Setphp thephp HTTPphp clientphp channelphp tophp use
php	php php*
php	php php*php php@paramphp Zendphp_Httpphp_Clientphp_Adapterphp_Interfacephp|stringphp php$adapterInstancephp Adapterphp instancephp orphp adapterphp classphp namephp.
php	php php*php/
php	publicphp functionphp setHttpClientChannelphp(php$adapterInstancephp php=php php'Zendphp_Httpphp_Clientphp_Adapterphp_Proxyphp'php)
php	php{
php	php	php$thisphp-php>php_httpClientChannelphp-php>setAdapterphp(php$adapterInstancephp)php;
php	php}

php php php php php/php*php*
php php php php php php*php Retrievephp HTTPphp clientphp channel
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Httpphp_Clientphp_Adapterphp_Interface
php php php php php php*php/
php php php php publicphp functionphp getHttpClientChannelphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_httpClientChannelphp;
php php php php php}
php	
php	php/php*php*
php	php php*php Setphp retryphp policyphp tophp usephp whenphp makingphp requests
php	php php*
php	php php*php php@paramphp Zendphp_Servicephp_WindowsAzurephp_RetryPolicyphp_RetryPolicyAbstractphp php$retryPolicyphp Retryphp policyphp tophp usephp whenphp makingphp requests
php	php php*php/
php	publicphp functionphp setRetryPolicyphp(Zendphp_Servicephp_WindowsAzurephp_RetryPolicyphp_RetryPolicyAbstractphp php$retryPolicyphp php=php nullphp)
php	php{
php	php	php$thisphp-php>php_retryPolicyphp php=php php$retryPolicyphp;
php	php	ifphp php(php$thisphp-php>php_retryPolicyphp php=php=php=php nullphp)php php{
php	php	php php php php php$thisphp-php>php_retryPolicyphp php=php Zendphp_Servicephp_WindowsAzurephp_RetryPolicyphp_RetryPolicyAbstractphp:php:noRetryphp(php)php;
php	php	php}
php	php}
php	
php	php/php*php*
php	php php*php Setphp proxy
php	php php*
php	php php*php php@paramphp booleanphp php$useProxyphp php php php php php php php php Usephp proxyphp?
php	php php*php php@paramphp stringphp php php$proxyUrlphp php php php php php php php php Proxyphp URL
php	php php*php php@paramphp intphp php php php php php$proxyPortphp php php php php php php php Proxyphp port
php	php php*php php@paramphp stringphp php php$proxyCredentialsphp Proxyphp credentials
php	php php*php/
php	publicphp functionphp setProxyphp(php$useProxyphp php=php falsephp,php php$proxyUrlphp php=php php'php'php,php php$proxyPortphp php=php php8php0php,php php$proxyCredentialsphp php=php php'php'php)
php	php{
php	php php php php php$thisphp-php>php_useProxyphp php php php php php php php php php=php php$useProxyphp;
php	php php php php php$thisphp-php>php_proxyUrlphp php php php php php php php php php=php php$proxyUrlphp;
php	php php php php php$thisphp-php>php_proxyPortphp php php php php php php php php=php php$proxyPortphp;
php	php php php php php$thisphp-php>php_proxyCredentialsphp php=php php$proxyCredentialsphp;
php	
php	php php php php ifphp php(php$thisphp-php>php_useProxyphp)php php{
php	php php php php php	php$credentialsphp php=php explodephp(php'php:php'php,php php$thisphp-php>php_proxyCredentialsphp)php;
php	php php php php php	
php	php php php php php	php$thisphp-php>php_httpClientChannelphp-php>setConfigphp(arrayphp(
php	php	php	php	php'proxyphp_hostphp'php php=php>php php$thisphp-php>php_proxyUrlphp,
php	php php php php php	php	php'proxyphp_portphp'php php=php>php php$thisphp-php>php_proxyPortphp,
php	php php php php php	php	php'proxyphp_userphp'php php=php>php php$credentialsphp[php0php]php,
php	php php php php php	php	php'proxyphp_passphp'php php=php>php php$credentialsphp[php1php]php,
php	php php php php php	php)php)php;
php	php php php php php}php elsephp php{
php	php	php	php$thisphp-php>php_httpClientChannelphp-php>setConfigphp(arrayphp(
php	php	php	php	php'proxyphp_hostphp'php php=php>php php'php'php,
php	php php php php php	php	php'proxyphp_portphp'php php=php>php php8php0php8php0php,
php	php php php php php	php	php'proxyphp_userphp'php php=php>php php'php'php,
php	php php php php php	php	php'proxyphp_passphp'php php=php>php php'php'php,
php	php php php php php	php)php)php;
php	php php php php php}
php	php}
php	
php	php/php*php*
php	php php*php Returnsphp thephp Windowsphp Azurephp accountphp name
php	php php*
php	php php*php php@returnphp string
php	php php*php/
php	publicphp functionphp getAccountNamephp(php)
php	php{
php	php	returnphp php$thisphp-php>php_accountNamephp;
php	php}
php	
php	php/php*php*
php	php php*php Getphp basephp URLphp forphp creatingphp requests
php	php php*
php	php php*php php@returnphp string
php	php php*php/
php	publicphp functionphp getBaseUrlphp(php)
php	php{
php	php	ifphp php(php$thisphp-php>php_usePathStyleUriphp)php php{
php	php	php	returnphp php'httpphp:php/php/php'php php.php php$thisphp-php>php_hostphp php.php php'php/php'php php.php php$thisphp-php>php_accountNamephp;
php	php	php}php elsephp php{
php	php	php	returnphp php'httpphp:php/php/php'php php.php php$thisphp-php>php_accountNamephp php.php php'php.php'php php.php php$thisphp-php>php_hostphp;
php	php	php}
php	php}
php	
php	php/php*php*
php	php php*php Setphp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstractphp instance
php	php php*
php	php php*php php@paramphp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstractphp php$credentialsphp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstractphp instancephp tophp usephp forphp requestphp signingphp.
php	php php*php/
php	publicphp functionphp setCredentialsphp(Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstractphp php$credentialsphp)
php	php{
php	php php php php php$thisphp-php>php_credentialsphp php=php php$credentialsphp;
php	php php php php php$thisphp-php>php_credentialsphp-php>setAccountNamephp(php$thisphp-php>php_accountNamephp)php;
php	php php php php php$thisphp-php>php_credentialsphp-php>setAccountkeyphp(php$thisphp-php>php_accountKeyphp)php;
php	php php php php php$thisphp-php>php_credentialsphp-php>setUsePathStyleUriphp(php$thisphp-php>php_usePathStyleUriphp)php;
php	php}
php	
php	php/php*php*
php	php php*php Getphp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstractphp instance
php	php php*
php	php php*php php@returnphp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstract
php	php php*php/
php	publicphp functionphp getCredentialsphp(php)
php	php{
php	php php php php returnphp php$thisphp-php>php_credentialsphp;
php	php}
php	
php	php/php*php*
php	php php*php Performphp requestphp usingphp Zendphp_Httpphp_Clientphp channel
php	php php*
php	php php*php php@paramphp stringphp php$pathphp Path
php	php php*php php@paramphp stringphp php$queryStringphp Queryphp string
php	php php*php php@paramphp stringphp php$httpVerbphp HTTPphp verbphp thephp requestphp willphp use
php	php php*php php@paramphp arrayphp php$headersphp xphp-msphp headersphp tophp add
php	php php*php php@paramphp booleanphp php$forTableStoragephp Isphp thephp requestphp forphp tablephp storagephp?
php	php php*php php@paramphp mixedphp php$rawDataphp Optionalphp RAWphp HTTPphp dataphp tophp bephp sentphp overphp thephp wire
php	php php*php php@paramphp stringphp php$resourceTypephp Resourcephp type
php	php php*php php@paramphp stringphp php$requiredPermissionphp Requiredphp permission
php	php php*php php@returnphp Zendphp_Httpphp_Response
php	php php*php/
php	protectedphp functionphp php_performRequestphp(
php	php	php$pathphp php=php php'php/php'php,
php	php	php$queryStringphp php=php php'php'php,
php	php	php$httpVerbphp php=php Zendphp_Httpphp_Clientphp:php:GETphp,
php	php	php$headersphp php=php arrayphp(php)php,
php	php	php$forTableStoragephp php=php falsephp,
php	php	php$rawDataphp php=php nullphp,
php	php	php$resourceTypephp php=php Zendphp_Servicephp_WindowsAzurephp_Storagephp:php:RESOURCEphp_UNKNOWNphp,
php	php	php$requiredPermissionphp php=php Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstractphp:php:PERMISSIONphp_READ
php	php)php php{
php	php php php php php/php/php Cleanphp path
php	php	ifphp php(strposphp(php$pathphp,php php'php/php'php)php php!php=php=php php0php)php php{
php	php	php	php$pathphp php=php php'php/php'php php.php php$pathphp;
php	php	php}
php	php	php	
php	php	php/php/php Cleanphp headers
php	php	ifphp php(php$headersphp php=php=php=php nullphp)php php{
php	php	php php php php php$headersphp php=php arrayphp(php)php;
php	php	php}
php	php	
php	php	php/php/php Ensurephp cUrlphp willphp alsophp workphp correctlyphp:
php	php	php/php/php php php-php disablephp Contentphp-Typephp ifphp required
php	php	php/php/php php php-php disablephp Expectphp:php php1php0php0php Continue
php	php	ifphp php(php!issetphp(php$headersphp[php"Contentphp-Typephp"php]php)php)php php{
php	php	php	php$headersphp[php"Contentphp-Typephp"php]php php=php php'php'php;
php	php	php}
php	php	php$headersphp[php"Expectphp"php]php=php php'php'php;

php	php	php/php/php Addphp versionphp header
php	php	php$headersphp[php'xphp-msphp-versionphp'php]php php=php php$thisphp-php>php_apiVersionphp;
php	php	
php	php	php/php/php URLphp encoding
php	php	php$pathphp php php php php php php php php php php php=php selfphp:php:urlencodephp(php$pathphp)php;
php	php	php$queryStringphp php php php php=php selfphp:php:urlencodephp(php$queryStringphp)php;

php php php php php php php php php/php/php Generatephp URLphp andphp signphp request
php php php php php php php php php$requestUrlphp php php php php php=php php$thisphp-php>php_credentials
php php php php php php php php php php php php php php php php php php php php php php php php php php php-php>signRequestUrlphp(php$thisphp-php>getBaseUrlphp(php)php php.php php$pathphp php.php php$queryStringphp,php php$resourceTypephp,php php$requiredPermissionphp)php;
php php php php php php php php php$requestHeadersphp php=php php$thisphp-php>php_credentials
php php php php php php php php php php php php php php php php php php php php php php php php php php php-php>signRequestHeadersphp(php$httpVerbphp,php php$pathphp,php php$queryStringphp,php php$headersphp,php php$forTableStoragephp,php php$resourceTypephp,php php$requiredPermissionphp,php php$rawDataphp)php;

php	php	php/php/php Preparephp request
php	php	php$thisphp-php>php_httpClientChannelphp-php>resetParametersphp(truephp)php;
php	php	php$thisphp-php>php_httpClientChannelphp-php>setUriphp(php$requestUrlphp)php;
php	php	php$thisphp-php>php_httpClientChannelphp-php>setHeadersphp(php$requestHeadersphp)php;
php	php	php$thisphp-php>php_httpClientChannelphp-php>setRawDataphp(php$rawDataphp)php;
php	php	php	php	
php	php	php/php/php Executephp request
php	php	php$responsephp php=php php$thisphp-php>php_retryPolicyphp-php>executephp(
php	php	php php php php arrayphp(php$thisphp-php>php_httpClientChannelphp,php php'requestphp'php)php,
php	php	php php php php arrayphp(php$httpVerbphp)
php	php	php)php;
php	php	
php	php	returnphp php$responsephp;
php	php}
php	
php	php/php*php*
php	php php*php Parsephp resultphp fromphp Zendphp_Httpphp_Response
php	php php*
php	php php*php php@paramphp Zendphp_Httpphp_Responsephp php$responsephp Responsephp fromphp HTTPphp call
php	php php*php php@returnphp object
php	php php*php php@throwsphp Zendphp_Servicephp_WindowsAzurephp_Exception
php	php php*php/
php	protectedphp functionphp php_parseResponsephp(Zendphp_Httpphp_Responsephp php$responsephp php=php nullphp)
php	php{
php	php	ifphp php(php$responsephp php=php=php=php nullphp)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Responsephp shouldphp notphp bephp nullphp.php'php)php;
php	php	php}
php	php	
php php php php php php php php php$xmlphp php=php php@simplexmlphp_loadphp_stringphp(php$responsephp-php>getBodyphp(php)php)php;

php php php php php php php php ifphp php(php$xmlphp php!php=php=php falsephp)php php{
php php php php php php php php php php php php php/php/php Fetchphp allphp namespaces
php php php php php php php php php php php php php$namespacesphp php=php arrayphp_mergephp(php$xmlphp-php>getNamespacesphp(truephp)php,php php$xmlphp-php>getDocNamespacesphp(truephp)php)php;

php php php php php php php php php php php php php/php/php Registerphp allphp namespacephp prefixes
php php php php php php php php php php php php foreachphp php(php$namespacesphp asphp php$prefixphp php=php>php php$nsphp)php php{
php php php php php php php php php php php php php php php php ifphp php(php$prefixphp php!php=php php'php'php)php php{
php php php php php php php php php php php php php php php php php php php php php$xmlphp-php>registerXPathNamespacephp(php$prefixphp,php php$nsphp)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp php$xmlphp;
php	php}
php	
php	php/php*php*
php	php php*php Generatephp metadataphp headers
php	php php*
php	php php*php php@paramphp arrayphp php$metadata
php	php php*php php@returnphp HTTPphp headersphp containingphp metadata
php	php php*php/
php	protectedphp functionphp php_generateMetadataHeadersphp(php$metadataphp php=php arrayphp(php)php)
php	php{
php	php	php/php/php Validate
php	php	ifphp php(php!isphp_arrayphp(php$metadataphp)php)php php{
php	php	php	returnphp arrayphp(php)php;
php	php	php}
php	php	
php	php	php/php/php Returnphp headers
php	php	php$headersphp php=php arrayphp(php)php;
php	php	foreachphp php(php$metadataphp asphp php$keyphp php=php>php php$valuephp)php php{
php	php	php	ifphp php(strposphp(php$valuephp,php php"php\rphp"php)php php!php=php=php falsephp php|php|php strposphp(php$valuephp,php php"php\nphp"php)php php!php=php=php falsephp)php php{
php	php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Metadataphp cannotphp containphp newlinephp charactersphp.php'php)php;
php	php	php	php}
php	php	php	
php	php	php	ifphp php(php!selfphp:php:isValidMetadataNamephp(php$keyphp)php)php php{
php	php	php php php php php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Metadataphp namephp doesphp notphp adherephp tophp metadataphp namingphp conventionsphp.php Seephp httpphp:php/php/msdnphp.microsoftphp.comphp/enphp-usphp/libraryphp/aaphp6php6php4php6php7php0php(VSphp.php7php1php)php.aspxphp forphp morephp informationphp.php'php)php;
php	php	php	php}
php	php	php	
php	php	php php php php php$headersphp[php"xphp-msphp-metaphp-php"php php.php strtolowerphp(php$keyphp)php]php php=php php$valuephp;
php	php	php}
php	php	returnphp php$headersphp;
php	php}
php	
php	php/php*php*
php	php php*php Parsephp metadataphp headers
php	php php*
php	php php*php php@paramphp arrayphp php$headersphp HTTPphp headersphp containingphp metadata
php	php php*php php@returnphp array
php	php php*php/
php	protectedphp functionphp php_parseMetadataHeadersphp(php$headersphp php=php arrayphp(php)php)
php	php{
php	php	php/php/php Validate
php	php	ifphp php(php!isphp_arrayphp(php$headersphp)php)php php{
php	php	php	returnphp arrayphp(php)php;
php	php	php}
php	php	
php	php	php/php/php Returnphp metadata
php	php	php$metadataphp php=php arrayphp(php)php;
php	php	foreachphp php(php$headersphp asphp php$keyphp php=php>php php$valuephp)php php{
php	php	php php php php ifphp php(substrphp(strtolowerphp(php$keyphp)php,php php0php,php php1php0php)php php=php=php php"xphp-msphp-metaphp-php"php)php php{
php	php	php php php php php php php php php$metadataphp[strphp_replacephp(php"xphp-msphp-metaphp-php"php,php php'php'php,php strtolowerphp(php$keyphp)php)php]php php=php php$valuephp;
php	php	php php php php php}
php	php	php}
php	php	returnphp php$metadataphp;
php	php}
php	
php	php/php*php*
php	php php*php Parsephp metadataphp XML
php	php php*
php	php php*php php@paramphp SimpleXMLElementphp php$parentElementphp Elementphp containingphp thephp Metadataphp elementphp.
php	php php*php php@returnphp array
php	php php*php/
php	protectedphp functionphp php_parseMetadataElementphp(php$elementphp php=php nullphp)
php	php{
php	php	php/php/php Metadataphp presentphp?
php	php	ifphp php(php$elementphp php!php=php=php nullphp php&php&php issetphp(php$elementphp-php>Metadataphp)php php&php&php php$elementphp-php>Metadataphp php!php=php=php nullphp)php php{
php	php	php	returnphp getphp_objectphp_varsphp(php$elementphp-php>Metadataphp)php;
php	php	php}

php	php	returnphp arrayphp(php)php;
php	php}
php	
php	php/php*php*
php	php php*php Generatephp ISOphp php8php6php0php1php compliantphp datephp stringphp inphp UTCphp timephp zone
php	php php*
php	php php*php php@paramphp intphp php$timestamp
php	php php*php php@returnphp string
php	php php*php/
php	publicphp functionphp isoDatephp(php$timestampphp php=php nullphp)
php	php{
php	php php php php php$tzphp php=php php@datephp_defaultphp_timezonephp_getphp(php)php;
php	php php php php php@datephp_defaultphp_timezonephp_setphp(php'UTCphp'php)php;
php	
php	php php php php ifphp php(php$timestampphp php=php=php=php nullphp)php php{
php	php php php php php php php php php$timestampphp php=php timephp(php)php;
php	php php php php php}
php	
php	php php php php php$returnValuephp php=php strphp_replacephp(php'php+php0php0php:php0php0php'php,php php'php.php0php0php0php0php0php0php0Zphp'php,php php@datephp(php'cphp'php,php php$timestampphp)php)php;
php	php php php php php@datephp_defaultphp_timezonephp_setphp(php$tzphp)php;
php	php php php php returnphp php$returnValuephp;
php	php}
php	
php	php/php*php*
php	php php*php URLphp encodephp function
php	php php*
php	php php*php php@paramphp php stringphp php$valuephp Valuephp tophp encode
php	php php*php php@returnphp stringphp php php php php php php php Encodedphp value
php	php php*php/
php	publicphp staticphp functionphp urlencodephp(php$valuephp)
php	php{
php	php php php php returnphp strphp_replacephp(php'php php'php,php php'php%php2php0php'php,php php$valuephp)php;
php	php}
php	
php	php/php*php*
php	php php*php Isphp validphp metadataphp namephp?
php	php php*
php	php php*php php@paramphp stringphp php$metadataNamephp Metadataphp name
php	php php*php php@returnphp boolean
php	php php*php/
php php php php publicphp staticphp functionphp isValidMetadataNamephp(php$metadataNamephp php=php php'php'php)
php php php php php{
php php php php php php php php ifphp php(pregphp_matchphp(php"php/php^php[aphp-zAphp-Zphp0php-php9php_php@php]php[aphp-zAphp-Zphp0php-php9php_php]php*php$php/php"php,php php$metadataNamephp)php php=php=php=php php0php)php php{
php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php}

php php php php php php php php ifphp php(php$metadataNamephp php=php=php php'php'php)php php{
php php php php php php php php php php php php returnphp falsephp;
php php php php php php php php php}

php php php php php php php php returnphp truephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Buildsphp aphp queryphp stringphp fromphp anphp arrayphp ofphp elements
php php php php php php*
php php php php php php*php php@paramphp arrayphp php php php php Arrayphp ofphp elements
php php php php php php*php php@returnphp stringphp php php Assembledphp queryphp string
php php php php php php*php/
php php php php publicphp staticphp functionphp createQueryStringFromArrayphp(php$queryStringphp)
php php php php php{
php php php php php php php php returnphp countphp(php$queryStringphp)php php>php php0php php?php php'php?php'php php.php implodephp(php'php&php'php,php php$queryStringphp)php php:php php'php'php;
php php php php php}php php php php 
php}
