<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Servicephp_WindowsAzure
php php*php php@subpackagephp Storage
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Tablephp.phpphp php2php3php5php8php4php php2php0php1php0php-php1php2php-php2php8php php1php9php:php5php1php:php4php9Zphp matthewphp php$
php php*php/

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstract
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Credentialsphp/CredentialsAbstractphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_SharedKey
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Credentialsphp/SharedKeyphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_SharedKeyLite
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Credentialsphp/SharedKeyLitephp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_RetryPolicyphp_RetryPolicyAbstract
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/RetryPolicyphp/RetryPolicyAbstractphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Httpphp_Client
php php*php/
requirephp_oncephp php'Zendphp/Httpphp/Clientphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Httpphp_Response
php php*php/
requirephp_oncephp php'Zendphp/Httpphp/Responsephp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Storage
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Storagephp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Storagephp_BatchStorageAbstract
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Storagephp/BatchStorageAbstractphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableInstance
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Storagephp/TableInstancephp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntity
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Storagephp/TableEntityphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Storagephp_DynamicTableEntity
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Storagephp/DynamicTableEntityphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityQuery
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Storagephp/TableEntityQueryphp.phpphp'php;

php/php*php*
php php*php php@seephp Zendphp_Servicephp_WindowsAzurephp_Exception
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/WindowsAzurephp/Exceptionphp.phpphp'php;


php/php*php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Servicephp_WindowsAzure
php php*php php@subpackagephp Storage
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_Table
php php php php extendsphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_BatchStorageAbstract
php{
php	php/php*php*
php	php php*php Createsphp aphp newphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_Tablephp instance
php	php php*
php	php php*php php@paramphp stringphp php$hostphp Storagephp hostphp name
php	php php*php php@paramphp stringphp php$accountNamephp Accountphp namephp forphp Windowsphp Azure
php	php php*php php@paramphp stringphp php$accountKeyphp Accountphp keyphp forphp Windowsphp Azure
php	php php*php php@paramphp booleanphp php$usePathStyleUriphp Usephp pathphp-stylephp URIphp's
php	php php*php php@paramphp Zendphp_Servicephp_WindowsAzurephp_RetryPolicyphp_RetryPolicyAbstractphp php$retryPolicyphp Retryphp policyphp tophp usephp whenphp makingphp requests
php	php php*php/
php	publicphp functionphp php_php_constructphp(php$hostphp php=php Zendphp_Servicephp_WindowsAzurephp_Storagephp:php:URLphp_DEVphp_TABLEphp,php php$accountNamephp php=php Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstractphp:php:DEVSTOREphp_ACCOUNTphp,php php$accountKeyphp php=php Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstractphp:php:DEVSTOREphp_KEYphp,php php$usePathStyleUriphp php=php falsephp,php Zendphp_Servicephp_WindowsAzurephp_RetryPolicyphp_RetryPolicyAbstractphp php$retryPolicyphp php=php nullphp)
php	php{
php	php	parentphp:php:php_php_constructphp(php$hostphp,php php$accountNamephp,php php$accountKeyphp,php php$usePathStyleUriphp,php php$retryPolicyphp)php;

php	php php php php php/php/php Alwaysphp usephp SharedKeyLitephp authentication
php	php php php php php$thisphp-php>php_credentialsphp php=php newphp Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_SharedKeyLitephp(php$accountNamephp,php php$accountKeyphp,php php$thisphp-php>php_usePathStyleUriphp)php;
php	
php	php php php php php/php/php APIphp version
php	php	php$thisphp-php>php_apiVersionphp php=php php'php2php0php0php9php-php0php9php-php1php9php'php;
php	php}
php	
php	php/php*php*
php	php php*php Checkphp ifphp aphp tablephp exists
php	php php*
php	php php*php php@paramphp stringphp php$tableNamephp Tablephp name
php	php php*php php@returnphp boolean
php	php php*php/
php	publicphp functionphp tableExistsphp(php$tableNamephp php=php php'php'php)
php	php{
php	php	ifphp php(php$tableNamephp php=php=php=php php'php'php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Tablephp namephp isphp notphp specifiedphp.php'php)php;
php	php	php}
php	php	php	
php	php	php/php/php Listphp tables
php php php php php php php php php$tablesphp php=php php$thisphp-php>listTablesphp(php)php;php php/php/php php2php0php0php9php-php0php9php-php1php9php doesphp notphp supportphp php$thisphp-php>listTablesphp(php$tableNamephp)php;php allphp ofphp aphp suddenphp.php.php.
php php php php php php php php foreachphp php(php$tablesphp asphp php$tablephp)php php{
php php php php php php php php php php php php ifphp php(php$tablephp-php>Namephp php=php=php php$tableNamephp)php php{
php php php php php php php php php php php php php php php php returnphp truephp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp falsephp;
php	php}
php	
php	php/php*php*
php	php php*php Listphp tables
php	php php*
php	php php*php php@paramphp php stringphp php$nextTableNamephp Nextphp tablephp namephp,php usedphp forphp listingphp tablesphp whenphp totalphp amountphp ofphp tablesphp isphp php>php php1php0php0php0php.
php	php php*php php@returnphp array
php	php php*php php@throwsphp Zendphp_Servicephp_WindowsAzurephp_Exception
php	php php*php/
php	publicphp functionphp listTablesphp(php$nextTableNamephp php=php php'php'php)
php	php{
php	php php php php php/php/php Buildphp queryphp string
php	php	php$queryStringphp php=php arrayphp(php)php;
php	php php php php ifphp php(php$nextTableNamephp php!php=php php'php'php)php php{
php	php php php php php php php php php$queryStringphp[php]php php=php php'NextTableNamephp=php'php php.php php$nextTableNamephp;
php	php php php php php}
php	php php php php php$queryStringphp php=php selfphp:php:createQueryStringFromArrayphp(php$queryStringphp)php;
php	
php	php	php/php/php Performphp request
php	php	php$responsephp php=php php$thisphp-php>php_performRequestphp(php'Tablesphp'php,php php$queryStringphp,php Zendphp_Httpphp_Clientphp:php:GETphp,php nullphp,php truephp)php;
php	php	ifphp php(php$responsephp-php>isSuccessfulphp(php)php)php php{php	
php	php	php php php php php/php/php Parsephp result
php	php	php php php php php$resultphp php=php php$thisphp-php>php_parseResponsephp(php$responsephp)php;php	
php	php	
php	php	php php php php ifphp php(php!php$resultphp php|php|php php!php$resultphp-php>entryphp)php php{
php	php	php php php php php php php php returnphp arrayphp(php)php;
php	php	php php php php php}
php	
php	php	php php php php php$entriesphp php=php nullphp;
php	php	php php php php ifphp php(countphp(php$resultphp-php>entryphp)php php>php php1php)php php{
php	php	php php php php php php php php php$entriesphp php=php php$resultphp-php>entryphp;
php	php	php php php php php}php elsephp php{
php	php	php php php php php php php php php$entriesphp php=php arrayphp(php$resultphp-php>entryphp)php;
php	php	php php php php php}

php	php	php php php php php/php/php Createphp returnphp value
php	php	php php php php php$returnValuephp php=php arrayphp(php)php;php	php	
php	php	php php php php foreachphp php(php$entriesphp asphp php$entryphp)php php{
php	php	php php php php php php php php php$tableNamephp php=php php$entryphp-php>xpathphp(php'php.php/php/mphp:propertiesphp/dphp:TableNamephp'php)php;
php	php	php php php php php php php php php$tableNamephp php=php php(stringphp)php$tableNamephp[php0php]php;
php	php	
php	php	php php php php php php php php php$returnValuephp[php]php php=php newphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableInstancephp(
php	php	php php php php php php php php php php php php php(stringphp)php$entryphp-php>idphp,
php	php	php php php php php php php php php php php php php$tableNamephp,
php	php	php php php php php php php php php php php php php(stringphp)php$entryphp-php>linkphp[php'hrefphp'php]php,
php	php	php php php php php php php php php php php php php(stringphp)php$entryphp-php>updated
php	php	php php php php php php php php php)php;
php	php	php php php php php}
php	php	
php	php	php	php/php/php Morephp tablesphp?
php	php	php php php php ifphp php(php$responsephp-php>getHeaderphp(php'xphp-msphp-continuationphp-NextTableNamephp'php)php php!php=php=php nullphp)php php{
php	php	php php php php php php php php php$returnValuephp php=php arrayphp_mergephp(php$returnValuephp,php php$thisphp-php>listTablesphp(php$responsephp-php>getHeaderphp(php'xphp-msphp-continuationphp-NextTableNamephp'php)php)php)php;
php	php	php php php php php}

php	php	php php php php returnphp php$returnValuephp;
php	php	php}php elsephp php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php$thisphp-php>php_getErrorMessagephp(php$responsephp,php php'Resourcephp couldphp notphp bephp accessedphp.php'php)php)php;
php	php	php}
php	php}
php	
php	php/php*php*
php	php php*php Createphp table
php	php php*
php	php php*php php@paramphp stringphp php$tableNamephp Tablephp name
php	php php*php php@returnphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableInstance
php	php php*php php@throwsphp Zendphp_Servicephp_WindowsAzurephp_Exception
php	php php*php/
php	publicphp functionphp createTablephp(php$tableNamephp php=php php'php'php)
php	php{
php	php	ifphp php(php$tableNamephp php=php=php=php php'php'php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Tablephp namephp isphp notphp specifiedphp.php'php)php;
php	php	php}
php	php	php	
php	php	php/php/php Generatephp requestphp body
php	php	php$requestBodyphp php=php php'<php?xmlphp versionphp=php"php1php.php0php"php encodingphp=php"utfphp-php8php"php standalonephp=php"yesphp"php?php>
php php php php php php php php php php php php php php php php php php php php php php php php php<entry
php php php php php php php php php php php php php php php php php php php php php php php php php php php php xmlnsphp:dphp=php"httpphp:php/php/schemasphp.microsoftphp.comphp/adophp/php2php0php0php7php/php0php8php/dataservicesphp"
php php php php php php php php php php php php php php php php php php php php php php php php php php php php xmlnsphp:mphp=php"httpphp:php/php/schemasphp.microsoftphp.comphp/adophp/php2php0php0php7php/php0php8php/dataservicesphp/metadataphp"
php php php php php php php php php php php php php php php php php php php php php php php php php php php php xmlnsphp=php"httpphp:php/php/wwwphp.wphp3php.orgphp/php2php0php0php5php/Atomphp"php>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<titlephp php/php>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<updatedphp>php{tplphp:Updatedphp}<php/updatedphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<authorphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php<namephp php/php>
php php php php php php php php php php php php php php php php php php php php php php php php php php <php/authorphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<idphp php/php>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<contentphp typephp=php"applicationphp/xmlphp"php>
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php<mphp:propertiesphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php<dphp:TableNamephp>php{tplphp:TableNamephp}<php/dphp:TableNamephp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php php <php/mphp:propertiesphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php <php/contentphp>
php php php php php php php php php php php php php php php php php php php php php php php php <php/entryphp>php'php;
php php php php php php php php 
php php php php php php php php php$requestBodyphp php=php php$thisphp-php>php_fillTemplatephp(php$requestBodyphp,php arrayphp(
php php php php php php php php php php php php php'BaseUrlphp'php php=php>php php$thisphp-php>getBaseUrlphp(php)php,
php php php php php php php php php php php php php'TableNamephp'php php=php>php htmlspecialcharsphp(php$tableNamephp)php,
php php php php php php php php php php php php php'Updatedphp'php php=php>php php$thisphp-php>isoDatephp(php)php,
php php php php php php php php php php php php php'AccountNamephp'php php=php>php php$thisphp-php>php_accountName
php php php php php php php php php)php)php;

php php php php php php php php php/php/php Addphp headerphp information
php php php php php php php php php$headersphp php=php arrayphp(php)php;
php php php php php php php php php$headersphp[php'Contentphp-Typephp'php]php php=php php'applicationphp/atomphp+xmlphp'php;
php php php php php php php php php$headersphp[php'DataServiceVersionphp'php]php php=php php'php1php.php0php;NetFxphp'php;
php php php php php php php php php$headersphp[php'MaxDataServiceVersionphp'php]php php=php php'php1php.php0php;NetFxphp'php;

php	php	php/php/php Performphp request
php	php	php$responsephp php=php php$thisphp-php>php_performRequestphp(php'Tablesphp'php,php php'php'php,php Zendphp_Httpphp_Clientphp:php:POSTphp,php php$headersphp,php truephp,php php$requestBodyphp)php;
php	php	ifphp php(php$responsephp-php>isSuccessfulphp(php)php)php php{
php	php	php php php php php/php/php Parsephp response
php	php	php php php php php$entryphp php=php php$thisphp-php>php_parseResponsephp(php$responsephp)php;
php	php	
php	php	php php php php php$tableNamephp php=php php$entryphp-php>xpathphp(php'php.php/php/mphp:propertiesphp/dphp:TableNamephp'php)php;
php	php	php php php php php$tableNamephp php=php php(stringphp)php$tableNamephp[php0php]php;
php	php	
php	php	php php php php returnphp newphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableInstancephp(
php	php	php php php php php php php php php(stringphp)php$entryphp-php>idphp,
php	php	php php php php php php php php php$tableNamephp,
php	php	php php php php php php php php php(stringphp)php$entryphp-php>linkphp[php'hrefphp'php]php,
php	php	php php php php php php php php php(stringphp)php$entryphp-php>updated
php	php	php php php php php)php;
php	php	php}php elsephp php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php$thisphp-php>php_getErrorMessagephp(php$responsephp,php php'Resourcephp couldphp notphp bephp accessedphp.php'php)php)php;
php	php	php}
php	php}
php	
php	php/php*php*
php	php php*php Deletephp table
php	php php*
php	php php*php php@paramphp stringphp php$tableNamephp Tablephp name
php	php php*php php@throwsphp Zendphp_Servicephp_WindowsAzurephp_Exception
php	php php*php/
php	publicphp functionphp deleteTablephp(php$tableNamephp php=php php'php'php)
php	php{
php	php	ifphp php(php$tableNamephp php=php=php=php php'php'php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Tablephp namephp isphp notphp specifiedphp.php'php)php;
php	php	php}

php php php php php php php php php/php/php Addphp headerphp information
php php php php php php php php php$headersphp php=php arrayphp(php)php;
php php php php php php php php php$headersphp[php'Contentphp-Typephp'php]php php=php php'applicationphp/atomphp+xmlphp'php;

php	php	php/php/php Performphp request
php	php	php$responsephp php=php php$thisphp-php>php_performRequestphp(php'Tablesphp(php\php'php'php php.php php$tableNamephp php.php php'php\php'php)php'php,php php'php'php,php Zendphp_Httpphp_Clientphp:php:DELETEphp,php php$headersphp,php truephp,php nullphp)php;
php	php	ifphp php(php!php$responsephp-php>isSuccessfulphp(php)php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php$thisphp-php>php_getErrorMessagephp(php$responsephp,php php'Resourcephp couldphp notphp bephp accessedphp.php'php)php)php;
php	php	php}
php	php}
php	
php	php/php*php*
php	php php*php Insertphp entityphp intophp table
php	php php*
php	php php*php php@paramphp stringphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$tableNamephp php php Tablephp name
php	php php*php php@paramphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp php$entityphp php php php php php Entityphp tophp insert
php	php php*php php@returnphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntity
php	php php*php php@throwsphp Zendphp_Servicephp_WindowsAzurephp_Exception
php	php php*php/
php	publicphp functionphp insertEntityphp(php$tableNamephp php=php php'php'php,php Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp php$entityphp php=php nullphp)
php	php{
php	php	ifphp php(php$tableNamephp php=php=php=php php'php'php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Tablephp namephp isphp notphp specifiedphp.php'php)php;
php	php	php}
php	php	ifphp php(php$entityphp php=php=php=php nullphp)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Entityphp isphp notphp specifiedphp.php'php)php;
php	php	php}
php	php	
php	php	php/php/php Generatephp requestphp body
php	php	php$requestBodyphp php=php php'<php?xmlphp versionphp=php"php1php.php0php"php encodingphp=php"utfphp-php8php"php standalonephp=php"yesphp"php?php>
php php php php php php php php php php php php php php php php php php php php php php php php php<entryphp xmlnsphp:dphp=php"httpphp:php/php/schemasphp.microsoftphp.comphp/adophp/php2php0php0php7php/php0php8php/dataservicesphp"php xmlnsphp:mphp=php"httpphp:php/php/schemasphp.microsoftphp.comphp/adophp/php2php0php0php7php/php0php8php/dataservicesphp/metadataphp"php xmlnsphp=php"httpphp:php/php/wwwphp.wphp3php.orgphp/php2php0php0php5php/Atomphp"php>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<titlephp php/php>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<updatedphp>php{tplphp:Updatedphp}<php/updatedphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<authorphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php<namephp php/php>
php php php php php php php php php php php php php php php php php php php php php php php php php php <php/authorphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<idphp php/php>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<contentphp typephp=php"applicationphp/xmlphp"php>
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php<mphp:propertiesphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php{tplphp:Propertiesphp}
php php php php php php php php php php php php php php php php php php php php php php php php php php php php <php/mphp:propertiesphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php <php/contentphp>
php php php php php php php php php php php php php php php php php php php php php php php php <php/entryphp>php'php;
php php php php php php php php 
php php php php php php php php php$requestBodyphp php=php php$thisphp-php>php_fillTemplatephp(php$requestBodyphp,php arrayphp(
php php php php php php php php php php php php php'Updatedphp'php php php php php=php>php php$thisphp-php>isoDatephp(php)php,
php php php php php php php php php php php php php'Propertiesphp'php php=php>php php$thisphp-php>php_generateAzureRepresentationphp(php$entityphp)
php php php php php php php php php)php)php;

php php php php php php php php php/php/php Addphp headerphp information
php php php php php php php php php$headersphp php=php arrayphp(php)php;
php php php php php php php php php$headersphp[php'Contentphp-Typephp'php]php php=php php'applicationphp/atomphp+xmlphp'php;

php	php	php/php/php Performphp request
php	php php php php php$responsephp php=php nullphp;
php	php php php php ifphp php(php$thisphp-php>isInBatchphp(php)php)php php{
php	php	php php php php php$thisphp-php>getCurrentBatchphp(php)php-php>enlistOperationphp(php$tableNamephp,php php'php'php,php Zendphp_Httpphp_Clientphp:php:POSTphp,php php$headersphp,php truephp,php php$requestBodyphp)php;
php	php	php php php php returnphp nullphp;
php	php	php}php elsephp php{
php	php	php php php php php$responsephp php=php php$thisphp-php>php_performRequestphp(php$tableNamephp,php php'php'php,php Zendphp_Httpphp_Clientphp:php:POSTphp,php php$headersphp,php truephp,php php$requestBodyphp)php;
php	php	php}
php	php	ifphp php(php$responsephp-php>isSuccessfulphp(php)php)php php{
php	php	php php php php php/php/php Parsephp result
php	php	php php php php php$resultphp php=php php$thisphp-php>php_parseResponsephp(php$responsephp)php;
php	php	
php	php	php php php php php$timestampphp php=php php$resultphp-php>xpathphp(php'php/php/mphp:propertiesphp/dphp:Timestampphp'php)php;
php	php	php php php php php$timestampphp php=php php(stringphp)php$timestampphp[php0php]php;

php	php	php php php php php$etagphp php php php php php php=php php$resultphp-php>attributesphp(php'httpphp:php/php/schemasphp.microsoftphp.comphp/adophp/php2php0php0php7php/php0php8php/dataservicesphp/metadataphp'php)php;
php	php	php php php php php$etagphp php php php php php php=php php(stringphp)php$etagphp[php'etagphp'php]php;
php	php	
php	php	php php php php php/php/php Updatephp properties
php	php	php php php php php$entityphp-php>setTimestampphp(php$timestampphp)php;
php	php	php php php php php$entityphp-php>setEtagphp(php$etagphp)php;

php	php	php php php php returnphp php$entityphp;
php	php	php}php elsephp php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php$thisphp-php>php_getErrorMessagephp(php$responsephp,php php'Resourcephp couldphp notphp bephp accessedphp.php'php)php)php;
php	php	php}
php	php}
php	
php	php/php*php*
php	php php*php Deletephp entityphp fromphp table
php	php php*
php	php php*php php@paramphp stringphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$tableNamephp php php Tablephp name
php	php php*php php@paramphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp php$entityphp php php php php php Entityphp tophp delete
php	php php*php php@paramphp booleanphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$verifyEtagphp php Verifyphp etagphp ofphp thephp entityphp php(usedphp forphp concurrencyphp)
php	php php*php php@throwsphp Zendphp_Servicephp_WindowsAzurephp_Exception
php	php php*php/
php	publicphp functionphp deleteEntityphp(php$tableNamephp php=php php'php'php,php Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp php$entityphp php=php nullphp,php php$verifyEtagphp php=php falsephp)
php	php{
php	php	ifphp php(php$tableNamephp php=php=php=php php'php'php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Tablephp namephp isphp notphp specifiedphp.php'php)php;
php	php	php}
php	php	ifphp php(php$entityphp php=php=php=php nullphp)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Entityphp isphp notphp specifiedphp.php'php)php;
php	php	php}
php	php	
php php php php php php php php php/php/php Addphp headerphp information
php php php php php php php php php$headersphp php=php arrayphp(php)php;
php php php php php php php php ifphp php(php!php$thisphp-php>isInBatchphp(php)php)php php{
php php php php php php php php php php php php php/php/php httpphp:php/php/socialphp.msdnphp.microsoftphp.comphp/Forumsphp/enphp-USphp/windowsazurephp/threadphp/php9ephp2php5php5php4php4php7php-php4dcphp7php-php4php5php8aphp-php9php9dphp3php-bdcphp0php4bdcphp5php4php7php4php/
php php php php php php php php php php php php php$headersphp[php'Contentphp-Typephp'php]php php php php=php php'applicationphp/atomphp+xmlphp'php;
php php php php php php php php php}
php php php php php php php php php$headersphp[php'Contentphp-Lengthphp'php]php php=php php0php;
php php php php php php php php ifphp php(php!php$verifyEtagphp)php php{
php php php php php php php php php php php php php$headersphp[php'Ifphp-Matchphp'php]php php php php php php php php=php php'php*php'php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$headersphp[php'Ifphp-Matchphp'php]php php php php php php php php=php php$entityphp-php>getEtagphp(php)php;
php php php php php php php php php}

php	php	php/php/php Performphp request
php	php php php php php$responsephp php=php nullphp;
php	php php php php ifphp php(php$thisphp-php>isInBatchphp(php)php)php php{
php	php	php php php php php$thisphp-php>getCurrentBatchphp(php)php-php>enlistOperationphp(php$tableNamephp php.php php'php(PartitionKeyphp=php\php'php'php php.php php$entityphp-php>getPartitionKeyphp(php)php php.php php'php\php'php,php RowKeyphp=php\php'php'php php.php php$entityphp-php>getRowKeyphp(php)php php.php php'php\php'php)php'php,php php'php'php,php Zendphp_Httpphp_Clientphp:php:DELETEphp,php php$headersphp,php truephp,php nullphp)php;
php	php	php php php php returnphp nullphp;
php	php	php}php elsephp php{
php	php	php php php php php$responsephp php=php php$thisphp-php>php_performRequestphp(php$tableNamephp php.php php'php(PartitionKeyphp=php\php'php'php php.php php$entityphp-php>getPartitionKeyphp(php)php php.php php'php\php'php,php RowKeyphp=php\php'php'php php.php php$entityphp-php>getRowKeyphp(php)php php.php php'php\php'php)php'php,php php'php'php,php Zendphp_Httpphp_Clientphp:php:DELETEphp,php php$headersphp,php truephp,php nullphp)php;
php	php	php}
php	php	ifphp php(php!php$responsephp-php>isSuccessfulphp(php)php)php php{
php	php	php php php php throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php$thisphp-php>php_getErrorMessagephp(php$responsephp,php php'Resourcephp couldphp notphp bephp accessedphp.php'php)php)php;
php	php	php}
php	php}
php	
php	php/php*php*
php	php php*php Retrievephp entityphp fromphp tablephp,php byphp id
php	php php*
php	php php*php php@paramphp stringphp php$tableNamephp php php php Tablephp name
php	php php*php php@paramphp stringphp php$partitionKeyphp Partitionphp key
php	php php*php php@paramphp stringphp php$rowKeyphp php php php php php php Rowphp key
php	php php*php php@paramphp stringphp php$entityClassphp php Entityphp classphp namephp*
php	php php*php php@returnphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntity
php	php php*php php@throwsphp Zendphp_Servicephp_WindowsAzurephp_Exception
php	php php*php/
php	publicphp functionphp retrieveEntityByIdphp(php$tableNamephp php=php php'php'php,php php$partitionKeyphp php=php php'php'php,php php$rowKeyphp php=php php'php'php,php php$entityClassphp php=php php'Zendphp_Servicephp_WindowsAzurephp_Storagephp_DynamicTableEntityphp'php)
php	php{
php	php	ifphp php(php$tableNamephp php=php=php=php php'php'php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Tablephp namephp isphp notphp specifiedphp.php'php)php;
php	php	php}
php	php	ifphp php(php$partitionKeyphp php=php=php=php php'php'php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Partitionphp keyphp isphp notphp specifiedphp.php'php)php;
php	php	php}
php	php	ifphp php(php$rowKeyphp php=php=php=php php'php'php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Rowphp keyphp isphp notphp specifiedphp.php'php)php;
php	php	php}
php	php	ifphp php(php$entityClassphp php=php=php=php php'php'php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Entityphp classphp isphp notphp specifiedphp.php'php)php;
php	php	php}

php	php	php	
php	php	php/php/php Checkphp forphp combinedphp sizephp ofphp partitionphp keyphp andphp rowphp key
php	php	php/php/php httpphp:php/php/msdnphp.microsoftphp.comphp/enphp-usphp/libraryphp/ddphp1php7php9php4php2php1php.aspx
php	php	ifphp php(strlenphp(php$partitionKeyphp php.php php$rowKeyphp)php php>php=php php2php5php6php)php php{
php	php	php php php php php/php/php Startphp aphp batchphp ifphp possible
php	php	php php php php ifphp php(php$thisphp-php>isInBatchphp(php)php)php php{
php	php	php php php php php php php php throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Entityphp cannotphp bephp retrievedphp.php Aphp transactionphp isphp requiredphp tophp retrievephp thephp entityphp,php butphp anotherphp transactionphp isphp alreadyphp activephp.php'php)php;
php	php	php php php php php}
php	php	
php	php	php php php php php$thisphp-php>startBatchphp(php)php;
php	php	php}
php	php	
php	php	php/php/php Fetchphp entitiesphp fromphp Azure
php php php php php php php php php$resultphp php=php php$thisphp-php>retrieveEntitiesphp(
php php php php php php php php php php php php php$thisphp-php>selectphp(php)
php php php php php php php php php php php php php php php php php php-php>fromphp(php$tableNamephp)
php php php php php php php php php php php php php php php php php php-php>wherePartitionKeyphp(php$partitionKeyphp)
php php php php php php php php php php php php php php php php php php-php>whereRowKeyphp(php$rowKeyphp)php,
php php php php php php php php php php php php php'php'php,
php php php php php php php php php php php php php$entityClass
php php php php php php php php php)php;

php php php php php php php php php/php/php Return
php php php php php php php php ifphp php(countphp(php$resultphp)php php=php=php php1php)php php{
php php php php php php php php php php php php returnphp php$resultphp[php0php]php;
php php php php php php php php php}

php php php php php php php php returnphp nullphp;
php	php}
php	
php	php/php*php*
php	php php*php Createphp aphp newphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityQuery
php	php php*
php	php php*php php@returnphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityQuery
php	php php*php/
php	publicphp functionphp selectphp(php)
php	php{
php	php php php php returnphp newphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityQueryphp(php)php;
php	php}
php	
php	php/php*php*
php	php php*php Retrievephp entitiesphp fromphp table
php	php php*
php	php php*php php@paramphp stringphp php$tableNamephp|Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityQueryphp php php php Tablephp namephp php-orphp-php Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityQueryphp instance
php	php php*php php@paramphp stringphp php$filterphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php Filterphp conditionphp php(notphp appliedphp whenphp php$tableNamephp isphp aphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityQueryphp instancephp)
php	php php*php php@paramphp stringphp php$entityClassphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php Entityphp classphp name
php	php php*php php@paramphp stringphp php$nextPartitionKeyphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php Nextphp partitionphp keyphp,php usedphp forphp listingphp entitiesphp whenphp totalphp amountphp ofphp entitiesphp isphp php>php php1php0php0php0php.
php	php php*php php@paramphp stringphp php$nextRowKeyphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php Nextphp rowphp keyphp,php usedphp forphp listingphp entitiesphp whenphp totalphp amountphp ofphp entitiesphp isphp php>php php1php0php0php0php.
php	php php*php php@returnphp arrayphp Arrayphp ofphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntity
php	php php*php php@throwsphp Zendphp_Servicephp_WindowsAzurephp_Exception
php	php php*php/
php	publicphp functionphp retrieveEntitiesphp(php$tableNamephp php=php php'php'php,php php$filterphp php=php php'php'php,php php$entityClassphp php=php php'Zendphp_Servicephp_WindowsAzurephp_Storagephp_DynamicTableEntityphp'php,php php$nextPartitionKeyphp php=php nullphp,php php$nextRowKeyphp php=php nullphp)
php	php{
php	php	ifphp php(php$tableNamephp php=php=php=php php'php'php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Tablephp namephp isphp notphp specifiedphp.php'php)php;
php	php	php}
php	php	ifphp php(php$entityClassphp php=php=php=php php'php'php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Entityphp classphp isphp notphp specifiedphp.php'php)php;
php	php	php}

php	php	php/php/php Conveniencephp.php.php.
php	php	ifphp php(classphp_existsphp(php$filterphp)php)php php{
php	php	php php php php php$entityClassphp php=php php$filterphp;
php	php	php php php php php$filterphp php=php php'php'php;
php	php	php}
php	php	php	
php	php	php/php/php Queryphp string
php	php	php$queryStringphp php=php php'php'php;

php	php	php/php/php Determinephp query
php	php	ifphp php(isphp_stringphp(php$tableNamephp)php)php php{
php	php	php php php php php/php/php Optionphp php1php:php php$tableNamephp isphp aphp string
php	php	
php	php	php php php php php/php/php Appendphp parentheses
php	php	php php php php php$tableNamephp php.php=php php'php(php)php'php;
php	php	
php php php php php	php php php php php/php/php Buildphp query
php php php php php	php php php php php$queryphp php=php arrayphp(php)php;
php php php php php	
php php php php php	php	php/php/php Filterphp?
php php php php php	php	ifphp php(php$filterphp php!php=php=php php'php'php)php php{
php php php php php	php	php php php php php$queryphp[php]php php=php php'php$filterphp=php'php php.php Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityQueryphp:php:encodeQueryphp(php$filterphp)php;
php php php php php	php	php}
php php php php php	php	
php php php php php	php php php php php/php/php Buildphp queryString
php php php php php	php php php php ifphp php(countphp(php$queryphp)php php>php php0php)php php php{
php php php php php	php php php php php php php php php$queryStringphp php=php php'php?php'php php.php implodephp(php'php&php'php,php php$queryphp)php;
php php php php php	php php php php php}
php	php	php}php elsephp ifphp php(getphp_classphp(php$tableNamephp)php php=php=php php'Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityQueryphp'php)php php{
php	php	php php php php php/php/php Optionphp php2php:php php$tableNamephp isphp aphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityQueryphp instance

php	php	php php php php php/php/php Buildphp queryString
php	php	php php php php php$queryStringphp php=php php$tableNamephp-php>assembleQueryStringphp(truephp)php;

php	php	php php php php php/php/php Changephp php$tableName
php	php	php php php php php$tableNamephp php=php php$tableNamephp-php>assembleFromphp(truephp)php;
php	php	php}php elsephp php{
php	php	php php php php throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Invalidphp argumentphp:php php$tableNamephp'php)php;
php	php	php}
php	php	
php	php	php/php/php Addphp continuationphp querystringphp parametersphp?
php	php	ifphp php(php$nextPartitionKeyphp php!php=php=php nullphp php&php&php php$nextRowKeyphp php!php=php=php nullphp)php php{
php	php	php php php php ifphp php(php$queryStringphp php!php=php=php php'php'php)php php{
php	php	php php php php php php php php php$queryStringphp php.php=php php'php&php'php;
php	php	php php php php php}
php	php	
php	php	php php php php php$queryStringphp php.php=php php'php&NextPartitionKeyphp=php'php php.php rawurlencodephp(php$nextPartitionKeyphp)php php.php php'php&NextRowKeyphp=php'php php.php rawurlencodephp(php$nextRowKeyphp)php;
php	php	php}

php	php	php/php/php Performphp request
php	php php php php php$responsephp php=php nullphp;
php	php php php php ifphp php(php$thisphp-php>isInBatchphp(php)php php&php&php php$thisphp-php>getCurrentBatchphp(php)php-php>getOperationCountphp(php)php php=php=php php0php)php php{
php	php	php php php php php$thisphp-php>getCurrentBatchphp(php)php-php>enlistOperationphp(php$tableNamephp,php php$queryStringphp,php Zendphp_Httpphp_Clientphp:php:GETphp,php arrayphp(php)php,php truephp,php nullphp)php;
php	php	php php php php php$responsephp php=php php$thisphp-php>getCurrentBatchphp(php)php-php>commitphp(php)php;
php	php	
php	php	php php php php php/php/php Getphp innerphp responsephp php(multipartphp)
php	php	php php php php php$innerResponsephp php=php php$responsephp-php>getBodyphp(php)php;
php	php	php php php php php$innerResponsephp php=php substrphp(php$innerResponsephp,php strposphp(php$innerResponsephp,php php'HTTPphp/php1php.php1php php2php0php0php OKphp'php)php)php;
php	php	php php php php php$innerResponsephp php=php substrphp(php$innerResponsephp,php php0php,php strposphp(php$innerResponsephp,php php'php-php-batchresponsephp'php)php)php;
php	php	php php php php php$responsephp php=php Zendphp_Httpphp_Responsephp:php:fromStringphp(php$innerResponsephp)php;
php	php	php}php elsephp php{
php	php	php php php php php$responsephp php=php php$thisphp-php>php_performRequestphp(php$tableNamephp,php php$queryStringphp,php Zendphp_Httpphp_Clientphp:php:GETphp,php arrayphp(php)php,php truephp,php nullphp)php;
php	php	php}

php	php	ifphp php(php$responsephp-php>isSuccessfulphp(php)php)php php{
php	php	php php php php php/php/php Parsephp result
php	php	php php php php php$resultphp php=php php$thisphp-php>php_parseResponsephp(php$responsephp)php;
php	php	php php php php ifphp php(php!php$resultphp)php php{
php	php	php php php php php php php php returnphp arrayphp(php)php;
php	php	php php php php php}

php	php	php php php php php$entriesphp php=php nullphp;
php	php	php php php php ifphp php(php$resultphp-php>entryphp)php php{
php php php php php	php	php php php php ifphp php(countphp(php$resultphp-php>entryphp)php php>php php1php)php php{
php php php php php	php	php php php php php php php php php$entriesphp php=php php$resultphp-php>entryphp;
php php php php php	php	php php php php php}php elsephp php{
php php php php php	php	php php php php php php php php php$entriesphp php=php arrayphp(php$resultphp-php>entryphp)php;
php php php php php	php	php php php php php}
php	php	php php php php php}php elsephp php{
php	php	php php php php php php php php php/php/php Thisphp onephp isphp trickyphp.php.php.php Ifphp wephp havephp propertiesphp definedphp,php wephp havephp anphp entityphp.
php	php	php php php php php php php php php$propertiesphp php=php php$resultphp-php>xpathphp(php'php/php/mphp:propertiesphp'php)php;
php	php	php php php php php php php php ifphp php(php$propertiesphp)php php{
php	php	php php php php php php php php php php php php php$entriesphp php=php arrayphp(php$resultphp)php;
php	php	php php php php php php php php php}php elsephp php{
php	php	php php php php php php php php php php php php returnphp arrayphp(php)php;
php	php	php php php php php php php php php}
php	php	php php php php php}

php	php	php php php php php/php/php Createphp returnphp value
php	php	php php php php php$returnValuephp php=php arrayphp(php)php;php	php	
php	php	php php php php foreachphp php(php$entriesphp asphp php$entryphp)php php{
php php php php php	php	php php php php php/php/php Parsephp properties
php php php php php	php	php php php php php$propertiesphp php=php php$entryphp-php>xpathphp(php'php.php/php/mphp:propertiesphp'php)php;
php php php php php	php	php php php php php$propertiesphp php=php php$propertiesphp[php0php]php-php>childrenphp(php'httpphp:php/php/schemasphp.microsoftphp.comphp/adophp/php2php0php0php7php/php0php8php/dataservicesphp'php)php;
php php php php php	php	
php php php php php	php	php php php php php/php/php Createphp entity
php php php php php	php	php php php php php$entityphp php=php newphp php$entityClassphp(php'php'php,php php'php'php)php;
php php php php php	php	php php php php php$entityphp-php>setAzureValuesphp(php(arrayphp)php$propertiesphp,php truephp)php;
php php php php php	php	
php php php php php	php	php php php php php/php/php Ifphp wephp havephp aphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_DynamicTableEntityphp,php makephp surephp allphp propertyphp typesphp arephp OK
php php php php php	php	php php php php ifphp php(php$entityphp instanceofphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_DynamicTableEntityphp)php php{
php php php php php	php	php php php php php php php php foreachphp php(php$propertiesphp asphp php$keyphp php=php>php php$valuephp)php php{
php php php php php	php	php php php php php php php php php php php php php$attributesphp php=php php$valuephp-php>attributesphp(php'httpphp:php/php/schemasphp.microsoftphp.comphp/adophp/php2php0php0php7php/php0php8php/dataservicesphp/metadataphp'php)php;
php php php php php	php	php php php php php php php php php php php php php$typephp php=php php(stringphp)php$attributesphp[php'typephp'php]php;
php php php php php	php	php php php php php php php php php php php php ifphp php(php$typephp php!php=php=php php'php'php)php php{
php php php php php	php	php php php php php php php php php php php php php php php php php$entityphp-php>setAzurePropertyTypephp(php$keyphp,php php$typephp)php;
php php php php php	php	php php php php php php php php php php php php php}
php php php php php	php	php php php php php php php php php}
php php php php php	php	php php php php php}

php php php php php	php	php php php php php/php/php Updatephp etag
php php php php php	php	php php php php php$etagphp php php php php php php=php php$entryphp-php>attributesphp(php'httpphp:php/php/schemasphp.microsoftphp.comphp/adophp/php2php0php0php7php/php0php8php/dataservicesphp/metadataphp'php)php;
php php php php php	php	php php php php php$etagphp php php php php php php=php php(stringphp)php$etagphp[php'etagphp'php]php;
php php php php php	php	php php php php php$entityphp-php>setEtagphp(php$etagphp)php;
php php php php php	php	
php php php php php	php	php php php php php/php/php Addphp tophp result
php php php php php	php	php php php php php$returnValuephp[php]php php=php php$entityphp;
php	php	php php php php php}

php	php	php	php/php/php Morephp entitiesphp?
php	php	php php php php ifphp php(php$responsephp-php>getHeaderphp(php'xphp-msphp-continuationphp-NextPartitionKeyphp'php)php php!php=php=php nullphp php&php&php php$responsephp-php>getHeaderphp(php'xphp-msphp-continuationphp-NextRowKeyphp'php)php php!php=php=php nullphp)php php{
php	php	php php php php php php php php ifphp php(strposphp(php$queryStringphp,php php'php$topphp'php)php php=php=php=php falsephp)php php{
php	php	php php php php php php php php php php php php php$returnValuephp php=php arrayphp_mergephp(php$returnValuephp,php php$thisphp-php>retrieveEntitiesphp(php$tableNamephp,php php$filterphp,php php$entityClassphp,php php$responsephp-php>getHeaderphp(php'xphp-msphp-continuationphp-NextPartitionKeyphp'php)php,php php$responsephp-php>getHeaderphp(php'xphp-msphp-continuationphp-NextRowKeyphp'php)php)php)php;
php	php	php php php php php php php php php}
php	php	php php php php php}
php	php	
php	php	php php php php php/php/php Return
php	php	php php php php returnphp php$returnValuephp;
php	php	php}php elsephp php{
php	php	php php php php throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php$thisphp-php>php_getErrorMessagephp(php$responsephp,php php'Resourcephp couldphp notphp bephp accessedphp.php'php)php)php;
php	php	php}
php	php}
php	
php	php/php*php*
php	php php*php Updatephp entityphp byphp replacingphp it
php	php php*
php	php php*php php@paramphp stringphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$tableNamephp php php Tablephp name
php	php php*php php@paramphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp php$entityphp php php php php php Entityphp tophp update
php	php php*php php@paramphp booleanphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$verifyEtagphp php Verifyphp etagphp ofphp thephp entityphp php(usedphp forphp concurrencyphp)
php	php php*php php@throwsphp Zendphp_Servicephp_WindowsAzurephp_Exception
php	php php*php/
php	publicphp functionphp updateEntityphp(php$tableNamephp php=php php'php'php,php Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp php$entityphp php=php nullphp,php php$verifyEtagphp php=php falsephp)
php	php{
php	php php php php returnphp php$thisphp-php>php_changeEntityphp(Zendphp_Httpphp_Clientphp:php:PUTphp,php php$tableNamephp,php php$entityphp,php php$verifyEtagphp)php;
php	php}
php	
php	php/php*php*
php	php php*php Updatephp entityphp byphp addingphp orphp updatingphp properties
php	php php*
php	php php*php php@paramphp stringphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$tableNamephp php php Tablephp name
php	php php*php php@paramphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp php$entityphp php php php php php Entityphp tophp update
php	php php*php php@paramphp booleanphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$verifyEtagphp php Verifyphp etagphp ofphp thephp entityphp php(usedphp forphp concurrencyphp)
php	php php*php php@paramphp arrayphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$propertiesphp php Propertiesphp tophp mergephp.php Allphp propertiesphp willphp bephp usedphp whenphp omittedphp.
php	php php*php php@throwsphp Zendphp_Servicephp_WindowsAzurephp_Exception
php	php php*php/
php	publicphp functionphp mergeEntityphp(php$tableNamephp php=php php'php'php,php Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp php$entityphp php=php nullphp,php php$verifyEtagphp php=php falsephp,php php$propertiesphp php=php arrayphp(php)php)
php	php{
php	php	php$mergeEntityphp php=php nullphp;
php	php	ifphp php(isphp_arrayphp(php$propertiesphp)php php&php&php countphp(php$propertiesphp)php php>php php0php)php php{
php	php	php	php/php/php Buildphp aphp newphp object
php	php	php	php$mergeEntityphp php=php newphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_DynamicTableEntityphp(php$entityphp-php>getPartitionKeyphp(php)php,php php$entityphp-php>getRowKeyphp(php)php)php;
php	php	php	
php	php	php	php/php/php Keepphp onlyphp valuesphp mentionedphp inphp php$properties
php	php	php	php$azureValuesphp php=php php$entityphp-php>getAzureValuesphp(php)php;
php	php	php	foreachphp php(php$azureValuesphp asphp php$keyphp php=php>php php$valuephp)php php{
php	php	php	php	ifphp php(inphp_arrayphp(php$valuephp-php>Namephp,php php$propertiesphp)php)php php{
php	php	php	php	php	php$mergeEntityphp-php>setAzurePropertyphp(php$valuephp-php>Namephp,php php$valuephp-php>Valuephp,php php$valuephp-php>Typephp)php;
php	php	php	php	php}
php	php	php	php}
php	php	php}php elsephp php{
php	php	php	php$mergeEntityphp php=php php$entityphp;
php	php	php}

php php php php php php php php php/php/php Ensurephp entityphp timestampphp matchesphp updatedphp timestamp
php php php php php php php php php$entityphp-php>setTimestampphp(php$thisphp-php>isoDatephp(php)php)php;
php	php	
php	php php php php returnphp php$thisphp-php>php_changeEntityphp(Zendphp_Httpphp_Clientphp:php:MERGEphp,php php$tableNamephp,php php$mergeEntityphp,php php$verifyEtagphp)php;
php	php}
php	
php	php/php*php*
php	php php*php Getphp errorphp messagephp fromphp Zendphp_Httpphp_Response
php	php php*
php	php php*php php@paramphp Zendphp_Httpphp_Responsephp php$responsephp Repsonse
php	php php*php php@paramphp stringphp php$alternativeErrorphp Alternativephp errorphp message
php	php php*php php@returnphp string
php	php php*php/
php	protectedphp functionphp php_getErrorMessagephp(Zendphp_Httpphp_Responsephp php$responsephp,php php$alternativeErrorphp php=php php'Unknownphp errorphp.php'php)
php	php{
php	php	php$responsephp php=php php$thisphp-php>php_parseResponsephp(php$responsephp)php;
php	php	ifphp php(php$responsephp php&php&php php$responsephp-php>messagephp)php php{
php	php	php php php php returnphp php(stringphp)php$responsephp-php>messagephp;
php	php	php}php elsephp php{
php	php	php php php php returnphp php$alternativeErrorphp;
php	php	php}
php	php}
php	
php	php/php*php*
php	php php*php Updatephp entityphp php/php mergephp entity
php	php php*
php	php php*php php@paramphp stringphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$httpVerbphp php php php HTTPphp verbphp tophp usephp php(PUTphp php=php updatephp,php MERGEphp php=php mergephp)
php	php php*php php@paramphp stringphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$tableNamephp php php Tablephp name
php	php php*php php@paramphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp php$entityphp php php php php php Entityphp tophp update
php	php php*php php@paramphp booleanphp php php php php php php php php php php php php php php php php php php php php php php php php php php php php php$verifyEtagphp php Verifyphp etagphp ofphp thephp entityphp php(usedphp forphp concurrencyphp)
php	php php*php php@throwsphp Zendphp_Servicephp_WindowsAzurephp_Exception
php	php php*php/
php	protectedphp functionphp php_changeEntityphp(php$httpVerbphp php=php Zendphp_Httpphp_Clientphp:php:PUTphp,php php$tableNamephp php=php php'php'php,php Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp php$entityphp php=php nullphp,php php$verifyEtagphp php=php falsephp)
php	php{
php	php	ifphp php(php$tableNamephp php=php=php=php php'php'php)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Tablephp namephp isphp notphp specifiedphp.php'php)php;
php	php	php}
php	php	ifphp php(php$entityphp php=php=php=php nullphp)php php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php'Entityphp isphp notphp specifiedphp.php'php)php;
php	php	php}
php	php	
php php php php php php php php php/php/php Addphp headerphp information
php php php php php php php php php$headersphp php=php arrayphp(php)php;
php php php php php php php php php$headersphp[php'Contentphp-Typephp'php]php php php php=php php'applicationphp/atomphp+xmlphp'php;
php php php php php php php php php$headersphp[php'Contentphp-Lengthphp'php]php php=php php0php;
php php php php php php php php ifphp php(php!php$verifyEtagphp)php php{
php php php php php php php php php php php php php$headersphp[php'Ifphp-Matchphp'php]php php php php php php php php=php php'php*php'php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$headersphp[php'Ifphp-Matchphp'php]php php php php php php php php=php php$entityphp-php>getEtagphp(php)php;
php php php php php php php php php}

php php php php php php php php php/php/php Generatephp requestphp body
php php php php php php php php php$requestBodyphp php=php php'<php?xmlphp versionphp=php"php1php.php0php"php encodingphp=php"utfphp-php8php"php standalonephp=php"yesphp"php?php>
php php php php php php php php php php php php php php php php php php php php php php php php php<entryphp xmlnsphp:dphp=php"httpphp:php/php/schemasphp.microsoftphp.comphp/adophp/php2php0php0php7php/php0php8php/dataservicesphp"php xmlnsphp:mphp=php"httpphp:php/php/schemasphp.microsoftphp.comphp/adophp/php2php0php0php7php/php0php8php/dataservicesphp/metadataphp"php xmlnsphp=php"httpphp:php/php/wwwphp.wphp3php.orgphp/php2php0php0php5php/Atomphp"php>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<titlephp php/php>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<updatedphp>php{tplphp:Updatedphp}<php/updatedphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<authorphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php<namephp php/php>
php php php php php php php php php php php php php php php php php php php php php php php php php php <php/authorphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<idphp php/php>
php php php php php php php php php php php php php php php php php php php php php php php php php php php<contentphp typephp=php"applicationphp/xmlphp"php>
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php<mphp:propertiesphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php{tplphp:Propertiesphp}
php php php php php php php php php php php php php php php php php php php php php php php php php php php php <php/mphp:propertiesphp>
php php php php php php php php php php php php php php php php php php php php php php php php php php <php/contentphp>
php php php php php php php php php php php php php php php php php php php php php php php php <php/entryphp>php'php;
php php php php php php php php 
php php php php php php php php php/php/php Attemptphp tophp getphp timestampphp fromphp entity
php php php php php php php php php$timestampphp php=php php$entityphp-php>getTimestampphp(php)php;
php php php php php php php php ifphp php(php$timestampphp php=php=php Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp:php:DEFAULTphp_TIMESTAMPphp)php php{
php php php php php php php php php php php php php$timestampphp php=php php$thisphp-php>isoDatephp(php)php;
php php php php php php php php php}

php php php php php php php php php$requestBodyphp php=php php$thisphp-php>php_fillTemplatephp(php$requestBodyphp,php arrayphp(
php php php php php php php php php php php php php'Updatedphp'php php php php php=php>php php$timestampphp,
php php php php php php php php php php php php php'Propertiesphp'php php=php>php php$thisphp-php>php_generateAzureRepresentationphp(php$entityphp)
php php php php php php php php php)php)php;

php php php php php php php php php/php/php Addphp headerphp information
php php php php php php php php php$headersphp php=php arrayphp(php)php;
php php php php php php php php php$headersphp[php'Contentphp-Typephp'php]php php=php php'applicationphp/atomphp+xmlphp'php;
php php php php php php php php ifphp php(php!php$verifyEtagphp)php php{
php php php php php php php php php php php php php$headersphp[php'Ifphp-Matchphp'php]php php php php php php php php=php php'php*php'php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$headersphp[php'Ifphp-Matchphp'php]php php php php php php php php=php php$entityphp-php>getEtagphp(php)php;
php php php php php php php php php}

php	php	php/php/php Performphp request
php	php	php$responsephp php=php nullphp;
php	php php php php ifphp php(php$thisphp-php>isInBatchphp(php)php)php php{
php	php	php php php php php$thisphp-php>getCurrentBatchphp(php)php-php>enlistOperationphp(php$tableNamephp php.php php'php(PartitionKeyphp=php\php'php'php php.php php$entityphp-php>getPartitionKeyphp(php)php php.php php'php\php'php,RowKeyphp=php\php'php'php php.php php$entityphp-php>getRowKeyphp(php)php php.php php'php\php'php)php'php,php php'php'php,php php$httpVerbphp,php php$headersphp,php truephp,php php$requestBodyphp)php;
php	php	php php php php returnphp nullphp;
php	php	php}php elsephp php{
php	php	php php php php php$responsephp php=php php$thisphp-php>php_performRequestphp(php$tableNamephp php.php php'php(PartitionKeyphp=php\php'php'php php.php php$entityphp-php>getPartitionKeyphp(php)php php.php php'php\php'php,RowKeyphp=php\php'php'php php.php php$entityphp-php>getRowKeyphp(php)php php.php php'php\php'php)php'php,php php'php'php,php php$httpVerbphp,php php$headersphp,php truephp,php php$requestBodyphp)php;
php	php	php}
php	php	ifphp php(php$responsephp-php>isSuccessfulphp(php)php)php php{
php	php	php php php php php/php/php Updatephp properties
php	php	php	php$entityphp-php>setEtagphp(php$responsephp-php>getHeaderphp(php'Etagphp'php)php)php;
php	php	php	php$entityphp-php>setTimestampphp(php$responsephp-php>getHeaderphp(php'Lastphp-modifiedphp'php)php)php;

php	php	php php php php returnphp php$entityphp;
php	php	php}php elsephp php{
php	php	php	throwphp newphp Zendphp_Servicephp_WindowsAzurephp_Exceptionphp(php$thisphp-php>php_getErrorMessagephp(php$responsephp,php php'Resourcephp couldphp notphp bephp accessedphp.php'php)php)php;
php	php	php}
php	php}
php	
php	php/php*php*
php	php php*php Generatephp RFCphp php1php1php2php3php compliantphp datephp string
php	php php*
php	php php*php php@returnphp string
php	php php*php/
php	protectedphp functionphp php_rfcDatephp(php)
php	php{
php	php php php php returnphp gmdatephp(php'Dphp,php dphp Mphp Yphp Hphp:iphp:sphp'php,php timephp(php)php)php php.php php'php GMTphp'php;php php/php/php RFCphp php1php1php2php3
php	php}
php	
php	php/php*php*
php	php php*php Fillphp textphp templatephp withphp variablesphp fromphp keyphp/valuephp array
php	php php*
php	php php*php php@paramphp stringphp php$templateTextphp Templatephp text
php	php php*php php@paramphp arrayphp php$variablesphp Arrayphp containingphp keyphp/valuephp pairs
php	php php*php php@returnphp string
php	php php*php/
php	protectedphp functionphp php_fillTemplatephp(php$templateTextphp,php php$variablesphp php=php arrayphp(php)php)
php	php{
php	php php php php foreachphp php(php$variablesphp asphp php$keyphp php=php>php php$valuephp)php php{
php	php php php php php php php php php$templateTextphp php=php strphp_replacephp(php'php{tplphp:php'php php.php php$keyphp php.php php'php}php'php,php php$valuephp,php php$templateTextphp)php;
php	php php php php php}
php	php php php php returnphp php$templateTextphp;
php	php}
php	
php	php/php*php*
php	php php*php Generatephp Azurephp representationphp fromphp entityphp php(createsphp atompubphp markupphp fromphp propertiesphp)
php	php php*
php	php php*php php@paramphp Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp php$entity
php	php php*php php@returnphp string
php	php php*php/
php	protectedphp functionphp php_generateAzureRepresentationphp(Zendphp_Servicephp_WindowsAzurephp_Storagephp_TableEntityphp php$entityphp php=php nullphp)
php	php{
php	php	php/php/php Generatephp Azurephp representationphp fromphp entity
php	php	php$azureRepresentationphp php=php arrayphp(php)php;
php	php	php$azureValuesphp php php php php php php php php php=php php$entityphp-php>getAzureValuesphp(php)php;
php	php	foreachphp php(php$azureValuesphp asphp php$azureValuephp)php php{
php	php	php php php php php$valuephp php=php arrayphp(php)php;
php	php	php php php php php$valuephp[php]php php=php php'php<dphp:php'php php.php php$azureValuephp-php>Namephp;
php	php	php php php php ifphp php(php$azureValuephp-php>Typephp php!php=php php'php'php)php php{
php	php	php php php php php php php php php$valuephp[php]php php=php php'php mphp:typephp=php"php'php php.php php$azureValuephp-php>Typephp php.php php'php"php'php;
php	php	php php php php php}
php	php	php php php php ifphp php(php$azureValuephp-php>Valuephp php=php=php=php nullphp)php php{
php	php	php php php php php php php php php$valuephp[php]php php=php php'php mphp:nullphp=php"truephp"php'php;
php	php	php php php php php}
php	php	php php php php php$valuephp[php]php php=php php'php>php'php;
php	php	
php	php	php php php php ifphp php(php$azureValuephp-php>Valuephp php!php=php=php nullphp)php php{
php	php	php php php php php php php php ifphp php(strtolowerphp(php$azureValuephp-php>Typephp)php php=php=php php'edmphp.booleanphp'php)php php{
php	php	php php php php php php php php php php php php php$valuephp[php]php php=php php(php$azureValuephp-php>Valuephp php=php=php truephp php?php php'php1php'php php:php php'php0php'php)php;
php	php	php php php php php php php php php}php elsephp php{
php	php	php php php php php php php php php php php php php$valuephp[php]php php=php htmlspecialcharsphp(php$azureValuephp-php>Valuephp)php;
php	php	php php php php php php php php php}
php	php	php php php php php}
php	php	
php	php	php php php php php$valuephp[php]php php=php php'<php/dphp:php'php php.php php$azureValuephp-php>Namephp php.php php'php>php'php;
php	php	php php php php php$azureRepresentationphp[php]php php=php implodephp(php'php'php,php php$valuephp)php;
php	php	php}

php	php	returnphp implodephp(php'php'php,php php$azureRepresentationphp)php;
php	php}
php	
php	php	php/php*php*
php	php php*php Performphp requestphp usingphp Zendphp_Httpphp_Clientphp channel
php	php php*
php	php php*php php@paramphp stringphp php$pathphp Path
php	php php*php php@paramphp stringphp php$queryStringphp Queryphp string
php	php php*php php@paramphp stringphp php$httpVerbphp HTTPphp verbphp thephp requestphp willphp use
php	php php*php php@paramphp arrayphp php$headersphp xphp-msphp headersphp tophp add
php	php php*php php@paramphp booleanphp php$forTableStoragephp Isphp thephp requestphp forphp tablephp storagephp?
php	php php*php php@paramphp mixedphp php$rawDataphp Optionalphp RAWphp HTTPphp dataphp tophp bephp sentphp overphp thephp wire
php	php php*php php@paramphp stringphp php$resourceTypephp Resourcephp type
php	php php*php php@paramphp stringphp php$requiredPermissionphp Requiredphp permission
php	php php*php php@returnphp Zendphp_Httpphp_Response
php	php php*php/
php	protectedphp functionphp php_performRequestphp(
php	php	php$pathphp php=php php'php/php'php,
php	php	php$queryStringphp php=php php'php'php,
php	php	php$httpVerbphp php=php Zendphp_Httpphp_Clientphp:php:GETphp,
php	php	php$headersphp php=php arrayphp(php)php,
php	php	php$forTableStoragephp php=php falsephp,
php	php	php$rawDataphp php=php nullphp,
php	php	php$resourceTypephp php=php Zendphp_Servicephp_WindowsAzurephp_Storagephp:php:RESOURCEphp_UNKNOWNphp,
php	php	php$requiredPermissionphp php=php Zendphp_Servicephp_WindowsAzurephp_Credentialsphp_CredentialsAbstractphp:php:PERMISSIONphp_READ
php	php)php php{
php	php	php/php/php Addphp headers
php	php	php$headersphp[php'DataServiceVersionphp'php]php php=php php'php1php.php0php;NetFxphp'php;
php	php	php$headersphp[php'MaxDataServiceVersionphp'php]php php=php php'php1php.php0php;NetFxphp'php;

php	php	php/php/php Performphp request
php	php	returnphp parentphp:php:php_performRequestphp(
php	php	php	php$pathphp,
php	php	php	php$queryStringphp,
php	php	php	php$httpVerbphp,
php	php	php	php$headersphp,
php	php	php	php$forTableStoragephp,
php	php	php	php$rawDataphp,
php	php	php	php$resourceTypephp,
php	php	php	php$requiredPermission
php	php	php)php;
php	php}
php}
