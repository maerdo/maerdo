<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Servicephp_Amazon
php php*php php@subpackagephp Ecphp2
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Instancephp.phpphp php2php2php0php4php6php php2php0php1php0php-php0php4php-php2php8php php2php2php:php1php2php:php3php2Zphp shaharphp php$
php php*php/

php/php*php*
php php*php php@seephp Zendphp_Servicephp_Amazonphp_Ecphp2php_Abstract
php php*php/
requirephp_oncephp php'Zendphp/Servicephp/Amazonphp/Ecphp2php/Abstractphp.phpphp'php;

php/php*php*
php php*php Anphp Amazonphp ECphp2php interfacephp thatphp allowsphp youtphp tophp runphp,php terminatephp,php rebootphp andphp describephp Amazon
php php*php Ecphp2php Instancesphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Servicephp_Amazon
php php*php php@subpackagephp Ecphp2
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_Servicephp_Amazonphp_Ecphp2php_Instancephp extendsphp Zendphp_Servicephp_Amazonphp_Ecphp2php_Abstract
php{
php php php php php/php*php*
php php php php php php*php Constantphp forphp Smallphp Instancephp TYpe
php php php php php php*php/
php php php php constphp SMALLphp php=php php'mphp1php.smallphp'php;

php php php php php/php*php*
php php php php php php*php Constantphp forphp Largephp Instancephp TYpe
php php php php php php*php/
php php php php constphp LARGEphp php=php php'mphp1php.largephp'php;

php php php php php/php*php*
php php php php php php*php Constantphp forphp Xphp-Largephp Instancephp TYpe
php php php php php php*php/
php php php php constphp XLARGEphp php=php php'mphp1php.xlargephp'php;

php php php php php/php*php*
php php php php php php*php Constantphp forphp Highphp CPUphp Mediumphp Instancephp TYpe
php php php php php php*php/
php php php php constphp HCPUphp_MEDIUMphp php=php php'cphp1php.mediumphp'php;

php php php php php/php*php*
php php php php php php*php Constantphp forphp Highphp CPUphp Xphp-Largephp Instancephp TYpe
php php php php php php*php/
php php php php constphp HCPUphp_XLARGEphp php=php php'cphp1php.xlargephp'php;


php php php php php/php*php*
php php php php php php*php Launchesphp aphp specifiedphp numberphp ofphp Instancesphp.
php php php php php php*
php php php php php php*php Ifphp Amazonphp ECphp2php cannotphp launchphp thephp minimumphp numberphp AMIsphp youphp requestphp,php no
php php php php php php*php instancesphp launchphp.php Ifphp therephp isphp insufficientphp capacityphp tophp launchphp the
php php php php php php*php maximumphp numberphp ofphp AMIsphp youphp requestphp,php Amazonphp ECphp2php launchesphp asphp many
php php php php php php*php asphp possiblephp tophp satisfyphp thephp requestedphp maximumphp valuesphp.
php php php php php php*
php php php php php php*php Everyphp instancephp isphp launchedphp inphp aphp securityphp groupphp.php Ifphp youphp dophp notphp specify
php php php php php php*php aphp securityphp groupphp atphp launchphp,php thephp instancesphp startphp inphp yourphp defaultphp securityphp groupphp.
php php php php php php*php Forphp morephp informationphp onphp creatingphp securityphp groupsphp,php seephp CreateSecurityGroupphp.
php php php php php php*
php php php php php php*php Anphp optionalphp instancephp typephp canphp bephp specifiedphp.php Forphp information
php php php php php php*php aboutphp instancephp typesphp,php seephp Instancephp Typesphp.
php php php php php php*
php php php php php php*php Youphp canphp providephp anphp optionalphp keyphp pairphp IDphp forphp eachphp imagephp inphp thephp launchphp request
php php php php php php*php php(forphp morephp informationphp,php seephp CreateKeyPairphp)php.php Allphp instancesphp thatphp arephp created
php php php php php php*php fromphp imagesphp thatphp usephp thisphp keyphp pairphp willphp havephp accessphp tophp thephp associatedphp public
php php php php php php*php keyphp atphp bootphp.php Youphp canphp usephp thisphp keyphp tophp providephp securephp accessphp tophp anphp instancephp ofphp an
php php php php php php*php imagephp onphp aphp perphp-instancephp basisphp.php Amazonphp ECphp2php publicphp imagesphp usephp thisphp featurephp to
php php php php php php*php providephp securephp accessphp withoutphp passwordsphp.
php php php php php php*
php php php php php php*php Launchingphp publicphp imagesphp withoutphp aphp keyphp pairphp IDphp willphp leavephp themphp inaccessiblephp.
php php php php php php*
php php php php php php*php php@paramphp arrayphp php$optionsphp php php php php php php php php php php php php php php php php php php php php php php php Anphp arrayphp thatphp continsphp thephp optionsphp tophp startphp anphp instancephp.
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php Requiredphp Valuesphp:
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php imageIdphp stringphp php php php php php php php IDphp ofphp thephp AMIphp withphp whichphp tophp launchphp instancesphp.
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php Optionalphp Valuesphp:
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php minCountphp integerphp php php php php php Minimumphp numberphp ofphp instancesphp tophp launchphp.
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php maxCountphp integerphp php php php php php Maximumphp numberphp ofphp instancesphp tophp launchphp.
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php keyNamephp stringphp php php php php php php php Namephp ofphp thephp keyphp pairphp withphp whichphp tophp launchphp instancesphp.
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php securityGruopphp stringphp|arrayphp Namesphp ofphp thephp securityphp groupsphp withphp whichphp tophp associatephp thephp instancesphp.
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php userDataphp stringphp php php php php php php Thephp userphp dataphp availablephp tophp thephp launchedphp instancesphp.php Thisphp shouldphp notphp bephp Basephp6php4php encodedphp.
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php instanceTypephp constantphp Specifiesphp thephp instancephp typephp.
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php placementphp stringphp php php php php php Specifiesphp thephp availabilityphp zonephp inphp whichphp tophp launchphp thephp instancephp(sphp)php.php Byphp defaultphp,php Amazonphp ECphp2php selectsphp anphp availabilityphp zonephp forphp youphp.
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php kernelIdphp stringphp php php php php php php Thephp IDphp ofphp thephp kernelphp withphp whichphp tophp launchphp thephp instancephp.
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php ramdiskIdphp stringphp php php php php php Thephp IDphp ofphp thephp RAMphp diskphp withphp whichphp tophp launchphp thephp instancephp.
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php blockDeviceVirtualNamephp stringphp php php php php Specifiesphp thephp virtualphp namephp tophp mapphp tophp thephp correspondingphp devicephp namephp.php Forphp examplephp:php instancestorephp0
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php blockDeviceNamephp stringphp php php php php php php php php php php php Specifiesphp thephp devicephp tophp whichphp youphp arephp mappingphp aphp virtualphp namephp.php Forphp examplephp:php sdb
php php php php php php*php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php php monitorphp booleanphp php php php php php php php php php php php php php php Turnphp onphp CloudWatchphp Monitoringphp forphp anphp instancephp.
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp runphp(arrayphp php$optionsphp)
php php php php php{
php php php php php php php php php$php_defaultOptionsphp php=php arrayphp(
php php php php php php php php php php php php php'minCountphp'php php php=php>php php1php,
php php php php php php php php php php php php php'maxCountphp'php php php=php>php php1php,
php php php php php php php php php php php php php'instanceTypephp'php php=php>php Zendphp_Servicephp_Amazonphp_Ecphp2php_Instancephp:php:SMALL
php php php php php php php php php)php;

php php php php php php php php php/php/php setphp php/php overridephp thephp defualtphp optoinsphp ifphp theyphp arephp notphp passedphp intophp thephp arrayphp;
php php php php php php php php php$optionsphp php=php arrayphp_mergephp(php$php_defaultOptionsphp,php php$optionsphp)php;

php php php php php php php php ifphp(php!issetphp(php$optionsphp[php'imageIdphp'php]php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Servicephp/Amazonphp/Ecphp2php/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Servicephp_Amazonphp_Ecphp2php_Exceptionphp(php'Nophp Imagephp Idphp Providedphp'php)php;
php php php php php php php php php}


php php php php php php php php php$paramsphp php=php arrayphp(php)php;
php php php php php php php php php$paramsphp[php'Actionphp'php]php php=php php'RunInstancesphp'php;
php php php php php php php php php$paramsphp[php'ImageIdphp'php]php php=php php$optionsphp[php'imageIdphp'php]php;
php php php php php php php php php$paramsphp[php'MinCountphp'php]php php=php php$optionsphp[php'minCountphp'php]php;
php php php php php php php php php$paramsphp[php'MaxCountphp'php]php php=php php$optionsphp[php'maxCountphp'php]php;

php php php php php php php php ifphp(issetphp(php$optionsphp[php'keyNamephp'php]php)php)php php{
php php php php php php php php php php php php php$paramsphp[php'KeyNamephp'php]php php=php php$optionsphp[php'keyNamephp'php]php;
php php php php php php php php php}

php php php php php php php php ifphp(isphp_arrayphp(php$optionsphp[php'securityGroupphp'php]php)php php&php&php php!emptyphp(php$optionsphp[php'securityGroupphp'php]php)php)php php{
php php php php php php php php php php php php foreachphp(php$optionsphp[php'securityGroupphp'php]php asphp php$kphp=php>php$namephp)php php{
php php php php php php php php php php php php php php php php php$paramsphp[php'SecurityGroupphp.php'php php.php php(php$kphp+php1php)php]php php=php php$namephp;
php php php php php php php php php php php php php}
php php php php php php php php php}php elseifphp(issetphp(php$optionsphp[php'securityGroupphp'php]php)php)php php{
php php php php php php php php php php php php php$paramsphp[php'SecurityGroupphp.php1php'php]php php=php php$optionsphp[php'securityGroupphp'php]php;
php php php php php php php php php}

php php php php php php php php ifphp(issetphp(php$optionsphp[php'userDataphp'php]php)php)php php{
php php php php php php php php php php php php php$paramsphp[php'UserDataphp'php]php php=php basephp6php4php_encodephp(php$optionsphp[php'userDataphp'php]php)php;
php php php php php php php php php}

php php php php php php php php ifphp(issetphp(php$optionsphp[php'instanceTypephp'php]php)php)php php{
php php php php php php php php php php php php php$paramsphp[php'InstanceTypephp'php]php php=php php$optionsphp[php'instanceTypephp'php]php;
php php php php php php php php php}

php php php php php php php php ifphp(issetphp(php$optionsphp[php'placementphp'php]php)php)php php{
php php php php php php php php php php php php php$paramsphp[php'Placementphp.AvailabilityZonephp'php]php php=php php$optionsphp[php'placementphp'php]php;
php php php php php php php php php}

php php php php php php php php ifphp(issetphp(php$optionsphp[php'kernelIdphp'php]php)php)php php{
php php php php php php php php php php php php php$paramsphp[php'KernelIdphp'php]php php=php php$optionsphp[php'kernelIdphp'php]php;
php php php php php php php php php}

php php php php php php php php ifphp(issetphp(php$optionsphp[php'ramdiskIdphp'php]php)php)php php{
php php php php php php php php php php php php php$paramsphp[php'RamdiskIdphp'php]php php=php php$optionsphp[php'ramdiskIdphp'php]php;
php php php php php php php php php}

php php php php php php php php ifphp(issetphp(php$optionsphp[php'blockDeviceVirtualNamephp'php]php)php php&php&php issetphp(php$optionsphp[php'blockDeviceNamephp'php]php)php)php php{
php php php php php php php php php php php php php$paramsphp[php'BlockDeviceMappingphp.nphp.VirtualNamephp'php]php php=php php$optionsphp[php'blockDeviceVirtualNamephp'php]php;
php php php php php php php php php php php php php$paramsphp[php'BlockDeviceMappingphp.nphp.DeviceNamephp'php]php php=php php$optionsphp[php'blockDeviceNamephp'php]php;
php php php php php php php php php}

php php php php php php php php ifphp(issetphp(php$optionsphp[php'monitorphp'php]php)php php&php&php php$optionsphp[php'monitorphp'php]php php=php=php=php truephp)php php{
php php php php php php php php php php php php php$paramsphp[php'Monitoringphp.Enabledphp'php]php php=php truephp;
php php php php php php php php php}

php php php php php php php php php$responsephp php=php php$thisphp-php>sendRequestphp(php$paramsphp)php;
php php php php php php php php php$xpathphp php=php php$responsephp-php>getXPathphp(php)php;

php php php php php php php php php$returnphp php=php arrayphp(php)php;

php php php php php php php php php$returnphp[php'reservationIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(php/php/ecphp2php:reservationIdphp/textphp(php)php)php'php)php;
php php php php php php php php php$returnphp[php'ownerIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(php/php/ecphp2php:ownerIdphp/textphp(php)php)php'php)php;

php php php php php php php php php$gsphp php=php php$xpathphp-php>queryphp(php'php/php/ecphp2php:groupSetphp/ecphp2php:itemphp'php)php;
php php php php php php php php foreachphp(php$gsphp asphp php$gsphp_nodephp)php php{
php php php php php php php php php php php php php$returnphp[php'groupSetphp'php]php[php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:groupIdphp/textphp(php)php)php'php,php php$gsphp_nodephp)php;
php php php php php php php php php php php php unsetphp(php$gsphp_nodephp)php;
php php php php php php php php php}
php php php php php php php php unsetphp(php$gsphp)php;

php php php php php php php php php$isphp php=php php$xpathphp-php>queryphp(php'php/php/ecphp2php:instancesSetphp/ecphp2php:itemphp'php)php;
php php php php php php php php foreachphp(php$isphp asphp php$isphp_nodephp)php php{
php php php php php php php php php php php php php$itemphp php=php arrayphp(php)php;

php php php php php php php php php php php php php$itemphp[php'instanceIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:instanceIdphp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php$itemphp[php'imageIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:imageIdphp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php$itemphp[php'instanceStatephp'php]php[php'codephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:instanceStatephp/ecphp2php:codephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php$itemphp[php'instanceStatephp'php]php[php'namephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:instanceStatephp/ecphp2php:namephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php$itemphp[php'privateDnsNamephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:privateDnsNamephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php$itemphp[php'dnsNamephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:dnsNamephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php$itemphp[php'keyNamephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:keyNamephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php$itemphp[php'instanceTypephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:instanceTypephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php$itemphp[php'amiLaunchIndexphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:amiLaunchIndexphp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php$itemphp[php'launchTimephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:launchTimephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php$itemphp[php'availabilityZonephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:placementphp/ecphp2php:availabilityZonephp/textphp(php)php)php'php,php php$isphp_nodephp)php;

php php php php php php php php php php php php php$returnphp[php'instancesphp'php]php[php]php php=php php$itemphp;
php php php php php php php php php php php php unsetphp(php$itemphp)php;
php php php php php php php php php php php php unsetphp(php$isphp_nodephp)php;
php php php php php php php php php}
php php php php php php php php unsetphp(php$isphp)php;

php php php php php php php php returnphp php$returnphp;

php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp informationphp aboutphp instancesphp thatphp youphp ownphp.
php php php php php php*
php php php php php php*php Ifphp youphp specifyphp onephp orphp morephp instancephp IDsphp,php Amazonphp ECphp2php returnsphp information
php php php php php php*php forphp thosephp instancesphp.php Ifphp youphp dophp notphp specifyphp instancephp IDsphp,php Amazonphp ECphp2
php php php php php php*php returnsphp informationphp forphp allphp relevantphp instancesphp.php Ifphp youphp specifyphp anphp invalid
php php php php php php*php instancephp IDphp,php aphp faultphp isphp returnedphp.php Ifphp youphp specifyphp anphp instancephp thatphp youphp do
php php php php php php*php notphp ownphp,php itphp willphp notphp bephp includedphp inphp thephp returnedphp resultsphp.
php php php php php php*
php php php php php php*php Recentlyphp terminatedphp instancesphp mightphp appearphp inphp thephp returnedphp resultsphp.
php php php php php php*php Thisphp intervalphp isphp usuallyphp lessphp thanphp onephp hourphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp|arrayphp php$instaceIdphp php php php php php php Setphp ofphp instancesphp IDsphp ofphp whichphp tophp getphp thephp statusphp.
php php php php php php*php php@paramphp booleanphp php php php php php php php php php php php php php php php php php php php php php php Turephp tophp ignorephp Terminatedphp Instancesphp.
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp describephp(php$instanceIdphp php=php nullphp,php php$ignoreTerminatedphp php=php falsephp)
php php php php php{
php php php php php php php php php$paramsphp php=php arrayphp(php)php;
php php php php php php php php php$paramsphp[php'Actionphp'php]php php=php php'DescribeInstancesphp'php;

php php php php php php php php ifphp(isphp_arrayphp(php$instanceIdphp)php php&php&php php!emptyphp(php$instanceIdphp)php)php php{
php php php php php php php php php php php php foreachphp(php$instanceIdphp asphp php$kphp=php>php$namephp)php php{
php php php php php php php php php php php php php php php php php$paramsphp[php'InstanceIdphp.php'php php.php php(php$kphp+php1php)php]php php=php php$namephp;
php php php php php php php php php php php php php}
php php php php php php php php php}php elseifphp(php$instanceIdphp)php php{
php php php php php php php php php php php php php$paramsphp[php'InstanceIdphp.php1php'php]php php=php php$instanceIdphp;
php php php php php php php php php}

php php php php php php php php php$responsephp php=php php$thisphp-php>sendRequestphp(php$paramsphp)php;

php php php php php php php php php$xpathphp php=php php$responsephp-php>getXPathphp(php)php;

php php php php php php php php php$nodesphp php=php php$xpathphp-php>queryphp(php'php/php/ecphp2php:reservationSetphp/ecphp2php:itemphp'php)php;

php php php php php php php php php$returnphp php=php arrayphp(php)php;
php php php php php php php php php$returnphp[php'instancesphp'php]php php=php arrayphp(php)php;

php php php php php php php php foreachphp(php$nodesphp asphp php$nodephp)php php{
php php php php php php php php php php php php ifphp(php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:instancesSetphp/ecphp2php:itemphp/ecphp2php:instanceStatephp/ecphp2php:codephp/textphp(php)php)php'php,php php$nodephp)php php=php=php php4php8php php&php&php php$ignoreTerminatedphp)php continuephp;
php php php php php php php php php php php php php$itemphp php=php arrayphp(php)php;

php php php php php php php php php php php php php$itemphp[php'reservationIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:reservationIdphp/textphp(php)php)php'php,php php$nodephp)php;
php php php php php php php php php php php php php$itemphp[php'ownerIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:ownerIdphp/textphp(php)php)php'php,php php$nodephp)php;

php php php php php php php php php php php php php$gsphp php=php php$xpathphp-php>queryphp(php'ecphp2php:groupSetphp/ecphp2php:itemphp'php,php php$nodephp)php;
php php php php php php php php php php php php foreachphp(php$gsphp asphp php$gsphp_nodephp)php php{
php php php php php php php php php php php php php php php php php$itemphp[php'groupSetphp'php]php[php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:groupIdphp/textphp(php)php)php'php,php php$gsphp_nodephp)php;
php php php php php php php php php php php php php php php php unsetphp(php$gsphp_nodephp)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php unsetphp(php$gsphp)php;

php php php php php php php php php php php php php$isphp php=php php$xpathphp-php>queryphp(php'ecphp2php:instancesSetphp/ecphp2php:itemphp'php,php php$nodephp)php;

php php php php php php php php php php php php foreachphp(php$isphp asphp php$isphp_nodephp)php php{

php php php php php php php php php php php php php php php php php$itemphp[php'instanceIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:instanceIdphp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'imageIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:imageIdphp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'instanceStatephp'php]php[php'codephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:instanceStatephp/ecphp2php:codephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'instanceStatephp'php]php[php'namephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:instanceStatephp/ecphp2php:namephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'privateDnsNamephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:privateDnsNamephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'dnsNamephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:dnsNamephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'keyNamephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:keyNamephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'productCodephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:productCodesSetphp/ecphp2php:itemphp/ecphp2php:productCodephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'instanceTypephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:instanceTypephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'launchTimephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:launchTimephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'availabilityZonephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:placementphp/ecphp2php:availabilityZonephp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'kernelIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:kernelIdphp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'ramediskIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:ramediskIdphp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'amiLaunchIndexphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:amiLaunchIndexphp/textphp(php)php)php'php,php php$isphp_nodephp)php;
php php php php php php php php php php php php php php php php php$itemphp[php'monitoringStatephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:monitoringphp/ecphp2php:statephp/textphp(php)php)php'php,php php$isphp_nodephp)php;

php php php php php php php php php php php php php php php php php$returnphp[php'instancesphp'php]php[php]php php=php php$itemphp;
php php php php php php php php php php php php php php php php unsetphp(php$isphp_nodephp)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php unsetphp(php$itemphp)php;
php php php php php php php php php php php php unsetphp(php$isphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$returnphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp informationphp aboutphp instancesphp thatphp youphp ownphp thatphp werephp startedphp from
php php php php php php*php aphp specificphp imageId
php php php php php php*
php php php php php php*php Recentlyphp terminatedphp instancesphp mightphp appearphp inphp thephp returnedphp resultsphp.
php php php php php php*php Thisphp intervalphp isphp usuallyphp lessphp thanphp onephp hourphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$imageIdphp php php php php php php php php php php php php php php Thephp imageIdphp usedphp tophp startphp thephp Instancephp.
php php php php php php*php php@paramphp booleanphp php php php php php php php php php php php php php php php php php php php php php php Turephp tophp ignorephp Terminatedphp Instancesphp.
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp describeByImageIdphp(php$imageIdphp,php php$ignoreTerminatedphp php=php falsephp)
php php php php php{
php php php php php php php php php$arrInstancesphp php=php php$thisphp-php>describephp(nullphp,php php$ignoreTerminatedphp)php;

php php php php php php php php php$returnphp php=php arrayphp(php)php;

php php php php php php php php foreachphp(php$arrInstancesphp[php'instancesphp'php]php asphp php$instancephp)php php{
php php php php php php php php php php php php ifphp(php$instancephp[php'imageIdphp'php]php php!php=php=php php$imageIdphp)php continuephp;
php php php php php php php php php php php php php$returnphp[php]php php=php php$instancephp;
php php php php php php php php php}

php php php php php php php php returnphp php$returnphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Shutsphp downphp onephp orphp morephp instancesphp.php Thisphp operationphp isphp idempotentphp;php ifphp youphp terminate
php php php php php php*php anphp instancephp morephp thanphp oncephp,php eachphp callphp willphp succeedphp.
php php php php php php*
php php php php php php*php Terminatedphp instancesphp willphp remainphp visiblephp afterphp terminationphp php(approximatelyphp onephp hourphp)php.
php php php php php php*
php php php php php php*php php@paramphp stringphp|arrayphp php$instanceIdphp php php php php php Onephp orphp morephp instancephp IDsphp returnedphp.
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp terminatephp(php$instanceIdphp)
php php php php php{
php php php php php php php php php$paramsphp php=php arrayphp(php)php;
php php php php php php php php php$paramsphp[php'Actionphp'php]php php=php php'TerminateInstancesphp'php;

php php php php php php php php ifphp(isphp_arrayphp(php$instanceIdphp)php php&php&php php!emptyphp(php$instanceIdphp)php)php php{
php php php php php php php php php php php php foreachphp(php$instanceIdphp asphp php$kphp=php>php$namephp)php php{
php php php php php php php php php php php php php php php php php$paramsphp[php'InstanceIdphp.php'php php.php php(php$kphp+php1php)php]php php=php php$namephp;
php php php php php php php php php php php php php}
php php php php php php php php php}php elseifphp(php$instanceIdphp)php php{
php php php php php php php php php php php php php$paramsphp[php'InstanceIdphp.php1php'php]php php=php php$instanceIdphp;
php php php php php php php php php}

php php php php php php php php php$responsephp php=php php$thisphp-php>sendRequestphp(php$paramsphp)php;
php php php php php php php php php$xpathphp php=php php$responsephp-php>getXPathphp(php)php;

php php php php php php php php php$nodesphp php=php php$xpathphp-php>queryphp(php'php/php/ecphp2php:instancesSetphp/ecphp2php:itemphp'php)php;

php php php php php php php php php$returnphp php=php arrayphp(php)php;
php php php php php php php php foreachphp(php$nodesphp asphp php$nodephp)php php{
php php php php php php php php php php php php php$itemphp php=php arrayphp(php)php;

php php php php php php php php php php php php php$itemphp[php'instanceIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:instanceIdphp/textphp(php)php)php'php,php php$nodephp)php;
php php php php php php php php php php php php php$itemphp[php'shutdownStatephp'php]php[php'codephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:shutdownStatephp/ecphp2php:codephp/textphp(php)php)php'php,php php$nodephp)php;
php php php php php php php php php php php php php$itemphp[php'shutdownStatephp'php]php[php'namephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:shutdownStatephp/ecphp2php:namephp/textphp(php)php)php'php,php php$nodephp)php;
php php php php php php php php php php php php php$itemphp[php'previousStatephp'php]php[php'codephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:previousStatephp/ecphp2php:codephp/textphp(php)php)php'php,php php$nodephp)php;
php php php php php php php php php php php php php$itemphp[php'previousStatephp'php]php[php'namephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(ecphp2php:previousStatephp/ecphp2php:namephp/textphp(php)php)php'php,php php$nodephp)php;

php php php php php php php php php php php php php$returnphp[php]php php=php php$itemphp;
php php php php php php php php php php php php unsetphp(php$itemphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$returnphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Requestsphp aphp rebootphp ofphp onephp orphp morephp instancesphp.
php php php php php php*
php php php php php php*php Thisphp operationphp isphp asynchronousphp;php itphp onlyphp queuesphp aphp requestphp tophp rebootphp thephp specifiedphp instancephp(sphp)php.php Thephp operation
php php php php php php*php willphp succeedphp ifphp thephp instancesphp arephp validphp andphp belongphp tophp thephp userphp.php Requestsphp tophp rebootphp terminatedphp instancesphp arephp ignoredphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp|arrayphp php$instanceIdphp php Onephp orphp morephp instancephp IDsphp.
php php php php php php*php php@returnphp boolean
php php php php php php*php/
php php php php publicphp functionphp rebootphp(php$instanceIdphp)
php php php php php{
php php php php php php php php php$paramsphp php=php arrayphp(php)php;
php php php php php php php php php$paramsphp[php'Actionphp'php]php php=php php'RebootInstancesphp'php;

php php php php php php php php ifphp(isphp_arrayphp(php$instanceIdphp)php php&php&php php!emptyphp(php$instanceIdphp)php)php php{
php php php php php php php php php php php php foreachphp(php$instanceIdphp asphp php$kphp=php>php$namephp)php php{
php php php php php php php php php php php php php php php php php$paramsphp[php'InstanceIdphp.php'php php.php php(php$kphp+php1php)php]php php=php php$namephp;
php php php php php php php php php php php php php}
php php php php php php php php php}php elseifphp(php$instanceIdphp)php php{
php php php php php php php php php php php php php$paramsphp[php'InstanceIdphp.php1php'php]php php=php php$instanceIdphp;
php php php php php php php php php}

php php php php php php php php php$responsephp php=php php$thisphp-php>sendRequestphp(php$paramsphp)php;
php php php php php php php php php$xpathphp php=php php$responsephp-php>getXPathphp(php)php;

php php php php php php php php php$returnphp php=php php$xpathphp-php>evaluatephp(php'stringphp(php/php/ecphp2php:returnphp/textphp(php)php)php'php)php;

php php php php php php php php returnphp php(php$returnphp php=php=php=php php"truephp"php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievesphp consolephp outputphp forphp thephp specifiedphp instancephp.
php php php php php php*
php php php php php php*php Instancephp consolephp outputphp isphp bufferedphp andphp postedphp shortlyphp afterphp instancephp bootphp,php rebootphp,php andphp terminationphp.
php php php php php php*php Amazonphp ECphp2php preservesphp thephp mostphp recentphp php6php4php KBphp outputphp whichphp willphp bephp availablephp forphp atphp leastphp onephp hourphp afterphp thephp mostphp recentphp postphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$instanceIdphp php php php php php php Anphp instancephp ID
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp consoleOutputphp(php$instanceIdphp)
php php php php php{
php php php php php php php php php$paramsphp php=php arrayphp(php)php;
php php php php php php php php php$paramsphp[php'Actionphp'php]php php=php php'GetConsoleOutputphp'php;
php php php php php php php php php$paramsphp[php'InstanceIdphp'php]php php=php php$instanceIdphp;

php php php php php php php php php$responsephp php=php php$thisphp-php>sendRequestphp(php$paramsphp)php;
php php php php php php php php php$xpathphp php=php php$responsephp-php>getXPathphp(php)php;

php php php php php php php php php$returnphp php=php arrayphp(php)php;

php php php php php php php php php$returnphp[php'instanceIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(php/php/ecphp2php:instanceIdphp/textphp(php)php)php'php)php;
php php php php php php php php php$returnphp[php'timestampphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(php/php/ecphp2php:timestampphp/textphp(php)php)php'php)php;
php php php php php php php php php$returnphp[php'outputphp'php]php php=php basephp6php4php_decodephp(php$xpathphp-php>evaluatephp(php'stringphp(php/php/ecphp2php:outputphp/textphp(php)php)php'php)php)php;

php php php php php php php php returnphp php$returnphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp truephp ifphp thephp specifiedphp productphp codephp isphp attachedphp tophp thephp specifiedphp instancephp.
php php php php php php*php Thephp operationphp returnsphp falsephp ifphp thephp productphp codephp isphp notphp attachedphp tophp thephp instancephp.
php php php php php php*
php php php php php php*php Thephp confirmProductphp operationphp canphp onlyphp bephp executedphp byphp thephp ownerphp ofphp thephp AMIphp.
php php php php php php*php Thisphp featurephp isphp usefulphp whenphp anphp AMIphp ownerphp isphp providingphp supportphp andphp wantsphp to
php php php php php php*php verifyphp whetherphp aphp userphp'sphp instancephp isphp eligiblephp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$productCodephp php php php php php php php php php php Thephp productphp codephp tophp confirmphp.
php php php php php php*php php@paramphp stringphp php$instanceIdphp php php php php php php php php php php php Thephp instancephp forphp whichphp tophp confirmphp thephp productphp codephp.
php php php php php php*php php@returnphp arrayphp|booleanphp php php php php php php php php php php php php php php php Anphp arrayphp ifphp thephp productphp codephp isphp attachedphp tophp thephp instancephp,php falsephp ifphp itphp isphp notphp.
php php php php php php*php/
php php php php publicphp functionphp confirmProductphp(php$productCodephp,php php$instanceIdphp)
php php php php php{
php php php php php php php php php$paramsphp php=php arrayphp(php)php;
php php php php php php php php php$paramsphp[php'Actionphp'php]php php=php php'ConfirmProductInstancephp'php;
php php php php php php php php php$paramsphp[php'ProductCodephp'php]php php=php php$productCodephp;
php php php php php php php php php$paramsphp[php'InstanceIdphp'php]php php=php php$instanceIdphp;

php php php php php php php php php$responsephp php=php php$thisphp-php>sendRequestphp(php$paramsphp)php;
php php php php php php php php php$xpathphp php=php php$responsephp-php>getXPathphp(php)php;

php php php php php php php php php$resultphp php=php php$xpathphp-php>evaluatephp(php'stringphp(php/php/ecphp2php:resultphp/textphp(php)php)php'php)php;

php php php php php php php php ifphp(php$resultphp php=php=php=php php"truephp"php)php php{
php php php php php php php php php php php php php$returnphp[php'resultphp'php]php php=php truephp;
php php php php php php php php php php php php php$returnphp[php'ownerIdphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(php/php/ecphp2php:ownerIdphp/textphp(php)php)php'php)php;

php php php php php php php php php php php php returnphp php$returnphp;
php php php php php php php php php}

php php php php php php php php returnphp falsephp;
php php php php php}

php php php php php/php*php*
php php php php php*php Turnphp onphp Amazonphp CloudWatchphp Monitoringphp forphp anphp instancephp orphp aphp listphp ofphp instances
php php php php php*
php php php php php*php php@paramphp arrayphp|stringphp php$instanceIdphp php php php php php php php php php php Thephp instancephp orphp listphp ofphp instancesphp youphp wantphp tophp enablephp monitoringphp for
php php php php php*php php@returnphp array
php php php php php*php/
php php php php publicphp functionphp monitorphp(php$instanceIdphp)
php php php php php{
php php php php php php php php php$paramsphp php=php arrayphp(php)php;
php php php php php php php php php$paramsphp[php'Actionphp'php]php php=php php'MonitorInstancesphp'php;

php php php php php php php php ifphp(isphp_arrayphp(php$instanceIdphp)php php&php&php php!emptyphp(php$instanceIdphp)php)php php{
php php php php php php php php php php php php foreachphp(php$instanceIdphp asphp php$kphp=php>php$namephp)php php{
php php php php php php php php php php php php php php php php php$paramsphp[php'InstanceIdphp.php'php php.php php(php$kphp+php1php)php]php php=php php$namephp;
php php php php php php php php php php php php php}
php php php php php php php php php}php elseifphp(php$instanceIdphp)php php{
php php php php php php php php php php php php php$paramsphp[php'InstanceIdphp.php1php'php]php php=php php$instanceIdphp;
php php php php php php php php php}

php php php php php php php php php$responsephp php=php php$thisphp-php>sendRequestphp(php$paramsphp)php;
php php php php php php php php php$xpathphp php=php php$responsephp-php>getXPathphp(php)php;


php php php php php php php php php$itemsphp php=php php$xpathphp-php>queryphp(php'php/php/ecphp2php:instancesSetphp/ecphp2php:itemphp'php)php;

php php php php php php php php php$arrReturnphp php=php arrayphp(php)php;
php php php php php php php php foreachphp(php$itemsphp asphp php$itemphp)php php{
php php php php php php php php php php php php php$iphp php=php arrayphp(php)php;
php php php php php php php php php php php php php$iphp[php'instanceidphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(php/php/ecphp2php:instanceIdphp/textphp(php)php)php'php,php php$itemphp)php;
php php php php php php php php php php php php php$iphp[php'monitorstatephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(php/php/ecphp2php:monitoringphp/ecphp2php:statephp/textphp(php)php)php'php)php;
php php php php php php php php php php php php php$arrReturnphp[php]php php=php php$iphp;
php php php php php php php php php php php php unsetphp(php$iphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$arrReturnphp;
php php php php php}
php php php php php/php*php*
php php php php php*php Turnphp offphp Amazonphp CloudWatchphp Monitoringphp forphp anphp instancephp orphp aphp listphp ofphp instances
php php php php php*
php php php php php*php php@paramphp arrayphp|stringphp php$instanceIdphp php php php php php php php php php php Thephp instancephp orphp listphp ofphp instancesphp youphp wantphp tophp disablephp monitoringphp for
php php php php php*php php@returnphp array
php php php php php*php/
php php php php publicphp functionphp unmonitorphp(php$instanceIdphp)
php php php php php{
php php php php php php php php php$paramsphp php=php arrayphp(php)php;
php php php php php php php php php$paramsphp[php'Actionphp'php]php php=php php'UnmonitorInstancesphp'php;

php php php php php php php php ifphp(isphp_arrayphp(php$instanceIdphp)php php&php&php php!emptyphp(php$instanceIdphp)php)php php{
php php php php php php php php php php php php foreachphp(php$instanceIdphp asphp php$kphp=php>php$namephp)php php{
php php php php php php php php php php php php php php php php php$paramsphp[php'InstanceIdphp.php'php php.php php(php$kphp+php1php)php]php php=php php$namephp;
php php php php php php php php php php php php php}
php php php php php php php php php}php elseifphp(php$instanceIdphp)php php{
php php php php php php php php php php php php php$paramsphp[php'InstanceIdphp.php1php'php]php php=php php$instanceIdphp;
php php php php php php php php php}

php php php php php php php php php$responsephp php=php php$thisphp-php>sendRequestphp(php$paramsphp)php;
php php php php php php php php php$xpathphp php=php php$responsephp-php>getXPathphp(php)php;


php php php php php php php php php$itemsphp php=php php$xpathphp-php>queryphp(php'php/php/ecphp2php:instancesSetphp/ecphp2php:itemphp'php)php;

php php php php php php php php php$arrReturnphp php=php arrayphp(php)php;
php php php php php php php php foreachphp(php$itemsphp asphp php$itemphp)php php{
php php php php php php php php php php php php php$iphp php=php arrayphp(php)php;
php php php php php php php php php php php php php$iphp[php'instanceidphp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(php/php/ecphp2php:instanceIdphp/textphp(php)php)php'php,php php$itemphp)php;
php php php php php php php php php php php php php$iphp[php'monitorstatephp'php]php php=php php$xpathphp-php>evaluatephp(php'stringphp(php/php/ecphp2php:monitoringphp/ecphp2php:statephp/textphp(php)php)php'php)php;
php php php php php php php php php php php php php$arrReturnphp[php]php php=php php$iphp;
php php php php php php php php php php php php unsetphp(php$iphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$arrReturnphp;
php php php php php}

php}

