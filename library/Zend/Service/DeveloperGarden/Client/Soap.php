<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Service
php php*php php@subpackagephp DeveloperGarden
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Soapphp.phpphp php2php2php6php6php2php php2php0php1php0php-php0php7php-php2php4php php1php7php:php3php7php:php3php6Zphp mabephp php$
php php*php/

php/php*php*
php php*php php@seephp Zendphp_Soapphp_Client
php php*php/
requirephp_oncephp php'Zendphp/Soapphp/Clientphp.phpphp'php;

php/php*php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Service
php php*php php@subpackagephp DeveloperGarden
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@authorphp php php php php Marcophp Kaiser
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_Servicephp_DeveloperGardenphp_Clientphp_Soapphp extendsphp Zendphp_Soapphp_Client
php{
php php php php php/php*php*
php php php php php php*php classphp withphp credentialphp interface
php php php php php php*
php php php php php php*php php@varphp Zendphp_Servicephp_DeveloperGardenphp_Credential
php php php php php php*php/
php php php php privatephp php$php_credentialphp php=php nullphp;

php php php php php/php*php*
php php php php php php*php WSSEphp Securityphp Extphp Namespace
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php constphp WSSEphp_NAMESPACEphp_SECEXTphp php=php php'httpphp:php/php/docsphp.oasisphp-openphp.orgphp/wssphp/php2php0php0php4php/php0php1php/oasisphp-php2php0php0php4php0php1php-wssphp-wssecurityphp-secextphp-php1php.php0php.xsdphp'php;

php php php php php/php*php*
php php php php php php*php WSSEphp Samlphp Namespace
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php constphp WSSEphp_NAMESPACEphp_SAMLphp php=php php'urnphp:oasisphp:namesphp:tcphp:SAMLphp:php2php.php0php:assertionphp'php;

php php php php php/php*php*
php php php php php php*php Securityphp Element
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php constphp WSSEphp_SECURITYphp_ELEMENTphp php=php php'Securityphp'php;

php php php php php/php*php*
php php php php php php*php UsernameTokenphp Element
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php constphp WSSEphp_ELEMENTphp_USERNAMETOKENphp php=php php'UsernameTokenphp'php;

php php php php php/php*php*
php php php php php php*php Usernaephp Element
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php constphp WSSEphp_ELEMENTphp_USERNAMEphp php=php php'Usernamephp'php;

php php php php php/php*php*
php php php php php php*php Passwordphp Element
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php constphp WSSEphp_ELEMENTphp_PASSWORDphp php=php php'Passwordphp'php;

php php php php php/php*php*
php php php php php php*php Passwordphp Elementphp WSSEphp Type
php php php php php php*
php php php php php php*php/
php php php php constphp WSSEphp_ELEMENTphp_PASSWORDphp_TYPEphp php=php php'httpphp:php/php/docsphp.oasisphp-openphp.orgphp/wssphp/php2php0php0php4php/php0php1php/oasisphp-php2php0php0php4php0php1php-wssphp-usernamephp-tokenphp-profilephp-php1php.php0php#PasswordTextphp'php;

php php php php php/php*php*
php php php php php php*php isphp thisphp clientphp usedphp byphp thephp tokenphp service
php php php php php php*
php php php php php php*php php@varphp Zendphp_Servicephp_DeveloperGardenphp_SecurityTokenServer
php php php php php php*php/
php php php php protectedphp php$php_tokenServicephp php=php nullphp;

php php php php php/php*php*
php php php php php php*php Performphp aphp SOAPphp callphp butphp firstphp checkphp forphp addingphp STSphp Tokenphp orphp fetchphp one
php php php php php php*
php php php php php php*php php@paramphp stringphp php$name
php php php php php php*php php@paramphp arrayphp php php$arguments
php php php php php php*php php@returnphp mixed
php php php php php php*php/
php php php php publicphp functionphp php_php_callphp(php$namephp,php php$argumentsphp)
php php php php php{
php php php php php php php php php/php*php*
php php php php php php php php php php*php addphp WSSEphp Securityphp header
php php php php php php php php php php*php/
php php php php php php php php ifphp php(php$thisphp-php>php_tokenServicephp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php/php/php ifphp loginphp methodphp wephp addWsseLoginHeader
php php php php php php php php php php php php ifphp php(inphp_arrayphp(php'loginphp'php,php php$argumentsphp)php)php php{
php php php php php php php php php php php php php php php php php$thisphp-php>addWsseLoginHeaderphp(php)php;
php php php php php php php php php php php php php}php elseifphp php(php$namephp php=php=php php'getTokensphp'php)php php{
php php php php php php php php php php php php php php php php php$thisphp-php>addWsseTokenHeaderphp(php$thisphp-php>php_tokenServicephp-php>getLoginTokenphp(php)php)php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$thisphp-php>addWsseSecurityTokenHeaderphp(php$thisphp-php>php_tokenServicephp-php>getTokensphp(php)php)php;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php returnphp parentphp:php:php_php_callphp(php$namephp,php php$argumentsphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php setsphp thephp internalphp handlingphp forphp handlephp tokenphp service
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Servicephp_DeveloperGardenphp_SecurityTokenServerphp php$isTokenService
php php php php php php*php php@returnphp Zendphp_Servicephp_DeveloperGardenphp_Clientphp_Soap
php php php php php php*php/
php php php php publicphp functionphp setTokenServicephp(Zendphp_Servicephp_DeveloperGardenphp_SecurityTokenServerphp php$tokenServicephp)
php php php php php{
php php php php php php php php php$thisphp-php>php_tokenServicephp php=php php$tokenServicephp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php returnsphp thephp currentlyphp configuredphp tokenServicephp object
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Servicephp_DeveloperGardenphp_SecurityTokenServer
php php php php php php*php/
php php php php publicphp functionphp getTokenServicephp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_tokenServicephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setsphp newphp credentialphp callbackphp object
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Servicephp_DeveloperGardenphp_Credentialphp php$credential
php php php php php php*php php@returnphp Zendphp_Servicephp_DeveloperGardenphp_Clientphp_Soap
php php php php php php*php/
php php php php publicphp functionphp setCredentialphp(Zendphp_Servicephp_DeveloperGardenphp_Credentialphp php$credentialphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_credentialphp php=php php$credentialphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php returnsphp thephp internalphp credentialphp callbackphp object
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Servicephp_DeveloperGardenphp_Credential
php php php php php php*php/
php php php php publicphp functionphp getCredentialphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_credentialphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php createsphp thephp loginphp headerphp andphp add
php php php php php php*
php php php php php php*php php@returnphp SoapHeader
php php php php php php*php/
php php php php publicphp functionphp getWsseLoginHeaderphp(php)
php php php php php{
php php php php php php php php php$domphp php=php newphp DOMDocumentphp(php)php;

php php php php php php php php php/php*php*
php php php php php php php php php php*php Securityphp Element
php php php php php php php php php php*php/
php php php php php php php php php$securityElementphp php=php php$domphp-php>createElementNSphp(
php php php php php php php php php php php php selfphp:php:WSSEphp_NAMESPACEphp_SECEXTphp,
php php php php php php php php php php php php php'wssephp:php'php php.php selfphp:php:WSSEphp_SECURITYphp_ELEMENT
php php php php php php php php php)php;
php php php php php php php php php$securityElementphp-php>setAttributephp(php'mustUnderstandphp'php,php truephp)php;

php php php php php php php php php/php*php*
php php php php php php php php php php*php Usernamephp Tokenphp Element
php php php php php php php php php php*php/
php php php php php php php php php$usernameTokenElementphp php=php php$domphp-php>createElementNSphp(
php php php php php php php php php php php php selfphp:php:WSSEphp_NAMESPACEphp_SECEXTphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_ELEMENTphp_USERNAMETOKEN
php php php php php php php php php)php;

php php php php php php php php php/php*php*
php php php php php php php php php php*php Usernamephp Element
php php php php php php php php php php*php/
php php php php php php php php php$usernameElementphp php=php php$domphp-php>createElementNSphp(
php php php php php php php php php php php php selfphp:php:WSSEphp_NAMESPACEphp_SECEXTphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_ELEMENTphp_USERNAMEphp,
php php php php php php php php php php php php php$thisphp-php>php_credentialphp-php>getUsernamephp(truephp)
php php php php php php php php php)php;

php php php php php php php php php/php*php*
php php php php php php php php php php*php Passwordphp Element
php php php php php php php php php php*php/
php php php php php php php php php$passwordElementphp php=php php$domphp-php>createElementNSphp(
php php php php php php php php php php php php selfphp:php:WSSEphp_NAMESPACEphp_SECEXTphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_ELEMENTphp_PASSWORDphp,
php php php php php php php php php php php php php$thisphp-php>php_credentialphp-php>getPasswordphp(php)
php php php php php php php php php)php;
php php php php php php php php php$passwordElementphp-php>setAttributephp(php'Typephp'php,php selfphp:php:WSSEphp_ELEMENTphp_PASSWORDphp_TYPEphp)php;

php php php php php php php php php$usernameTokenElementphp-php>appendChildphp(php$usernameElementphp)php;
php php php php php php php php php$usernameTokenElementphp-php>appendChildphp(php$passwordElementphp)php;

php php php php php php php php php$securityElementphp-php>appendChildphp(php$usernameTokenElementphp)php;
php php php php php php php php php$domphp-php>appendChildphp(php$securityElementphp)php;

php php php php php php php php php$authSoapVarphp php=php newphp SoapVarphp(
php php php php php php php php php php php php php$domphp-php>saveXMLphp(php$securityElementphp)php,
php php php php php php php php php php php php XSDphp_ANYXMLphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_NAMESPACEphp_SECEXTphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_SECURITYphp_ELEMENT
php php php php php php php php php)php;

php php php php php php php php php$authSoapHeaderphp php=php newphp SoapHeaderphp(
php php php php php php php php php php php php selfphp:php:WSSEphp_NAMESPACEphp_SECEXTphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_SECURITYphp_ELEMENTphp,
php php php php php php php php php php php php php$authSoapVarphp,
php php php php php php php php php php php php true
php php php php php php php php php)php;

php php php php php php php php returnphp php$authSoapHeaderphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php createsphp thephp tokenphp authphp headerphp forphp directphp calls
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Servicephp_DeveloperGardenphp_Responsephp_SecurityTokenServerphp_SecurityTokenResponsephp php$token
php php php php php php*php php@returnphp SoapHeader
php php php php php php*php/
php php php php publicphp functionphp getWsseTokenHeaderphp(
php php php php php php php php Zendphp_Servicephp_DeveloperGardenphp_Responsephp_SecurityTokenServerphp_SecurityTokenResponsephp php$token
php php php php php)php php{
php php php php php php php php php$formatphp php=php php'php<wssephp:php%sphp xmlnsphp:wssephp=php"php%sphp"php SOAPphp-ENVphp:mustUnderstandphp=php"php1php"php>php%s<php/wssephp:php%sphp>php'php;
php php php php php php php php php$securityHeaderphp php=php sprintfphp(
php php php php php php php php php php php php php$formatphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_SECURITYphp_ELEMENTphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_NAMESPACEphp_SECEXTphp,
php php php php php php php php php php php php php$tokenphp-php>getTokenDataphp(php)php,
php php php php php php php php php php php php selfphp:php:WSSEphp_SECURITYphp_ELEMENT
php php php php php php php php php)php;

php php php php php php php php php$authSoapVarphp php=php newphp SoapVarphp(
php php php php php php php php php php php php php$securityHeaderphp,
php php php php php php php php php php php php XSDphp_ANYXMLphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_NAMESPACEphp_SECEXTphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_SECURITYphp_ELEMENT
php php php php php php php php php)php;

php php php php php php php php php$authSoapHeaderphp php=php newphp SoapHeaderphp(
php php php php php php php php php php php php selfphp:php:WSSEphp_NAMESPACEphp_SECEXTphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_SECURITYphp_ELEMENTphp,
php php php php php php php php php php php php php$authSoapVarphp,
php php php php php php php php php php php php true
php php php php php php php php php)php;

php php php php php php php php returnphp php$authSoapHeaderphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php createsphp thephp securityphp tokenphp authphp headerphp forphp directphp calls
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Servicephp_DeveloperGardenphp_Responsephp_SecurityTokenServerphp_SecurityTokenResponsephp php$token
php php php php php php*php php@returnphp SoapHeader
php php php php php php*php/
php php php php publicphp functionphp getWsseSecurityTokenHeaderphp(
php php php php php php php php Zendphp_Servicephp_DeveloperGardenphp_Responsephp_SecurityTokenServerphp_GetTokensResponsephp php$token
php php php php php)php php{
php php php php php php php php php$formatphp php=php php'php<wssephp:php%sphp xmlnsphp:wssephp=php"php%sphp"php SOAPphp-ENVphp:mustUnderstandphp=php"php1php"php>php%s<php/wssephp:php%sphp>php'php;
php php php php php php php php php$securityHeaderphp php=php sprintfphp(
php php php php php php php php php php php php php$formatphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_SECURITYphp_ELEMENTphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_NAMESPACEphp_SECEXTphp,
php php php php php php php php php php php php php$tokenphp-php>getTokenDataphp(php)php,
php php php php php php php php php php php php selfphp:php:WSSEphp_SECURITYphp_ELEMENT
php php php php php php php php php)php;

php php php php php php php php php$authSoapVarphp php=php newphp SoapVarphp(
php php php php php php php php php php php php php$securityHeaderphp,
php php php php php php php php php php php php XSDphp_ANYXMLphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_NAMESPACEphp_SECEXTphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_SECURITYphp_ELEMENT
php php php php php php php php php)php;

php php php php php php php php php$authSoapHeaderphp php=php newphp SoapHeaderphp(
php php php php php php php php php php php php selfphp:php:WSSEphp_NAMESPACEphp_SECEXTphp,
php php php php php php php php php php php php selfphp:php:WSSEphp_SECURITYphp_ELEMENTphp,
php php php php php php php php php php php php php$authSoapVarphp,
php php php php php php php php php php php php true
php php php php php php php php php)php;

php php php php php php php php returnphp php$authSoapHeaderphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php addsphp thephp loginphp specificphp headerphp tophp thephp client
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Servicephp_DeveloperGardenphp_Clientphp_Soap
php php php php php php*php/
php php php php publicphp functionphp addWsseLoginHeaderphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>addSoapInputHeaderphp(php$thisphp-php>getWsseLoginHeaderphp(php)php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php addsphp thephp earlierphp fetchedphp tokenphp tophp thephp header
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Servicephp_DeveloperGardenphp_Responsephp_SecurityTokenServerphp_SecurityTokenResponsephp php$token
php php php php php php*php php@returnphp Zendphp_Servicephp_DeveloperGardenphp_Clientphp_Soap
php php php php php php*php/
php php php php publicphp functionphp addWsseTokenHeaderphp(
php php php php php php php php Zendphp_Servicephp_DeveloperGardenphp_Responsephp_SecurityTokenServerphp_SecurityTokenResponsephp php$token
php php php php php)php php{
php php php php php php php php returnphp php$thisphp-php>addSoapInputHeaderphp(php$thisphp-php>getWsseTokenHeaderphp(php$tokenphp)php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php addsphp thephp earlierphp fetchedphp tokenphp tophp thephp header
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Servicephp_DeveloperGardenphp_Responsephp_SecurityTokenServerphp_SecurityTokenResponsephp php$token
php php php php php php*php php@returnphp Zendphp_Servicephp_DeveloperGardenphp_Clientphp_Soap
php php php php php php*php/
php php php php publicphp functionphp addWsseSecurityTokenHeaderphp(
php php php php php php php php Zendphp_Servicephp_DeveloperGardenphp_Responsephp_SecurityTokenServerphp_GetTokensResponsephp php$token
php php php php php)php php{
php php php php php php php php returnphp php$thisphp-php>addSoapInputHeaderphp(php$thisphp-php>getWsseSecurityTokenHeaderphp(php$tokenphp)php)php;
php php php php php}
php}
