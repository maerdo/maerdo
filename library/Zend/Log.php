<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Log
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Logphp.phpphp php2php3php5php7php6php php2php0php1php0php-php1php2php-php2php3php php2php3php:php2php5php:php4php4Zphp ramonphp php$
php php*php/

php/php*php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Log
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php php@versionphp php php php php$Idphp:php Logphp.phpphp php2php3php5php7php6php php2php0php1php0php-php1php2php-php2php3php php2php3php:php2php5php:php4php4Zphp ramonphp php$
php php*php/
classphp Zendphp_Log
php{
php php php php constphp EMERGphp php php php=php php0php;php php php/php/php Emergencyphp:php systemphp isphp unusable
php php php php constphp ALERTphp php php php=php php1php;php php php/php/php Alertphp:php actionphp mustphp bephp takenphp immediately
php php php php constphp CRITphp php php php php=php php2php;php php php/php/php Criticalphp:php criticalphp conditions
php php php php constphp ERRphp php php php php php=php php3php;php php php/php/php Errorphp:php errorphp conditions
php php php php constphp WARNphp php php php php=php php4php;php php php/php/php Warningphp:php warningphp conditions
php php php php constphp NOTICEphp php php=php php5php;php php php/php/php Noticephp:php normalphp butphp significantphp condition
php php php php constphp INFOphp php php php php=php php6php;php php php/php/php Informationalphp:php informationalphp messages
php php php php constphp DEBUGphp php php php=php php7php;php php php/php/php Debugphp:php debugphp messages

php php php php php/php*php*
php php php php php php*php php@varphp arrayphp ofphp prioritiesphp wherephp thephp keysphp arephp the
php php php php php php*php priorityphp numbersphp andphp thephp valuesphp arephp thephp priorityphp names
php php php php php php*php/
php php php php protectedphp php$php_prioritiesphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php php@varphp arrayphp ofphp Zendphp_Logphp_Writerphp_Abstract
php php php php php php*php/
php php php php protectedphp php$php_writersphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php php@varphp arrayphp ofphp Zendphp_Logphp_Filterphp_Interface
php php php php php php*php/
php php php php protectedphp php$php_filtersphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php php@varphp arrayphp ofphp extraphp logphp event
php php php php php php*php/
php php php php protectedphp php$php_extrasphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_defaultWriterNamespacephp php=php php'Zendphp_Logphp_Writerphp'php;

php php php php php/php*php*
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_defaultFilterNamespacephp php=php php'Zendphp_Logphp_Filterphp'php;

php php php php php/php*php*
php php php php php php*
php php php php php php*php php@varphp callback
php php php php php php*php/
php php php php protectedphp php$php_origErrorHandlerphp php php php php php php php=php nullphp;

php php php php php/php*php*
php php php php php php*
php php php php php php*php php@varphp boolean
php php php php php php*php/
php php php php protectedphp php$php_registeredErrorHandlerphp php=php falsephp;

php php php php php/php*php*
php php php php php php*
php php php php php php*php php@varphp arrayphp|boolean
php php php php php php*php/
php php php php protectedphp php$php_errorHandlerMapphp php php php php php php php php=php falsephp;

php php php php php/php*php*
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_timestampFormatphp php php php php php php php php=php php'cphp'php;

php php php php php/php*php*
php php php php php php*php Classphp constructorphp.php php Createphp aphp newphp logger
php php php php php php*
php php php php php php*php php@paramphp Zendphp_Logphp_Writerphp_Abstractphp|nullphp php php$writerphp php defaultphp writer
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php publicphp functionphp php_php_constructphp(Zendphp_Logphp_Writerphp_Abstractphp php$writerphp php=php nullphp)
php php php php php{
php php php php php php php php php$rphp php=php newphp ReflectionClassphp(php$thisphp)php;
php php php php php php php php php$thisphp-php>php_prioritiesphp php=php arrayphp_flipphp(php$rphp-php>getConstantsphp(php)php)php;

php php php php php php php php ifphp php(php$writerphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php php$thisphp-php>addWriterphp(php$writerphp)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Factoryphp tophp constructphp thephp loggerphp andphp onephp orphp morephp writers
php php php php php php*php basedphp onphp thephp configurationphp array
php php php php php php*
php php php php php php*php php@paramphp php arrayphp|Zendphp_Configphp Arrayphp orphp instancephp ofphp Zendphp_Config
php php php php php php*php php@returnphp Zendphp_Log
php php php php php php*php php@throwsphp Zendphp_Logphp_Exception
php php php php php php*php/
php php php php staticphp publicphp functionphp factoryphp(php$configphp php=php arrayphp(php)php)
php php php php php{
php php php php php php php php ifphp php(php$configphp instanceofphp Zendphp_Configphp)php php{
php php php php php php php php php php php php php$configphp php=php php$configphp-php>toArrayphp(php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!isphp_arrayphp(php$configphp)php php|php|php emptyphp(php$configphp)php)php php{
php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Logphp_Exceptionphp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(php'Configurationphp mustphp bephp anphp arrayphp orphp instancephp ofphp Zendphp_Configphp'php)php;
php php php php php php php php php}

php php php php php php php php php$logphp php=php newphp selfphp;

php php php php php php php php ifphp php(php!isphp_arrayphp(currentphp(php$configphp)php)php)php php{
php php php php php php php php php php php php php$logphp-php>addWriterphp(currentphp(php$configphp)php)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php foreachphp(php$configphp asphp php$writerphp)php php{
php php php php php php php php php php php php php php php php php$logphp-php>addWriterphp(php$writerphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp php$logphp;
php php php php php}


php php php php php/php*php*
php php php php php php*php Constructphp aphp writerphp objectphp basedphp onphp aphp configurationphp array
php php php php php php*
php php php php php php*php php@paramphp php arrayphp php$specphp configphp arrayphp withphp writerphp spec
php php php php php php*php php@returnphp Zendphp_Logphp_Writerphp_Abstract
php php php php php php*php php@throwsphp Zendphp_Logphp_Exception
php php php php php php*php/
php php php php protectedphp functionphp php_constructWriterFromConfigphp(php$configphp)
php php php php php{
php php php php php php php php php$writerphp php=php php$thisphp-php>php_constructFromConfigphp(php'writerphp'php,php php$configphp,php php$thisphp-php>php_defaultWriterNamespacephp)php;

php php php php php php php php ifphp php(php!php$writerphp instanceofphp Zendphp_Logphp_Writerphp_Abstractphp)php php{
php php php php php php php php php php php php php$writerNamephp php=php isphp_objectphp(php$writerphp)
php php php php php php php php php php php php php php php php php php php php php php php php php?php getphp_classphp(php$writerphp)
php php php php php php php php php php php php php php php php php php php php php php php php php:php php'Thephp specifiedphp writerphp'php;
php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Logphp_Exceptionphp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(php"php{php$writerNamephp}php doesphp notphp extendphp Zendphp_Logphp_Writerphp_Abstractphp!php"php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(issetphp(php$configphp[php'filterNamephp'php]php)php)php php{
php php php php php php php php php php php php php$filterphp php=php php$thisphp-php>php_constructFilterFromConfigphp(php$configphp)php;
php php php php php php php php php php php php php$writerphp-php>addFilterphp(php$filterphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$writerphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Constructphp filterphp objectphp fromphp configurationphp arrayphp orphp Zendphp_Configphp object
php php php php php php*
php php php php php php*php php@paramphp php arrayphp|Zendphp_Configphp php$configphp Zendphp_Configphp orphp Array
php php php php php php*php php@returnphp Zendphp_Logphp_Filterphp_Interface
php php php php php php*php php@throwsphp Zendphp_Logphp_Exception
php php php php php php*php/
php php php php protectedphp functionphp php_constructFilterFromConfigphp(php$configphp)
php php php php php{
php php php php php php php php php$filterphp php=php php$thisphp-php>php_constructFromConfigphp(php'filterphp'php,php php$configphp,php php$thisphp-php>php_defaultFilterNamespacephp)php;

php php php php php php php php ifphp php(php!php$filterphp instanceofphp Zendphp_Logphp_Filterphp_Interfacephp)php php{
php php php php php php php php php php php php php php$filterNamephp php=php isphp_objectphp(php$filterphp)
php php php php php php php php php php php php php php php php php php php php php php php php php php?php getphp_classphp(php$filterphp)
php php php php php php php php php php php php php php php php php php php php php php php php php php:php php'Thephp specifiedphp filterphp'php;
php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Logphp_Exceptionphp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(php"php{php$filterNamephp}php doesphp notphp implementphp Zendphp_Logphp_Filterphp_Interfacephp"php)php;
php php php php php php php php php}

php php php php php php php php returnphp php$filterphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Constructphp aphp filterphp orphp writerphp fromphp config
php php php php php php*
php php php php php php*php php@paramphp stringphp php$typephp php'writerphp'php ofphp php'filterphp'
php php php php php php*php php@paramphp mixedphp php$configphp Zendphp_Configphp orphp Array
php php php php php php*php php@paramphp stringphp php$namespace
php php php php php php*php php@returnphp object
php php php php php php*php php@throwsphp Zendphp_Logphp_Exception
php php php php php php*php/
php php php php protectedphp functionphp php_constructFromConfigphp(php$typephp,php php$configphp,php php$namespacephp)
php php php php php{
php php php php php php php php ifphp php(php$configphp instanceofphp Zendphp_Configphp)php php{
php php php php php php php php php php php php php$configphp php=php php$configphp-php>toArrayphp(php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!isphp_arrayphp(php$configphp)php php|php|php emptyphp(php$configphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(
php php php php php php php php php php php php php php php php php'Configurationphp mustphp bephp anphp arrayphp orphp instancephp ofphp Zendphp_Configphp'
php php php php php php php php php php php php php)php;
php php php php php php php php php}

php php php php php php php php php$paramsphp php php php php=php issetphp(php$configphp[php php$typephp php.php'Paramsphp'php php]php)php php?php php$configphp[php php$typephp php.php'Paramsphp'php php]php php:php arrayphp(php)php;
php php php php php php php php php$classNamephp php=php php$thisphp-php>getClassNamephp(php$configphp,php php$typephp,php php$namespacephp)php;
php php php php php php php php ifphp php(php!classphp_existsphp(php$classNamephp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Loaderphp.phpphp'php;
php php php php php php php php php php php php Zendphp_Loaderphp:php:loadClassphp(php$classNamephp)php;
php php php php php php php php php}

php php php php php php php php php$reflectionphp php=php newphp ReflectionClassphp(php$classNamephp)php;
php php php php php php php php ifphp php(php!php$reflectionphp-php>implementsInterfacephp(php'Zendphp_Logphp_FactoryInterfacephp'php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(
php php php php php php php php php php php php php php php php php'Driverphp doesphp notphp implementphp Zendphp_Logphp_FactoryInterfacephp andphp canphp notphp bephp constructedphp fromphp configphp.php'
php php php php php php php php php php php php php)php;
php php php php php php php php php}

php php php php php php php php returnphp callphp_userphp_funcphp(arrayphp(php$classNamephp,php php'factoryphp'php)php,php php$paramsphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp thephp writerphp orphp filterphp fullphp classname
php php php php php php*
php php php php php php*php php@paramphp arrayphp php$config
php php php php php php*php php@paramphp stringphp php$typephp filterphp|writer
php php php php php php*php php@paramphp stringphp php$defaultNamespace
php php php php php php*php php@returnphp stringphp fullphp classname
php php php php php php*php php@throwsphp Zendphp_Logphp_Exception
php php php php php php*php/
php php php php protectedphp functionphp getClassNamephp(php$configphp,php php$typephp,php php$defaultNamespacephp)
php php php php php{
php php php php php php php php ifphp php(php!issetphp(php$configphp[php php$typephp php.php php'Namephp'php php]php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(php"Specifyphp php{php$typephp}Namephp inphp thephp configurationphp arrayphp"php)php;
php php php php php php php php php}
php php php php php php php php php$classNamephp php=php php$configphp[php php$typephp php.php php'Namephp'php php]php;

php php php php php php php php php$namespacephp php=php php$defaultNamespacephp;
php php php php php php php php ifphp php(issetphp(php$configphp[php php$typephp php.php php'Namespacephp'php php]php)php)php php{
php php php php php php php php php php php php php$namespacephp php=php php$configphp[php php$typephp php.php php'Namespacephp'php php]php;
php php php php php php php php php}

php php php php php php php php php$fullClassNamephp php=php php$namespacephp php.php php'php_php'php php.php php$classNamephp;
php php php php php php php php returnphp php$fullClassNamephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Packsphp messagephp andphp priorityphp intophp Eventphp array
php php php php php php*
php php php php php php*php php@paramphp php stringphp php php php$messagephp php php Messagephp tophp log
php php php php php php*php php@paramphp php integerphp php php$priorityphp php Priorityphp ofphp message
php php php php php php*php php@returnphp arrayphp Eventphp array
php php php php php php*php/
php php php php protectedphp functionphp php_packEventphp(php$messagephp,php php$priorityphp)
php php php php php{
php php php php php php php php returnphp arrayphp_mergephp(arrayphp(
php php php php php php php php php php php php php'timestampphp'php php php php php=php>php datephp(php$thisphp-php>php_timestampFormatphp)php,
php php php php php php php php php php php php php'messagephp'php php php php php php php=php>php php$messagephp,
php php php php php php php php php php php php php'priorityphp'php php php php php php=php>php php$priorityphp,
php php php php php php php php php php php php php'priorityNamephp'php php=php>php php$thisphp-php>php_prioritiesphp[php$priorityphp]
php php php php php php php php php php php php php)php,
php php php php php php php php php php php php php$thisphp-php>php_extras
php php php php php php php php php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Classphp destructorphp.php php Shutdownphp logphp writers
php php php php php php*
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php publicphp functionphp php_php_destructphp(php)
php php php php php{
php php php php php php php php foreachphp(php$thisphp-php>php_writersphp asphp php$writerphp)php php{
php php php php php php php php php php php php php$writerphp-php>shutdownphp(php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Undefinedphp methodphp handlerphp allowsphp aphp shortcutphp:
php php php php php php*php php php php$logphp-php>priorityNamephp(php'messagephp'php)
php php php php php php*php php php php php insteadphp of
php php php php php php*php php php php$logphp-php>logphp(php'messagephp'php,php Zendphp_Logphp:php:PRIORITYphp_NAMEphp)
php php php php php php*
php php php php php php*php php@paramphp php stringphp php php$methodphp php priorityphp name
php php php php php php*php php@paramphp php stringphp php php$paramsphp php messagephp tophp log
php php php php php php*php php@returnphp void
php php php php php php*php php@throwsphp Zendphp_Logphp_Exception
php php php php php php*php/
php php php php publicphp functionphp php_php_callphp(php$methodphp,php php$paramsphp)
php php php php php{
php php php php php php php php php$priorityphp php=php strtoupperphp(php$methodphp)php;
php php php php php php php php ifphp php(php(php$priorityphp php=php arrayphp_searchphp(php$priorityphp,php php$thisphp-php>php_prioritiesphp)php)php php!php=php=php falsephp)php php{
php php php php php php php php php php php php switchphp php(countphp(php$paramsphp)php)php php{
php php php php php php php php php php php php php php php php casephp php0php:
php php php php php php php php php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Logphp_Exceptionphp php*php/
php php php php php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(php'Missingphp logphp messagephp'php)php;
php php php php php php php php php php php php php php php php casephp php1php:
php php php php php php php php php php php php php php php php php php php php php$messagephp php=php arrayphp_shiftphp(php$paramsphp)php;
php php php php php php php php php php php php php php php php php php php php php$extrasphp php=php nullphp;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php php php php php php$messagephp php=php arrayphp_shiftphp(php$paramsphp)php;
php php php php php php php php php php php php php php php php php php php php php$extrasphp php php=php arrayphp_shiftphp(php$paramsphp)php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$thisphp-php>logphp(php$messagephp,php php$priorityphp,php php$extrasphp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Logphp_Exceptionphp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(php'Badphp logphp priorityphp'php)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Logphp aphp messagephp atphp aphp priority
php php php php php php*
php php php php php php*php php@paramphp php stringphp php php php$messagephp php php Messagephp tophp log
php php php php php php*php php@paramphp php integerphp php php$priorityphp php Priorityphp ofphp message
php php php php php php*php php@paramphp php mixedphp php php php php$extrasphp php php php Extraphp informationphp tophp logphp inphp event
php php php php php php*php php@returnphp void
php php php php php php*php php@throwsphp Zendphp_Logphp_Exception
php php php php php php*php/
php php php php publicphp functionphp logphp(php$messagephp,php php$priorityphp,php php$extrasphp php=php nullphp)
php php php php php{
php php php php php php php php php/php/php sanityphp checks
php php php php php php php php ifphp php(emptyphp(php$thisphp-php>php_writersphp)php)php php{
php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Logphp_Exceptionphp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(php'Nophp writersphp werephp addedphp'php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!php issetphp(php$thisphp-php>php_prioritiesphp[php$priorityphp]php)php)php php{
php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Logphp_Exceptionphp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(php'Badphp logphp priorityphp'php)php;
php php php php php php php php php}

php php php php php php php php php/php/php packphp intophp eventphp requiredphp byphp filtersphp andphp writers
php php php php php php php php php$eventphp php=php php$thisphp-php>php_packEventphp(php$messagephp,php php$priorityphp)php;

php php php php php php php php php/php/php Checkphp tophp seephp ifphp anyphp extraphp informationphp wasphp passed
php php php php php php php php ifphp php(php!emptyphp(php$extrasphp)php)php php{
php php php php php php php php php php php php php$infophp php=php arrayphp(php)php;
php php php php php php php php php php php php ifphp php(isphp_arrayphp(php$extrasphp)php)php php{
php php php php php php php php php php php php php php php php foreachphp php(php$extrasphp asphp php$keyphp php=php>php php$valuephp)php php{
php php php php php php php php php php php php php php php php php php php php ifphp php(isphp_stringphp(php$keyphp)php)php php{
php php php php php php php php php php php php php php php php php php php php php php php php php$eventphp[php$keyphp]php php=php php$valuephp;
php php php php php php php php php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php php php php php php php php php$infophp[php]php php=php php$valuephp;
php php php php php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$infophp php=php php$extrasphp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php ifphp php(php!emptyphp(php$infophp)php)php php{
php php php php php php php php php php php php php php php php php$eventphp[php'infophp'php]php php=php php$infophp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php/php/php abortphp ifphp rejectedphp byphp thephp globalphp filters
php php php php php php php php foreachphp php(php$thisphp-php>php_filtersphp asphp php$filterphp)php php{
php php php php php php php php php php php php ifphp php(php!php php$filterphp-php>acceptphp(php$eventphp)php)php php{
php php php php php php php php php php php php php php php php returnphp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php php/php/php sendphp tophp eachphp writer
php php php php php php php php foreachphp php(php$thisphp-php>php_writersphp asphp php$writerphp)php php{
php php php php php php php php php php php php php$writerphp-php>writephp(php$eventphp)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Addphp aphp customphp priority
php php php php php php*
php php php php php php*php php@paramphp php stringphp php php php$namephp php php php php php Namephp ofphp priority
php php php php php php*php php@paramphp php integerphp php php$priorityphp php Numericphp priority
php php php php php php*php php@throwsphp Zendphp_Logphp_Exception
php php php php php php*php/
php php php php publicphp functionphp addPriorityphp(php$namephp,php php$priorityphp)
php php php php php{
php php php php php php php php php/php/php Priorityphp namesphp mustphp bephp uppercasephp forphp predictabilityphp.
php php php php php php php php php$namephp php=php strtoupperphp(php$namephp)php;

php php php php php php php php ifphp php(issetphp(php$thisphp-php>php_prioritiesphp[php$priorityphp]php)
php php php php php php php php php php php php php|php|php falsephp php!php=php=php arrayphp_searchphp(php$namephp,php php$thisphp-php>php_prioritiesphp)php)php php{
php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Logphp_Exceptionphp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(php'Existingphp prioritiesphp cannotphp bephp overwrittenphp'php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_prioritiesphp[php$priorityphp]php php=php php$namephp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Addphp aphp filterphp thatphp willphp bephp appliedphp beforephp allphp logphp writersphp.
php php php php php php*php Beforephp aphp messagephp willphp bephp receivedphp byphp anyphp ofphp thephp writersphp,php it
php php php php php php*php mustphp bephp acceptedphp byphp allphp filtersphp addedphp withphp thisphp methodphp.
php php php php php php*
php php php php php php*php php@paramphp php intphp|Zendphp_Configphp|arrayphp|Zendphp_Logphp_Filterphp_Interfacephp php$filter
php php php php php php*php php@returnphp Zendphp_Log
php php php php php php*php php@throwsphp Zendphp_Logphp_Exception
php php php php php php*php/
php php php php publicphp functionphp addFilterphp(php$filterphp)
php php php php php{
php php php php php php php php ifphp php(isphp_intphp(php$filterphp)php)php php{
php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Logphp_Filterphp_Priorityphp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Filterphp/Priorityphp.phpphp'php;
php php php php php php php php php php php php php$filterphp php=php newphp Zendphp_Logphp_Filterphp_Priorityphp(php$filterphp)php;

php php php php php php php php php}php elseifphp php(php$filterphp instanceofphp Zendphp_Configphp php|php|php isphp_arrayphp(php$filterphp)php)php php{
php php php php php php php php php php php php php$filterphp php=php php$thisphp-php>php_constructFilterFromConfigphp(php$filterphp)php;

php php php php php php php php php}php elseifphp(php!php php$filterphp instanceofphp Zendphp_Logphp_Filterphp_Interfacephp)php php{
php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Logphp_Exceptionphp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(php'Invalidphp filterphp providedphp'php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_filtersphp[php]php php=php php$filterphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Addphp aphp writerphp.php php Aphp writerphp isphp responsiblephp forphp takingphp aphp log
php php php php php php*php messagephp andphp writingphp itphp outphp tophp storagephp.
php php php php php php*
php php php php php php*php php@paramphp php mixedphp php$writerphp Zendphp_Logphp_Writerphp_Abstractphp orphp Configphp array
php php php php php php*php php@returnphp Zendphp_Log
php php php php php php*php/
php php php php publicphp functionphp addWriterphp(php$writerphp)
php php php php php{
php php php php php php php php ifphp php(isphp_arrayphp(php$writerphp)php php|php|php php$writerphp instanceofphp php Zendphp_Configphp)php php{
php php php php php php php php php php php php php$writerphp php=php php$thisphp-php>php_constructWriterFromConfigphp(php$writerphp)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!php$writerphp instanceofphp Zendphp_Logphp_Writerphp_Abstractphp)php php{
php php php php php php php php php php php php php/php*php*php php@seephp Zendphp_Logphp_Exceptionphp php*php/
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Logphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Logphp_Exceptionphp(
php php php php php php php php php php php php php php php php php'Writerphp mustphp bephp anphp instancephp ofphp Zendphp_Logphp_Writerphp_Abstractphp'
php php php php php php php php php php php php php php php php php.php php'php orphp youphp shouldphp passphp aphp configurationphp arrayphp'
php php php php php php php php php php php php php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_writersphp[php]php php=php php$writerphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp anphp extraphp itemphp tophp passphp tophp thephp logphp writersphp.
php php php php php php*
php php php php php php*php php@paramphp php php$namephp php php php Namephp ofphp thephp field
php php php php php php*php php@paramphp php php$valuephp php php Valuephp ofphp thephp field
php php php php php php*php php@returnphp Zendphp_Log
php php php php php php*php/
php php php php publicphp functionphp setEventItemphp(php$namephp,php php$valuephp)
php php php php php{
php php php php php php php php php$thisphp-php>php_extrasphp php=php arrayphp_mergephp(php$thisphp-php>php_extrasphp,php arrayphp(php$namephp php=php>php php$valuephp)php)php;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Registerphp Loggingphp systemphp asphp anphp errorphp handlerphp tophp logphp phpphp errors
php php php php php php*php Notephp:php itphp stillphp callsphp thephp originalphp errorphp handlerphp ifphp setphp_errorphp_handlerphp isphp ablephp tophp returnphp itphp.
php php php php php php*
php php php php php php*php Errorsphp willphp bephp mappedphp asphp:
php php php php php php*php php php Ephp_NOTICEphp,php Ephp_USERphp_NOTICEphp php=php>php NOTICE
php php php php php php*php php php Ephp_WARNINGphp,php Ephp_COREphp_WARNINGphp,php Ephp_USERphp_WARNINGphp php=php>php WARN
php php php php php php*php php php Ephp_ERRORphp,php Ephp_USERphp_ERRORphp,php Ephp_COREphp_ERRORphp,php Ephp_RECOVERABLEphp_ERRORphp php=php>php ERR
php php php php php php*php php php Ephp_DEPRECATEDphp,php Ephp_STRICTphp,php Ephp_USERphp_DEPRECATEDphp php=php>php DEBUG
php php php php php php*php php php php(unknownphp/otherphp)php php=php>php INFO
php php php php php php*
php php php php php php*php php@linkphp httpphp:php/php/wwwphp.phpphp.netphp/manualphp/enphp/functionphp.setphp-errorphp-handlerphp.phpphp Customphp errorphp handler
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Log
php php php php php php*php/
php php php php publicphp functionphp registerErrorHandlerphp(php)
php php php php php{
php php php php php php php php php/php/php Onlyphp registerphp oncephp.php php Avoidsphp loopphp issuesphp ifphp itphp getsphp registeredphp twicephp.
php php php php php php php php ifphp php(php$thisphp-php>php_registeredErrorHandlerphp)php php{
php php php php php php php php php php php php returnphp php$thisphp;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_origErrorHandlerphp php=php setphp_errorphp_handlerphp(arrayphp(php$thisphp,php php'errorHandlerphp'php)php)php;

php php php php php php php php php/php/php Contructphp aphp defaultphp mapphp ofphp phpErrorsphp tophp Zendphp_Logphp prioritiesphp.
php php php php php php php php php/php/php Somephp ofphp thephp errorsphp arephp uncatchablephp,php butphp arephp includedphp forphp completeness
php php php php php php php php php$thisphp-php>php_errorHandlerMapphp php=php arrayphp(
php php php php php php php php php php php php Ephp_NOTICEphp php php php php php php php php php php php php=php>php Zendphp_Logphp:php:NOTICEphp,
php php php php php php php php php php php php Ephp_USERphp_NOTICEphp php php php php php php php=php>php Zendphp_Logphp:php:NOTICEphp,
php php php php php php php php php php php php Ephp_WARNINGphp php php php php php php php php php php php=php>php Zendphp_Logphp:php:WARNphp,
php php php php php php php php php php php php Ephp_COREphp_WARNINGphp php php php php php php=php>php Zendphp_Logphp:php:WARNphp,
php php php php php php php php php php php php Ephp_USERphp_WARNINGphp php php php php php php=php>php Zendphp_Logphp:php:WARNphp,
php php php php php php php php php php php php Ephp_ERRORphp php php php php php php php php php php php php php=php>php Zendphp_Logphp:php:ERRphp,
php php php php php php php php php php php php Ephp_USERphp_ERRORphp php php php php php php php php=php>php Zendphp_Logphp:php:ERRphp,
php php php php php php php php php php php php Ephp_COREphp_ERRORphp php php php php php php php php=php>php Zendphp_Logphp:php:ERRphp,
php php php php php php php php php php php php Ephp_RECOVERABLEphp_ERRORphp php=php>php Zendphp_Logphp:php:ERRphp,
php php php php php php php php php php php php Ephp_STRICTphp php php php php php php php php php php php php=php>php Zendphp_Logphp:php:DEBUGphp,
php php php php php php php php php)php;
php php php php php php php php php/php/php PHPphp php5php.php3php.php0php+
php php php php php php php php ifphp php(definedphp(php'Ephp_DEPRECATEDphp'php)php)php php{
php php php php php php php php php php php php php$thisphp-php>php_errorHandlerMapphp[php'Ephp_DEPRECATEDphp'php]php php=php Zendphp_Logphp:php:DEBUGphp;
php php php php php php php php php}
php php php php php php php php ifphp php(definedphp(php'Ephp_USERphp_DEPRECATEDphp'php)php)php php{
php php php php php php php php php php php php php$thisphp-php>php_errorHandlerMapphp[php'Ephp_USERphp_DEPRECATEDphp'php]php php=php Zendphp_Logphp:php:DEBUGphp;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_registeredErrorHandlerphp php=php truephp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Errorphp Handlerphp willphp convertphp errorphp intophp logphp messagephp,php andphp thenphp callphp thephp originalphp errorphp handler
php php php php php php*
php php php php php php*php php@linkphp httpphp:php/php/wwwphp.phpphp.netphp/manualphp/enphp/functionphp.setphp-errorphp-handlerphp.phpphp Customphp errorphp handler
php php php php php php*php php@paramphp intphp php$errno
php php php php php php*php php@paramphp stringphp php$errstr
php php php php php php*php php@paramphp stringphp php$errfile
php php php php php php*php php@paramphp intphp php$errline
php php php php php php*php php@paramphp arrayphp php$errcontext
php php php php php php*php php@returnphp boolean
php php php php php php*php/
php php php php publicphp functionphp errorHandlerphp(php$errnophp,php php$errstrphp,php php$errfilephp,php php$errlinephp,php php$errcontextphp)
php php php php php{
php php php php php php php php php$errorLevelphp php=php errorphp_reportingphp(php)php;

php php php php php php php php ifphp php(php$errorLevelphp php&php&php php$errnophp)php php{
php php php php php php php php php php php php ifphp php(issetphp(php$thisphp-php>php_errorHandlerMapphp[php$errnophp]php)php)php php{
php php php php php php php php php php php php php php php php php$priorityphp php=php php$thisphp-php>php_errorHandlerMapphp[php$errnophp]php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$priorityphp php=php Zendphp_Logphp:php:INFOphp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$thisphp-php>logphp(php$errstrphp,php php$priorityphp,php arrayphp(php'errnophp'php=php>php$errnophp,php php'filephp'php=php>php$errfilephp,php php'linephp'php=php>php$errlinephp,php php'contextphp'php=php>php$errcontextphp)php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$thisphp-php>php_origErrorHandlerphp php!php=php=php nullphp)php php{
php php php php php php php php php php php php returnphp callphp_userphp_funcphp(php$thisphp-php>php_origErrorHandlerphp,php php$errnophp,php php$errstrphp,php php$errfilephp,php php$errlinephp,php php$errcontextphp)php;
php php php php php php php php php}
php php php php php php php php returnphp falsephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp timestampphp formatphp forphp logphp entriesphp.
php php php php php php*
php php php php php php*php php@paramphp stringphp php$format
php php php php php php*php php@returnphp Zendphp_Log
php php php php php php*php/
php php php php publicphp functionphp setTimestampFormatphp(php$formatphp)
php php php php php{
php php php php php php php php php$thisphp-php>php_timestampFormatphp php=php php$formatphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp timestampphp formatphp usedphp forphp logphp entriesphp.
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getTimestampFormatphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_timestampFormatphp;
php php php php php}
php}
