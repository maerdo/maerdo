<php?php
php/php*php*
php php*php Zendphp Framework
php php*
php php*php LICENSE
php php*
php php*php Thisphp sourcephp filephp isphp subjectphp tophp thephp newphp BSDphp licensephp thatphp isphp bundled
php php*php withphp thisphp packagephp inphp thephp filephp LICENSEphp.txtphp.
php php*php Itphp isphp alsophp availablephp throughphp thephp worldphp-widephp-webphp atphp thisphp URLphp:
php php*php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsd
php php*php Ifphp youphp didphp notphp receivephp aphp copyphp ofphp thephp licensephp andphp arephp unablephp to
php php*php obtainphp itphp throughphp thephp worldphp-widephp-webphp,php pleasephp sendphp anphp email
php php*php tophp licensephp@zendphp.comphp sophp wephp canphp sendphp youphp aphp copyphp immediatelyphp.
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Httpphp_UserAgent
php php*php php@subpackagephp UserAgent
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/

php/php*php*
php php*php Listsphp ofphp Userphp Agentphp chainsphp forphp testingphp php:
php php*
php php*php php-php httpphp:php/php/wwwphp.useragentstringphp.comphp/layoutphp/useragentstringphp.php
php php*php php-php httpphp:php/php/userphp-agentphp-stringphp.infophp/listphp-ofphp-ua
php php*php php-php httpphp:php/php/wwwphp.userphp-agentsphp.orgphp/allagentsphp.xml
php php*php php-php httpphp:php/php/enphp.wikipediaphp.orgphp/wikiphp/Listphp_ofphp_userphp_agentsphp_forphp_mobilephp_phones
php php*php php-php httpphp:php/php/wwwphp.mobilemultimediaphp.bephp/frphp/
php php*
php php*php php@categoryphp php php Zend
php php*php php@packagephp php php php Zendphp_Httpphp_UserAgent
php php*php php@subpackagephp UserAgent
php php*php php@copyrightphp php Copyrightphp php(cphp)php php2php0php0php5php-php2php0php1php0php Zendphp Technologiesphp USAphp Incphp.php php(httpphp:php/php/wwwphp.zendphp.comphp)
php php*php php@licensephp php php php httpphp:php/php/frameworkphp.zendphp.comphp/licensephp/newphp-bsdphp php php php php Newphp BSDphp License
php php*php/
classphp Zendphp_Httpphp_UserAgentphp implementsphp Serializable
php{
php php php php php/php*php*
php php php php php php*php php'desktopphp'php byphp defaultphp ifphp thephp sequencephp returnphp falsephp forphp eachphp itemphp orphp isphp empty
php php php php php php*php/
php php php php constphp DEFAULTphp_IDENTIFICATIONphp_SEQUENCEphp php=php php'mobilephp,desktopphp'php;

php php php php php/php*php*
php php php php php php*php Defaultphp persitentphp storagephp adapterphp php:php Sessionphp orphp NonPersitent
php php php php php php*php/
php php php php constphp DEFAULTphp_PERSISTENTphp_STORAGEphp_ADAPTERphp php=php php'Sessionphp'php;

php php php php php/php*php*
php php php php php php*php php'desktopphp'php byphp defaultphp ifphp thephp sequencephp returnphp falsephp forphp eachphp item
php php php php php php*php/
php php php php constphp DEFAULTphp_BROWSERphp_TYPEphp php=php php'desktopphp'php;

php php php php php/php*php*
php php php php php php*php Defaultphp Userphp Agentphp chainphp tophp preventphp emptyphp value
php php php php php php*php/
php php php php constphp DEFAULTphp_HTTPphp_USERphp_AGENTphp php=php php'Mozillaphp/php4php.php0php php(compatiblephp;php MSIEphp php7php.php0php;php Windowsphp NTphp php5php.php1php)php'php;

php php php php php/php*php*
php php php php php php*php Defaultphp Httpphp Acceptphp paramphp tophp preventphp emptyphp value
php php php php php php*php/
php php php php constphp DEFAULTphp_HTTPphp_ACCEPTphp php=php php"applicationphp/xhtmlphp+xmlphp"php;

php php php php php/php*php*
php php php php php php*php Defaultphp markupphp language
php php php php php php*php/
php php php php constphp DEFAULTphp_MARKUPphp_LANGUAGEphp php=php php"xhtmlphp"php;

php php php php php/php*php*
php php php php php php*php Browserphp type
php php php php php php*
php php php php php php*php php@varphp string
php php php php php php*php/
php php php php protectedphp php$php_browserTypephp;

php php php php php/php*php*
php php php php php php*php Browserphp typephp class
php php php php php php*
php php php php php php*php Mapphp ofphp browserphp typesphp tophp classesphp.
php php php php php php*
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_browserTypeClassphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Arrayphp tophp storephp config
php php php php php php*
php php php php php php*php Defaultphp valuesphp arephp providedphp tophp ensurephp specificphp keysphp arephp presentphp at
php php php php php php*php instantiationphp.
php php php php php php*
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_configphp php=php arrayphp(
php php php php php php php php php'identificationphp_sequencephp'php php=php>php selfphp:php:DEFAULTphp_IDENTIFICATIONphp_SEQUENCEphp,
php php php php php php php php php'storagephp'php php php php php php php php php php php php php php php php php php=php>php arrayphp(
php php php php php php php php php php php php php'adapterphp'php php php php php php php php php php php php php php=php>php selfphp:php:DEFAULTphp_PERSISTENTphp_STORAGEphp_ADAPTERphp,
php php php php php php php php php)php,
php php php php php)php;

php php php php php/php*php*
php php php php php php*php Identifiedphp device
php php php php php php*
php php php php php php*php php@varphp Zendphp_Httpphp_UserAgentphp_Device
php php php php php php*php/
php php php php protectedphp php$php_devicephp;

php php php php php/php*php*
php php php php php php*php Whetherphp orphp notphp thisphp instancephp isphp immutablephp.
php php php php php php*
php php php php php php*php Ifphp truephp,php nonephp ofphp thephp followingphp mayphp bephp modifiedphp:
php php php php php php*php php-php php$php_server
php php php php php php*php php-php php$php_browserType
php php php php php php*php php-php Userphp-Agentphp php(definedphp inphp php$php_serverphp)
php php php php php php*php php-php HTTPphp Acceptphp valuephp php(definedphp inphp php$php_serverphp)
php php php php php php*php php-php php$php_storage
php php php php php php*
php php php php php php*php php@varphp bool
php php php php php php*php/
php php php php protectedphp php$php_immutablephp php=php falsephp;

php php php php php/php*php*
php php php php php php*php Pluginphp loaders
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_loadersphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Validphp pluginphp loaderphp types
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_loaderTypesphp php=php arrayphp(php'storagephp'php,php php'devicephp'php)php;

php php php php php/php*php*
php php php php php php*php Tracephp ofphp itemsphp matchedphp tophp identifyphp thephp browserphp type
php php php php php php*
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_matchLogphp php=php arrayphp(php)php;

php php php php php/php*php*
php php php php php php*php Serverphp variable
php php php php php php*
php php php php php php*php php@varphp array
php php php php php php*php/
php php php php protectedphp php$php_serverphp;

php php php php php/php*php*
php php php php php php*php Persistentphp storagephp handler
php php php php php php*
php php php php php php*php php@varphp Zendphp_Httpphp_UserAgentphp_Storage
php php php php php php*php/
php php php php protectedphp php$php_storagephp;

php php php php php/php*php*
php php php php php php*php Constructor
php php php php php php*
php php php php php php*php php@paramphp php nullphp|arrayphp|Zendphp_Configphp|ArrayAccessphp php$options
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php publicphp functionphp php_php_constructphp(php$optionsphp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(nullphp php!php=php=php php$optionsphp)php php{
php php php php php php php php php php php php php$thisphp-php>setOptionsphp(php$optionsphp)php;
php php php php php php php php php}
php php php php php}

php php php php php/php*php*
php php php php php php*php Serializedphp representationphp ofphp thephp object
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp serializephp(php)
php php php php php{
php php php php php php php php php$specphp php=php arrayphp(
php php php php php php php php php php php php php'browserphp_typephp'php php=php>php php$thisphp-php>php_browserTypephp,
php php php php php php php php php php php php php'configphp'php php php php php php php php=php>php php$thisphp-php>php_configphp,
php php php php php php php php php php php php php'devicephp_classphp'php php=php>php getphp_classphp(php$thisphp-php>php_devicephp)php,
php php php php php php php php php php php php php'devicephp'php php php php php php php php=php>php php$thisphp-php>php_devicephp-php>serializephp(php)php,
php php php php php php php php php php php php php'userphp_agentphp'php php php php=php>php php$thisphp-php>getServerValuephp(php'httpphp_userphp_agentphp'php)php,
php php php php php php php php php php php php php'httpphp_acceptphp'php php php=php>php php$thisphp-php>getServerValuephp(php'httpphp_acceptphp'php)php,
php php php php php php php php php)php;
php php php php php php php php returnphp serializephp(php$specphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Unserializephp aphp previousphp representationphp ofphp thephp object
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$serialized
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php publicphp functionphp unserializephp(php$serializedphp)
php php php php php{
php php php php php php php php php$specphp php=php unserializephp(php$serializedphp)php;

php php php php php php php php php$thisphp-php>setOptionsphp(php$specphp)php;

php php php php php php php php php/php/php Determinephp devicephp classphp andphp ensurephp thephp classphp isphp loaded
php php php php php php php php php$deviceClassphp php php php php php php php php php php=php php$specphp[php'devicephp_classphp'php]php;
php php php php php php php php ifphp php(php!classphp_existsphp(php$deviceClassphp)php)php php{
php php php php php php php php php php php php php$thisphp-php>php_getUserAgentDevicephp(php$thisphp-php>getBrowserTypephp(php)php)php;
php php php php php php php php php}

php php php php php php php php php/php/php Getphp devicephp specificationphp andphp instantiate
php php php php php php php php php$deviceSpecphp php php php php php php php php php php php php=php unserializephp(php$specphp[php'devicephp'php]php)php;
php php php php php php php php php$deviceSpecphp[php'php_configphp'php]php php=php php$thisphp-php>getConfigphp(php)php;
php php php php php php php php php$deviceSpecphp[php'php_serverphp'php]php php=php php$thisphp-php>getServerphp(php)php;
php php php php php php php php php$thisphp-php>php_devicephp php=php newphp php$deviceClassphp(php$deviceSpecphp)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Configurephp instance
php php php php php php*
php php php php php php*php php@paramphp php arrayphp|Zendphp_Configphp|ArrayAccessphp php$options
php php php php php php*php php@returnphp Zendphp_Httpphp_UserAgent
php php php php php php*php/
php php php php publicphp functionphp setOptionsphp(php$optionsphp)
php php php php php{
php php php php php php php php ifphp php(php$optionsphp instanceofphp Zendphp_Configphp)php php{
php php php php php php php php php php php php php$optionsphp php=php php$optionsphp-php>toArrayphp(php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!isphp_arrayphp(php$optionsphp)
php php php php php php php php php php php php php&php&php php!php$optionsphp instanceofphp ArrayAccess
php php php php php php php php php php php php php&php&php php!php$optionsphp instanceofphp Traversable
php php php php php php php php php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Httpphp/UserAgentphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Httpphp_UserAgentphp_Exceptionphp(sprintfphp(
php php php php php php php php php php php php php php php php php'Invalidphp argumentphp;php expectedphp arrayphp,php Zendphp_Configphp objectphp,php orphp objectphp implementingphp ArrayAccessphp andphp Traversablephp;php receivedphp php%sphp'php,
php php php php php php php php php php php php php php php php php(isphp_objectphp(php$optionsphp)php php?php getphp_classphp(php$optionsphp)php php:php gettypephp(php$optionsphp)php)
php php php php php php php php php php php php php)php)php;
php php php php php php php php php}

php php php php php php php php php/php/php Setphp php$php_SERVERphp first
php php php php php php php php ifphp php(issetphp(php$optionsphp[php'serverphp'php]php)php)php php{
php php php php php php php php php php php php php$thisphp-php>setServerphp(php$optionsphp[php'serverphp'php]php)php;
php php php php php php php php php php php php unsetphp(php$optionsphp[php'serverphp'php]php)php;
php php php php php php php php php}

php php php php php php php php php/php/php Getphp pluginphp loadersphp sorted
php php php php php php php php ifphp php(issetphp(php$optionsphp[php'pluginphp_loaderphp'php]php)php)php php{
php php php php php php php php php php php php php$plConfigphp php=php php$optionsphp[php'pluginphp_loaderphp'php]php;
php php php php php php php php php php php php ifphp php(isphp_arrayphp(php$plConfigphp)php php|php|php php$plConfigphp instanceofphp Traversablephp)php php{
php php php php php php php php php php php php php php php php foreachphp php(php$plConfigphp asphp php$typephp php=php>php php$classphp)php php{
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setPluginLoaderphp(php$typephp,php php$classphp)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}
php php php php php php php php php php php php unsetphp(php$plConfigphp,php php$optionsphp[php'pluginphp_loaderphp'php]php)php;
php php php php php php php php php}

php php php php php php php php php/php/php Andphp thenphp loopphp throughphp thephp remainingphp options
php php php php php php php php php$configphp php=php arrayphp(php)php;
php php php php php php php php foreachphp php(php$optionsphp asphp php$keyphp php=php>php php$valuephp)php php{
php php php php php php php php php php php php switchphp php(strtolowerphp(php$keyphp)php)php php{
php php php php php php php php php php php php php php php php casephp php'browserphp_typephp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setBrowserTypephp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php casephp php'httpphp_acceptphp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setHttpAcceptphp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php casephp php'userphp_agentphp'php:
php php php php php php php php php php php php php php php php php php php php php$thisphp-php>setUserAgentphp(php$valuephp)php;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php php php php defaultphp:
php php php php php php php php php php php php php php php php php php php php php/php/php Cachephp remainingphp optionsphp forphp php$php_config
php php php php php php php php php php php php php php php php php php php php php$configphp[php$keyphp]php php=php php$valuephp;
php php php php php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php}
php php php php php php php php php}
php php php php php php php php php$thisphp-php>setConfigphp(php$configphp)php;

php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Comparisonphp ofphp thephp UserAgentphp chainphp andphp browserphp signaturesphp.
php php php php php php*
php php php php php php*php Thephp comparisonphp isphp casephp-insensitivephp php:php thephp browserphp signaturesphp mustphp bephp inphp lower
php php php php php php*php case
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$deviceClassphp Namephp ofphp classphp againstphp whichphp aphp matchphp willphp bephp attempted
php php php php php php*php php@returnphp bool
php php php php php php*php/
php php php php protectedphp functionphp php_matchphp(php$deviceClassphp)
php php php php php{
php php php php php php php php php/php/php Validatephp devicephp class
php php php php php php php php php$rphp php=php newphp ReflectionClassphp(php$deviceClassphp)php;
php php php php php php php php ifphp php(php!php$rphp-php>implementsInterfacephp(php'Zendphp_Httpphp_UserAgentphp_Devicephp'php)php)php php{
php php php php php php php php php php php php throwphp newphp Zendphp_Httpphp_UserAgentphp_Exceptionphp(sprintfphp(
php php php php php php php php php php php php php php php php php'Invalidphp devicephp classphp providedphp php(php"php%sphp"php)php;php mustphp implementphp Zendphp_Httpphp_UserAgentphp_Devicephp'php,
php php php php php php php php php php php php php php php php php$deviceClass
php php php php php php php php php php php php php)php)php;
php php php php php php php php php}

php php php php php php php php php$userAgentphp php=php php$thisphp-php>getUserAgentphp(php)php;

php php php php php php php php php/php/php Callphp matchphp methodphp onphp devicephp class
php php php php php php php php returnphp callphp_userphp_funcphp(
php php php php php php php php php php php php arrayphp(php$deviceClassphp,php php'matchphp'php)php,
php php php php php php php php php php php php php$userAgentphp,
php php php php php php php php php php php php php$thisphp-php>getServerphp(php)
php php php php php php php php php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Loadsphp classphp forphp aphp userphp agentphp device
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$browserTypephp Browserphp type
php php php php php php*php php@returnphp string
php php php php php php*php php@throwsphp Zendphp_Loaderphp_PluginLoaderphp_Exceptionphp ifphp unablephp tophp loadphp UAphp device
php php php php php php*php/
php php php php protectedphp functionphp php_getUserAgentDevicephp(php$browserTypephp)
php php php php php{
php php php php php php php php php$browserTypephp php=php strtolowerphp(php$browserTypephp)php;
php php php php php php php php ifphp php(issetphp(php$thisphp-php>php_browserTypeClassphp[php$browserTypephp]php)php)php php{
php php php php php php php php php php php php returnphp php$thisphp-php>php_browserTypeClassphp[php$browserTypephp]php;
php php php php php php php php php}

php php php php php php php php ifphp php(issetphp(php$thisphp-php>php_configphp[php$browserTypephp]php)
php php php php php php php php php php php php php&php&php issetphp(php$thisphp-php>php_configphp[php$browserTypephp]php[php'devicephp'php]php)
php php php php php php php php php)php php{
php php php php php php php php php php php php php$deviceConfigphp php=php php$thisphp-php>php_configphp[php$browserTypephp]php[php'devicephp'php]php;
php php php php php php php php php php php php ifphp php(isphp_arrayphp(php$deviceConfigphp)php php&php&php issetphp(php$deviceConfigphp[php'classnamephp'php]php)php)php php{
php php php php php php php php php php php php php php php php php$devicephp php=php php(stringphp)php php$deviceConfigphp[php'classnamephp'php]php;
php php php php php php php php php php php php php php php php ifphp php(php!classphp_existsphp(php$devicephp)php)php php{
php php php php php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Httpphp/UserAgentphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php php php php php php php php php throwphp newphp Zendphp_Httpphp_UserAgentphp_Exceptionphp(sprintfphp(
php php php php php php php php php php php php php php php php php php php php php php php php php'Invalidphp classnamephp php"php%sphp"php providedphp inphp devicephp configurationphp forphp browserphp typephp php"php%sphp"php'php,
php php php php php php php php php php php php php php php php php php php php php php php php php$devicephp,
php php php php php php php php php php php php php php php php php php php php php php php php php$browserType
php php php php php php php php php php php php php php php php php php php php php)php)php;
php php php php php php php php php php php php php php php php php}
php php php php php php php php php php php php php}php elseifphp php(isphp_arrayphp(php$deviceConfigphp)php php&php&php issetphp(php$deviceConfigphp[php'pathphp'php]php)php)php php{
php php php php php php php php php php php php php php php php php$loaderphp php=php php$thisphp-php>getPluginLoaderphp(php'devicephp'php)php;
php php php php php php php php php php php php php php php php php$pathphp php php php=php php$deviceConfigphp[php'pathphp'php]php;
php php php php php php php php php php php php php php php php php$prefixphp php=php issetphp(php$deviceConfigphp[php'prefixphp'php]php)php php?php php$deviceConfigphp[php'prefixphp'php]php php:php php'Zendphp_Httpphp_UserAgentphp'php;
php php php php php php php php php php php php php php php php php$loaderphp-php>addPrefixPathphp(php$prefixphp,php php$pathphp)php;

php php php php php php php php php php php php php php php php php$devicephp php=php php$loaderphp-php>loadphp(php$browserTypephp)php;
php php php php php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php php php php php$loaderphp php=php php$thisphp-php>getPluginLoaderphp(php'devicephp'php)php;
php php php php php php php php php php php php php php php php php$devicephp php=php php$loaderphp-php>loadphp(php$browserTypephp)php;
php php php php php php php php php php php php php}
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php$loaderphp php=php php$thisphp-php>getPluginLoaderphp(php'devicephp'php)php;
php php php php php php php php php php php php php$devicephp php=php php$loaderphp-php>loadphp(php$browserTypephp)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_browserTypeClassphp[php$browserTypephp]php php=php php$devicephp;

php php php php php php php php returnphp php$devicephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp thephp Userphp Agentphp value
php php php php php php*
php php php php php php*php Ifphp php$userAgentphp paramphp isphp nullphp,php thephp valuephp ofphp php$php_serverphp[php'HTTPphp_USERphp_AGENTphp'php]php is
php php php php php php*php returnedphp.
php php php php php php*
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getUserAgentphp(php)
php php php php php{
php php php php php php php php ifphp php(nullphp php=php=php=php php(php$uaphp php=php php$thisphp-php>getServerValuephp(php'httpphp_userphp_agentphp'php)php)php)php php{
php php php php php php php php php php php php php$uaphp php=php selfphp:php:DEFAULTphp_HTTPphp_USERphp_AGENTphp;
php php php php php php php php php php php php php$thisphp-php>setUserAgentphp(php$uaphp)php;
php php php php php php php php php}

php php php php php php php php returnphp php$uaphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Forcephp orphp replacephp thephp UAphp chainphp inphp php$php_serverphp variable
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$userAgentphp Forcedphp UserAgentphp chain
php php php php php php*php php@returnphp Zendphp_Httpphp_UserAgent
php php php php php php*php/
php php php php publicphp functionphp setUserAgentphp(php$userAgentphp)
php php php php php{
php php php php php php php php php$thisphp-php>setServerValuephp(php'httpphp_userphp_agentphp'php,php php$userAgentphp)php;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp thephp HTTPphp Acceptphp serverphp param
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$httpAcceptphp php(optionphp)php forcedphp HTTPphp Acceptphp chain
php php php php php php*php php@returnphp string
php php php php php php*php/
php php php php publicphp functionphp getHttpAcceptphp(php$httpAcceptphp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(nullphp php=php=php=php php(php$acceptphp php=php php$thisphp-php>getServerValuephp(php'httpphp_acceptphp'php)php)php)php php{
php php php php php php php php php php php php php$acceptphp php=php selfphp:php:DEFAULTphp_HTTPphp_ACCEPTphp;
php php php php php php php php php php php php php$thisphp-php>setHttpAcceptphp(php$acceptphp)php;
php php php php php php php php php}
php php php php php php php php returnphp php$acceptphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Forcephp orphp replacephp thephp HTTPphp_ACCEPTphp chainphp inphp selfphp:php:php$php_serverphp variable
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$httpAcceptphp Forcedphp HTTPphp Acceptphp chain
php php php php php php*php php@returnphp Zendphp_Httpphp_UserAgent
php php php php php php*php/
php php php php publicphp functionphp setHttpAcceptphp(php$httpAcceptphp)
php php php php php{
php php php php php php php php php$thisphp-php>setServerValuephp(php'httpphp_acceptphp'php,php php$httpAcceptphp)php;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Returnsphp thephp persistentphp storagephp handler
php php php php php php*
php php php php php php*php Sessionphp storagephp isphp usedphp byphp defaultphp unlessphp aphp differentphp storagephp adapter
php php php php php php*php hasphp beenphp setphp viaphp thephp php"persistentphp_storagephp_adapterphp"php keyphp.php Thatphp keyphp should
php php php php php php*php containphp eitherphp aphp fullyphp qualifiedphp classphp namephp,php orphp aphp shortphp namephp that
php php php php php php*php resolvesphp viaphp thephp pluginphp loaderphp.
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$browserphp Browserphp identifierphp php(Userphp Agentphp chainphp)
php php php php php php*php php@returnphp Zendphp_Httpphp_UserAgentphp_Storage
php php php php php php*php/
php php php php publicphp functionphp getStoragephp(php$browserphp php=php nullphp)
php php php php php{
php php php php php php php php ifphp php(nullphp php=php=php=php php$browserphp)php php{
php php php php php php php php php php php php php$browserphp php=php php$thisphp-php>getUserAgentphp(php)php;
php php php php php php php php php}
php php php php php php php php ifphp php(nullphp php=php=php=php php$thisphp-php>php_storagephp)php php{
php php php php php php php php php php php php php$configphp php php=php php$thisphp-php>php_configphp[php'storagephp'php]php;
php php php php php php php php php php php php php$adapterphp php=php php$configphp[php'adapterphp'php]php;
php php php php php php php php php php php php ifphp php(php!classphp_existsphp(php$adapterphp)php)php php{
php php php php php php php php php php php php php php php php php$loaderphp php=php php$thisphp-php>getPluginLoaderphp(php'storagephp'php)php;
php php php php php php php php php php php php php php php php php$adapterphp php=php php$loaderphp-php>loadphp(php$adapterphp)php;
php php php php php php php php php php php php php php php php php$loaderphp php=php php$thisphp-php>getPluginLoaderphp(php'storagephp'php)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$optionsphp php=php arrayphp(php'browserphp_typephp'php php=php>php php$browserphp)php;
php php php php php php php php php php php php ifphp php(issetphp(php$configphp[php'optionsphp'php]php)php)php php{
php php php php php php php php php php php php php php php php php$optionsphp php=php arrayphp_mergephp(php$optionsphp,php php$configphp[php'optionsphp'php]php)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$thisphp-php>setStoragephp(newphp php$adapterphp(php$optionsphp)php)php;
php php php php php php php php php}
php php php php php php php php returnphp php$thisphp-php>php_storagephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setsphp thephp persistentphp storagephp handler
php php php php php php*
php php php php php php*php php@paramphp php Zendphp_Httpphp_UserAgentphp_Storagephp php$storage
php php php php php php*php php@returnphp Zendphp_Httpphp_UserAgent
php php php php php php*php/
php php php php publicphp functionphp setStoragephp(Zendphp_Httpphp_UserAgentphp_Storagephp php$storagephp)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_immutablephp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Httpphp/UserAgentphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Httpphp_UserAgentphp_Exceptionphp(
php php php php php php php php php php php php php php php php php'Thephp Userphp-Agentphp devicephp objectphp hasphp alreadyphp beenphp retrievedphp;php thephp storagephp objectphp isphp nowphp immutablephp'
php php php php php php php php php php php php php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_storagephp php=php php$storagephp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Cleanphp thephp persistentphp storage
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$browserphp Browserphp identifierphp php(Userphp Agentphp chainphp)
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php publicphp functionphp clearStoragephp(php$browserphp php=php nullphp)
php php php php php{
php php php php php php php php php$thisphp-php>getStoragephp(php$browserphp)php-php>clearphp(php)php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp userphp configuration
php php php php php php*
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp getConfigphp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_configphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Configphp parametersphp isphp anphp Arrayphp orphp aphp Zendphp_Configphp object
php php php php php php*
php php php php php php*php Thephp allowedphp parametersphp arephp php:
php php php php php php*php php-php thephp identificationphp sequencephp php(canphp bephp emptyphp)php php=php>php desktopphp browserphp typephp isphp the
php php php php php php*php defaultphp browserphp typephp returned
php php php php php php*php php$configphp[php'identificationphp_sequencephp'php]php php:php php'php,php'php separatedphp browserphp types
php php php php php php*php php-php thephp persistentphp storagephp adapter
php php php php php php*php php$configphp[php'persistentphp_storagephp_adapterphp'php]php php=php php"Sessionphp"php orphp php"NonPersistentphp"
php php php php php php*php php-php tophp addphp orphp replacephp aphp browserphp typephp device
php php php php php php*php php$configphp[php(typephp)php]php[php'devicephp'php]php[php'pathphp'php]
php php php php php php*php php$configphp[php(typephp)php]php[php'devicephp'php]php[php'classnamephp'php]
php php php php php php*php php-php tophp addphp orphp replacephp aphp browserphp typephp featuresphp adapter
php php php php php php*php php$configphp[php(typephp)php]php[php'featuresphp'php]php[php'pathphp'php]
php php php php php php*php php$configphp[php(typephp)php]php[php'featuresphp'php]php[php'classnamephp'php]
php php php php php php*
php php php php php php*php php@paramphp php mixedphp php$configphp php(optionphp)php Configphp array
php php php php php php*php php@returnphp Zendphp_Httpphp_UserAgent
php php php php php php*php/
php php php php publicphp functionphp setConfigphp(php$configphp php=php arrayphp(php)php)
php php php php php{
php php php php php php php php ifphp php(php$configphp instanceofphp Zendphp_Configphp)php php{
php php php php php php php php php php php php php$configphp php=php php$configphp-php>toArrayphp(php)php;
php php php php php php php php php}

php php php php php php php php php/php/php Verifyphp thatphp Configphp parametersphp arephp inphp anphp arrayphp.
php php php php php php php php ifphp php(php!isphp_arrayphp(php$configphp)php php&php&php php!php$configphp instanceofphp Traversablephp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Httpphp/UserAgentphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Httpphp_UserAgentphp_Exceptionphp(sprintfphp(
php php php php php php php php php php php php php php php php php'Configphp parametersphp mustphp bephp inphp anphp arrayphp orphp aphp Traversablephp objectphp;php receivedphp php"php%sphp"php'php,
php php php php php php php php php php php php php php php php php(isphp_objectphp(php$configphp)php php?php getphp_classphp(php$configphp)php php:php gettypephp(php$configphp)php)
php php php php php php php php php php php php php)php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php$configphp instanceofphp Traversablephp)php php{
php php php php php php php php php php php php php$tmpphp php=php arrayphp(php)php;
php php php php php php php php php php php php foreachphp php(php$configphp asphp php$keyphp php=php>php php$valuephp)php php{
php php php php php php php php php php php php php php php php php$tmpphp[php$keyphp]php php=php php$valuephp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$configphp php=php php$tmpphp;
php php php php php php php php php php php php unsetphp(php$tmpphp)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_configphp php=php arrayphp_mergephp(php$thisphp-php>php_configphp,php php$configphp)php;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php php@returnphp thephp php$device
php php php php php php*php/
php php php php publicphp functionphp getDevicephp(php)
php php php php php{
php php php php php php php php ifphp php(nullphp php!php=php=php php$thisphp-php>php_devicephp)php php{
php php php php php php php php php php php php returnphp php$thisphp-php>php_devicephp;
php php php php php php php php php}

php php php php php php php php php$userAgentphp php=php php$thisphp-php>getUserAgentphp(php)php;

php php php php php php php php php/php/php searchphp anphp existingphp identificationphp inphp thephp session
php php php php php php php php php$storagephp php=php php$thisphp-php>getStoragephp(php$userAgentphp)php;

php php php php php php php php ifphp php(php!php$storagephp-php>isEmptyphp(php)php)php php{
php php php php php php php php php php php php php/php/php Ifphp thephp userphp agentphp andphp featuresphp arephp alreadyphp existingphp,php the
php php php php php php php php php php php php php/php/php Zendphp_Httpphp_UserAgentphp objectphp isphp serializedphp inphp thephp session
php php php php php php php php php php php php php$objectphp php=php php$storagephp-php>readphp(php)php;
php php php php php php php php php php php php php$thisphp-php>unserializephp(php$objectphp)php;
php php php php php php php php php}php elsephp php{
php php php php php php php php php php php php php/php/php Otherwisephp,php thephp identificationphp isphp madephp andphp storedphp inphp thephp sessionphp.
php php php php php php php php php php php php php/php/php Findphp thephp browserphp typephp:
php php php php php php php php php php php php php$thisphp-php>setBrowserTypephp(php$thisphp-php>php_matchUserAgentphp(php)php)php;
php php php php php php php php php php php php php$thisphp-php>php_createDevicephp(php)php;

php php php php php php php php php php php php php/php/php putphp thephp resultphp inphp storagephp:
php php php php php php php php php php php php php$thisphp-php>getStoragephp(php$userAgentphp)
php php php php php php php php php php php php php php php php php php-php>writephp(php$thisphp-php>serializephp(php)php)php;
php php php php php php php php php}

php php php php php php php php php/php/php Markphp thephp objectphp asphp immutable
php php php php php php php php php$thisphp-php>php_immutablephp php=php truephp;

php php php php php php php php php/php/php Returnphp thephp devicephp instance
php php php php php php php php returnphp php$thisphp-php>php_devicephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp thephp browserphp type
php php php php php php*
php php php php php php*php php@returnphp stringphp php$browserType
php php php php php php*php/
php php php php publicphp functionphp getBrowserTypephp(php)
php php php php php{
php php php php php php php php returnphp php$thisphp-php>php_browserTypephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp thephp browserphp php"typephp"
php php php php php php*
php php php php php php*php php@paramphp stringphp php$browserType
php php php php php php*php php@returnphp Zendphp_Httpphp_UserAgent
php php php php php php*php/
php php php php publicphp functionphp setBrowserTypephp(php$browserTypephp)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_immutablephp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Httpphp/UserAgentphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Httpphp_UserAgentphp_Exceptionphp(
php php php php php php php php php php php php php php php php php'Thephp Userphp-Agentphp devicephp objectphp hasphp alreadyphp beenphp retrievedphp;php thephp browserphp typephp isphp nowphp immutablephp'
php php php php php php php php php php php php php)php;
php php php php php php php php php}

php php php php php php php php php$thisphp-php>php_browserTypephp php=php php$browserTypephp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp thephp php"php$php_SERVERphp"php array
php php php php php php*
php php php php php php*php Basicallyphp,php thephp php$php_SERVERphp arrayphp orphp anphp equivalentphp containerphp storingphp the
php php php php php php*php dataphp thatphp willphp bephp introspectedphp.
php php php php php php*
php php php php php php*php Ifphp thephp valuephp hasphp notphp beenphp previouslyphp setphp,php itphp setsphp itselfphp fromphp the
php php php php php php*php php$php_SERVERphp superglobalphp.
php php php php php php*
php php php php php php*php php@returnphp array
php php php php php php*php/
php php php php publicphp functionphp getServerphp(php)
php php php php php{
php php php php php php php php ifphp php(nullphp php=php=php=php php$thisphp-php>php_serverphp)php php{
php php php php php php php php php php php php php$thisphp-php>setServerphp(php$php_SERVERphp)php;
php php php php php php php php php}
php php php php php php php php returnphp php$thisphp-php>php_serverphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp thephp php"php$php_SERVERphp"php array
php php php php php php*
php php php php php php*php Basicallyphp,php thephp php$php_SERVERphp arrayphp orphp anphp equivalentphp containerphp storingphp the
php php php php php php*php dataphp thatphp willphp bephp introspectedphp.
php php php php php php*
php php php php php php*php php@paramphp php arrayphp|ArrayAccessphp php$server
php php php php php php*php php@returnphp void
php php php php php php*php php@throwsphp Zendphp_Httpphp_UserAgentphp_Exceptionphp onphp invalidphp parameter
php php php php php php*php/
php php php php publicphp functionphp setServerphp(php$serverphp)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_immutablephp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Httpphp/UserAgentphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Httpphp_UserAgentphp_Exceptionphp(
php php php php php php php php php php php php php php php php php'Thephp Userphp-Agentphp devicephp objectphp hasphp alreadyphp beenphp retrievedphp;php thephp serverphp arrayphp isphp nowphp immutablephp'
php php php php php php php php php php php php php)php;
php php php php php php php php php}

php php php php php php php php ifphp php(php!isphp_arrayphp(php$serverphp)php php&php&php php!php$serverphp instanceofphp Traversablephp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Httpphp/UserAgentphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Httpphp_UserAgentphp_Exceptionphp(sprintfphp(
php php php php php php php php php php php php php php php php php'Expectedphp anphp arrayphp orphp objectphp implementingphp Traversablephp;php receivedphp php%sphp'php,
php php php php php php php php php php php php php php php php php(isphp_objectphp(php$serverphp)php php?php getphp_classphp(php$serverphp)php php:php gettypephp(php$serverphp)php)
php php php php php php php php php php php php php)php)php;
php php php php php php php php php}

php php php php php php php php php/php/php Getphp anphp arrayphp ifphp wephp donphp'tphp havephp one
php php php php php php php php ifphp php(php$serverphp instanceofphp ArrayObjectphp)php php{
php php php php php php php php php php php php php$serverphp php=php php$serverphp-php>getArrayCopyphp(php)php;
php php php php php php php php php}php elseifphp php(php$serverphp instanceofphp Traversablephp)php php{
php php php php php php php php php php php php php$tmpphp php=php arrayphp(php)php;
php php php php php php php php php php php php foreachphp php(php$serverphp asphp php$keyphp php=php>php php$valuephp)php php{
php php php php php php php php php php php php php php php php php$tmpphp[php$keyphp]php php=php php$valuephp;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$serverphp php=php php$tmpphp;
php php php php php php php php php php php php unsetphp(php$tmpphp)php;
php php php php php php php php php}

php php php php php php php php php/php/php Normalizephp keyphp case
php php php php php php php php php$serverphp php=php arrayphp_changephp_keyphp_casephp(php$serverphp,php CASEphp_LOWERphp)php;

php php php php php php php php php$thisphp-php>php_serverphp php=php php$serverphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Retrievephp aphp serverphp value
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$key
php php php php php php*php php@returnphp mixed
php php php php php php*php/
php php php php publicphp functionphp getServerValuephp(php$keyphp)
php php php php php{
php php php php php php php php php$keyphp php php php php=php strtolowerphp(php$keyphp)php;
php php php php php php php php php$serverphp php=php php$thisphp-php>getServerphp(php)php;
php php php php php php php php php$returnphp php=php nullphp;
php php php php php php php php ifphp php(issetphp(php$serverphp[php$keyphp]php)php)php php{
php php php php php php php php php php php php php$returnphp php=php php$serverphp[php$keyphp]php;
php php php php php php php php php}
php php php php php php php php unsetphp(php$serverphp)php;
php php php php php php php php returnphp php$returnphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp aphp serverphp value
php php php php php php*
php php php php php php*php php@paramphp php stringphp|intphp|floatphp php$key
php php php php php php*php php@paramphp php mixedphp php$value
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php publicphp functionphp setServerValuephp(php$keyphp,php php$valuephp)
php php php php php{
php php php php php php php php ifphp php(php$thisphp-php>php_immutablephp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Httpphp/UserAgentphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Httpphp_UserAgentphp_Exceptionphp(
php php php php php php php php php php php php php php php php php'Thephp Userphp-Agentphp devicephp objectphp hasphp alreadyphp beenphp retrievedphp;php thephp serverphp arrayphp isphp nowphp immutablephp'
php php php php php php php php php php php php php)php;
php php php php php php php php php}

php php php php php php php php php$serverphp php=php php$thisphp-php>getServerphp(php)php;php php/php/php ensurephp itphp'sphp beenphp initialized
php php php php php php php php php$keyphp php php php php=php strtolowerphp(php$keyphp)php;
php php php php php php php php php$thisphp-php>php_serverphp[php$keyphp]php php=php php$valuephp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Setphp pluginphp loader
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$typephp Typephp ofphp pluginphp loaderphp;php onephp ofphp php'storagephp'php,php php(php?php)
php php php php php php*php php@paramphp php stringphp|Zendphp_Loaderphp_PluginLoaderphp php$loader
php php php php php php*php php@returnphp Zendphp_Httpphp_UserAgent
php php php php php php*php/
php php php php publicphp functionphp setPluginLoaderphp(php$typephp,php php$loaderphp)
php php php php php{
php php php php php php php php php$typephp php php php php php php php=php php$thisphp-php>php_validateLoaderTypephp(php$typephp)php;

php php php php php php php php ifphp php(isphp_stringphp(php$loaderphp)php)php php{
php php php php php php php php php php php php ifphp php(php!classphp_existsphp(php$loaderphp)php)php php{
php php php php php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Loaderphp.phpphp'php;
php php php php php php php php php php php php php php php php Zendphp_Loaderphp:php:loadClassphp(php$loaderphp)php;
php php php php php php php php php php php php php}
php php php php php php php php php php php php php$loaderphp php=php newphp php$loaderphp(php)php;
php php php php php php php php php}php elseifphp php(php!isphp_objectphp(php$loaderphp)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Httpphp/UserAgentphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Httpphp_UserAgentphp_Exceptionphp(sprintfphp(
php php php php php php php php php php php php php php php php php'Expectedphp aphp pluginphp loaderphp classphp orphp objectphp;php receivedphp php%sphp'php,
php php php php php php php php php php php php php php php php gettypephp(php$loaderphp)
php php php php php php php php php php php php php)php)php;
php php php php php php php php php}
php php php php php php php php ifphp php(php!php$loaderphp instanceofphp Zendphp_Loaderphp_PluginLoaderphp)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Httpphp/UserAgentphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Httpphp_UserAgentphp_Exceptionphp(sprintfphp(
php php php php php php php php php php php php php php php php php'Expectedphp anphp objectphp extendingphp Zendphp_Loaderphp_PluginLoaderphp;php receivedphp php%sphp'php,
php php php php php php php php php php php php php php php php getphp_classphp(php$loaderphp)
php php php php php php php php php php php php php)php)php;
php php php php php php php php php}

php php php php php php php php php$basePrefixphp php=php php'Zendphp_Httpphp_UserAgentphp_php'php;
php php php php php php php php php$basePathphp php php php=php php'Zendphp/Httpphp/UserAgentphp/php'php;
php php php php php php php php switchphp php(php$typephp)php php{
php php php php php php php php php php php php casephp php'storagephp'php:
php php php php php php php php php php php php php php php php php$prefixphp php=php php$basePrefixphp php.php php'Storagephp'php;
php php php php php php php php php php php php php php php php php$pathphp php php php=php php$basePathphp php php php.php php'Storagephp'php;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php casephp php'devicephp'php:
php php php php php php php php php php php php php php php php php$prefixphp php=php php$basePrefixphp;
php php php php php php php php php php php php php php php php php$pathphp php php php=php php$basePathphp;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php}
php php php php php php php php php$loaderphp-php>addPrefixPathphp(php$prefixphp,php php$pathphp)php;
php php php php php php php php php$thisphp-php>php_loadersphp[php$typephp]php php=php php$loaderphp;
php php php php php php php php returnphp php$thisphp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Getphp aphp pluginphp loader
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$typephp Aphp validphp pluginphp loaderphp typephp;php seephp php{php@linkphp php$php_loaderTypesphp}
php php php php php php*php php@returnphp Zendphp_Loaderphp_PluginLoader
php php php php php php*php/
php php php php publicphp functionphp getPluginLoaderphp(php$typephp)
php php php php php{
php php php php php php php php php$typephp php=php php$thisphp-php>php_validateLoaderTypephp(php$typephp)php;
php php php php php php php php ifphp php(php!issetphp(php$thisphp-php>php_loadersphp[php$typephp]php)php)php php{
php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Loaderphp/PluginLoaderphp.phpphp'php;
php php php php php php php php php php php php php$thisphp-php>setPluginLoaderphp(php$typephp,php newphp Zendphp_Loaderphp_PluginLoaderphp(php)php)php;
php php php php php php php php php}
php php php php php php php php returnphp php$thisphp-php>php_loadersphp[php$typephp]php;
php php php php php}

php php php php php/php*php*
php php php php php php*php Validatephp aphp pluginphp loaderphp type
php php php php php php*
php php php php php php*php Verifiesphp thatphp itphp isphp inphp php{php@linkphp php$php_loaderTypesphp}php,php andphp returnsphp aphp normalized
php php php php php php*php versionphp ofphp thephp typephp.
php php php php php php*
php php php php php php*php php@paramphp php stringphp php$type
php php php php php php*php php@returnphp string
php php php php php php*php php@throwsphp Zendphp_Httpphp_UserAgentphp_Exceptionphp onphp invalidphp type
php php php php php php*php/
php php php php protectedphp functionphp php_validateLoaderTypephp(php$typephp)
php php php php php{
php php php php php php php php php$typephp php=php strtolowerphp(php$typephp)php;
php php php php php php php php ifphp php(php!inphp_arrayphp(php$typephp,php php$thisphp-php>php_loaderTypesphp)php)php php{
php php php php php php php php php php php php php$typesphp php=php implodephp(php'php,php php'php,php php$thisphp-php>php_loaderTypesphp)php;

php php php php php php php php php php php php requirephp_oncephp php'Zendphp/Httpphp/UserAgentphp/Exceptionphp.phpphp'php;
php php php php php php php php php php php php throwphp newphp Zendphp_Httpphp_UserAgentphp_Exceptionphp(sprintfphp(
php php php php php php php php php php php php php php php php php'Expectedphp onephp ofphp php"php%sphp"php forphp pluginphp loaderphp typephp;php receivedphp php"php%sphp"php'php,
php php php php php php php php php php php php php php php php php$typesphp,
php php php php php php php php php php php php php php php php php(stringphp)php php$type
php php php php php php php php php php php php php)php)php;
php php php php php php php php php}
php php php php php php php php returnphp php$typephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Runphp thephp identificationphp sequencephp tophp matchphp thephp rightphp browserphp typephp accordingphp tophp the
php php php php php php*php userphp agent
php php php php php php*
php php php php php php*php php@returnphp Zendphp_Httpphp_UserAgentphp_Result
php php php php php php*php/
php php php php protectedphp functionphp php_matchUserAgentphp(php)
php php php php php{
php php php php php php php php php$typephp php=php selfphp:php:DEFAULTphp_BROWSERphp_TYPEphp;

php php php php php php php php php/php/php Ifphp wephp havephp nophp identificationphp sequencephp,php justphp returnphp thephp defaultphp type
php php php php php php php php ifphp php(emptyphp(php$thisphp-php>php_configphp[php'identificationphp_sequencephp'php]php)php)php php{
php php php php php php php php php php php php returnphp php$typephp;
php php php php php php php php php}

php php php php php php php php php/php/php Getphp sequencephp againstphp whichphp tophp match
php php php php php php php php php$sequencephp php=php explodephp(php'php,php'php,php php$thisphp-php>php_configphp[php'identificationphp_sequencephp'php]php)php;

php php php php php php php php php/php/php Ifphp aphp browserphp typephp isphp alreadyphp configuredphp,php pushphp thatphp tophp thephp frontphp ofphp thephp list
php php php php php php php php ifphp php(nullphp php!php=php=php php(php$browserTypephp php=php php$thisphp-php>getBrowserTypephp(php)php)php)php php{
php php php php php php php php php php php php arrayphp_unshiftphp(php$sequencephp,php php$browserTypephp)php;
php php php php php php php php php}

php php php php php php php php php/php/php Appendphp thephp defaultphp browserphp typephp tophp thephp listphp ifphp notphp alreadphp inphp thephp list
php php php php php php php php ifphp php(php!inphp_arrayphp(php$typephp,php php$sequencephp)php)php php{
php php php php php php php php php php php php php$sequencephp[php]php php=php php$typephp;
php php php php php php php php php}

php php php php php php php php php/php/php Testphp eachphp typephp untilphp wephp findphp aphp match
php php php php php php php php foreachphp php(php$sequencephp asphp php$browserTypephp)php php{
php php php php php php php php php php php php php$browserTypephp php=php trimphp(php$browserTypephp)php;
php php php php php php php php php php php php php$classNamephp php php php=php php$thisphp-php>php_getUserAgentDevicephp(php$browserTypephp)php;

php php php php php php php php php php php php php/php/php Attemptphp tophp matchphp thisphp devicephp class
php php php php php php php php php php php php ifphp php(php$thisphp-php>php_matchphp(php$classNamephp)php)php php{
php php php php php php php php php php php php php php php php php$typephp php=php php$browserTypephp;
php php php php php php php php php php php php php php php php php$thisphp-php>php_browserTypeClassphp[php$typephp]php php=php php$classNamephp;
php php php php php php php php php php php php php php php php breakphp;
php php php php php php php php php php php php php}
php php php php php php php php php}

php php php php php php php php returnphp php$typephp;
php php php php php}

php php php php php/php*php*
php php php php php php*php Createsphp devicephp objectphp instance
php php php php php php*
php php php php php php*php php@returnphp void
php php php php php php*php/
php php php php protectedphp functionphp php_createDevicephp(php)
php php php php php{
php php php php php php php php php$browserTypephp php=php php$thisphp-php>getBrowserTypephp(php)php;
php php php php php php php php php$classnamephp php php php=php php$thisphp-php>php_getUserAgentDevicephp(php$browserTypephp)php;
php php php php php php php php php$thisphp-php>php_devicephp php=php newphp php$classnamephp(php$thisphp-php>getUserAgentphp(php)php,php php$thisphp-php>getServerphp(php)php,php php$thisphp-php>getConfigphp(php)php)php;
php php php php php}
php}
